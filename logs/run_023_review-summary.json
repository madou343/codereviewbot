{
  "timestamp" : "2025-11-03T13:12:59.4442954",
  "index" : 23,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\profil\\ProfilView.java =====\n```\npackage com.hom.ebmw.view.sortment.profil;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseBlankGetRepository;\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseCustomRepository;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.ExcelUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.BaseLayout;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.RoleChanger;\r\nimport com.hom.ebmw.view.filter.FilterGrid;\r\nimport com.hom.ebmw.view.filter.FilterProgressLoader;\r\nimport com.hom.ebmw.view.filter.FilterStructureGrid;\r\nimport com.hom.ebmw.view.filter.StructureTreeFilterGrid;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.accordion.AccordionPanel;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.confirmdialog.ConfirmDialog;\r\nimport com.vaadin.flow.component.dependency.CssImport;\r\nimport com.vaadin.flow.component.formlayout.FormLayout;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.html.Paragraph;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.FlexComponent;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.radiobutton.RadioButtonGroup;\r\nimport com.vaadin.flow.component.radiobutton.RadioGroupVariant;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.binder.Binder;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\n\r\nimport java.util.*;\r\n\r\nimport static com.hom.ebmw.utilities.constans.ASTConst.*;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_PROFIL;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_PROFIL;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_PROFIL, layout = MainView.class)\r\n@PageTitle(TITLE_PROFIL)\r\n@CssImport(\"./styles/component/vaadin-grid.css\")\r\npublic class ProfilView extends BaseLayout implements HasPermission {\r\n\r\n    private final Context ctx = new Context();\r\n    private final GridPro<Filter> filterGrid = new GridPro<>();\r\n    private final Binder<Filter> binder = new Binder<>();\r\n    private final Accordion accordion;\r\n    private final VerticalLayout box = new VerticalLayout();\r\n    private final DnDUtils util = new DnDUtils();\r\n    private final FilterBaseBlankGetRepository service;\r\n    private Filter selectFilter = null;\r\n    private ComboBox<ObjectType> assortmentBox;\r\n    private RadioButtonGroup<String> radioGroupDirection;\r\n    private Grid<Filterbase> rightGrid;\r\n    private ComboBox<String> priorityBox;\r\n    private Div filterpart;\r\n    private Setting structureSetting = null;\r\n    private Checkbox activeBox = null;\r\n    private FilterProgressLoader assignedPnl;\r\n    private FilterProgressLoader infoTypePnl;\r\n    private FilterProgressLoader structurePnl;\r\n    private FilterProgressLoader articleClassPnl;\r\n    private FilterProgressLoader ghsPnl;\r\n    private FilterProgressLoader configPnl;\r\n    private FilterProgressLoader brandsPnl;\r\n    private FilterProgressLoader freePnl;\r\n    private FilterProgressLoader intrastatPnl;\r\n    private FilterProgressLoader eClassPnl;\r\n    private AccordionPanel assignedAccPnl;\r\n    private AccordionPanel infoTypeAccPnl;\r\n    private AccordionPanel structureAccPnl;\r\n    private AccordionPanel articleClassAccPnl;\r\n    private AccordionPanel ghsAccPnl;\r\n    private AccordionPanel configAccPnl;\r\n    private AccordionPanel brandsAccPnl;\r\n    private AccordionPanel freeAccPnl;\r\n    private AccordionPanel intrastatAccPnl;\r\n    private AccordionPanel eClassAccPnl;\r\n    private FilterGrid assignedGrd;\r\n    private FilterGrid infoTypeGrd;\r\n    private StructureTreeFilterGrid structureGrd;\r\n    private FilterGrid articleClassGrd;\r\n    private FilterGrid ghsGrd;\r\n    private FilterGrid configGrd;\r\n    private FilterGrid brandsGrd;\r\n    private FilterGrid freeGrd;\r\n    private FilterGrid intrastatGrd;\r\n    private FilterStructureGrid eClassGrd;\r\n    private Locale locale = null;\r\n    private Button deleteBtn = null;\r\n    private Button unDeleteBtn = null;\r\n    private Button editBtn = null;\r\n    private ImageButton saveBtn = null;\r\n    private Button addBtn = null;\r\n    private ObjectType type = null;\r\n    private UI ui = null;\r\n\r\n\r\n    /**\r\n     * The ProfilView function is the main function of the ProfilView class.\r\n     * It creates a new instance of the ProfilView class, and initializes it with\r\n     * all necessary parameters.  The function then calls three other functions:\r\n     * setLeftSection(), setMiddleSection(), and setRightSection().  These functions are responsible for creating each section of the view, respectively.\r\n     *\r\n     * @param Services    services Get the services from the application context\r\n     * @param UserSession uSession Get the user's session\r\n     * @return The accordion object\r\n     */\r\n    public ProfilView(Services services, UserSession uSession) {\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.USER_SESSION, uSession);\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        ui = UI.getCurrent();\r\n        if (Objects.isNull(ui)) {\r\n            ui = ctx.getUserSession().get(Params.ACTIVE_UI);\r\n        }\r\n        locale = getLocale();\r\n        accordion = new Accordion();\r\n        accordion.setSizeFull();\r\n        service = ctx.getServices().getFilterBaseBlankService();\r\n        initialPanel();\r\n\r\n        setLeftSection();\r\n        setMiddleSection();\r\n        setRightSection();\r\n\r\n        reload();\r\n    }\r\n\r\n    /**\r\n     * The clearSelection function is called when the user clicks on a grid.\r\n     * It deselects all of the grids in order to prevent multiple selections.\r\n     */\r\n    private void clearSelection() {\r\n        List<Grid<Filterbase>> grids = new ArrayList<>();\r\n        grids.add(assignedGrd.getGrid());\r\n        grids.add(infoTypeGrd.getGrid());\r\n        grids.add(structureGrd.getGrid());\r\n        grids.add(articleClassGrd.getGrid());\r\n        grids.add(ghsGrd.getGrid());\r\n        grids.add(configGrd.getGrid());\r\n        grids.add(brandsGrd.getGrid());\r\n        grids.add(freeGrd.getGrid());\r\n        grids.add(intrastatGrd.getGrid());\r\n        grids.add(eClassGrd.getGrid());\r\n\r\n        ui.access(() ->\r\n                grids.forEach(Grid::deselectAll)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The initialPanel function is used to initialize the panels that are displayed in the\r\n     * Material Master.  The function calls other functions that create each panel and then\r\n     * adds them to a list of panels.  This list is then returned by the function so it can be\r\n     * added to a tabbed pane for display in the Material Master window.\r\n     */\r\n    private void initialPanel() {\r\n\r\n        assignedAccPnl = getMaterialAssignedPanel();\r\n        infoTypeAccPnl = getInfoTypePanel();\r\n        structureAccPnl = getStructurePanel();\r\n        articleClassAccPnl = getArticleClassPanel();\r\n        ghsAccPnl = getGHSCodePanel();\r\n        configAccPnl = getConfigPanel();\r\n        brandsAccPnl = getBrandsPanel();\r\n        freeAccPnl = getNotFreePanel();\r\n        intrastatAccPnl = getIntraStatPanel();\r\n        eClassAccPnl = getEClassPanel();\r\n\r\n        loadArticleClass();\r\n        loadAssigned();\r\n        loadBrands();\r\n        loadEClass();\r\n        loadConfig();\r\n        loadGHSCode();\r\n        loadInfoType();\r\n        loadNotFree();\r\n        loadIntraStat();\r\n    }\r\n\r\n    /**\r\n     * The setLeftSection function is responsible for setting up the left section of the FilterView.\r\n     * It does this by creating a TextField, DownloadButton, RoleChanger and HorizontalLayout object.\r\n     * The TextField object is used to search through filters in the filterGrid. The DownloadButton allows users to download all filters as an Excel file.\r\n     * The RoleChanger allows users to change their role from within this view (as opposed to having them go back into Settings).\r\n     * Finally, the HorizontalLayout contains both a Search Field and a Download Button which are added into it using addComponentColumn().\r\n     */\r\n    private void setLeftSection() {\r\n        binder.setBean(defaultFilter());\r\n\r\n        TextField searchFld = new TextField();\r\n        searchFld.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Filter> listProvider = (ListDataProvider<Filter>) filterGrid.getDataProvider();\r\n            listProvider.setFilter(Filter::getName, name -> {\r\n                String nameLower = name == null ? \"\" : name.toLowerCase(Locale.ENGLISH);\r\n                String filterLower = searchFld.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n        });\r\n\r\n        DownloadButton downloadBtn = new DownloadButton(ctx, TMS.PROFIL_DOWNLOAD_TOOLTIP);\r\n\r\n        downloadBtn.reloadAsFile(\r\n                () -> \"Filters.xlsx\",\r\n                () -> {\r\n                    Role role = ctx.getSession().get(SessionParams.ACTIVE_ROLE);\r\n                    List<Map<String, Object>> table = ctx.getServices().getCustomRepository().findAllFiltersByRole(role);\r\n                    return ExcelUtils\r\n                            .writeExcelFileAsMap(ctx, table, SettingUtils.createTempFile(ctx, \"\"), \"FiltersByRole\");\r\n                });\r\n\r\n        filterGrid.addSelectionListener(event -> {\r\n            Optional<Filter> optFilter = event.getFirstSelectedItem();\r\n            optFilter.ifPresent(filter -> {\r\n                binder.setBean(filter);\r\n                this.type = filter.getSortType();\r\n                reloadPanelFilter(filter);\r\n                box.setEnabled(false);\r\n                filterpart.setEnabled(true);\r\n                deleteBtn.setVisible(true);\r\n                editBtn.setEnabled(true);\r\n                saveBtn.setEnabled(false);\r\n                addBtn.setVisible(true);\r\n                if (Objects.nonNull(filter.getDeleteBy()))\r\n                    unDeleteBtn.setVisible(true);\r\n                ctx.getUserSession().put(Params.ACTIVE_FILTER, filter);\r\n            });\r\n        });\r\n\r\n        filterGrid.addComponentColumn(this::setParagraph)\r\n                .setHeader(getTranslation(TMS.PROFIL_GRID_NAME, getLocale(), ctx));\r\n        filterGrid.setHeight(\"100%\");\r\n\r\n\r\n        RoleChanger changer = new RoleChanger(ctx);\r\n        changer.getRoleCombo().addValueChangeListener(event -> reload());\r\n        HorizontalLayout line = new HorizontalLayout(searchFld, downloadBtn);\r\n        CompUtils.removeMSP(line, \"MSP\");\r\n        line.setJustifyContentMode(FlexComponent.JustifyContentMode.BETWEEN);\r\n        getLeftSection().add(changer, line, filterGrid);\r\n    }\r\n\r\n    /**\r\n     * The setParagraph function takes a Filter object as an argument and returns a Paragraph object.\r\n     * The function sets the text of the paragraph to be equal to the nameWithPrefix property of\r\n     * filter, which is defined in Filter.java as being equal to &quot;filter.&quot; + this.name (where this refers\r\n     * to an instance of Filter). If deleteBy is not null, then it sets the background color of para's style\r\n     * property (which I assume means that it changes its CSS) so that it has a red background color (#ffd9d9).\r\n     *\r\n     * @param Filter filter Get the name of the filter\r\n     * @return A paragraph object\r\n     */\r\n    private Paragraph setParagraph(Filter filter) {\r\n        Paragraph para = new Paragraph();\r\n        para.setText(filter.getNameWithPrefix());\r\n        if (Objects.nonNull(filter.getDeleteBy()))\r\n            para.getStyle().set(\"background-color\", \"#ffd9d9\");\r\n        return para;\r\n    }\r\n\r\n\r\n    /**\r\n     * The setMiddleSection function is responsible for creating the middle section of the Filter view.\r\n     * It creates a HorizontalLayout called headValues, which contains all of the buttons that are used in this section.\r\n     * The TextField nameTxt is created and set to be required, as well as being bound to a validator that checks if it's empty or not.\r\n     * The Checkbox activeBox is created and set to be invisible by default, with its value being true by default. It's also bound to a validator that checks if it's empty or not.\r\n     * A saveBtn ImageButton is created using CompUtils\r\n     */\r\n    private void setMiddleSection() {\r\n        HorizontalLayout headValues = new HorizontalLayout();\r\n\r\n        TextField nameTxt = new TextField();\r\n        nameTxt.setRequired(true);\r\n\r\n        binder.forField(nameTxt)\r\n                .withValidator(item -> !item.isEmpty(),\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), ctx))\r\n                .withValidator(item -> CompUtils.checkIfProfilNameExists(ctx, binder.getBean(), item),\r\n                        getTranslation(TMS.ERROR_VALIDATION_NAME_EXISTS, getLocale(), ctx))\r\n                .bind(Filter::getName, Filter::setName);\r\n\r\n        activeBox = new Checkbox(getTranslation(TMS.PROFIL_USE_AS_TEMPLATE, getLocale(), ctx));\r\n\r\n        activeBox.setVisible(false);\r\n        activeBox.setValue(true);\r\n\r\n        binder.forField(activeBox).bind(Filter::isActive, Filter::setActive);\r\n\r\n        saveBtn = new ImageButton(CompUtils.getSaveFloppy(ctx), CompUtils.getDisableSaveFloppy(ctx));\r\n        CompUtils.addToolTip(ctx, saveBtn, TMS.PROFIL_BUTTON_SAVE_TOOLTIP);\r\n        saveBtn.setEnabled(true);\r\n        saveBtn.addClickListener(event -> {\r\n            binder.validate();\r\n            if (binder.isValid()) {\r\n                User user = ctx.getSession().getCurrentUser(ctx);\r\n                resetRightGrid();\r\n                selectFilter = binder.getBean();\r\n                selectFilter.setDate(user);\r\n                // create Filter ID\r\n                selectFilter = ctx.getServices().getFilterService().save(selectFilter);\r\n                reload();\r\n                reloadPanelFilter(selectFilter);\r\n                box.setEnabled(false);\r\n                saveBtn.setEnabled(false);\r\n                editBtn.setEnabled(true);\r\n                filterpart.setEnabled(false);\r\n                deleteBtn.setVisible(true);\r\n                addBtn.setVisible(true);\r\n                ctx.getUserSession().put(Params.ACTIVE_FILTER, selectFilter);\r\n            }\r\n        });\r\n\r\n        Button reloadBtn = new Button(VaadinIcon.REFRESH.create());\r\n        CompUtils.addToolTip(ctx, reloadBtn, TMS.PROFIL_BUTTON_REFRESH_TOOLTIP);\r\n        reloadBtn.addClickListener(event -> {\r\n            reload();\r\n            reloadPanelFilter(selectFilter);\r\n            filterpart.setEnabled(!box.isEnabled());\r\n        });\r\n\r\n        unDeleteBtn = new Button(VaadinIcon.OUTBOX.create());\r\n        CompUtils.addToolTip(ctx, deleteBtn, TMS.PROFIL_BUTTON_UNDELETE_TOOLTIP);\r\n        unDeleteBtn.setVisible(false);\r\n        unDeleteBtn.addClickListener(event -> {\r\n            if (!filterGrid.getSelectedItems().isEmpty()) {\r\n                List<Filter> items = new ArrayList<>(filterGrid.getSelectedItems());\r\n                Filter filter = items.get(0);\r\n                filter.setDeleteBy(null);\r\n                filter.setDeleteOn(null);\r\n                ctx.getServices().getFilterService().save(filter);\r\n                unDeleteBtn.setVisible(false);\r\n            }\r\n        });\r\n\r\n        deleteBtn = new Button(VaadinIcon.CLOSE.create());\r\n        deleteBtn.setVisible(false);\r\n        CompUtils.addToolTip(ctx, deleteBtn, TMS.PROFIL_BUTTON_DELETE_TOOLTIP);\r\n        deleteBtn.addClickListener(event -> {\r\n            ConfirmDialog dialog = new ConfirmDialog();\r\n            dialog.setText(getTranslation(TMS.PROFIL_MSG_DELETE_CONFIRM, getLocale()));\r\n            dialog.setCancelable(true);\r\n            dialog.setCancelText(getTranslation(TMS.GLB_BUTTON_CANCEL, getLocale()));\r\n            dialog.addCancelListener(e -> dialog.close());\r\n            dialog.setConfirmText(getTranslation(TMS.GLB_BUTTON_DELETE, getLocale()));\r\n            dialog.addConfirmListener(e -> {\r\n                if (Objects.isNull(selectFilter)) {\r\n                    selectFilter = binder.getBean();\r\n                }\r\n                User user = ctx.getSession().getCurrentUser(ctx);\r\n                selectFilter.setDelete(user);\r\n                ctx.getServices().getFilterService().save(selectFilter);\r\n                selectFilter = null;\r\n                filterpart.setEnabled(false);\r\n                deleteBtn.setVisible(false);\r\n                binder.setBean(defaultFilter());\r\n                editBtn.setEnabled(false);\r\n                saveBtn.setEnabled(true);\r\n                box.setEnabled(true);\r\n                reload();\r\n                reloadPanelFilter(null);\r\n            });\r\n            dialog.open();\r\n        });\r\n\r\n        addBtn = new Button(VaadinIcon.PLUS.create());\r\n        addBtn.setVisible(false);\r\n        CompUtils.addToolTip(ctx, addBtn, TMS.PROFIL_BUTTON_ADD_TOOLTIP);\r\n        addBtn.addClickListener(event -> {\r\n            selectFilter = null;\r\n            binder.setBean(defaultFilter());\r\n            editBtn.setEnabled(false);\r\n            deleteBtn.setVisible(false);\r\n            saveBtn.setEnabled(true);\r\n            box.setEnabled(true);\r\n            rightGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<Filterbase>()));\r\n        });\r\n\r\n        editBtn = new Button(VaadinIcon.PENCIL.create());\r\n        editBtn.setEnabled(false);\r\n        CompUtils.addToolTip(ctx, editBtn, TMS.PROFIL_BUTTON_EDIT_TOOLTIP);\r\n        editBtn.addClickListener(event -> {\r\n            editBtn.setEnabled(false);\r\n            deleteBtn.setVisible(true);\r\n            saveBtn.setEnabled(true);\r\n            box.setEnabled(true);\r\n            filterpart.setEnabled(false);\r\n        });\r\n\r\n        setPrioritybox();\r\n        setRadioInAssortment();\r\n        FormLayout form = new FormLayout();\r\n        form.addFormItem(nameTxt, getTranslation(TMS.PROFIL_FORM_NAME, getLocale(), ctx));\r\n        form.addFormItem(priorityBox, getTranslation(TMS.PROFIL_FORM_VISIBLE_FOR, getLocale(), ctx));\r\n        form.addFormItem(assortmentBox, getTranslation(TMS.PROFIL_FORM_ASSORTMENT_TYPE, getLocale(), ctx));\r\n        form.setWidth(\"50%\");\r\n        box.add(form, activeBox);\r\n\r\n        headValues.add(saveBtn, editBtn, reloadBtn, deleteBtn, addBtn, unDeleteBtn);\r\n        getMiddleSection().add(box, headValues);\r\n        setFilterPart();\r\n        getMiddleSection().add(filterpart);\r\n    }\r\n\r\n    /**\r\n     * The reloadPanelFilter function is called when the user clicks on a filter in the left panel.\r\n     * It sets the active filter to be that which was clicked, and then calls loadStructure() and reloadRightGridByFilter().\r\n     *\r\n     * @param Filter filter Reload the right grid\r\n     */\r\n    private void reloadPanelFilter(Filter filter) {\r\n        if (Objects.nonNull(filter)) {\r\n            ui.access(() -> {\r\n                ctx.getUserSession().put(Params.ACTIVE_FILTER, filter);\r\n                filterpart.setEnabled(true);\r\n\r\n                loadStructure(structureSetting);\r\n            });\r\n        }\r\n        reloadRightGridByFilter(filter);\r\n    }\r\n\r\n    /**\r\n     * The reloadRightGridByFilter function is called when the user clicks on a filter in the left grid.\r\n     * It reloads the right grid with all of that filter's Filterbase objects, sorted by their order field.\r\n     *\r\n     * @param Filter filter Filter the data in the rightgrid\r\n     */\r\n    private void reloadRightGridByFilter(Filter filter) {\r\n        ui.access(() -> {\r\n            List<Filterbase> filters = new ArrayList<>();\r\n            if (Objects.nonNull(filter)) {\r\n                filters = ctx.getServices().getFilterBaseService().findAllByFilterAndDelete(filter, false);\r\n\r\n                CompUtils.sortFilterBase(filters);\r\n            }\r\n            rightGrid.setDataProvider(DataProvider.ofCollection(filters));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setPrioritybox function sets the priorityBox ComboBox to a new ComboBox.\r\n     * It adds a tooltip to the priority box, and sets it so that it is clearable.\r\n     * The items in the combo box are set to FILTER_TEAM, which is defined as &quot;team&quot; in this class.\r\n     * The item label generator for each item replaces underscores with nothing (so that team becomes Team).\r\n     * It also makes sure that there is an item selected by setting required as true.  This means if you try and submit without selecting an option, you will get an error message saying &quot;This field may not be empty&quot;.\r\n     */\r\n    private void setPrioritybox() {\r\n        priorityBox = new ComboBox<>();\r\n        CompUtils.addToolTip(ctx, priorityBox, TMS.PROFIL_COMBO_PRIORITY_TOOLTIP);\r\n        priorityBox.setClearButtonVisible(true);\r\n        priorityBox.setItems(FILTER_TEAM);\r\n        priorityBox.setItemLabelGenerator(item -> item.replace(\"_\", \"\"));\r\n        priorityBox.setRequired(true);\r\n        binder.forField(priorityBox)\r\n                .withValidator(item -> Objects.nonNull(item) && !item.isEmpty(),\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), ctx))\r\n                .bind(Filter::getPrefix, (filter, value) -> filter.setPrefix(value, ctx));\r\n        priorityBox.addValueChangeListener(event -> {\r\n            Role activeRole = ctx.getHttpAttribute(SessionParams.ACTIVE_ROLE);\r\n            activeBox.setVisible(activeRole.getName().equals(\"admin\"));\r\n        });\r\n        priorityBox.setReadOnly(true);\r\n        priorityBox.setValue(FILTER_TEAM);\r\n    }\r\n\r\n    /**\r\n     * The resetRightGrid function is called when the user clicks on a filter in the left grid.\r\n     * It resets the right grid to display only those fields that are relevant to that filter.\r\n     */\r\n    private void resetRightGrid() {\r\n        Filter filterBean = binder.getBean();\r\n        if (Objects.nonNull(selectFilter))\r\n            type = selectFilter.getSortType();\r\n\r\n        if (filterBean.getId() != 0 && !type.equals(filterBean.getSortType())) {\r\n            final FilterBaseCustomRepository customService = ctx.getServices().getFilterBaseCustomService();\r\n            customService.removeByFilter(filterBean);\r\n            reloadRightGridByFilter(filterBean);\r\n        }\r\n\r\n        loadAccordion();\r\n    }\r\n\r\n    /**\r\n     * The setRadioInAssortment function sets the assortmentBox to a ComboBox object.\r\n     * The assortmentBox is set to have two items, ObjectType.ECAT and ObjectType.IMPEX,\r\n     * with the default value being ObjectType.ECAT (the first item).  The function then sets\r\n     * structureSetting equal to SettingUtils' getSettingByType method called on ctx and SettingType's DEFAULT_ECAT_STRUCUTURE_NAME constant; this is done because of the default value of ECAT in the assortment box (see above).  Then an addValueChangeListener method is called on assortmentBox that\r\n     */\r\n    private void setRadioInAssortment() {\r\n        assortmentBox = new ComboBox<>();\r\n        assortmentBox.setItems(ObjectType.ECAT, ObjectType.IMPEX);\r\n        assortmentBox.setValue(ObjectType.ECAT);\r\n        assortmentBox.setItemLabelGenerator(ObjectType::name);\r\n        structureSetting = SettingUtils.getSettingByType(ctx, SettingType.DEFAULT_ECAT_STRUCUTURE_NAME);\r\n        assortmentBox.addValueChangeListener(event -> {\r\n\r\n            if (Objects.nonNull(event.getValue())) {\r\n                switch (event.getValue()) {\r\n                    default:\r\n                    case ECAT:\r\n                        structureSetting = SettingUtils.getSettingByType(ctx, SettingType.DEFAULT_ECAT_STRUCUTURE_NAME);\r\n                        break;\r\n                    case IMPEX:\r\n                        structureSetting = SettingUtils.getSettingByType(ctx, SettingType.DEFAULT_IMPEX_STRUCUTURE_NAME);\r\n                        break;\r\n                }\r\n            }\r\n            if (Objects.nonNull(radioGroupDirection) && Objects.nonNull(radioGroupDirection.getValue())) {\r\n                loadDirection(radioGroupDirection.getValue());\r\n            }\r\n        });\r\n        binder.forField(assortmentBox).bind(Filter::getSortType, Filter::setSortType);\r\n    }\r\n\r\n    /**\r\n     * The setRadioInDirection function sets the radio buttons for the direction of a profile.\r\n     * The user can choose between adding or removing material from a profile.\r\n     */\r\n    private void setRadioInDirection() {\r\n        radioGroupDirection = new RadioButtonGroup<>();\r\n        radioGroupDirection.setLabel(getTranslation(TMS.PROFIL_RADIO_DIRECTION, getLocale(), ctx));\r\n        radioGroupDirection.setItems(\"ADD\", \"REMOVE\");\r\n        radioGroupDirection.addThemeVariants(RadioGroupVariant.MATERIAL_VERTICAL);\r\n        radioGroupDirection.setValue(\"ADD\");\r\n        radioGroupDirection.addValueChangeListener(event -> loadDirection(event.getValue()));\r\n        loadDirection(\"ADD\");\r\n    }\r\n\r\n    /**\r\n     * The loadDirection function is called by the loadFilter function.\r\n     * It takes a String as an argument and sets the direction of the filter to either ADD or REMOVE.\r\n     * If no direction is specified, it defaults to ADD.\r\n     *\r\n     * @param String direction Determine the direction of the filter\r\n     */\r\n    private void loadDirection(String direction) {\r\n        if (!direction.isEmpty()) {\r\n            switch (direction) {\r\n                default:\r\n                case \"ADD\":\r\n                    util.setDirection(Filterbase.ADD);\r\n                    break;\r\n                case \"REMOVE\":\r\n                    util.setDirection(Filterbase.REMOVE);\r\n                    break;\r\n            }\r\n            loadAccordion();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The loadAccordion function is called when the user selects a new assortment type or direction.\r\n     * It clears the accordion and adds new components to it based on what was selected.\r\n     */\r\n    private void loadAccordion() {\r\n        ui.access(() -> {\r\n            accordion.close();\r\n            ObjectType radioAssortment = assortmentBox.getValue();\r\n            String radioDirection = radioGroupDirection.getValue();\r\n            switch (radioAssortment) {\r\n                default:\r\n                case ECAT:\r\n                case IMPEX:\r\n                    switch (radioDirection) {\r\n                        default:\r\n                        case \"ADD\":\r\n                            addToAccordionEcatAdd();\r\n                            break;\r\n                        case \"REMOVE\":\r\n                            addToAccordionEcatRemove();\r\n                            break;\r\n                    }\r\n                    break;\r\n            }\r\n\r\n            clearSelection();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The addToAccordionEcatAdd function adds the assignedAccPnl to the accordion.\r\n     */\r\n    private void addToAccordionEcatAdd() {\r\n        accordion.getChildren().forEach(accordion::remove);\r\n        accordion.add(assignedAccPnl);\r\n    }\r\n\r\n    /**\r\n     * The addToAccordionEcatRemove function removes all the accordion panels from the accordion, then adds them back in.\r\n     * This is done to ensure that they are added in a specific order.\r\n     */\r\n    private void addToAccordionEcatRemove() {\r\n        accordion.getChildren().forEach(accordion::remove);\r\n        accordion.add(structureAccPnl);\r\n        accordion.add(articleClassAccPnl);\r\n        accordion.add(brandsAccPnl);\r\n        accordion.add(infoTypeAccPnl);\r\n        accordion.add(ghsAccPnl);\r\n        accordion.add(configAccPnl);\r\n        accordion.add(freeAccPnl);\r\n        accordion.add(intrastatAccPnl);\r\n        accordion.add(eClassAccPnl);\r\n    }\r\n\r\n    /**\r\n     * The addToAccordionDefault function adds the following panels to the accordion:\r\n     * assignedAccPnl, structureAccPnl, articleClassAccPnl, brandsAccPnl, infoTypeAccPnl\r\n     * ghsAccPnl, configuratorPanel (configuration panel), freeTextPanel (free text panel)\r\n     */\r\n    @SuppressWarnings(\"unused\")\r\n    private void addToAccordionDefault() {\r\n        accordion.add(assignedAccPnl);\r\n        accordion.add(structureAccPnl);\r\n        accordion.add(articleClassAccPnl);\r\n        accordion.add(brandsAccPnl);\r\n        accordion.add(infoTypeAccPnl);\r\n        accordion.add(ghsAccPnl);\r\n        accordion.add(configAccPnl);\r\n        accordion.add(freeAccPnl);\r\n        accordion.add(intrastatAccPnl);\r\n        accordion.add(eClassAccPnl);\r\n    }\r\n\r\n    /**\r\n     * The setFilterPart function is responsible for setting up the filter part of the UI.\r\n     * It does this by creating a new Grid, and then adding columns to it.\r\n     * The grid is then added to an accordion, which is in turn added to a horizontal layout.\r\n     * This horizontal layout also contains another grid (rightGrid), which has been created earlier in the code.\r\n     */\r\n    private void setFilterPart() {\r\n        setRadioInDirection();\r\n\r\n        addToAccordionEcatAdd();\r\n        accordion.close();\r\n\r\n        rightGrid = new Grid<>();\r\n        rightGrid.addComponentColumn(CompUtils::getDirection)\r\n                .setHeader(getTranslation(TMS.PROFIL_GRID_DIRECTION, getLocale(), ctx));\r\n        rightGrid.addColumn(Filterbase::getLabel).setHeader(getTranslation(TMS.PROFIL_GRID_NAME, getLocale(), ctx));\r\n        rightGrid.addColumn(Filterbase::getType).setHeader(getTranslation(TMS.PROFIL_GRID_TYPE, getLocale(), ctx));\r\n\r\n        rightGrid.setSelectionMode(SelectionMode.MULTI);\r\n        rightGrid.setSizeFull();\r\n\r\n        util.dragNdrop(ui, ctx, assignedGrd.getGrid(), rightGrid, FilterType.ZUORDNUNG_MATERIAL);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, assignedGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, structureGrd.getGrid(), rightGrid, FilterType.STRUCTURE);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, structureGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, articleClassGrd.getGrid(), rightGrid, FilterType.ARTIKELKLASSE);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, articleClassGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, ghsGrd.getGrid(), rightGrid, FilterType.GHS_CODES);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, ghsGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, infoTypeGrd.getGrid(), rightGrid, FilterType.INFOTYPE);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, infoTypeGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, intrastatGrd.getGrid(), rightGrid, FilterType.INTRASTAT);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, intrastatGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, freeGrd.getGrid(), rightGrid, FilterType.NOTFREE);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, freeGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, brandsGrd.getGrid(), rightGrid, FilterType.BRANDS);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, brandsGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, configGrd.getGrid(), rightGrid, FilterType.CONFIG);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, configGrd.getGrid());\r\n        util.dragNdrop(ui, ctx, eClassGrd.getGrid(), rightGrid, FilterType.STRUCTURE);\r\n        DnDUtils.dragNDelete(ui, ctx, rightGrid, eClassGrd.getGrid());\r\n\r\n        filterpart = new Div();\r\n        filterpart.setWidthFull();\r\n        filterpart.setHeight(\"70%\");\r\n        filterpart.setEnabled(false);\r\n\r\n        HorizontalLayout filters = new HorizontalLayout();\r\n        filters.add(accordion, rightGrid);\r\n        filters.setSizeFull();\r\n        filterpart.add(radioGroupDirection, filters);\r\n    }\r\n\r\n    /**\r\n     * The setRightSection function is used to set the right section of the GUI.\r\n     * It sets it to be invisible, and then calls a function that switches its visibility.\r\n     */\r\n    private void setRightSection() {\r\n        setRightVisible(false);\r\n        switchVisibility();\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to refresh the filterGrid.\r\n     * It does this by first getting a list of all filters from the database, then removing any filters that are not relevant to the current user.\r\n     * The function then sets up the priorityBox based on whether or not you are an admin, and finally it sets up a tooltip for saveBtn.\r\n     */\r\n    private void reload() {\r\n        List<Filter> filters = ctx.getServices().getFilterService().findAll();\r\n        User user = ctx.getSession().getCurrentUser(ctx);\r\n        Role currentRole = ctx.getSession().get(SessionParams.ACTIVE_ROLE);\r\n        if (!getPermission(user, ctx.getServices(), getClass().getCanonicalName() + \".showDeleted\").isRead())\r\n            filters.removeIf(item -> (Objects.nonNull(item.getDeleteBy())));\r\n        filters.removeIf(item -> (Objects.nonNull(item.getTeam()) && item.getTeam().getId() != currentRole.getId()));\r\n        filters.removeIf(item -> (Objects.nonNull(item.getPrivate()) && item.getPrivate().getId() != user.getId()));\r\n        if (currentRole.getName().equals(\"admin\")) {\r\n            priorityBox.setReadOnly(false);\r\n            priorityBox.setItems(FILTER_GLB, FILTER_TEAM, FILTER_PRV);\r\n            priorityBox.setValue(FILTER_GLB);\r\n        } else {\r\n            priorityBox.setReadOnly(true);\r\n            priorityBox.setItems(FILTER_TEAM);\r\n            priorityBox.setValue(FILTER_TEAM);\r\n        }\r\n\r\n        filterGrid.setDataProvider(DataProvider.ofCollection(filters));\r\n\r\n        //Reload ToolTip\r\n        CompUtils.addToolTip(ctx, saveBtn, TMS.PROFIL_BUTTON_SAVE_TOOLTIP);\r\n    }\r\n\r\n    /**\r\n     * The getStructurePanel function creates a new AccordionPanel object, which is used to create the structure panel.\r\n     * The structure panel contains a FilterProgressLoader object and a StructureTreeFilterGrid object.\r\n     * The FilterProgressLoader is used to display the progress of loading data into the StructureTreeFilterGrid.\r\n     * The StructureTreeFilterGrid displays all of the structures in an expandable tree format, allowing users to select one or more structures for filtering purposes.\r\n     *\r\n     * @return The following:\r\n     */\r\n    protected AccordionPanel getStructurePanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        structurePnl = new FilterProgressLoader();\r\n        structureGrd = new StructureTreeFilterGrid(ctx, false);\r\n        structureGrd.setId(\"stucture-type\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_STRUCTURE, locale, ctx));\r\n\r\n        structurePnl.add(structureGrd);\r\n        panel.addContent(structurePnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getArticleClassPanel function creates a new AccordionPanel, which is a collapsible panel that can be expanded and collapsed by clicking on the title bar.\r\n     * The articleClassPnl variable is set to an instance of FilterProgressLoader, which displays a loading animation while data loads into the grid.\r\n     * The articleClassGrd variable is set to an instance of FilterGrid with two boolean parameters passed in: false and false.  These booleans are used for filtering purposes (see below).\r\n     * The id attribute of the articleClassGrd object is set to &quot;article-class&quot;.  This will be used later when we want to\r\n     *\r\n     * @return The panel that contains the article class grid\r\n     */\r\n    protected AccordionPanel getArticleClassPanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        articleClassPnl = new FilterProgressLoader();\r\n        articleClassGrd = new FilterGrid(ctx, false, false);\r\n        articleClassGrd.setId(\"article-class\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_ARTICLE_CLASS, locale, ctx));\r\n\r\n        articleClassPnl.add(articleClassGrd);\r\n        panel.addContent(articleClassPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getInfoTypePanel function creates a new AccordionPanel object, which is used to create the\r\n     * Info Type filter panel. The function then creates a FilterProgressLoader object and assigns it to\r\n     * the infoTypePnl variable. This loader will be used to display loading progress when filtering by\r\n     * Info Type. Next, the function creates a FilterGrid object and assigns it to infoTypeGrd variable.\r\n     * This grid will be used for displaying data in the Info Type filter panel (i.e., all of the available\r\n     * information types). Finally, this function adds both objects created above into an AccordionPanel\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getInfoTypePanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        infoTypePnl = new FilterProgressLoader();\r\n        infoTypeGrd = new FilterGrid(ctx, false, true);\r\n        infoTypeGrd.setId(\"info-type\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_INFO_TYPE, locale, ctx));\r\n\r\n        infoTypePnl.add(infoTypeGrd);\r\n        panel.addContent(infoTypePnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getGHSCodePanel function creates a new AccordionPanel object, which is used to create the GHS Code filter.\r\n     * The function then creates a FilterProgressLoader object and assigns it to the ghsPnl variable.\r\n     * A FilterGrid object is created and assigned to the ghsGrd variable, with parameters of ctx (the Vaadin context), false (indicating that this grid will not be editable),\r\n     * and false (indicating that this grid will not be selectable). The id &quot;ghs-type&quot; is set for this grid.\r\n     * Then, panel's summary text is set using get\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getGHSCodePanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        ghsPnl = new FilterProgressLoader();\r\n        ghsGrd = new FilterGrid(ctx, false, false);\r\n        ghsGrd.setId(\"ghs-type\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_GHS_CODES, locale, ctx));\r\n\r\n        ghsPnl.add(ghsGrd);\r\n        panel.addContent(ghsPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getConfigPanel function creates a new AccordionPanel, which is a collapsible panel that can be expanded and collapsed.\r\n     * It then creates two new objects: configPnl, which is an instance of the FilterProgressLoader class; and configGrd,\r\n     * which is an instance of the FilterGrid class. The setId function sets the id attribute for this element in the DOM to &quot;config-type&quot;.\r\n     * The setSummaryText function sets text to display as summary for this accordion panel. This text will be displayed when\r\n     * accordion panel is collapsed (see getTranslation). Then it adds configPnl to\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getConfigPanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        configPnl = new FilterProgressLoader();\r\n        configGrd = new FilterGrid(ctx, false, false);\r\n        configGrd.setId(\"config-type\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_CONFIGURABLE_ARTICLES, locale, ctx));\r\n\r\n        configPnl.add(configGrd);\r\n        panel.addContent(configPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getBrandsPanel function creates a new AccordionPanel object, which is used to create the Brands panel in the filter.\r\n     * It also creates a FilterProgressLoader object and adds it to the AccordionPanel.\r\n     * The function then creates a FilterGrid object and sets its ID attribute to &quot;brand-type&quot;.  This will be used later when we want to access this grid from JavaScript code.\r\n     * The function then sets the summary text of our AccordionPanel using getTranslation, which is defined in TMSConstants (see above).  This allows us to use translations for all of our strings that are displayed on screen.\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getBrandsPanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        brandsPnl = new FilterProgressLoader();\r\n        brandsGrd = new FilterGrid(ctx, false, false);\r\n        brandsGrd.setId(\"brand-type\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_BRANDS, locale, ctx));\r\n\r\n        brandsPnl.add(brandsGrd);\r\n        panel.addContent(brandsPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getNotFreePanel function creates a new AccordionPanel object, which is used to create the\r\n     * &quot;Not Free&quot; panel in the filter accordion. The function then creates a FilterProgressLoader object\r\n     * and assigns it to freePnl. It also creates a FilterGrid object and assigns it to freeGrd. The\r\n     * function sets the id of freeGrd as &quot;free-type&quot;. It then sets the summary text of panel using\r\n     * getTranslation with TMS.FILTER_NOT_FREE as an argument, along with locale and ctx (the current\r\n     * Vaadin context). Finally, it adds\r\n     *\r\n     * @return An accordionpanel object\r\n     */\r\n    protected AccordionPanel getNotFreePanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        freePnl = new FilterProgressLoader();\r\n        freeGrd = new FilterGrid(ctx, false, false);\r\n        freeGrd.setId(\"free-type\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_NOT_FREE, locale, ctx));\r\n\r\n        freePnl.add(freeGrd);\r\n        panel.addContent(freePnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getIntraStatPanel function creates a new AccordionPanel object, which is used to create the Intrastat panel.\r\n     * The function then creates a FilterProgressLoader object called intrastatPnl and a FilterGrid object called intrastatGrd.\r\n     * The function sets the id of the intrastatGrd to &quot;intra-stat&quot; and sets the summary text of panel to be equal to\r\n     * getTranslation(TMS.FILTER_INTRA_STAT, locale, ctx). It then adds intrastatGrd into intrastatPnl and adds that into\r\n     * panel before returning it\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getIntraStatPanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        intrastatPnl = new FilterProgressLoader();\r\n        intrastatGrd = new FilterGrid(ctx, false, false);\r\n        intrastatGrd.setId(\"intra-stat\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_INTRA_STAT, locale, ctx));\r\n\r\n        intrastatPnl.add(intrastatGrd);\r\n        panel.addContent(intrastatPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getEClassPanel function creates a new AccordionPanel object, which is a collapsible panel that can be expanded and collapsed.\r\n     * The function then creates an instance of the FilterProgressLoader class, which is used to display loading progress when the user clicks on the E-Class filter.\r\n     * The function also creates an instance of the FilterStructureGrid class, which displays all available E-Classes in a grid format.\r\n     * This grid will be populated with data from getArticleStructureClassification() in ArticleServiceImpl once it has been called by eClassGrd's lambda expression (which calls getArticleStructureClassification\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getEClassPanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        eClassPnl = new FilterProgressLoader();\r\n        eClassGrd = new FilterStructureGrid(ctx, locale,\r\n                () -> service.getArticleStructureClassification(eClassGrd.getStructureName(), locale, 0));\r\n        eClassGrd.setId(\"e-class\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_E_CLASS, locale, ctx));\r\n\r\n        eClassPnl.add(eClassGrd);\r\n        panel.addContent(eClassPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The getMaterialAssignedPanel function creates a new AccordionPanel object, which is used to create the accordion\r\n     * panel that will contain the assigned material grid. The function then creates a FilterProgressLoader object and\r\n     * assigns it to the assignedPnl variable. This loader will be used by the filter progress bar in order to display its\r\n     * progress when filtering data in this grid. Next, we create a new FilterGrid object and assign it to our assignedGrd\r\n     * variable. We pass three arguments into this constructor: ctx (the context of our application), false (indicating that\r\n     * we do not want any sortable\r\n     *\r\n     * @return An accordionpanel\r\n     */\r\n    protected AccordionPanel getMaterialAssignedPanel() {\r\n        AccordionPanel panel = new AccordionPanel();\r\n        assignedPnl = new FilterProgressLoader();\r\n        assignedGrd = new FilterGrid(ctx, false, false);\r\n        assignedGrd.setId(\"assigned-material\");\r\n        panel.setSummaryText(getTranslation(TMS.FILTER_ASSIGNED_MATERIAL, locale, ctx));\r\n        assignedPnl.add(assignedGrd);\r\n        panel.addContent(assignedPnl);\r\n        return panel;\r\n    }\r\n\r\n    /**\r\n     * The loadAssigned function is called when the user clicks on the &quot;Assigned&quot; tab.\r\n     * It loads all of the materials that are assigned to this article, and displays them in a grid.\r\n     */\r\n    protected void loadAssigned() {\r\n        ui.access(() ->\r\n                assignedPnl.reload(assignedGrd, () -> {\r\n                    List<Filterbase> assigned = new ArrayList<>();\r\n                    assigned.addAll(service.getArticleAssignedMaterialInBasicAssortment(locale, 0));\r\n                    assigned.addAll(service.getArticleAssignedMaterial(ctx, locale, 0));\r\n                    return assigned;\r\n                })\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The getSetting function is used to retrieve a setting from the database.\r\n     *\r\n     *\r\n     * @param SettingType type Determine which setting to return\r\n     *\r\n     * @return The value of a setting\r\n     */\r\n    protected String getSetting(SettingType type) {\r\n        String result = \"\";\r\n        Optional<Setting> optSetting = ctx.getServices().getSettingCustomServices().findBySettingType(ctx, type);\r\n        if (optSetting.isPresent()) {\r\n            result = optSetting.get().getValue();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The loadEClass function is called when the user clicks on a structure in the grid.\r\n     * It loads all of the EClasses for that structure into a new grid, and displays it to\r\n     * the user. The function also sets up an event listener so that if any of these EClasses\r\n     * are clicked, they will load their corresponding attributes into another grid. This is done by calling\r\n     * loadAttributes(). The function also sets up an event listener so that if any of these EClasses are double-clicked,\r\n     * they will be added to a list which can then be used to create articles with those attributes\r\n     */\r\n    protected void loadEClass() {\r\n        ui.access(() ->\r\n                eClassPnl.reload(eClassGrd, () -> sortByLabel(\r\n                        service.getArticleStructureClassification(eClassGrd.getStructureName(), locale, 0)))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadIntraStat function is called when the user clicks on the &quot;Intrastat&quot; button in the menu bar.\r\n     * It loads a list of all articles that have been imported from Intrastat, and displays them in a grid.\r\n     */\r\n    protected void loadIntraStat() {\r\n        ui.access(() ->\r\n                intrastatPnl.reload(intrastatGrd,\r\n                        () -> sortByLabel(service.getArticleIntraStat(locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadNotFree function is called when the user clicks on the &quot;Not Free&quot; tab.\r\n     * It reloads the freePnl panel with a list of articles that are not free, sorted by label.\r\n     */\r\n    protected void loadNotFree() {\r\n        ui.access(() ->\r\n                freePnl.reload(freeGrd, () -> sortByLabel(service.getArticleNotFree(locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadBrands function is called when the user clicks on the &quot;Brands&quot; tab.\r\n     * It loads all of the brands from the database and displays them in a grid.\r\n     */\r\n    protected void loadBrands() {\r\n        ui.access(() ->\r\n                brandsPnl.reload(brandsGrd,\r\n                        () -> sortByLabel(service.getArticleBrand(locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadGHSCode function is called when the user clicks on the &quot;GHS&quot; button in the top right corner of\r\n     * the screen. It loads all GHS codes from a database and displays them in a grid. The function also sorts\r\n     * these codes by their labels, which are displayed to users as text descriptions of each code's meaning.\r\n     */\r\n    protected void loadGHSCode() {\r\n        ui.access(() ->\r\n                ghsPnl.reload(ghsGrd, () -> sortByLabel(service.getArticleGHSCode(locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadConfig function is called when the user clicks on the &quot;Load Config&quot; button.\r\n     * It loads a default configuration from the database and displays it in a grid.\r\n     */\r\n    protected void loadConfig() {\r\n        ui.access(() ->\r\n                configPnl.reload(configGrd,\r\n                        () -> sortByLabel(service.getArticleConfig(locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadInfoType function is called when the user clicks on the &quot;Info Type&quot; button in the\r\n     * left-hand navigation bar. It loads a list of all Info Types that are currently available to\r\n     */\r\n    protected void loadInfoType() {\r\n        ui.access(() ->\r\n                infoTypePnl.reload(infoTypeGrd,\r\n                        () -> sortByLabel(service.getArticleInfoType(ctx, locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadArticleClass function is called when the user clicks on the &quot;Article Class&quot; button.\r\n     * It loads a list of article classes from the database and displays them in a grid.\r\n     */\r\n    protected void loadArticleClass() {\r\n        ui.access(() ->\r\n                articleClassPnl.reload(articleClassGrd,\r\n                        () -> sortByLabel(service.getArticleClass(ctx, locale, FilterStatus.DEFAULT.getId())))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The loadStructure function is called when the user clicks on a structure in the tree.\r\n     * It loads all of the articles that are part of that structure into a grid, and displays them to the user.\r\n     *\r\n     * @param Setting structureSetting Filter the structure by a specific setting\r\n     */\r\n    protected void loadStructure(Setting structureSetting) {\r\n        ui.access(() ->\r\n                structurePnl.reload(structureGrd, () ->\r\n                        service.getArticleStructure(structureSetting, locale, FilterStatus.DEFAULT.getId()))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The sortByLabel function takes a list of Filterbase objects and sorts them by their label.\r\n     *\r\n     * @param List&lt;Filterbase&gt; list Pass in the list of filters to be sorted\r\n     * @return A list of filterbase\r\n     */\r\n    private List<Filterbase> sortByLabel(List<Filterbase> list) {\r\n        list.sort((o1, o2) -> o1.getLabel().compareTo(o2.getLabel()));\r\n        return list;\r\n    }\r\n\r\n    /**\r\n     * The defaultFilter function creates a new Filter object and sets the sortType to ObjectType.ECAT,\r\n     * which is an enum that represents the type of objects we want to display in our table. The date\r\n     * field is set to the current user's date, which will be used as a filter for displaying only those\r\n     * ECATs that were created by this user. This function returns this newly created Filter object so it can be used elsewhere in our codebase.\r\n     *\r\n     * @return A new filter object with the sorttype and date set\r\n     */\r\n    private Filter defaultFilter() {\r\n        Filter filter = new Filter();\r\n        filter.setSortType(ObjectType.ECAT);\r\n        filter.setDate(ctx.getSession().getCurrentUser(ctx));\r\n        return filter;\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\profil\\ProfilView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\crumb\\FileEditCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.promotion.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.DoubleFoundException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.DataFile;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.MultiLanguage;\r\nimport com.hom.ebmw.utilities.AstNotification;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.HomLang;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToDataFileDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.confirmdialog.ConfirmDialog;\r\nimport com.vaadin.flow.component.datepicker.DatePicker;\r\nimport com.vaadin.flow.component.formlayout.FormLayout;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.binder.Binder;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.function.SerializablePredicate;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.time.LocalDate;\r\nimport java.time.LocalDateTime;\r\nimport java.util.*;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_FILE_EDIT)\r\npublic class FileEditCrumb extends Crumb implements FileInputLoader, HasPermission {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private GridPro<ArticleBase> articleGrid;\r\n    private ListDataProvider<ArticleBase> dataProvider;\r\n    private SerializablePredicate<ArticleBase> filters = null;\r\n\r\n    private ComboBox<Territory> territoryCbx;\r\n    private ComboBox<Currency> currencyCbx;\r\n    private ComboBox<Language> languageCbx;\r\n    private Checkbox showDoubles;\r\n    private Button deleteDoubles;\r\n    private DatePicker fromDate;\r\n    private DatePicker toDate;\r\n    private Button newLine;\r\n    private Button deleteLine;\r\n    private ImageButton saveNclose;\r\n    private TextField fieldTxt;\r\n    private TextField awNrTxt;\r\n    private TextField newsPic;\r\n    private HomLang multiTxt;\r\n    private final Binder<DataFile> bDataFile = new Binder<>();\r\n\r\n    private List<DataFile> selection;\r\n    private DataFile selected;\r\n\r\n    /**\r\n     * The FileEditCrumb function is a constructor for the FileEditCrumb class.\r\n     * It initializes all of the variables and components that are used in this class,\r\n     * including: selection, selected, bDataFile (a BeanItemContainer), oFrom (an Object),\r\n     * oTo (an Object), oTitels (an Object), langs(a List of Languages) texts(a List of MultiLanguages)\r\n     * item(Language object). The function also calls several other functions to initialize more variables.\r\n     *\r\n     * @param Context ctx Get the current context\r\n     * @return A fileeditcrumb object\r\n     * @docauthor Trelent\r\n     */\r\n    public FileEditCrumb(Context ctx) {\r\n        super(ctx);\r\n\r\n        selection = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n        if (Objects.isNull(selection) || selection.isEmpty()) {\r\n            selection = new ArrayList<>();\r\n            selected = new DataFile();\r\n            selected.setDate(ctx.getSession().getCurrentUser(ctx));\r\n            selected = getCtx().getServices().getDataFileService().save(selected);\r\n            setParameter(FileParam.FILE_TYPE, ObjectType.PROMOTION_INPUT, selected);\r\n            if (Objects.isNull(selection))\r\n                selection = new ArrayList<>();\r\n            selection.add(selected);\r\n            getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selection);\r\n        } else {\r\n            selected = selection.get(0);\r\n        }\r\n        bDataFile.setBean(selected);\r\n\r\n        Object oFrom = getParameter(FileParam.VALID_FROM, selected);\r\n        Object oTo = getParameter(FileParam.VALID_TO, selected);\r\n        Object oTitels = getParameter(FileParam.TITLE_MAP, selected);\r\n\r\n        if (Objects.isNull(oFrom)) {\r\n            setParameter(FileParam.VALID_FROM, LocalDate.now(), selected);\r\n        }\r\n        if (Objects.isNull(oTo)) {\r\n            setParameter(FileParam.VALID_TO, LocalDate.now().plusDays(1), selected);\r\n        }\r\n        if (Objects.isNull(oTitels)) {\r\n            List<Language> langs = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n            List<MultiLanguage> texts = new ArrayList<>();\r\n\r\n            langs.forEach(item -> {\r\n                MultiLanguage text = new MultiLanguage();\r\n                text.setKey(item);\r\n                texts.add(text);\r\n            });\r\n\r\n            setParameter(FileParam.TITLE_MAP, texts, selected);\r\n        }\r\n\r\n        setLanguageParamByCustomer(selected);\r\n\r\n        initFromDate();\r\n        initToDate();\r\n        initLanguage();\r\n        initTerritory();\r\n        initCurrency();\r\n        initMultiLanguage();\r\n        initAwNr();\r\n        initNewsPic();\r\n\r\n        initNewBtn();\r\n        initDeleteBtn();\r\n        initSaveBtn();\r\n        initSearchFld();\r\n        initShowDouble();\r\n        initDeleteDouble();\r\n\r\n        loadLayout();\r\n        reloadCrumb();\r\n    }\r\n\r\n    /**\r\n     * The loadLayout function is responsible for loading the layout of the file editor.\r\n     * It removes all components from the file editor, initializes a new grid, and then adds\r\n     * a vertical layout to hold all other components. The vertical layout holds two horizontal layouts:\r\n     * one for buttons and one for form items (date pickers, text fields). The articleGrid is added last.\r\n     *\r\n     * @return A verticallayout object\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadLayout() {\r\n        if (getComponentCount() > 0) {\r\n            removeAll();\r\n        }\r\n        initGrid();\r\n\r\n        VerticalLayout body = new VerticalLayout();\r\n        CompUtils.removeMSP(body, \"MP\");\r\n\r\n        HorizontalLayout buttons = new HorizontalLayout();\r\n        CompUtils.removeMSP(buttons, \"MSP\");\r\n\r\n        FormLayout form = new FormLayout();\r\n\r\n        form.addFormItem(fromDate, getTranslation(TMS.FILE_EDIT_VALID_FROM, getLocale(), getCtx()));\r\n        form.addFormItem(toDate, getTranslation(TMS.FILE_EDIT_VALID_TO, getLocale(), getCtx()));\r\n        form.addFormItem(languageCbx, getTranslation(TMS.FILE_EDIT_LANGUAGE, getLocale(), getCtx()));\r\n        form.addFormItem(territoryCbx, getTranslation(TMS.FILE_EDIT_TERRITORY, getLocale(), getCtx()));\r\n        form.addFormItem(currencyCbx, getTranslation(TMS.FILE_EDIT_CURRENCY, getLocale(), getCtx()));\r\n        form.addFormItem(multiTxt, getTranslation(TMS.FILE_EDIT_MULTI_TITLE, getLocale(), getCtx()));\r\n        form.addFormItem(awNrTxt, getTranslation(TMS.FILE_EDIT_AW_NUMBER, getLocale(), getCtx()));\r\n        form.addFormItem(newsPic, getTranslation(TMS.FILE_EDIT_NEWSPIC, getLocale(), getCtx()));\r\n\r\n        buttons.add(newLine, deleteLine, saveNclose, fieldTxt, showDoubles, deleteDoubles);\r\n\r\n        body.add(form, buttons, articleGrid);\r\n        body.setSizeFull();\r\n        add(body);\r\n    }\r\n\r\n    /**\r\n     * The initSearchFld function initializes the search field.\r\n     * The function sets a placeholder for the search field, and adds a value change listener to it.\r\n     * When the value of the textfield changes, it filters out all articles that do not contain\r\n     * what is written in the textfield in their article number. It then updates both dataProvider and articleGrid with this new filter.\r\n     *\r\n     * @return A textfield\r\n     * @docauthor Trelent\r\n     */\r\n    private void initSearchFld() {\r\n        fieldTxt = new TextField();\r\n        fieldTxt.setPlaceholder(getTranslation(TMS.FILE_EDIT_SEARCH_PLACEHOLDER, getLocale(), getCtx()));\r\n        fieldTxt.addValueChangeListener(event -> {\r\n            dataProvider.addFilter(ArticleBase::getArticleNr, name -> {\r\n                String nameLower = (name == null ? \"\" : name.toLowerCase(Locale.ENGLISH));\r\n                String filterLower = fieldTxt.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n            filters = dataProvider.getFilter();\r\n            articleGrid.setDataProvider(dataProvider);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The initFromDate function initializes the fromDate DatePicker object.\r\n     * The fromDate DatePicker object is used to select a date for the VALID_FROM parameter of a DataFile.\r\n     * The initFromDate function sets up the binder and validator for this field, as well as setting it to be required.\r\n     *\r\n     * @return A datepicker\r\n     * @docauthor Trelent\r\n     */\r\n    private void initFromDate() {\r\n        fromDate = new DatePicker();\r\n        fromDate.setRequired(true);\r\n        bDataFile.forField(fromDate)\r\n                .withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.VALID_FROM, item),\r\n                        (item, date) -> setParameter(FileParam.VALID_FROM, date, item));\r\n    }\r\n\r\n    /**\r\n     * The initToDate function initializes the toDate DatePicker.\r\n     * The toDate DatePicker is used for selecting a date that represents the end of a time period.\r\n     *\r\n     * @return A datepicker\r\n     * @docauthor Trelent\r\n     */\r\n    private void initToDate() {\r\n        toDate = new DatePicker();\r\n        toDate.setRequired(true);\r\n        bDataFile.forField(toDate)\r\n                .withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.VALID_TO, item),\r\n                        (item, date) -> setParameter(FileParam.VALID_TO, date, item));\r\n    }\r\n\r\n    /**\r\n     * The initNewBtn function initializes the newLine button.\r\n     * The newLine button is a plus sign that adds an empty line to the grid when clicked.\r\n     *\r\n     * @return A button that adds a new article to the list\r\n     * @docauthor Trelent\r\n     */\r\n    private void initNewBtn() {\r\n        newLine = new Button(VaadinIcon.PLUS.create());\r\n        newLine.addClickListener(event -> {\r\n            List<ArticleBase> articles = getArticles();\r\n            ArticleBase initial = new ArticleBase();\r\n            articles.add(0, initial);\r\n            reload(articles);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The initDeleteBtn function initializes the deleteLine button.\r\n     * The deleteLine button is a VaadinIcon.CLOSE icon that deletes all selected articles from the articleGrid when clicked.\r\n     *\r\n     * @return A button object\r\n     * @docauthor Trelent\r\n     */\r\n    private void initDeleteBtn() {\r\n        deleteLine = new Button(VaadinIcon.CLOSE.create());\r\n        deleteLine.addClickListener(event -> {\r\n            List<ArticleBase> curSelected = new ArrayList<>();\r\n            curSelected.addAll(articleGrid.getSelectedItems());\r\n            if (!curSelected.isEmpty()) {\r\n                delArticles(curSelected);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The onAccept function is called when the user clicks on the &quot;Accept&quot; button.\r\n     * It creates a new SaveArticlesToDataFileDialog object, which is used to save\r\n     * articles to a data file. The dialog's open and run functions are then called,\r\n     * which opens up the dialog and runs it until it closes (i.e., until either\r\n     * cancel or accept has been clicked). \t\t\t\t&lt;br&gt; &lt;br&gt;\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Pass the list of articles to the savearticlestodatafiledialog constructor\r\n     * @return A list&lt;articlebase&gt;\r\n     * @docauthor Trelent\r\n     */\r\n    private void onAccept(List<ArticleBase> articles) {\r\n        SaveArticlesToDataFileDialog dialog = new SaveArticlesToDataFileDialog(getCtx(), articles,\r\n                ObjectType.PROMOTION_INPUT);\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initSaveBtn function initializes the saveNclose button.\r\n     *\r\n     * @return The savenclose variable\r\n     * @docauthor Trelent\r\n     */\r\n    private void initSaveBtn() throws NullPointerException {\r\n        saveNclose = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        saveNclose.addClickListener(event -> {\r\n            List<ArticleBase> articles = new ArrayList<>();\r\n\r\n            bDataFile.validate();\r\n\r\n            try {\r\n                if (Objects.nonNull(dataProvider) && Objects.nonNull(dataProvider.getItems())\r\n                        && !dataProvider.getItems().isEmpty()) {\r\n                    articles.addAll(dataProvider.getItems());\r\n                    FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_ARTICLELIST_CONTAINS_DOUBLES);\r\n                }\r\n                if (bDataFile.isValid()) {\r\n                    // FallBack da Binder nicht Greift\r\n                    setParameter(FileParam.TITLE_MAP, multiTxt.getValue(), selected);\r\n\r\n                    List<String> list = new ArrayList<>();\r\n\r\n                    if (list.isEmpty() && articles.isEmpty()) {\r\n                        String description = getTranslation(TMS.FILE_EDIT_IMPEX_NO_ARTICLE_DESCRIPTION, getLocale(),\r\n                                getCtx());\r\n                        String accept = getTranslation(TMS.GLB_BUTTON_ACCEPT, getLocale(), getCtx());\r\n                        String cancel = getTranslation(TMS.GLB_BUTTON_CANCEL, getLocale(), getCtx());\r\n                        ConfirmDialog dialog = new ConfirmDialog(\"\", description, accept,\r\n                                eventCd -> onAccept(articles));\r\n                        Button cancelBtn = new Button(cancel, eventB -> dialog.close());\r\n                        dialog.setCancelButton(cancelBtn);\r\n                        dialog.open();\r\n                    } else\r\n                        onAccept(articles);\r\n                }\r\n            } catch (DoubleFoundException e) {\r\n                showDoubles.setValue(true);\r\n                setDoubleFilter(true);\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_PRICELIST_CONTAINS_DOUBLES, getLocale(), getCtx())\r\n                        + \": \" + e.getMessage());\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The initCurrency function initializes the currencyCbx ComboBox.\r\n     * The ComboBox is set to display all currencies in the database, and it is required.\r\n     * The function also binds the currencyCbx to a parameter of type FileParam called CURRENCY.\r\n     *\r\n     * @return A combobox&lt;currency&gt; object\r\n     * @docauthor Trelent\r\n     */\r\n    private void initCurrency() {\r\n        currencyCbx = new ComboBox<>();\r\n        currencyCbx.setClearButtonVisible(true);\r\n        currencyCbx.setItems(getServices().getEnumerationService().getAllCurrencies());\r\n        currencyCbx.setItemLabelGenerator(item -> item.getKey() + \" (\" + item.getLabel() + \")\");\r\n        currencyCbx.setRequired(true);\r\n\r\n        bDataFile.forField(currencyCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.CURRENCY, item),\r\n                        (item, currency) -> setParameter(FileParam.CURRENCY, currency, item));\r\n    }\r\n\r\n    /**\r\n     * The initTerritory function initializes the territoryCbx ComboBox.\r\n     * The ComboBox is populated with all territories from the database, and it's itemLabelGenerator property is set to display both the key and label of each territory.\r\n     * The ComboBox is also set as required, meaning that a value must be selected before submitting a form containing this field.\r\n     * Finally, we bind this field to our bDataFile Binder using forField(territoryCbx).withValidator(Objects:nonNull) which ensures that a non-null value has been selected in order for validation to pass (i.\r\n     *\r\n     * @return A combobox&lt;territory&gt;\r\n     * @docauthor Trelent\r\n     */\r\n    private void initTerritory() {\r\n        territoryCbx = new ComboBox<>();\r\n        territoryCbx.setClearButtonVisible(true);\r\n        territoryCbx.setItems(getServices().getEnumerationService().getAllTerritories());\r\n        territoryCbx.setItemLabelGenerator(item -> item.getKey() + \" - \" + item.getLabel());\r\n        territoryCbx.setRequired(true);\r\n\r\n        bDataFile.forField(territoryCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.TERRITORY, item),\r\n                        (item, currency) -> setParameter(FileParam.TERRITORY, currency, item));\r\n    }\r\n\r\n    /**\r\n     * The initLanguage function initializes the languageCbx ComboBox.\r\n     * The ComboBox is set to display all languages in the database, and it is required that a language be selected.\r\n     * The function also binds the value of this ComboBox to a parameter called LANGUAGE in FileParam, which will be used later on when creating an instance of TMSFile.\r\n     *\r\n     * @return The combobox&lt;language&gt; languagecbx\r\n     * @docauthor Trelent\r\n     */\r\n    private void initLanguage() {\r\n        languageCbx = new ComboBox<>();\r\n        languageCbx.setClearButtonVisible(true);\r\n        languageCbx.setItems(getServices().getEnumerationService().getAllLanguages());\r\n        languageCbx.setItemLabelGenerator(item -> item.getLabel().split(\"-\")[0] + \" - \"\r\n                + Locale.forLanguageTag(item.getLabel()).getDisplayLanguage(getLocale()));\r\n        languageCbx.setRequired(true);\r\n\r\n        bDataFile.forField(languageCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.LANGUAGE, item), this::setSettingLanguage);\r\n    }\r\n\r\n    /**\r\n     * The reloadGridLayout function is used to remove all columns from the articleGrid and then add them back in.\r\n     * This function is called when the user changes their language preference, so that the column headers can be updated\r\n     * with translations of their names.\r\n     *\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    private void reloadGridLayout() {\r\n        articleGrid.removeAllColumns();\r\n\r\n        articleGrid.addEditColumn(ArticleBase::getArticleNr).text((item, newValue) -> item.setArticleNr(newValue))\r\n                .setHeader(getTranslation(TMS.FILE_EDIT_ARTICLE_NR, getLocale(), getCtx())).setSortable(true);\r\n        articleGrid.addEditColumn(ArticleBase::getPriceFirstWithThousend).text(ArticleBase::setPriceFirst)\r\n                .setHeader(getTranslation(TMS.FILE_EDIT_PRICE_FIRST, getLocale(), getCtx()))\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                .setSortable(true);\r\n        articleGrid.addEditColumn(ArticleBase::getPriceXWithThousend).text(ArticleBase::setPriceX)\r\n                .setHeader(getTranslation(TMS.FILE_EDIT_PRICE_SCALE, getLocale(), getCtx()))\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX())).setSortable(true);\r\n        articleGrid.addEditColumn(ArticleBase::getScalelimit).text(ArticleBase::setScalelimit)\r\n                .setHeader(getTranslation(TMS.FILE_EDIT_SCALE_LIMIT, getLocale(), getCtx())).setSortable(true);\r\n\r\n    }\r\n\r\n    /**\r\n     * The initMultiLanguage function initializes the multiTxt variable, which is a HomLang object.\r\n     * The bDataFile.forField(multiTxt).asRequired().bind function binds the multiTxt variable to\r\n     * the FileParam.TITLE_MAP parameter of an item in a file list (the &quot;item&quot; argument). This means that\r\n     * when you change something in one of these fields, it will automatically update all other fields with\r\n     * this same parameter value for their respective items as well. For example, if you change one title field's text from &quot;Title 1&quot; to &quot;Title 2&quot;,\r\n     *\r\n     * @return A homlang object\r\n     * @docauthor Trelent\r\n     */\r\n    private void initMultiLanguage() {\r\n        multiTxt = new HomLang();\r\n\r\n        bDataFile.forField(multiTxt).asRequired().bind(item ->\r\n                        getParameter(FileParam.TITLE_MAP, item)\r\n                , (item, value) ->\r\n                        setParameter(FileParam.TITLE_MAP, value, item)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The initAwNr function initializes the awNrTxt TextField.\r\n     * The awNrTxt TextField is bound to the AW_NUMBER FileParam, which is a String.\r\n     * The binding ensures that any changes made to the value of awNrTxt are reflected in its corresponding FileParam and vice versa.\r\n     *\r\n     * @return The awnrtxt textfield\r\n     * @docauthor Trelent\r\n     */\r\n    private void initAwNr() {\r\n        awNrTxt = new TextField();\r\n        bDataFile.forField(awNrTxt)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.AW_NUMBER, item),\r\n                        (item, value) -> setParameter(FileParam.AW_NUMBER, value, item));\r\n    }\r\n\r\n    /**\r\n     * The initNewsPic function initializes the newsPic TextField.\r\n     * The newsPic TextField is used to store the path of a picture file that will be displayed on the News page.\r\n     *\r\n     * @return A textfield\r\n     * @docauthor Trelent\r\n     */\r\n    private void initNewsPic() {\r\n        newsPic = new TextField();\r\n        bDataFile.forField(newsPic)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.NEWSPIC, item),\r\n                        (item, value) -> setParameter(FileParam.NEWSPIC, value, item));\r\n\r\n    }\r\n\r\n    /**\r\n     * The initGrid function initializes the articleGrid object.\r\n     * It sets the selection mode to MULTI, and calls reloadGridLayout().\r\n     *\r\n     * @return A gridpro&lt;article&gt;\r\n     * @docauthor Trelent\r\n     */\r\n    private void initGrid() {\r\n        articleGrid = new GridPro<>();\r\n        reloadGridLayout();\r\n        articleGrid.setSelectionMode(SelectionMode.MULTI);\r\n    }\r\n\r\n    /**\r\n     * The initShowDouble function initializes the showDoubles checkbox.\r\n     * The showDoubles checkbox is used to filter out duplicate entries in the file list.\r\n     * When checked, only one entry for each file will be shown in the list.\r\n     *\r\n     * @return A checkbox\r\n     * @docauthor Trelent\r\n     */\r\n    private void initShowDouble() {\r\n        showDoubles = new Checkbox(getTranslation(TMS.FILE_EDIT_SHOW_DOUBLES, getLocale(), getCtx()));\r\n        showDoubles.addClickListener(event -> setDoubleFilter(event.getSource().getValue()));\r\n    }\r\n\r\n    /**\r\n     * The initDeleteDouble function is used to create a button that will delete all the doubles in the grid.\r\n     * The function creates a new HashMap, which is then filled with all of the articles from getArticles().\r\n     * Then, it sets dataProvider to be equal to DataProvider.ofCollection(articleClean.values()). This means that\r\n     * dataProvider now contains only unique values (no doubles). Finally, articleGrid's dataprovider is set\r\n     * equal to this new value for dataProvider. This means that when you click on deleteDoubles, any double values are deleted from articleGrid and replaced by unique\r\n     *\r\n     * @return A button\r\n     * @docauthor Trelent\r\n     */\r\n    private void initDeleteDouble() {\r\n        deleteDoubles = new Button(getTranslation(TMS.FILE_EDIT_DELETE_DOUBLES, getLocale(), getCtx()));\r\n        deleteDoubles.addClickListener(event -> {\r\n            Map<String, ArticleBase> articleClean = new HashMap<>();\r\n            getArticles().forEach(item -> articleClean.put(item.getArticleNr(), item));\r\n            dataProvider = DataProvider.ofCollection(articleClean.values());\r\n            articleGrid.setDataProvider(dataProvider);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setDoubleFilter function is used to filter the articles in the articleGrid.\r\n     * If valid is true, then it will check if there are any doubles in the dataProvider and add a filter for them.\r\n     * If valid is false, then it will clear all filters from the dataProvider.\r\n     *\r\n     * @param boolean valid Check if the article list contains doubles\r\n     * @return The dataprovider\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDoubleFilter(boolean valid) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        articles.addAll(dataProvider.getItems());\r\n        if (valid) {\r\n            try {\r\n                FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_ARTICLELIST_CONTAINS_DOUBLES);\r\n            } catch (DoubleFoundException e) {\r\n                dataProvider.addFilter(ArticleBase::getArticleNr, e.getArticleNrs()::contains\r\n                );\r\n            }\r\n        } else {\r\n            dataProvider.clearFilters();\r\n        }\r\n        articleGrid.setDataProvider(dataProvider);\r\n    }\r\n\r\n    /**\r\n     * The delArticles function is used to remove articles from the grid.\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Pass the list of articles to be deleted\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    private void delArticles(List<ArticleBase> articles) {\r\n        List<ArticleBase> buffer = new ArrayList<>();\r\n        buffer.addAll(dataProvider.getItems());\r\n        buffer.removeAll(articles);\r\n\r\n        dataProvider = DataProvider.ofCollection(buffer);\r\n        articleGrid.setDataProvider(dataProvider);\r\n        if (Objects.nonNull(filters))\r\n            dataProvider.addFilter(filters);\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to update the grid with new data.\r\n     * It takes a list of articles as an argument and sets the data provider for the grid to be that list.\r\n     * If there are filters applied, it adds those filters back in after setting up the new data provider.\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Set the dataprovider\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    private void reload(List<ArticleBase> articles) {\r\n        if (Objects.nonNull(getArticles()) && Objects.nonNull(articles)) {\r\n            dataProvider = DataProvider.ofCollection(articles);\r\n            articleGrid.setDataProvider(dataProvider);\r\n        }\r\n\r\n        if (Objects.nonNull(filters))\r\n            dataProvider.addFilter(filters);\r\n    }\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the CrumbProgressDialog is executed.\r\n     * This function can be used to perform any actions that need to be done before moving on, such as\r\n     * updating a progress bar or checking for errors.  The doBeforeNext function should return true if it\r\n     * wants the CrumbProgressDialog to continue executing steps, and false if it does not want execution of\r\n     * steps to continue (for example, because an error occurred).   If this method returns false then no more\r\n     * steps will be executed after this one until resume() is called on the dialog.   Note that\r\n     *\r\n     * @param CrumbProgressDialog dialog Update the progress bar\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        log.debug(\"doBeforeNext not in use\");\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the &quot;Exit&quot; button.\r\n     * It deletes any empty files that were created by the user, and then closes\r\n     * all open windows.\r\n     *\r\n     * @return A value of type string\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        List<DataFile> files = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n        if (Objects.nonNull(files) && files.get(0).getName().isEmpty()) {\r\n            files.get(0).setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n            files.get(0).setDeleteOn(LocalDateTime.now());\r\n            getCtx().getServices().getDataFileService().save(files.get(0));\r\n        }\r\n\r\n        CloseDialog dialog = new CloseDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reload the buttons on the bottom of the screen.\r\n     * This function is called when a new page is loaded, and it sets all of the buttons to their default state.\r\n     *\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called by the ArticleCrumb class when a user clicks on an article in the crumb.\r\n     * The function reloads the current page with new data from that article.\r\n     *\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() ->\r\n                reload(getCtx().getUserSession().get(Params.ACTIVE_ARTICLES))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The getArticles function returns a list of articles.\r\n     *\r\n     * @return A list of articlebase objects\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public List<ArticleBase> getArticles() {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        if (Objects.nonNull(dataProvider))\r\n            articles.addAll(dataProvider.getItems());\r\n        else\r\n            dataProvider = DataProvider.ofCollection(articles);\r\n        return articles;\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the checkboxes for the user to select which columns they want\r\n     * in their import file. The first parameter of each dialog.addValueCbx function call is a string that\r\n     * represents a column name, and the second parameter determines whether or not that column will be selected by default.\r\n     *\r\n     * @param FileImportDialog dialog Add the checkboxes to the dialog\r\n     * @return The number of columns that are used in the file\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in\r\n     * the FileImportDialog. It takes all of the rows from that dialog's table and\r\n     * adds them to a list of articles, which it then reloads into this view.\r\n     *\r\n     * @param FileImportDialog dialog Access the data in the table\r\n     * @return A list of articles\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = getArticles();\r\n        dialog.getTable().forEach(row -> {\r\n            ArticleBase item = setPrice(row, dialog);\r\n            articles.add(item);\r\n        });\r\n\r\n        reload(articles);\r\n        getCtx().getUserSession().remove(Params.ACTIVE_ARTICLES);\r\n    }\r\n\r\n    /**\r\n     * The setPrice function takes the data from the file and puts it into a new ArticleBase object.\r\n     * The function then returns this object to be used in other functions.\r\n     *\r\n     * @param Map&lt;Integer   Map the column index to a string value\r\n     * @param String&gt;       colString Get the values from the csv file\r\n     * @param FileImportDialog dialog Get the column indexes of the columns that are selected in the dialog\r\n     * @return The articlebase object\r\n     * @docauthor Trelent\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n\r\n        if (dialog.getColumns()[0] > -1) {\r\n            price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n        }\r\n        if (dialog.getColumns()[1] > -1) {\r\n            price.setPriceFirst(dialog.getColumnsByIdx(colString, 1));\r\n        }\r\n        if (dialog.getColumns()[2] > -1) {\r\n            price.setPriceX(dialog.getColumnsByIdx(colString, 2));\r\n        }\r\n        if (dialog.getColumns()[3] > -1) {\r\n            price.setPriceType(dialog.getColumnsByIdx(colString, 3));\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in\r\n     * the FileImportDialog. It takes a list of articles and adds them to this ArticleList's\r\n     * current list of articles, then reloads this ArticleList with all of its new articles.\r\n     *\r\n     * @param FileImportDialog        dialog Get the file path\r\n     * @param List&lt;ArticleBase&gt; articles Get the articles that were imported\r\n     * @return A list of articles\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        List<ArticleBase> cArticles = getArticles();\r\n        cArticles.addAll(articles);\r\n        reload(cArticles);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\crumb\\FileEditCrumb.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-rEPue9tRNnWhrUKsWw50M1vkJe4FIgwc",
    "created" : 1762171979,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "[\n  {\n    \"file\": \"C:\\\\Users\\\\mtheele\\\\IdeaProjects\\\\TIP - Assortmenttool_2\\\\src\\\\main\\\\java\\\\com\\\\hom\\\\ebmw\\\\view\\\\sortment\\\\profil\\\\ProfilView.java\",\n    \"issues\": [\n      {\n        \"severity\": \"High\",\n        \"problem\": \"Potential NullPointerException when accessing UI instance\",\n        \"justification\": \"ui is stored at construction and may be null if UI.getCurrent() returns null; subsequent ui.access() calls will throw NPE, causing runtime failures.\",\n        \"action\": \"Replace stored ui field with UI.getCurrent() inside each method or ensure ui is always nonnull before using; add unit test that simulates missing UI and expects graceful handling.\",\n        \"source\": \"Constructor and any ui.access(...) calls, e.g., clearSelection(), reloadPanelFilter()\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"prod-relevant, crashes UI\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"High\",\n        \"problem\": \"Class violates Single Responsibility Principle (over 800 lines, >30 fields)\",\n        \"justification\": \"Mixes UI layout, data loading, business logic and permission checks, making maintenance and testing difficult and increasing risk of bugs.\",\n        \"action\": \"Refactor into separate components: (1) UI builder, (2) service layer for data loading, (3) permission helper; add integration tests for each component.\",\n        \"source\": \"Entire ProfilView class\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"maintainability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Med\",\n        \"problem\": \"Unchecked cast to ListDataProvider in setLeftSection()\",\n        \"justification\": \"Suppressing unchecked warning hides a potential ClassCastException if filterGrid's data provider is not a ListDataProvider.\",\n        \"action\": \"Replace cast with proper generic handling; if needed, use DataProvider.fromCallbacks; add test verifying provider type.\",\n        \"source\": \"setLeftSection(), line with ListDataProvider<Filter> listProvider = (ListDataProvider<Filter>) filterGrid.getDataProvider();\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"runtime stability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Med\",\n        \"problem\": \"clearSelection() may contain null grids\",\n        \"justification\": \"Grids are added to the list before they are guaranteed to be initialized; a null entry causes NPE during ui.access().\",\n        \"action\": \"Add nullcheck before adding each grid or filter the list after creation; unit test with partially initialized grids.\",\n        \"source\": \"clearSelection() method\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"prod-relevant\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Med\",\n        \"problem\": \"PriorityBox readOnly toggling is inconsistent\",\n        \"justification\": \"priorityBox is setReadOnly(true) initially and later switched based on role; admin may see a readonly box before role check, causing UI flicker.\",\n        \"action\": \"Determine readOnly state after role is known; move setReadOnly logic into reload() after role evaluation; add UI test for role change.\",\n        \"source\": \"setPrioritybox() and reload()\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"usability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Hardcoded string literals for permission checks\",\n        \"justification\": \"Using getPermission(...).isRead() with concatenated class name strings is errorprone and hard to refactor.\",\n        \"action\": \"Introduce a Permission enum or constants; replace string concatenation with typed references; add unit test for permission mapping.\",\n        \"source\": \"reload() method\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"maintainability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Potential memory leak: many UI components kept as fields without detach\",\n        \"justification\": \"Longlived view objects may retain references to UI components after navigation, preventing GC.\",\n        \"action\": \"Implement @PreDestroy cleanup to remove listeners and nullify large fields; add test ensuring detach on navigation.\",\n        \"source\": \"All component fields (e.g., filterGrid, rightGrid, accordion)\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"performance\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Insufficient input validation on TextField values before persisting Filter\",\n        \"justification\": \"Userprovided strings are stored directly; could lead to XSS or malformed data in DB.\",\n        \"action\": \"Add sanitisation/validation for all Binder fields (e.g., nameTxt) using Vaadin Validators; unit test with malicious input.\",\n        \"source\": \"setMiddleSection() Binder configuration\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"security\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Default filter does not initialise all required fields\",\n        \"justification\": \"defaultFilter() only sets sortType and date; other required fields may stay null, causing NPE later.\",\n        \"action\": \"Populate all mandatory properties (e.g., name, prefix) with sensible defaults; add test for binder validation of default filter.\",\n        \"source\": \"defaultFilter() method\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"robustness\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Repeated use of magic strings for CSS IDs and panel titles\",\n        \"justification\": \"Hardcoded IDs (e.g., \\\"assigned-material\\\") make refactoring errorprone.\",\n        \"action\": \"Extract IDs and titles into constants; replace literals; add compilation test for constant usage.\",\n        \"source\": \"Various get*Panel() methods\",\n        \"component\": \"view-profil\",\n        \"impact_scope\": \"maintainability\",\n        \"relations\": null,\n        \"evidence\": null\n      }\n    ],\n    \"summary\": {\n      \"overall_rating\": \"2\",\n      \"top_todos\": [\n        \"Replace stored UI reference with safe UI.getCurrent() calls and add NPE handling tests\",\n        \"Refactor ProfilView into separate UI, service, and permission components\",\n        \"Add proper null checks for grids in clearSelection() and ensure safe casting of data providers\"\n      ]\n    }\n  },\n  {\n    \"file\": \"C:\\\\Users\\\\mtheele\\\\IdeaProjects\\\\TIP - Assortmenttool_2\\\\src\\\\main\\\\java\\\\com\\\\hom\\\\ebmw\\\\view\\\\sortment\\\\promotion\\\\crumb\\\\FileEditCrumb.java\",\n    \"issues\": [\n      {\n        \"severity\": \"High\",\n        \"problem\": \"Binding lambda for territoryCbx uses wrong parameter name (currency) leading to wrong parameter being set\",\n        \"justification\": \"bDataFile.forField(territoryCbx).bind(..., (item, currency) -> setParameter(FileParam.TERRITORY, currency, item)) stores a Currency object instead of Territory, causing type mismatch and runtime errors.\",\n        \"action\": \"Correct lambda to use (item, territory) and set correct parameter; add unit test verifying saved territory value.\",\n        \"source\": \"initTerritory() method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"prod-relevant\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"High\",\n        \"problem\": \"initSaveBtn declares throws NullPointerException unnecessarily and catches generic exceptions\",\n        \"justification\": \"Method signature misleads callers; NullPointerException should be prevented, not thrown; catching generic Exception hides bugs.\",\n        \"action\": \"Remove throws declaration, add explicit null checks before using objects, catch only expected exceptions (e.g., DoubleFoundException); add tests for NPE scenarios.\",\n        \"source\": \"initSaveBtn() method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"robustness\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Med\",\n        \"problem\": \"initSearchFld may use dataProvider before it is initialised\",\n        \"justification\": \"fieldTxt listener adds filter on dataProvider, but dataProvider is only set after first reload; first use can cause NPE.\",\n        \"action\": \"Initialise dataProvider with an empty collection in constructor or guard against null in listener; add test for search before data load.\",\n        \"source\": \"initSearchFld() method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"prod-relevant\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Med\",\n        \"problem\": \"setDoubleFilter assumes dataProvider is nonnull\",\n        \"justification\": \"If setDoubleFilter is called before any reload, dataProvider may be null, causing NPE.\",\n        \"action\": \"Add nullcheck and initialise with empty provider if needed; unit test doublefilter activation without prior data load.\",\n        \"source\": \"setDoubleFilter(boolean) method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"prod-relevant\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Med\",\n        \"problem\": \"Potential ArrayIndexOutOfBounds in setPrice() when dialog columns array shorter than expected\",\n        \"justification\": \"Method accesses dialog.getColumns()[3] without verifying length; custom import dialogs may have fewer columns, leading to runtime exception.\",\n        \"action\": \"Check array length before accessing each index; add defensive fallback; test with import dialogs of varying column counts.\",\n        \"source\": \"setPrice() method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"prod-relevant\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"initLanguage binds using this::setSettingLanguage which is not shown; possible missing implementation\",\n        \"justification\": \"If setSettingLanguage is absent or misimplemented, language binding will fail silently.\",\n        \"action\": \"Ensure setSettingLanguage method exists and correctly updates language parameter; add unit test for language selection persistence.\",\n        \"source\": \"initLanguage() method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"maintainability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"deleteDoubles button replaces dataProvider but does not preserve existing filters\",\n        \"justification\": \"After deduplication, any active filters are lost, confusing user.\",\n        \"action\": \"Reapply previous filters after resetting dataProvider; add UI test verifying filter persistence after deleteDoubles.\",\n        \"source\": \"initDeleteDouble() method\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"usability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Direct use of getServices() inside initCurrency/Territory may expose internal services to UI layer\",\n        \"justification\": \"Tight coupling makes testing harder and may expose more than needed.\",\n        \"action\": \"Introduce a dedicated service faade for enumeration lookup; inject into crumb; add mockbased tests.\",\n        \"source\": \"initCurrency(), initTerritory()\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"maintainability\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"No validation for file import data beyond duplicate check\",\n        \"justification\": \"Missing checks for numeric formats, required fields may lead to corrupted data saved to DB.\",\n        \"action\": \"Add Vaadin Validators for price fields (numeric, positive) and mandatory columns; unit tests with malformed CSV rows.\",\n        \"source\": \"doOnSave() / setPrice()\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"data integrity\",\n        \"relations\": null,\n        \"evidence\": null\n      },\n      {\n        \"severity\": \"Low\",\n        \"problem\": \"Hardcoded string literals for UI captions and messages\",\n        \"justification\": \"Reduces localisation flexibility and increases maintenance effort.\",\n        \"action\": \"Move all UI strings to translation keys (already used partially) and replace literals; add test ensuring translation fallback works.\",\n        \"source\": \"Various UI component constructors\",\n        \"component\": \"promotion-fileedit\",\n        \"impact_scope\": \"maintainability\",\n        \"relations\": null,\n        \"evidence\": null\n      }\n    ],\n    \"summary\": {\n      \"overall_rating\": \"3\",\n      \"top_todos\": [\n        \"Fix binding lambda in initTerritory() to store correct Territory object\",\n        \"Guard against null dataProvider in search and doublefilter functions\",\n        \"Add arraylength checks in setPrice() to prevent IndexOutOfBounds\"\n      ]\n    }\n  }\n]",
        "role" : "assistant",
        "reasoning_content" : "We need to produce JSON review for each file? The prompt says \"analyze jeweils einen Code-Chunk\". The user gave two files. Probably need separate JSON objects? But schema expects single object with file path. Could we combine? Probably need separate entries? The instruction: \"Deine Antwort MUSS exakt dieses JSON-Objekt\". So likely one object per file. But they gave two files. Might need to output two separate JSON objects in an array? Not specified. Probably output one JSON per file. Might combine both with separate file fields? But schema only has one file field. I think we should output two separate JSON objects concatenated? That would violate JSON format (multiple top-level). Might need to output an array of objects. But schema not mention array. However they said \"gibt maximal 10 Issues pro Datei/Chunk\". So each chunk gets its own object. I think output array.\n\nWe'll produce array with two objects.\n\nNow identify issues.\n\nFile ProfilView.java: many concerns.\n\nIssues:\n\n1 High: UI.access used from non-UI thread? In Vaadin, UI.access should be called from UI thread; but they store UI reference at construction; could be null. Potential NPE when ui is null later. Action: Use UI.getCurrent() inside methods or check null.\n\n2 High: Large class violates Single Responsibility, too many fields, UI logic mixed with data loading; refactor.\n\n3 Med: filterGrid uses ListDataProvider cast without type safety, unchecked warning suppressed.\n\n4 Med: In setPrioritybox, priorityBox.setReadOnly(true) then later setReadOnly(false based on role; but initial setReadOnly(true) may hide items for admin before role check; minor.\n\n5 Med: In clearSelection, grids list may contain null if any grid not initialized before; NPE risk. Ensure null checks.\n\n6 Low: In defaultFilter sets sortType but not other required fields; maybe missing default values.\n\n7 Low: Using raw String literals for permissions: getPermission... etc, could be centralized.\n\n8 Low: In reload(), filters removal uses removeIf on list while iterating, okay.\n\n9 Med: Potential memory leak: many UI components held as fields, not detached.\n\n10 High: No CSRF or XSS validation for user inputs (e.g., TextField values) when saved to DB; need validation.\n\nNow FileEditCrumb.java:\n\n1 High: initSaveBtn declares throws NullPointerException but never thrown; catch NPE not needed; also potential NPE if saveNclose null.\n\n2 High: In initCurrency/Territory bind lambda uses (item, currency) but binds territory param incorrectly: setParameter(FileParam.TERRITORY, currency, item) variable name mismatch; potential bug.\n\n3 Med: In initLanguage bind uses this::setSettingLanguage but method not shown; may cause compile error.\n\n4 Med: In initSearchFld, dataProvider may be null initially leading to NPE when adding filter; ensure init.\n\n5 Med: In setDoubleFilter, dataProvider may be null leading NPE.\n\n6 High: In initDeleteDouble, uses getArticles() which may be empty; dataProvider may become null after operation.\n\n7 Med: In reload(), if getArticles() null, fine.\n\n8 High: In setPrice, assumes dialog.getColumns()[3] exists but columns length may be less; potential ArrayIndexOutOfBounds.\n\n9 Low: Use of raw Map<Integer, String> without generics for column mapping; but okay.\n\n10 Med: No validation for file upload; potential injection.\n\nNow produce summary rating and top todos.\n\nProvide JSON array."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 3662,
      "prompt_tokens" : 19799,
      "total_tokens" : 23461
    },
    "timings" : {
      "cache_n" : 62,
      "prompt_n" : 19737,
      "prompt_ms" : 14677.099,
      "prompt_per_token_ms" : 0.7436337335967979,
      "prompt_per_second" : 1344.7480322916674,
      "predicted_n" : 3662,
      "predicted_ms" : 43321.37,
      "predicted_per_token_ms" : 11.829975423265976,
      "predicted_per_second" : 84.53102937418645
    }
  }
}