{
  "timestamp" : "2025-11-03T13:10:02.126979",
  "index" : 21,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\crumb\\LoaderCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.eshop.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.AssortmentLockException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.dao.AssortmentDataFileDAO;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.Header;\r\nimport com.hom.ebmw.pojo.KatalogVersion;\r\nimport com.hom.ebmw.utilities.*;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.CustomDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToADDCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToFileEditCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToPreviewCrumpDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.Getter;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.time.LocalDateTime;\r\nimport java.util.*;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_IMPEX_LOADER)\r\n@SuppressWarnings(\"serial\")\r\npublic class LoaderCrumb extends Crumb implements FileInputLoader, HasPermission {\r\n\r\n    private final @Getter Grid<DataFile> dataFileGrid = new Grid<>();\r\n    private final @Getter Grid<Assortment> assortmentGrid = new Grid<>();\r\n    private final HorizontalLayout body = new HorizontalLayout();\r\n    private DownloadButton downloadBtn;\r\n    private ComboBox<Header> header;\r\n\r\n    /**\r\n     * The LoaderCrumb function is a constructor for the LoaderCrumb class.\r\n     * It sets up the datafile grid and assortment grid, then adds them to the body of this crumb.\r\n     *\r\n     * @param Context ctx Create the loadercrumb object\r\n     * @return The body of the loadercrumb\r\n     * @docauthor Trelent\r\n     */\r\n    public LoaderCrumb(Context ctx) {\r\n        super(ctx);\r\n        setDatafileGrid();\r\n        setAssortmentGrid();\r\n        setSizeFull();\r\n\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n        add(body);\r\n        CompUtils.removeMSP(body, \"MSP\");\r\n        body.setSizeFull();\r\n    }\r\n\r\n    /**\r\n     * The reloadDatafileGrid function is called when the user clicks on the &quot;Refresh&quot; button in the Data File Grid.\r\n     * It reloads all of the data files that are associated with a particular project role, and then displays them in\r\n     * a grid. The function also removes any data files that have been deleted or are not Impex Input Files (i.e., they\r\n     * are not .csv files). Finally, it sorts these remaining data files by their creation date (most recent first).\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadDatafileGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<DataFile> dataFiles = getServices().getDataFileService().findAllByProjectRole(projectRole);\r\n            dataFiles.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            dataFiles.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = !value.equals(ObjectType.IMPEX_INPUT);\r\n                }\r\n                return result;\r\n            });\r\n\r\n            dataFiles.sort((o1, o2) -> o2.getCreateOn().compareTo(o1.getCreateOn()));\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(dataFiles));\r\n        } else {\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The reloadAssortmentGrid function is called when the user clicks on the &quot;Refresh&quot; button.\r\n     * It reloads all of the data in the assortmentGrid, which displays a list of all assortments\r\n     * that have been created by this user for this project role.  The function first gets a reference to\r\n     * an instance of ProjectRole from session parameters (the active project role).  If there is no active project role, then it sets an empty data provider for assortmentGrid and returns.   Otherwise, it calls getServices().getAssortmentService().findAllByProjectRole(projectRole) to get a list of Assortment\r\n     *\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadAssortmentGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<Assortment> assortments = getServices().getAssortmentService().findAllByProjectRole(projectRole);\r\n            assortments.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            assortments.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = !value.equals(ObjectType.IMPEX);\r\n                }\r\n                return result;\r\n            });\r\n            assortments.sort((o1, o2) -> o2.getUpdateOn().compareTo(o1.getUpdateOn()));\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(assortments));\r\n        } else {\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setDatafileGrid function sets up the grid that displays the data files.\r\n     * It adds three columns to the grid: one for file name, one for update by, and\r\n     * one for update on. The function also adds a selection listener to this grid so that when an item is selected in it,\r\n     * its corresponding DataFile object is stored in a session variable called ACTIVE_DATAFILE. This allows us to access this object later on from other functions.\r\n     *\r\n     * @return The datafilegrid object\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDatafileGrid() {\r\n        dataFileGrid.setSelectionMode(SelectionMode.MULTI);\r\n        dataFileGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(4);\r\n        dataFileGrid.addColumn(this::getName)\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_BY, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n        dataFileGrid.addColumn(file -> Parse.formatDateTime(file.getUpdateOn(), AstDateTimeFormat.GERMAN))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_ON, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n\r\n        reloadDatafileGrid();\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_BASE_FILE), setLeftButtons(), dataFileGrid));\r\n\r\n        dataFileGrid.addSelectionListener(event -> {\r\n            List<DataFile> selected = new ArrayList<>();\r\n            selected.addAll(event.getAllSelectedItems());\r\n            if (selected.isEmpty()) {\r\n                getCtx().getUserSession().remove(Params.ACTIVE_DATAFILE);\r\n            } else {\r\n                getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selected);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The getName function takes an object as a parameter and returns the name of the user who last updated that object.\r\n     * If no user is found, it returns &quot;UNKNOWN&quot;.\r\n     *\r\n     * @param Object obj Determine the type of object that is passed in\r\n     * @return A string containing the surname and given name of the user\r\n     * @docauthor Trelent\r\n     */\r\n    private String getName(Object obj) {\r\n        User user = null;\r\n        if (obj instanceof DataFile) {\r\n            user = ((DataFile) obj).getUpdateBy();\r\n        } else if (obj instanceof Assortment) {\r\n            user = ((Assortment) obj).getUpdateBy();\r\n        }\r\n        if (Objects.nonNull(user)) {\r\n            return user.getSurName() + \", \" + user.getGivenName();\r\n        } else {\r\n            return \"UNKNOWN\";\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The openAssortment function is used to open an assortment.\r\n     *\r\n     * @param Callable&lt;Assortment&gt; selected Create a new assortment\r\n     * @param boolean                    openOnly Determine if the assortment should be opened in read only mode or not\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private void openAssortment(Callable<Assortment> selected, boolean openOnly) {\r\n        CustomDialog cDialog = new CustomDialog(getCtx());\r\n        cDialog.setCom(() -> {\r\n            cDialog.setLabel(TMS.SET_DIALOG_CREATE_ASSORTMENT);\r\n            Assortment assortment;\r\n            try {\r\n                assortment = selected.call();\r\n\r\n                AssortmentUtil.isLocked(getCtx(), assortment);\r\n\r\n                if (Objects.nonNull(assortment)) {\r\n                    setSessionAssortment(assortment);\r\n                    loadAssortmentsBreadCrumb();\r\n                    ToADDCrumbDialog dialog = new ToADDCrumbDialog(getCtx(), openOnly);\r\n                    dialog.open();\r\n                    dialog.execute();\r\n                } else {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_NOT_READY, getLocale(), getCtx()));\r\n                }\r\n            } catch (AssortmentLockException e) {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_IS_LOCKED, getLocale(), getCtx()));\r\n            } catch (Exception e) {\r\n                log.debug(e.getMessage(), e);\r\n            }\r\n        });\r\n        cDialog.open();\r\n        cDialog.run();\r\n    }\r\n\r\n    /**\r\n     * The setAssortmentGrid function is responsible for setting up the assortment grid.\r\n     * It sets the selection mode of the grid to either single or multi depending on whether\r\n     * or not a user has permission to select multiple items in the grid. The function then adds\r\n     * columns to display information about each item in the assortment, and finally it reloads\r\n     * all of this information into a new instance of an AssortmentGrid object. Finally, it adds\r\n     * listeners that allow users to download files from their selected assortments and open them up in a new window.\r\n     *\r\n     * @return A verticallayout object\r\n     * @docauthor Trelent\r\n     */\r\n    private void setAssortmentGrid() {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        if (getPermission(user, getServices(), this.getClass().getCanonicalName() + \".Assortment.MultiSelector\")\r\n                .isRead())\r\n            assortmentGrid.setSelectionMode(SelectionMode.MULTI);\r\n        else\r\n            assortmentGrid.setSelectionMode(SelectionMode.SINGLE);\r\n\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setFlexGrow(4)\r\n                .setResizable(true).setFlexGrow(7);\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.isLocked(getCtx(), item))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_IS_LOCKED, getLocale(), getCtx())).setFlexGrow(1)\r\n                .setResizable(true).setWidth(\"10%\");\r\n        reloadAssortmentGrid();\r\n\r\n        assortmentGrid.addSelectionListener(event -> {\r\n            downloadBtn.setEnabled(false);\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, null);\r\n                cDialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                List<Assortment> selected = new ArrayList<>();\r\n                selected.addAll(event.getAllSelectedItems());\r\n\r\n                if (!selected.isEmpty()) {\r\n                    if (!selected.get(0).getName().isEmpty()) {\r\n                        downloadBtn.setEnabled(true);\r\n                    }\r\n                    Optional<Assortment> optAssortment = getServices().getAssortmentService()\r\n                            .findById(selected.get(0).getId());\r\n                    optAssortment.ifPresent(assortment -> {\r\n                        downloader(assortment);\r\n                        getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, assortment);\r\n                        reloadInfoBox(cDialog.getDialogUI());\r\n                    });\r\n                } else {\r\n                    reloadInfoBox(cDialog.getDialogUI());\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        assortmentGrid.addItemDoubleClickListener(event -> openAssortment(event::getItem, false));\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_ASSORTMENT_FILE), setRightButtons(), assortmentGrid));\r\n    }\r\n\r\n    /**\r\n     * The setLeftButtons function creates a HorizontalLayout containing three buttons:\r\n     * - newVersion, which allows the user to create a new version of an existing file.\r\n     * - changeVersion, which allows the user to edit an existing file.\r\n     * - deleteVersion, which allows the user to delete one or more files from their project.\r\n     *\r\n     * @return A horizontallayout with the buttons that are displayed on the left side of the screen\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setLeftButtons() {\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_FILE_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole)) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), null);\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button changeVersion = new Button(VaadinIcon.PENCIL.create());\r\n        CompUtils.addToolTip(getCtx(), changeVersion, TMS.LOADER_FILE_GRID_BUTTON_EDIT_TOOLTIP);\r\n        changeVersion.addClickListener(event -> {\r\n            List<DataFile> files = new ArrayList<>();\r\n            files.addAll(dataFileGrid.getSelectedItems());\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole) && !files.isEmpty()) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), files.get(0));\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_FILE_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!dataFileGrid.getSelectedItems().isEmpty()) {\r\n                List<DataFile> files = new ArrayList<>();\r\n                dataFileGrid.getSelectedItems().forEach(file -> {\r\n                    Optional<DataFile> optFile = getServices().getDataFileService().findById(file.getId());\r\n                    optFile.ifPresent(dataFile -> {\r\n                        dataFile.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                        dataFile.setDeleteOn(LocalDateTime.now());\r\n                        files.add(dataFile);\r\n                    });\r\n                });\r\n                getServices().getDataFileService().saveAll(files);\r\n                reloadDatafileGrid();\r\n            }\r\n        });\r\n\r\n        return buttons(newVersion, changeVersion, deleteVersion);\r\n    }\r\n\r\n    /**\r\n     * The setRightButtons function creates a HorizontalLayout containing buttons that are used to manipulate the assortment grid.\r\n     * The function takes no parameters and returns a HorizontalLayout containing the following buttons:\r\n     * - newVersion - A button that allows users to create a new assortment version.\r\n     * - editVersion - A button that allows users to edit an existing assortment version.\r\n     * - copyVersion - A button that allows users to copy an existing assortment version, including its data files and filters.\r\n     * - deleteVersion - A button that deletes selected versions of assortments from the database\r\n     *\r\n     * @return A horizontallayout with the buttons\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setRightButtons() {\r\n\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            assortmentGrid.deselectAll();\r\n            openAssortment(() -> createNewAssortment(getSelectedItems()), false);\r\n        });\r\n\r\n        Button editVersion = new Button(VaadinIcon.PENCIL.create());\r\n        CompUtils.addToolTip(getCtx(), editVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_EDIT_TOOLTIP);\r\n        editVersion.addClickListener(event -> {\r\n            List<DataFile> selectedDataFile = new ArrayList<>(getSelectedItems());\r\n            if (selectedDataFile.isEmpty()) {\r\n                openAssortment(() -> {\r\n                    Assortment result = null;\r\n                    List<Assortment> selected = new ArrayList<>();\r\n                    if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                        selected.addAll(assortmentGrid.getSelectedItems());\r\n                        result = selected.get(0);\r\n                        setSessionAssortment(result);\r\n                    }\r\n                    return result;\r\n                }, true);\r\n            } else {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(TMS.ERROR_MSG_NO_NEW_PRICE_FILE_EXCEPT);\r\n            }\r\n        });\r\n\r\n        Button copyVersion = new Button(VaadinIcon.COPY.create());\r\n        CompUtils.addToolTip(getCtx(), copyVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_COPY_TOOLTIP);\r\n        copyVersion.addClickListener(event -> {\r\n\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n\r\n                // Selected Assortment\r\n                List<Assortment> selection = new ArrayList<>();\r\n                selection.addAll(assortmentGrid.getSelectedItems());\r\n                final Assortment selected = selection.get(0);\r\n\r\n                // Selected DataFiles\r\n                List<DataFile> selectedDataFile = new ArrayList<>();\r\n                selectedDataFile.addAll(getSelectedItems());\r\n                if (selectedDataFile.isEmpty()) {\r\n                    List<AssortmentDatafile> xCross = getCtx().getServices().getAssortmentDataFileService()\r\n                            .findAllByAssortment(selected);\r\n                    xCross.forEach(item -> {\r\n                        if (item.getAstFile() instanceof DataFile) {\r\n                            selectedDataFile.add((DataFile) item.getAstFile());\r\n                        }\r\n                    });\r\n                }\r\n\r\n                checkFilter(() -> openAssortment(() -> copyAssortment(selection.get(0), selectedDataFile), false),\r\n                        selected, \"eshop\");\r\n            }\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                    assortment.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                    assortment.setDeleteOn(LocalDateTime.now());\r\n                });\r\n                getServices().getAssortmentService().saveAll(assortmentGrid.getSelectedItems());\r\n                reloadAssortmentGrid();\r\n            }\r\n        });\r\n\r\n        downloader(null);\r\n\r\n        Button unlockVersion = new Button(VaadinIcon.UNLOCK.create());\r\n        CompUtils.addToolTip(getCtx(), unlockVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_LOCK_TOOLTIP);\r\n        unlockVersion.addClickListener(event -> {\r\n\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                    assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                        AssortmentUtil.unLock(getCtx(), assortment);\r\n                        reloadAssortmentGrid();\r\n                        assortmentGrid.select(assortment);\r\n                    });\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        Button uploadVersion = new Button(VaadinIcon.UPLOAD_ALT.create());\r\n        CompUtils.addToolTip(getCtx(), uploadVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_UPLOAD_TOOLTIP);\r\n\r\n        uploadVersion.addClickListener(event -> {\r\n            final Map<String, Boolean> ready = new HashMap<>();\r\n            User user = getCtx().getSession().getCurrentUser(getCtx());\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOAD_ASSORTMENT);\r\n                new Thread(() -> {\r\n                    List<Assortment> selected = new ArrayList<>();\r\n\r\n                    selected.addAll(getAssortmentGrid().getSelectedItems());\r\n                    if (SchedulerUtils.isValid(getCtx(), selected.get(0))) {\r\n                        setParameter(FileParam.QUEUE_BY, user, selected.get(0));\r\n                        setParameter(FileParam.QUEUE_ON, LocalDateTime.now(), selected.get(0));\r\n                    } else {\r\n                        AssortmentUtil.upload(getCtx(), selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_BY, user, selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_ON, LocalDateTime.now(), selected.get(0));\r\n                    }\r\n\r\n                    reloadInfoBox(dialog.getDialogUI());\r\n\r\n                    dialog.showUploadSuccess();\r\n                    ready.put(\"error\", false);\r\n                    dialog.uiClose();\r\n                }).start();\r\n            });\r\n\r\n            dialog.open();\r\n            dialog.execute();\r\n\r\n            ready.forEach((k, v) -> {\r\n                if (k.equals(\"error\")) {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_CREATE_ASSORTMENT_FIRST, getLocale(), getCtx()));\r\n                }\r\n            });\r\n        });\r\n\r\n        Button previewVersion = new Button(VaadinIcon.EYE.create());\r\n        previewVersion.setId(\"assortment-file-preview\");\r\n        CompUtils.addToolTip(getCtx(), previewVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_PREVIEW_TOOLTIP);\r\n        previewVersion.addClickListener(event -> {\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n                if (Objects.nonNull(assortment) && !assortment.getName().isEmpty()) {\r\n                    loadPreviewBreadCrumb();\r\n                    ToPreviewCrumpDialog pDialog = new ToPreviewCrumpDialog(getCtx());\r\n                    pDialog.open();\r\n                    pDialog.run();\r\n                }\r\n            });\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n\r\n        downloadBtn = new DownloadButton(getCtx(), TMS.LOADER_ASSORTMENT_GRID_BUTTON_DOWNLOAD_TOOLTIP);\r\n        return buttons(newVersion, editVersion, copyVersion, deleteVersion, unlockVersion, downloadBtn, uploadVersion,\r\n                previewVersion);\r\n    }\r\n\r\n    /**\r\n     * The downloader function is responsible for downloading the assortment as a zip file.\r\n     * It does this by first building the name of the zip file, and then calling reloadAsFile on downloadBtn.\r\n     * The reloadAsFile function takes two functions as parameters: one that returns a String (the filename), and another that returns an InputStream (the contents of the file).\r\n     *\r\n     * @param Assortment assortment Get the assortment id and name\r\n     * @return A supplier&lt;inputstream&gt; that is used to create a file download\r\n     * @docauthor Trelent\r\n     */\r\n    private void downloader(Assortment assortment) {\r\n        if (Objects.nonNull(assortment)) {\r\n            final String zipFileName = ExportFileUtils.buildZIPFileName(getCtx(), assortment);\r\n            downloadBtn.reloadAsFile(() -> zipFileName, () -> AssortmentUtil.zip(getCtx(), assortment));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The createNewAssortment function creates a new assortment and saves it to the database.\r\n     *\r\n     * @param List&lt;DataFile&gt; selectedFiles Set the data files to the assortment\r\n     *                             public assortment setdatafilestoassortment(assortment assortment, list&lt;datafile&gt; selectedfiles) {\r\n     *                             for (datafile file : selectedfiles) {\r\n     *                             file\r\n     * @return An assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    public Assortment createNewAssortment(List<DataFile> selectedFiles) {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        Assortment assortment = new Assortment();\r\n        assortment.setDate(user);\r\n        assortment.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        assortment = getServices().getAssortmentService().save(assortment);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.IMPEX, assortment);\r\n        setSessionAssortment(assortment);\r\n        return setDataFilesToAssortment(assortment, selectedFiles);\r\n    }\r\n\r\n\r\n    /**\r\n     * The setDataFilesToAssortment function takes an assortment and a list of datafiles as parameters.\r\n     * It then checks if the selected files are valid, and if they are it adds them to the assortment.\r\n     *\r\n     * @param Assortment           assortment Get the assortment object from the database\r\n     * @param List&lt;DataFile&gt; selectedFiles Get the selected files from the grid\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment setDataFilesToAssortment(Assortment assortment, List<DataFile> selectedFiles) {\r\n        Assortment result = null;\r\n        List<AstFile> datafiles = getAstFileTypeFromAssortment(assortment, DataFile.class);\r\n        boolean valid = false;\r\n        for (DataFile datafile : selectedFiles) {\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, datafile);\r\n            if (type.equals(ObjectType.IMPEX_INPUT)) {\r\n                valid = true;\r\n            }\r\n        }\r\n\r\n        if (valid) {\r\n            selectedFiles.forEach(dataFile -> {\r\n                boolean notValid = false;\r\n                for (AstFile datafile : datafiles) {\r\n                    if (datafile.getId() == dataFile.getId()) {\r\n                        notValid = true;\r\n                        break;\r\n                    }\r\n                }\r\n                if (!notValid) {\r\n                    AssortmentDatafile xrossFile = new AssortmentDatafile();\r\n                    xrossFile.setAssortment(assortment);\r\n                    xrossFile.setAstFile(dataFile);\r\n                    getServices().getAssortmentDataFileService().save(xrossFile);\r\n                }\r\n            });\r\n            result = assortment;\r\n\r\n            // reloadTable\r\n            reloadAssortmentGrid();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The copyAssortment function is used to copy an assortment.\r\n     *\r\n     * @param Assortment           fromCopy Copy the assortment from the source to a new one\r\n     * @param List&lt;DataFile&gt; newDatafiles Store the new datafiles that are created by the user\r\n     * @return The new assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment copyAssortment(Assortment fromCopy, List<DataFile> newDatafiles) {\r\n        Assortment result = new Assortment();\r\n        loadAssortmentsBreadCrumb();\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n\r\n        AssortmentDataFileDAO serviceXcross = getCtx().getServices().getAssortmentDataFileService();\r\n\r\n        result.setDate(user);\r\n        result.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        Assortment assortment = getServices().getAssortmentService().save(result);\r\n        CompUtils.cloneParameter(getCtx(), FileParam.FILE_TYPE, fromCopy, assortment);\r\n\r\n        newDatafiles.forEach(item -> {\r\n            AssortmentDatafile file = new AssortmentDatafile();\r\n            file.setAssortment(assortment);\r\n            file.setAstFile(item);\r\n            serviceXcross.save(file);\r\n        });\r\n\r\n        getCtx().getServices().getFilterBaseCustomService().clone(fromCopy, assortment);\r\n\r\n        List<AssortmentFilter> preFilters = getCtx().getServices().getAssortmentFilterService()\r\n                .findAllByAssortment(fromCopy);\r\n        preFilters.forEach(item -> {\r\n            AssortmentFilter assortmentFilter = new AssortmentFilter();\r\n            assortmentFilter.setCreateBy(user);\r\n            assortmentFilter.setFilter(item.getFilter());\r\n            assortmentFilter.setAssortment(assortment);\r\n            getCtx().getServices().getAssortmentFilterService().save(assortmentFilter);\r\n        });\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, newDatafiles);\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reload the buttons on the screen.\r\n     * This function is called when a new page has been loaded, and it sets all of\r\n     * the buttons to be disabled except for &quot;Exit&quot;. The reason that this function\r\n     * exists is because we want to make sure that no other button can be clicked until\r\n     * after a user has finished answering questions on a given page. This prevents users from skipping ahead in the survey or going back before they have answered all of their questions.\r\n     *\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the assortment grid and datafile grid, as well as resets the breadcrumbs to their first state.\r\n     *\r\n     * @return The current ui\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            reloadAssortmentGrid();\r\n            reloadDatafileGrid();\r\n            reset2BreadCrumbFirst();\r\n        });\r\n        reloadInfoBox(UI.getCurrent());\r\n    }\r\n\r\n    /**\r\n     * The reset2BreadCrumbFirst function is called when the user clicks on a breadcrumb.\r\n     * It removes all breadcrumbs after the clicked one, and then reloads the buttons in\r\n     * order to update them with their new values. Finally, it calls initial() on the box\r\n     * so that it can be updated with its new values as well. The box is then put back into\r\n     * UserSession so that it can be accessed by other functions later on if needed.\r\n     *\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    private void reset2BreadCrumbFirst() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            if (!box.getCrumbs().contains(this))\r\n                box.getCrumbs().add(this);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            reloadButtons();\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadAssortmentsBreadCrumb function is responsible for loading the breadcrumbs that are displayed on the top of\r\n     * the Assortments page. The function first removes all crumbs from the BreadBox except for LoaderCrumb, which is a\r\n     * special type of Crumb that cannot be removed. Then, it adds three new crumbs to represent each filter option: FilterAddCrumb,\r\n     * FilterRemoveCrumb and FilterIndividualCrumb. Finally, it initializes these new crumbs so they can be used by calling their respective functions in their classes.\r\n     *\r\n     * @return The following:\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadAssortmentsBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            box.getCrumbs().add(new FilterAddCrumb(getCtx()));\r\n            box.getCrumbs().add(new FilterRemoveCrumb(getCtx()));\r\n            box.getCrumbs().add(new FilterIndividualCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadFileEditBreadCrumb function is called when the user clicks on a file in the FileListView.\r\n     * It loads a new breadcrumb into the BreadBox, which will be displayed at the top of the screen.\r\n     * The breadcrumb contains an icon and text that indicates to users what they are currently viewing.\r\n     *\r\n     * @return A breadcrumb with a fileeditcrumb\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadFileEditBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new FileEditCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadPreviewBreadCrumb function is called when the user clicks on the Preview button.\r\n     * It loads a new breadcrumb into the BreadBox, which is then displayed in the UI.\r\n     *\r\n     * @return A breadcrumb with the name &quot;preview&quot;\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadPreviewBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new PreviewCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the CrumbProgressDialog.\r\n     * It sets the label of the dialog to &quot;Set Proof&quot; and calls getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n     *\r\n     * @param CrumbProgressDialog dialog Set the label of the dialog\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        dialog.setLabel(TMS.setProof(FilterType.ZUORDNUNG_MATERIAL));\r\n        getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL,\r\n                FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     *\r\n     * @return The value that the dialog returns\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the checkboxes for each of the values that can be imported.\r\n     * The first parameter in each dialog.addValueCbx call is a string representing one of the values that can be imported,\r\n     * and it must match one of the strings defined in TMS.java (e.g., &quot;FILE_IMPORTER_ARTICLE_NR&quot;).  The second parameter\r\n     * determines whether or not this value will be required when importing data from a file; if true, then an error message will appear if no column has been selected for this value during importation; otherwise, no error message\r\n     *\r\n     * @param FileImportDialog dialog Get the values of the checkboxes\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CURRENCY, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_TERRITORY, false);\r\n        header = dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in a FileImportDialog.\r\n     * It takes all of the data from each row in the table and creates an ArticleBase object for each one.\r\n     * Then, it checks to see if there is a header (if so, then it's a price file). If there isn't, then\r\n     * it's an impex file. The function also sets default parameters for both types of files (price and impex)\r\n     *\r\n     * @param FileImportDialog dialog Access the data of the table\r\n     * @return A list of articles\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        dialog.getTable().forEach(row -> {\r\n            ArticleBase price = setPrice(row, dialog);\r\n            if (Objects.nonNull(price)) {\r\n                articles.add(price);\r\n            }\r\n        });\r\n\r\n        if (!articles.isEmpty()) {\r\n            UI.getCurrent().access(() -> {\r\n                dialog.removeAll();\r\n                dialog.init();\r\n                dialog.setLabel(TMS.LOADER_DIALOG_CONVERT_FILE);\r\n\r\n                DataFile dataFile = new DataFile();\r\n                dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n                dataFile = getCtx().getServices().getDataFileService().save(dataFile);\r\n\r\n                setParameter(FileParam.FILE_TYPE, ObjectType.IMPEX_INPUT, dataFile);\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                File fi = null;\r\n                if (Objects.nonNull(header.getValue())) {\r\n                    setParameter(FileParam.HAS_PRICE, Boolean.TRUE, dataFile);\r\n\r\n                    fi = ExportFileUtils.buildPriceFile(getCtx(), articles, ASTConst.DEFAULT, dataFile);\r\n                } else {\r\n\r\n                    fi = ExportFileUtils.buildImpexFile(getCtx(), articles, ASTConst.DEFAULT, dataFile);\r\n                }\r\n                dataFile.setName(ExportFileUtils.buildPositivFileName(getCtx(), dataFile));\r\n                dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n                dataFile = getServices().getDataFileService().save(dataFile);\r\n                saveStorage(dataFile, fi);\r\n\r\n                final DataFile dFile = dataFile;\r\n                Map<Integer, String> colString = dialog.getTable().get(0);\r\n                // CURRENCY\r\n                if (dialog.getColumns()[1] > -1) {\r\n                    String currency = dialog.getColumnsByIdx(colString, 1);\r\n                    if (!currency.isEmpty()) {\r\n                        List<Currency> items = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n                        Optional<Currency> opt = items.stream().filter(item -> item.getKey().equals(currency))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.CURRENCY, value, dFile));\r\n                    }\r\n                }\r\n                // LANGUAGE\r\n                if (dialog.getColumns()[2] > -1) {\r\n                    String language = dialog.getColumnsByIdx(colString, 2);\r\n                    if (!language.isEmpty()) {\r\n                        List<Language> items = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n                        Optional<Language> opt = items.stream().filter(item -> item.getLabel().contains(language))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.LANGUAGE, value, dFile));\r\n                    }\r\n                }\r\n                // TERRITORY\r\n                if (dialog.getColumns()[3] > -1) {\r\n                    String territory = dialog.getColumnsByIdx(colString, 3);\r\n                    if (!territory.isEmpty()) {\r\n                        List<Territory> items = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n                        Optional<Territory> opt = items.stream().filter(item -> item.getKey().equals(territory))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.TERRITORY, value, dFile));\r\n                    }\r\n                }\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                reloadDatafileGrid();\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setPrice function takes the column string and the dialog as parameters.\r\n     * It then creates a new ArticleBase object, which is an assortment of prices.\r\n     * If there are any columns in the column string, it will set them to their respective values:\r\n     * - The article number (column 0) will be set to price's article number.\r\n     * - The first price (column 4) will be set to price's first price.\r\n     * - The Xth Price (column 5) will be set to price's Xth Price.\r\n     *\r\n     * @param Map&lt;Integer   Map the column index to a string value\r\n     * @param String&gt;       colString Get the values from the csv file\r\n     * @param FileImportDialog dialog Get the column values from the file\r\n     * @return An articlebase object\r\n     * @docauthor Trelent\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n\r\n        if (Objects.nonNull(colString)) {\r\n            if (dialog.getColumns()[0] > -1) {\r\n                price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n            }\r\n            if (dialog.getColumns()[4] > -1) {\r\n                price.setPriceFirst(dialog.getColumnsByIdx(colString, 4));\r\n            }\r\n            if (dialog.getColumns()[5] > -1) {\r\n                price.setPriceX(dialog.getColumnsByIdx(colString, 5));\r\n            }\r\n            if (dialog.getColumns()[6] > -1) {\r\n                price.setPriceType(dialog.getColumnsByIdx(colString, 6));\r\n            }\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It saves a DataFile object to the database, and then calls setParameter() to set its file type as an IMPEX_INPUT.\r\n     * Then it calls saveStorage() with two parameters: dataFile and ExportFileUtils.buildImpexFile(getCtx(), articles, ASTConst.DEFAULT, dataFile).\r\n     * The buildImpex function returns a String containing all of the articles that were imported from Excel into Hybris Management Console (HMC).\r\n     *\r\n     * @param FileImportDialog        dialog Get the file name and content of the uploaded file\r\n     * @param List&lt;ArticleBase&gt; articles Get the list of articles to be exported\r\n     * @return The list of articles to be saved\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        DataFile dataFile = new DataFile();\r\n        dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n\r\n        dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        dataFile = getServices().getDataFileService().save(dataFile);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.IMPEX_INPUT, dataFile);\r\n        setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n        dataFile.setName(ExportFileUtils.buildImpexFileName(getCtx(), dataFile));\r\n        saveStorage(dataFile, ExportFileUtils.buildImpexFile(getCtx(), articles, ASTConst.DEFAULT, dataFile));\r\n        getServices().getDataFileService().save(dataFile);\r\n\r\n        setLanguageParamByCustomer(dataFile);\r\n\r\n        reloadDatafileGrid();\r\n    }\r\n\r\n    /**\r\n     * The setSessionAssortment function is used to set the active assortment in the user session.\r\n     *\r\n     * @param Assortment assortment Find the assortment object in the database and then put it into the usersession\r\n     * @return The active assortment\r\n     * @docauthor Trelent\r\n     */\r\n    private void setSessionAssortment(Assortment assortment) {\r\n        Optional<Assortment> optAssortment = getServices().getAssortmentService().findById(assortment.getId());\r\n        optAssortment.ifPresent(item -> getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, item));\r\n    }\r\n\r\n    /**\r\n     * The getSelectedItems function returns a list of DataFile objects that have been selected in the data file grid.\r\n     * The function first creates an empty ArrayList object called selectedFiles, which will be populated with the\r\n     * DataFile objects that are returned by the getSelectedItems method of the data file grid.  This method returns a set\r\n     * of items from its internal selection model, and these items are added to our new ArrayList object.\r\n     * Next we iterate through each item in this list using Java 8's forEach lambda expression syntax (which is equivalent to:  for(DataFile item : selectedFiles) {\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    private List<DataFile> getSelectedItems() {\r\n        List<DataFile> selectedFiles = new ArrayList<>();\r\n        selectedFiles.addAll(dataFileGrid.getSelectedItems());\r\n        selectedFiles.forEach(item -> {\r\n            Optional<DataFile> optDatafile = getCtx().getServices().getDataFileService().findById(item.getId());\r\n            if (optDatafile.isPresent())\r\n                item = optDatafile.get();\r\n        });\r\n        return selectedFiles;\r\n    }\r\n\r\n    /**\r\n     * The setDefaultParameterToDataFile function is used to set the default parameters for a data file.\r\n     * The function takes in two arguments: articles and save.\r\n     * Articles is a list of ArticleBase objects, which are the articles that will be saved into the database.\r\n     * Save is an AstFile object, which represents the data file that will be saved into the database.\r\n     * The function sets default values for currency, territory, language (if applicable), KatalogVersion (which version of Katalog this data file belongs to), validFrom date (the date when this version of Katalog became valid) and validTo date (the date\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Get the first article in the list and use it to set parameters\r\n     *                                private void setdefaultparametertodatafile(list&lt;articlebase&gt; articles, astfile save) {\r\n     *                                articlebase first = articles\r\n     * @param AstFile                 save Set the parameters in the astfile\r\n     * @return The currency, territory, language, version and valid from/to dates\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDefaultParameterToDataFile(List<ArticleBase> articles, AstFile save) {\r\n        ArticleBase first = articles.get(0);\r\n\r\n        List<Currency> currencies = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n        List<Language> languages = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n        List<Territory> territories = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n\r\n        if (!first.getCurrency().isEmpty() && Objects.isNull(getParameter(FileParam.CURRENCY, save))) {\r\n            Optional<Currency> optCurr = currencies.stream().filter(item -> item.getKey().equals(first.getCurrency()))\r\n                    .findFirst();\r\n            optCurr.ifPresent(item -> setParameter(FileParam.CURRENCY, item, save));\r\n        }\r\n        if (!first.getTerritory().isEmpty() && Objects.isNull(getParameter(FileParam.TERRITORY, save))) {\r\n            String territory = first.getTerritory();\r\n            if (territory.contains(\"-\") && Objects.isNull(getParameter(FileParam.LANGUAGE, save))) {\r\n                String language = territory.split(\"-\")[0];\r\n                territory = territory.split(\"-\")[2];\r\n                Optional<Language> optLang = languages.stream().filter(item -> item.getKey().equals(language))\r\n                        .findFirst();\r\n                optLang.ifPresent(item -> setParameter(FileParam.LANGUAGE, item, save));\r\n            }\r\n            String finalTerr = territory;\r\n            Optional<Territory> optTerr = territories.stream().filter(item -> item.getKey().equals(finalTerr))\r\n                    .findFirst();\r\n            optTerr.ifPresent(item -> setParameter(FileParam.TERRITORY, item, save));\r\n        }\r\n\r\n        KatalogVersion version = CompUtils.getKatalogVersion(getCtx(), save);\r\n\r\n        setParameter(FileParam.KATALOG_VERSION, version, save);\r\n\r\n        if (!first.getValidFrom().isEmpty()) {\r\n            setParameter(FileParam.VALID_FROM, first.getValidFromAsLocalDate(), save);\r\n        } else {\r\n            setParameter(FileParam.VALID_FROM, version.getValidFrom(), save);\r\n        }\r\n\r\n        if (!first.getValidTo().isEmpty()) {\r\n            setParameter(FileParam.VALID_TO, first.getValidToAsLocalDate(), save);\r\n        } else {\r\n            setParameter(FileParam.VALID_TO, version.getValidTo(), save);\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\crumb\\LoaderCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\crumb\\PreviewCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.eshop.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.ExcelUtils;\r\nimport com.hom.ebmw.utilities.InternalUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.TabBox;\r\nimport com.hom.ebmw.view.dialogs.FileConvertDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseQuickDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.Component;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.progressbar.ProgressBar;\r\nimport com.vaadin.flow.component.tabs.Tab;\r\nimport com.vaadin.flow.component.tabs.Tabs;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.HashMap;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_PREVIEW)\r\npublic class PreviewCrumb extends Crumb {\r\n\r\n    private final Tabs tabBay = new Tabs();\r\n    private final Div pages = new Div();\r\n    private final Map<Tab, VerticalLayout> tabMap = new HashMap<Tab, VerticalLayout>();\r\n    private final ArticleDetailBox details;\r\n    private Assortment assortment = null;\r\n\r\n    /**\r\n     * The PreviewCrumb function is a constructor for the PreviewCrumb class.\r\n     * It creates a new instance of the PreviewCrumb class, and sets up its UI elements.\r\n     *\r\n     * @param Context ctx Get the usersession and to set the active ui\r\n     * @return A new previewcrumb object\r\n     */\r\n    public PreviewCrumb(Context ctx) {\r\n        super(ctx);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_UI, UI.getCurrent());\r\n        this.assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        details = new ArticleDetailBox(getCtx(), new ArrayList<ArticleBase>());\r\n        add(details, tabBay, pages);\r\n        pages.setSizeFull();\r\n\r\n        tabBay.addSelectedChangeListener(event -> {\r\n            tabMap.forEach((k, v) -> {\r\n                v.setVisible(false);\r\n            });\r\n            Component selectedPage = tabMap.get(tabBay.getSelectedTab());\r\n            selectedPage.setVisible(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a tab in the\r\n     * ArticleBaseCrumb. It removes all tabs from the TabSheet and then adds them\r\n     * again, so that they are updated with new information. The details object is also reloaded,\r\n     * so that it can be updated with new information as well.\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        final UI ui = UI.getCurrent();\r\n\r\n        ui.access(() -> {\r\n            tabBay.removeAll();\r\n            pages.removeAll();\r\n            tabMap.clear();\r\n\r\n            addTabPriceList(assortment);\r\n            addTabRemoved(assortment);\r\n        });\r\n\r\n        details.reload(() -> getServices().getArticleBaseService().findAllInArchivByAssortment(assortment));\r\n    }\r\n\r\n    /**\r\n     * The addTabPriceList function adds a tab to the preview window.\r\n     * The tab is labeled &quot;Price List&quot; and contains a grid of all articles in the assortment that are not comments.\r\n     * The grid has two columns: article number and price list (in EUR).\r\n     *\r\n     * @param Assortment assortment Get the assortment id in order to remove it from the article number\r\n     */\r\n    private void addTabPriceList(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_PRICELIST, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setKey(\"articleNr\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n\r\n        box.setLoad(loadGrid(box.getGrid(), () -> {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, false);\r\n            box.getDownload().reloadAsFile(() -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT,\r\n                            box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        Button customExport = new Button(getTranslation(TMS.GENERATE_DIALOG_RENDER_EXPORT, getLocale(), getCtx()));\r\n        customExport.addClickListener(event -> {\r\n            FileConvertDialog dialog = new FileConvertDialog(getCtx());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        box.getButtons().add(customExport);\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    /**\r\n     * The addTabRemoved function adds a tab to the preview page that displays all articles in the assortment\r\n     * that have been removed. The tab is labeled &quot;Removed&quot; and contains two columns: one for article number,\r\n     * and one for comment. The grid can be sorted by either column, and it can be searched by article number.\r\n     *\r\n     * @param Assortment assortment Get the assortment id and to replace it in the article number\r\n     */\r\n    private void addTabRemoved(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_REMOVED, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setKey(\"articleNr\");\r\n        box.getGrid().addColumn(ArticleBase::getComment)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_COMMENT, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setKey(\"comment\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n\r\n        box.setLoad(loadGrid(box.getGrid(), () -> {\r\n\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, true);\r\n            box.getDownload().reloadAsFile(() -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT,\r\n                            box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    /**\r\n     * The loadGrid function is a helper function that allows for the loading of data into a grid\r\n     * in an asynchronous manner. This means that the UI will not be blocked while waiting for\r\n     * data to load, and instead will show a progress bar until all of the data has been loaded.\r\n     *\r\n     * @param Grid&lt;E&gt;                 grid Set the data provider of the grid\r\n     * @param Callable&lt;List&lt;E&gt;&gt; list Pass a list of objects to the grid\r\n     * @return A progressbar\r\n     */\r\n    private <E> ProgressBar loadGrid(Grid<E> grid, Callable<List<E>> list) {\r\n        ProgressBar progress = new ProgressBar();\r\n        progress.setIndeterminate(true);\r\n        final UI ui = UI.getCurrent();\r\n\r\n        new Thread(() -> {\r\n            ui.access(() -> {\r\n                progress.setVisible(true);\r\n                try {\r\n                    List<E> buffer = list.call();\r\n                    grid.setDataProvider(DataProvider.ofCollection(buffer));\r\n                } catch (Exception e) {\r\n                    log.error(e.getLocalizedMessage());\r\n                    log.debug(e.toString());\r\n                }\r\n                progress.setVisible(false);\r\n            });\r\n        }).start();\r\n        return progress;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reset the buttons on the bottom of\r\n     * the screen. It sets all buttons to disabled except for exit, which is set\r\n     * to enabled. This function is called when a new page loads in order to ensure\r\n     * that only valid options are available at any given time.\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setExitEnable(true);\r\n            setNextEnable(false);\r\n            setLastEnable(false);\r\n            setFinishEnable(false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        CloseQuickDialog dialog = new CloseQuickDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\crumb\\PreviewCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\EShopPresenter.java =====\n```\npackage com.hom.ebmw.view.sortment.eshop;\r\n\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.view.sortment.eshop.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\n\r\nimport java.util.Locale;\r\nimport java.util.Objects;\r\n\r\npublic class EShopPresenter {\r\n\r\n    private LoaderCrumb loader;\r\n    private Importer importer;\r\n    private InfoBox info;\r\n    private LocalCustomer localCustomer;\r\n\r\n    private Context ctx = new Context();\r\n\r\n    public EShopPresenter(Context ctx) {\r\n        this.ctx = ctx;\r\n    }\r\n\r\n    public void setLoader(LoaderCrumb loader) {\r\n        this.loader = loader;\r\n    }\r\n\r\n    public void setInfo(InfoBox info) {\r\n        this.info = info;\r\n    }\r\n\r\n    public InfoBox getInfo() {\r\n        return info;\r\n    }\r\n\r\n    /**\r\n     * The setImporter function sets the importer variable to the Importer object passed in as a parameter.\r\n     *\r\n     * @param Importer importer Set the importer object\r\n     */\r\n    public void setImporter(Importer importer) {\r\n        this.importer = importer;\r\n    }\r\n\r\n    /**\r\n     * The setChangeValue function is called when the user selects a customer from the dropdown menu.\r\n     * It sets the localCustomer variable to be equal to whatever customer was selected, and then calls\r\n     * reloadDatafileGrid() and reloadAssortmentGrid(). These functions are defined in Loader.java, which\r\n     * is used as an interface between this class (ImporterView) and ImporterPresenter. The purpose of these\r\n     * two functions is to update both grids on screen with data that corresponds with whichever customer was selected.\r\n     *\r\n     * @param LocalCustomer customer Set the localcustomer variable to a new value\r\n     */\r\n    public void setChangeValue(LocalCustomer customer) {\r\n        if (Objects.nonNull(customer)) {\r\n            importer.getUploader().setVisible(true);\r\n            localCustomer = customer;\r\n            CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n            loader.reloadDatafileGrid();\r\n            loader.reloadAssortmentGrid();\r\n        } else {\r\n            importer.getUploader().setVisible(false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setStartedEvent function is called when the user clicks on the &quot;Started&quot; button.\r\n     * It sets a session variable to indicate that this event has been started, and then\r\n     * redirects to the main page.  The main page will check for this session variable and\r\n     * display an appropriate message if it exists.  This function also sets a cookie with\r\n     * information about which customer was selected by the user, so that we can remember their choice later on.\r\n     *\r\n     * @param Locale locale Set the language of the application\r\n     */\r\n    public void setStartedEvent(Locale locale) {\r\n        //CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\EShopPresenter.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\EShopView.java =====\n```\npackage com.hom.ebmw.view.sortment.eshop;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.BaseLayout;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.eshop.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\nimport com.vaadin.flow.router.*;\r\n\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.Objects;\r\n\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_ESHOP;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_ESHOP;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_ESHOP, layout = MainView.class)\r\n@PageTitle(TITLE_ESHOP)\r\npublic class EShopView extends BaseLayout implements HasPermission, HasUrlParameter<String> {\r\n\r\n    private final EShopPresenter presenter;\r\n    private final Context ctx = new Context();\r\n    private final Importer importer;\r\n\r\n    /**\r\n     * The EShopView function is the constructor for the EShopView class.\r\n     * It initializes all of the variables that are used in this class, and it also sets up\r\n     * all of the sections on this page (left, middle, right).\r\n     *\r\n     * @param Services services Pass the services object to the eshopview constructor\r\n     * @return The presenter\r\n     */\r\n    public EShopView(Services services) {\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        LocalCustomer customer = ctx.getHttpAttribute(SessionParams.ACTIVE_CUSTOMER);\r\n        if (Objects.nonNull(customer) && customer.getCustomerId().equals(ASTConst.PROMOTION_CUSTOMER))\r\n            ctx.putHttpAttribute(SessionParams.ACTIVE_CUSTOMER, null);\r\n        ctx.getUserSession().put(Params.ACTIVE_TYPE, ObjectType.IMPEX);\r\n        this.presenter = new EShopPresenter(ctx);\r\n        importer = new Importer(ctx);\r\n\r\n        setLeftSection();\r\n        setMiddleSection();\r\n        setRightSection();\r\n    }\r\n\r\n\r\n    /**\r\n     * The setMiddleSection function is responsible for creating the middle section of the GUI.\r\n     * It creates a new LoaderCrumb object, and sets it as the presenter's loader. Then, it creates\r\n     * a BreadBox object and sets its default crumb to be our newly created LoaderCrumb. The function then adds\r\n     * this LoaderCrumb to our list of crumbs in our BreadBox, initializes it (which I believe just means that we set\r\n     * its content), and then set's this breadbox as the content for our middle section. Finally, we reload both buttons\r\n     * on this loadercrumb\r\n     */\r\n    private void setMiddleSection() {\r\n        LoaderCrumb loader = new LoaderCrumb(ctx);\r\n        presenter.setLoader(loader);\r\n\r\n        BreadBox breadBox = new BreadBox(ctx);\r\n        breadBox.setDefaultCrumb(loader);\r\n\r\n        breadBox.getCrumbs().add(loader);\r\n        breadBox.initial();\r\n\r\n        getMiddleSection().add(breadBox);\r\n\r\n        breadBox.setContent(loader);\r\n        loader.reloadButtons();\r\n        loader.reloadCrumb();\r\n    }\r\n\r\n    /**\r\n     * The setLeftSection function is responsible for adding the importer to the left section of\r\n     * the view. It also adds a listener to listen for changes in customer value, and another\r\n     * listener to listen for changes in role value. The function also adds a started listener and\r\n     * succeeded listener that are used when uploading files. Finally, it calls getLeftSection() from\r\n     * its superclass (AbstractImportView) and passes it an instance of Importer as an argument.\r\n     */\r\n    private void setLeftSection() {\r\n\r\n        presenter.setImporter(importer);\r\n\r\n        importer.addCustomerValueChangeListener(e ->\r\n                presenter.setChangeValue(e.getValue())\r\n        );\r\n\r\n        importer.addRoleValueChangeListener(e -> {\r\n            if (Objects.nonNull(importer.getSelected()))\r\n                presenter.setChangeValue(importer.getSelected());\r\n            importer.reloadCustomer();\r\n        });\r\n\r\n        importer.getUploader().addStartedListener(e ->\r\n                presenter.setStartedEvent(getLocale())\r\n        );\r\n\r\n        importer.getUploader().addSucceededListener(e -> {\r\n            FileImportDialog dialog = new FileImportDialog(ctx, e, importer.getMemoryFileBuffer());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        getLeftSection().add(importer);\r\n    }\r\n\r\n    /**\r\n     * The setRightSection function is called by the setRightSection function.\r\n     * It creates a new InfoBox object, and then adds it to the right section of the page.\r\n     */\r\n    private void setRightSection() {\r\n        InfoBox info = new InfoBox(ctx);\r\n\r\n        ctx.getUserSession().put(Params.ACTIVE_INFO_BOX, info);\r\n\r\n        presenter.setInfo(info);\r\n        getRightSection().add(info);\r\n    }\r\n\r\n    /**\r\n     * The setParameter function is called by the framework when a user navigates to this view.\r\n     * The function receives an event object and an optional parameter string.\r\n     * The event object contains information about the navigation, including a reference to the location that was navigated from.\r\n     * If there are parameters in the URL, they will be passed as a String in this second argument.\r\n     *\r\n     * @param BeforeEvent        event Get the location of the page\r\n     * @param @OptionalParameter String parameter Pass the parameter to the setparameter function\r\n     */\r\n    @Override\r\n    public void setParameter(BeforeEvent event, @OptionalParameter String parameter) {\r\n        Location location = event.getLocation();\r\n        QueryParameters parameters = location.getQueryParameters();\r\n\r\n        Map<String, List<String>> parametersMap = parameters.getParameters();\r\n        if (parametersMap.containsKey(\"customer\")) {\r\n            ctx.getUserSession().put(Params.ACTIVE_PAGE_PARAMETERS, parametersMap);\r\n            LocalCustomer paramCustomer = CompUtils.setSessionProjectByCustomerParameter(ctx);\r\n            importer.setSelectedLocalCustomer(paramCustomer);\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\eshop\\EShopView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FileEditCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.la.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.DoubleFoundException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.KatalogVersion;\r\nimport com.hom.ebmw.pojo.PartnerShort;\r\nimport com.hom.ebmw.utilities.AstNotification;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToDataFileDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.confirmdialog.ConfirmDialog;\r\nimport com.vaadin.flow.component.datepicker.DatePicker;\r\nimport com.vaadin.flow.component.formlayout.FormLayout;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.binder.Binder;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.function.SerializablePredicate;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.time.LocalDateTime;\r\nimport java.util.*;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_FILE_EDIT)\r\npublic class FileEditCrumb extends Crumb implements FileInputLoader, HasPermission {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private GridPro<ArticleBase> articleGrid;\r\n    private ListDataProvider<ArticleBase> dataProvider;\r\n    private SerializablePredicate<ArticleBase> filters = null;\r\n\r\n    private ComboBox<KatalogVersion> katalogVersionCbx;\r\n    private ComboBox<PartnerShort> partnerShortCbx; // replace with Partner Krzel\r\n    private ComboBox<Territory> territoryCbx;\r\n    private ComboBox<Currency> currencyCbx;\r\n    private ComboBox<Language> languageCbx;\r\n    private ComboBox<CustomerType> customerTypeCbx;\r\n    private Checkbox showDoubles;\r\n    private Checkbox useBaseAssortment;\r\n\r\n    private Checkbox s3Box;\r\n    private Checkbox hasPrice;\r\n    private Button deleteDoubles;\r\n    private DatePicker fromDate;\r\n    private DatePicker toDate;\r\n    private Button newLine;\r\n    private Button deleteLine;\r\n    private ImageButton saveNclose;\r\n    private TextField fieldTxt;\r\n    private final Binder<DataFile> bDataFile = new Binder<>();\r\n\r\n    private List<DataFile> selection;\r\n    private DataFile selected;\r\n    private KatalogVersion defaultKatalogVersion = null;\r\n    private final Setting sKatalogVersion;\r\n    private final User user;\r\n\r\n    public FileEditCrumb(Context ctx) {\r\n        super(ctx);\r\n\r\n        user = getCtx().getSession().getCurrentUser(getCtx());\r\n        selection = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n        if (Objects.isNull(selection) || selection.isEmpty()) {\r\n            selection = new ArrayList<>();\r\n            selected = new DataFile();\r\n            selected.setDate(ctx.getSession().getCurrentUser(ctx));\r\n            selected = getCtx().getServices().getDataFileService().save(selected);\r\n            setParameter(FileParam.FILE_TYPE, ObjectType.LA_INPUT, selected);\r\n            if (Objects.isNull(selection))\r\n                selection = new ArrayList<>();\r\n            selection.add(selected);\r\n            getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selection);\r\n        } else {\r\n            selected = selection.get(0);\r\n        }\r\n        bDataFile.setBean(selected);\r\n\r\n        sKatalogVersion = SettingUtils.getSettingByType(getCtx(), SettingType.DEFAULT_CATALOGVERSION);\r\n        Object oVersion = getParameter(FileParam.KATALOG_VERSION, selected);\r\n        Object oFrom = getParameter(FileParam.VALID_FROM, selected);\r\n        Object oTo = getParameter(FileParam.VALID_TO, selected);\r\n        if (Objects.nonNull(oVersion)) {\r\n            defaultKatalogVersion = (KatalogVersion) oVersion;\r\n        } else {\r\n            defaultKatalogVersion = CompUtils.getKatalogVersion(ctx, selected);\r\n        }\r\n\r\n        int iValid = 0;\r\n        if (Objects.isNull(oFrom)) {\r\n            setParameter(FileParam.VALID_FROM, defaultKatalogVersion.getValidFrom(), selected);\r\n            iValid++;\r\n        }\r\n        if (Objects.isNull(oTo)) {\r\n            setParameter(FileParam.VALID_TO, defaultKatalogVersion.getValidTo(), selected);\r\n            iValid++;\r\n        }\r\n        if (iValid > 1) {\r\n            setParameter(FileParam.KATALOG_VERSION, defaultKatalogVersion, selected);\r\n        }\r\n\r\n        setLanguageParamByCustomer(selected);\r\n\r\n        initKatalogVersion();\r\n        initFromDate();\r\n        initToDate();\r\n        initLanguage();\r\n        initTerritory();\r\n        initCurrency();\r\n        initPartnerShort();\r\n        initCustomerType();\r\n        initBaseAssortment();\r\n\r\n        katalogVersionCbx.setValue(defaultKatalogVersion);\r\n\r\n        initNewBtn();\r\n        initDeleteBtn();\r\n        initSaveBtn();\r\n        initSearchFld();\r\n        initShowDouble();\r\n        initDeleteDouble();\r\n        initECms();\r\n        initS3();\r\n        initHasPrice();\r\n\r\n        loadLayout();\r\n        reloadCrumb();\r\n    }\r\n\r\n    private void loadLayout() {\r\n        if (getComponentCount() > 0) {\r\n            removeAll();\r\n        }\r\n        initGrid();\r\n\r\n        VerticalLayout body = new VerticalLayout();\r\n        CompUtils.removeMSP(body, \"MP\");\r\n\r\n        HorizontalLayout buttons = new HorizontalLayout();\r\n        CompUtils.removeMSP(buttons, \"MSP\");\r\n\r\n        FormLayout form = new FormLayout();\r\n\r\n        form.addFormItem(katalogVersionCbx, getTranslation(TMS.FILE_EDIT_KATALOG_VERSION, getLocale(), getCtx()));\r\n        form.addFormItem(fromDate, getTranslation(TMS.FILE_EDIT_VALID_FROM, getLocale(), getCtx()));\r\n        form.addFormItem(toDate, getTranslation(TMS.FILE_EDIT_VALID_TO, getLocale(), getCtx()));\r\n        form.addFormItem(languageCbx, getTranslation(TMS.FILE_EDIT_LANGUAGE, getLocale(), getCtx()));\r\n        form.addFormItem(territoryCbx, getTranslation(TMS.FILE_EDIT_TERRITORY, getLocale(), getCtx()));\r\n        form.addFormItem(currencyCbx, getTranslation(TMS.FILE_EDIT_CURRENCY, getLocale(), getCtx()));\r\n        form.addFormItem(partnerShortCbx, getTranslation(TMS.FILE_EDIT_PARTNER_SHORT, getLocale(), getCtx()));\r\n        form.addFormItem(customerTypeCbx, getTranslation(TMS.FILE_EDIT_CUSTOMER_TYPE, getLocale(), getCtx()));\r\n        form.addFormItem(useBaseAssortment, getTranslation(TMS.FILE_EDIT_USE_BASE_ASSORTMENT, getLocale(), getCtx()));\r\n        if (getPermission(user, getServices(), this.getClass().getCanonicalName() + \".S3-Catalog\").isRead())\r\n            form.addFormItem(s3Box, getTranslation(TMS.FILE_EDIT_USE_S3_CATALOG, getLocale(), getCtx()));\r\n        form.addFormItem(hasPrice, getTranslation(TMS.FILE_EDIT_HAS_PRICE, getLocale(), getCtx()));\r\n\r\n        // wurde durch Ticket PDM-1778 nach absprache mit Kilian wieder deaktiviert\r\n        // form.addFormItem(eCmsBox, getTranslation(TMS.FILE_EDIT_E_CMS, getLocale(),\r\n        // getCtx()));\r\n\r\n        buttons.add(newLine, deleteLine, saveNclose, fieldTxt, showDoubles, deleteDoubles);\r\n\r\n        body.add(form, buttons, articleGrid);\r\n        body.setSizeFull();\r\n        add(body);\r\n    }\r\n\r\n    private void initSearchFld() {\r\n        fieldTxt = new TextField();\r\n        fieldTxt.setPlaceholder(getTranslation(TMS.FILE_EDIT_SEARCH_PLACEHOLDER, getLocale(), getCtx()));\r\n        fieldTxt.addValueChangeListener(event -> {\r\n            dataProvider.addFilter(ArticleBase::getArticleNr, name -> {\r\n                String nameLower = (name == null ? \"\" : name.toLowerCase(Locale.ENGLISH));\r\n                String filterLower = fieldTxt.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n            filters = dataProvider.getFilter();\r\n            articleGrid.setDataProvider(dataProvider);\r\n        });\r\n    }\r\n\r\n    private void initKatalogVersion() {\r\n        katalogVersionCbx = new ComboBox<>();\r\n        katalogVersionCbx.setClearButtonVisible(true);\r\n        katalogVersionCbx.setRequired(true);\r\n        List<KatalogVersion> versions = new ArrayList<>();\r\n        List<SettingParameter<KatalogVersion>> params = getCtx().getServices().getSettingParameterService().findAllBySettingOrderByDisplayOrder(sKatalogVersion);\r\n        params.removeIf(item -> item.getValue().getType().equals(ObjectType.ECAT));\r\n        params.forEach(item -> versions.add(item.getValue()));\r\n        katalogVersionCbx.setItems(versions);\r\n        katalogVersionCbx.setItemLabelGenerator(KatalogVersion::getVersion);\r\n        bDataFile.forField(katalogVersionCbx).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.KATALOG_VERSION, item), (\r\n                item, version) -> setParameter(FileParam.KATALOG_VERSION, version, item));\r\n    }\r\n\r\n    private void initFromDate() {\r\n        fromDate = new DatePicker();\r\n        fromDate.setRequired(true);\r\n        bDataFile.forField(fromDate).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.VALID_FROM, item), (\r\n                item, date) -> setParameter(FileParam.VALID_FROM, date, item));\r\n    }\r\n\r\n    private void initToDate() {\r\n        toDate = new DatePicker();\r\n        toDate.setRequired(true);\r\n        bDataFile.forField(toDate).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.VALID_TO, item), (\r\n                item, date) -> setParameter(FileParam.VALID_TO, date, item));\r\n    }\r\n\r\n    private void initNewBtn() {\r\n        newLine = new Button(VaadinIcon.PLUS.create());\r\n        newLine.addClickListener(event -> {\r\n            List<ArticleBase> articles = getArticles();\r\n            ArticleBase initial = new ArticleBase();\r\n            articles.add(0, initial);\r\n            reload(articles);\r\n        });\r\n    }\r\n\r\n    private void initDeleteBtn() {\r\n        deleteLine = new Button(VaadinIcon.CLOSE.create());\r\n        deleteLine.addClickListener(event -> {\r\n            List<ArticleBase> curSelected = new ArrayList<>();\r\n            curSelected.addAll(articleGrid.getSelectedItems());\r\n            if (!curSelected.isEmpty()) {\r\n                delArticles(curSelected);\r\n            }\r\n        });\r\n    }\r\n\r\n    private void onAccept(List<ArticleBase> articles) {\r\n        ObjectType type = getParameter(FileParam.FILE_TYPE, selected);\r\n\r\n        SaveArticlesToDataFileDialog dialog = new SaveArticlesToDataFileDialog(getCtx(), articles, type);\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    private void initSaveBtn() throws NullPointerException {\r\n        saveNclose = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        saveNclose.addClickListener(event -> {\r\n            List<ArticleBase> articles = new ArrayList<>();\r\n\r\n            bDataFile.validate();\r\n\r\n            try {\r\n                if (Objects.nonNull(dataProvider) && Objects.nonNull(dataProvider.getItems())\r\n                        && !dataProvider.getItems().isEmpty()) {\r\n                    articles.addAll(dataProvider.getItems());\r\n                    FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_ARTICLELIST_CONTAINS_DOUBLES);\r\n                }\r\n                if (bDataFile.isValid()) {\r\n                    List<String> list = new ArrayList<>();\r\n                    if (useBaseAssortment.getValue().booleanValue())\r\n                        list.add(\"BASIC\");\r\n                    if (s3Box.getValue().booleanValue())\r\n                        list.add(\"S3\");\r\n\r\n                    if (list.isEmpty() && articles.isEmpty()) {\r\n                        String description = getTranslation(TMS.FILE_EDIT_IMPEX_NO_ARTICLE_DESCRIPTION, getLocale(), getCtx());\r\n                        String accept = getTranslation(TMS.GLB_BUTTON_ACCEPT, getLocale(), getCtx());\r\n                        String cancel = getTranslation(TMS.GLB_BUTTON_CANCEL, getLocale(), getCtx());\r\n                        ConfirmDialog dialog = new ConfirmDialog(\"\", description, accept, eventCd -> {\r\n                            useBaseAssortment.setValue(Boolean.TRUE);\r\n                            onAccept(articles);\r\n                        });\r\n                        Button cancelBtn = new Button(cancel, eventB -> dialog.close());\r\n                        dialog.setCancelButton(cancelBtn);\r\n                        dialog.open();\r\n                    } else\r\n                        onAccept(articles);\r\n                }\r\n            } catch (DoubleFoundException e) {\r\n                showDoubles.setValue(true);\r\n                setDoubleFilter(true);\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_PRICELIST_CONTAINS_DOUBLES, getLocale(), getCtx()) + \": \" + e.getMessage());\r\n            }\r\n        });\r\n    }\r\n\r\n    private void initCustomerType() {\r\n        customerTypeCbx = new ComboBox<>();\r\n        customerTypeCbx.setClearButtonVisible(true);\r\n        customerTypeCbx.setItems(CustomerType.values());\r\n        customerTypeCbx.setRequired(true);\r\n\r\n        bDataFile.forField(customerTypeCbx).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.CUSTOMER_TYPE, item), (\r\n                item, value) -> setParameter(FileParam.CUSTOMER_TYPE, value, item));\r\n    }\r\n\r\n    private void initBaseAssortment() {\r\n        useBaseAssortment = new Checkbox();\r\n        bDataFile.forField(useBaseAssortment).bind(item -> getParameter(FileParam.BASE_ASSORTMENT, item), (item,\r\n                                                                                                           value) -> setParameter(FileParam.BASE_ASSORTMENT, value, item));\r\n    }\r\n\r\n    private void initECms() {\r\n        Checkbox eCmsBox = new Checkbox();\r\n        bDataFile.forField(eCmsBox).bind(item -> getParameter(FileParam.E_CMS, item), (item,\r\n                                                                                       value) -> setParameter(FileParam.E_CMS, value, item));\r\n    }\r\n\r\n    private void initS3() {\r\n        s3Box = new Checkbox();\r\n        s3Box.setReadOnly(!(getPermission(user, getServices(), this.getClass().getCanonicalName() + \".S3-Catalog\").isEdit()));\r\n        bDataFile.forField(s3Box).bind(item -> getParameter(FileParam.S3_CATALOG, item), (item,\r\n                                                                                          value) -> setParameter(FileParam.S3_CATALOG, value, item));\r\n    }\r\n\r\n    private void initHasPrice() {\r\n        hasPrice = new Checkbox();\r\n        bDataFile.forField(hasPrice).bind(item -> getParameter(FileParam.HAS_PRICE, item), (item,\r\n                                                                                            value) -> setParameter(FileParam.HAS_PRICE, value, item));\r\n\r\n        hasPrice.addValueChangeListener(event ->\r\n                reloadGridLayout()\r\n        );\r\n    }\r\n\r\n    private void initPartnerShort() {\r\n        partnerShortCbx = new ComboBox<>();\r\n        partnerShortCbx.setClearButtonVisible(true);\r\n        partnerShortCbx.setItems(getPartnerShorts());\r\n        partnerShortCbx.setItemLabelGenerator(item -> \" (\" + item.getId() + \") \" + item.getName());\r\n        partnerShortCbx.setRequired(true);\r\n\r\n        bDataFile.forField(partnerShortCbx).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.PARTNER_SHORT, item), (\r\n                item, value) -> setParameter(FileParam.PARTNER_SHORT, value, item));\r\n    }\r\n\r\n    private List<PartnerShort> getPartnerShorts() {\r\n        return SettingUtils.getAllSettingParameterValuesByType(getCtx(), SettingType.IMPEX_PARTNER_SHORT);\r\n    }\r\n\r\n    private void initCurrency() {\r\n        currencyCbx = new ComboBox<>();\r\n        currencyCbx.setClearButtonVisible(true);\r\n        currencyCbx.setItems(getServices().getEnumerationService().getAllCurrencies());\r\n        currencyCbx.setItemLabelGenerator(item -> item.getKey() + \" (\" + item.getLabel() + \")\");\r\n        currencyCbx.setRequired(true);\r\n\r\n        bDataFile.forField(currencyCbx).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.CURRENCY, item), (\r\n                item, currency) -> setParameter(FileParam.CURRENCY, currency, item));\r\n    }\r\n\r\n    private void initTerritory() {\r\n        territoryCbx = new ComboBox<>();\r\n        territoryCbx.setClearButtonVisible(true);\r\n        territoryCbx.setItems(getServices().getEnumerationService().getAllTerritories());\r\n        territoryCbx.setItemLabelGenerator(item -> item.getKey() + \" - \" + item.getLabel());\r\n        territoryCbx.setRequired(true);\r\n\r\n        bDataFile.forField(territoryCbx).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.TERRITORY, item), (\r\n                item, currency) -> setParameter(FileParam.TERRITORY, currency, item));\r\n    }\r\n\r\n    private void initLanguage() {\r\n        languageCbx = new ComboBox<>();\r\n        languageCbx.setClearButtonVisible(true);\r\n        languageCbx.setItems(getServices().getEnumerationService().getAllLanguages());\r\n        languageCbx.setItemLabelGenerator(item -> item.getLabel().split(\"-\")[0] + \" - \" + Locale.forLanguageTag(item.getLabel()).getDisplayLanguage(getLocale()));\r\n        languageCbx.setRequired(true);\r\n\r\n        bDataFile.forField(languageCbx).withValidator(Objects::nonNull, getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx())).asRequired().bind(item -> getParameter(FileParam.LANGUAGE, item), this::setSettingLanguage);\r\n    }\r\n\r\n    private void reloadGridLayout() {\r\n        articleGrid.removeAllColumns();\r\n\r\n        articleGrid.addEditColumn(ArticleBase::getArticleNr).text((item,\r\n                                                                   newValue) -> item.setArticleNr(newValue)).setHeader(getTranslation(TMS.FILE_EDIT_ARTICLE_NR, getLocale(), getCtx())).setSortable(true);\r\n\r\n        if (hasPrice.getValue().booleanValue()) {\r\n            articleGrid.addEditColumn(ArticleBase::getPriceFirstWithThousend).text(ArticleBase::setPriceFirst).setHeader(getTranslation(TMS.FILE_EDIT_PRICE_FIRST, getLocale(), getCtx())).setComparator((\r\n                    o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst())).setSortable(true);\r\n            articleGrid.addEditColumn(ArticleBase::getPriceXWithThousend).text(ArticleBase::setPriceX).setHeader(getTranslation(TMS.FILE_EDIT_PRICE_SCALE, getLocale(), getCtx())).setComparator((\r\n                    o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX())).setSortable(true);\r\n            articleGrid.addEditColumn(ArticleBase::getScalelimit).text(ArticleBase::setScalelimit).setHeader(getTranslation(TMS.FILE_EDIT_SCALE_LIMIT, getLocale(), getCtx())).setSortable(true);\r\n        }\r\n\r\n    }\r\n\r\n    private void initGrid() {\r\n\r\n        articleGrid = new GridPro<>();\r\n\r\n        reloadGridLayout();\r\n\r\n        articleGrid.setSelectionMode(SelectionMode.MULTI);\r\n    }\r\n\r\n    private void initShowDouble() {\r\n        showDoubles = new Checkbox(getTranslation(TMS.FILE_EDIT_SHOW_DOUBLES, getLocale(), getCtx()));\r\n        showDoubles.addClickListener(event -> setDoubleFilter(event.getSource().getValue()));\r\n    }\r\n\r\n    private void initDeleteDouble() {\r\n        deleteDoubles = new Button(getTranslation(TMS.FILE_EDIT_DELETE_DOUBLES, getLocale(), getCtx()));\r\n        deleteDoubles.addClickListener(event -> {\r\n            Map<String, ArticleBase> articleClean = new HashMap<>();\r\n            getArticles().forEach(item -> articleClean.put(item.getArticleNr(), item));\r\n            dataProvider = DataProvider.ofCollection(articleClean.values());\r\n            articleGrid.setDataProvider(dataProvider);\r\n        });\r\n    }\r\n\r\n    private void setDoubleFilter(boolean valid) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        articles.addAll(dataProvider.getItems());\r\n        if (valid) {\r\n            try {\r\n                FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_ARTICLELIST_CONTAINS_DOUBLES);\r\n            } catch (DoubleFoundException e) {\r\n                dataProvider.addFilter(ArticleBase::getArticleNr, e.getArticleNrs()::contains\r\n                );\r\n            }\r\n        } else {\r\n            dataProvider.clearFilters();\r\n        }\r\n        articleGrid.setDataProvider(dataProvider);\r\n    }\r\n\r\n    private void delArticles(List<ArticleBase> articles) {\r\n        List<ArticleBase> buffer = new ArrayList<>();\r\n        buffer.addAll(dataProvider.getItems());\r\n        buffer.removeAll(articles);\r\n\r\n        dataProvider = DataProvider.ofCollection(buffer);\r\n        articleGrid.setDataProvider(dataProvider);\r\n        if (Objects.nonNull(filters))\r\n            dataProvider.addFilter(filters);\r\n    }\r\n\r\n    private void reload(List<ArticleBase> articles) {\r\n        if (Objects.nonNull(getArticles()) && Objects.nonNull(articles)) {\r\n            dataProvider = DataProvider.ofCollection(articles);\r\n            articleGrid.setDataProvider(dataProvider);\r\n        }\r\n\r\n        if (Objects.nonNull(filters))\r\n            dataProvider.addFilter(filters);\r\n    }\r\n\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        log.debug(\"doBeforeNext not in use\");\r\n    }\r\n\r\n    @Override\r\n    public void exit() {\r\n        List<DataFile> files = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n        if (Objects.nonNull(files) && files.get(0).getName().isEmpty()) {\r\n            files.get(0).setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n            files.get(0).setDeleteOn(LocalDateTime.now());\r\n            getCtx().getServices().getDataFileService().save(files.get(0));\r\n        }\r\n\r\n        CloseDialog dialog = new CloseDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() ->\r\n                reload(getCtx().getUserSession().get(Params.ACTIVE_ARTICLES))\r\n        );\r\n    }\r\n\r\n    @Override\r\n    public List<ArticleBase> getArticles() {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        if (Objects.nonNull(dataProvider))\r\n            articles.addAll(dataProvider.getItems());\r\n        else\r\n            dataProvider = DataProvider.ofCollection(articles);\r\n        return articles;\r\n    }\r\n\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CURRENCY, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_TERRITORY, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n    }\r\n\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = getArticles();\r\n        dialog.getTable().forEach(row -> {\r\n            ArticleBase item = setPrice(row, dialog);\r\n            articles.add(item);\r\n        });\r\n\r\n        Map<Integer, String> colString = dialog.getTable().get(0);\r\n\r\n        // CURRENCY\r\n        if (dialog.getColumns()[1] > -1) {\r\n            String currency = dialog.getColumnsByIdx(colString, 1);\r\n            if (!currency.isEmpty()) {\r\n                List<Currency> items = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n                Optional<Currency> opt = items.stream().filter(item -> item.getKey().equals(currency)).findFirst();\r\n                opt.ifPresent(currencyCbx::setValue);\r\n            }\r\n        }\r\n        // LANGUAGE\r\n        if (dialog.getColumns()[2] > -1) {\r\n            String language = dialog.getColumnsByIdx(colString, 2);\r\n            if (!language.isEmpty()) {\r\n                List<Language> items = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n                Optional<Language> opt = items.stream().filter(item -> item.getLabel().contains(language)).findFirst();\r\n                opt.ifPresent(languageCbx::setValue);\r\n            }\r\n        }\r\n        // TERRITORY\r\n        if (dialog.getColumns()[3] > -1) {\r\n            String territory = dialog.getColumnsByIdx(colString, 3);\r\n            if (!territory.isEmpty()) {\r\n                List<Territory> items = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n                Optional<Territory> opt = items.stream().filter(item -> item.getKey().equals(territory)).findFirst();\r\n                opt.ifPresent(territoryCbx::setValue);\r\n            }\r\n        }\r\n\r\n        reload(articles);\r\n        getCtx().getUserSession().remove(Params.ACTIVE_ARTICLES);\r\n    }\r\n\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n\r\n        if (dialog.getColumns()[0] > -1) {\r\n            price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n        }\r\n        if (dialog.getColumns()[4] > -1) {\r\n            price.setPriceFirst(dialog.getColumnsByIdx(colString, 4));\r\n        }\r\n        if (dialog.getColumns()[5] > -1) {\r\n            price.setPriceX(dialog.getColumnsByIdx(colString, 5));\r\n        }\r\n        if (dialog.getColumns()[6] > -1) {\r\n            price.setPriceType(dialog.getColumnsByIdx(colString, 6));\r\n        }\r\n        return price;\r\n    }\r\n\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        List<ArticleBase> cArticles = getArticles();\r\n        cArticles.addAll(articles);\r\n        reload(cArticles);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FileEditCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FilterAddCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.la.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseUpdateRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.FilterType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.FromADDToINDIVIDUALCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToAssortmentDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToREMOVECrumbDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.splitlayout.SplitLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\n\r\n@BreadCrumb(TMS.CRB_FILTER_ADD)\r\n@SuppressWarnings(\"serial\")\r\npublic class FilterAddCrumb\r\n        extends\r\n        FilterCrumb {\r\n\r\n    private final ArticleDetailBox details;\r\n\r\n    private final Grid<Filterbase> rightFilterGrid;\r\n\r\n    public FilterAddCrumb(\r\n            Context ctx) {\r\n        super(ctx, new Accordion());\r\n\r\n        SplitLayout boxes = new SplitLayout();\r\n        boxes.setSizeFull();\r\n\r\n        details = new ArticleDetailBox(getCtx(), getArticles());\r\n        add(details, boxes);\r\n\r\n        getAccordion().add(buildMaterialAssigmentPanel());\r\n        getAccordion().add(builds3CatalogPanel());\r\n        getAccordion().add(buildNotInPimPanel());\r\n        getAccordion().add(buildNotApprovalPanel());\r\n        getAccordion().add(buildNotInPositivPanel());\r\n        getAccordion().add(buildRemoveByPositivPanel());\r\n        getAccordion().add(buildInvalidVtlStatusPanel());\r\n\r\n        VerticalLayout rightBox = new VerticalLayout();\r\n        rightFilterGrid = new Grid<Filterbase>();\r\n        rightFilterGrid.addColumn(Filterbase::getLabel).setHeader(getTranslation(TMS.FILTER_ADD_GRID_NAME, getLocale(), getCtx()));\r\n        rightFilterGrid.addColumn(Filterbase::getType).setHeader(getTranslation(TMS.FILTER_ADD_GRID_TYPE, getLocale(), getCtx()));\r\n        rightFilterGrid.setSelectionMode(SelectionMode.MULTI);\r\n        rightBox.add(getPanelHeader(TMS.FILTER_PANEL_BASE_LIST), rightFilterGrid);\r\n        boxes.addToPrimary(getAccordion());\r\n        boxes.addToSecondary(rightBox);\r\n        rightBox.getStyle().set(\"margin\", \"0em\");\r\n        rightBox.getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        DnDUtils.dragNdropToAdd(UI.getCurrent(), getCtx(), getAssigmendGrid().getGrid(), rightFilterGrid, FilterType.ZUORDNUNG_MATERIAL);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getAssigmendGrid().getGrid());\r\n        DnDUtils.dragNdropToAdd(UI.getCurrent(), getCtx(), getS3CatalogGrid().getGrid(), rightFilterGrid, FilterType.S3_CATALOGS);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getS3CatalogGrid().getGrid());\r\n    }\r\n\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(true);\r\n            setNextEnable(true);\r\n            setFinishEnable(true);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void reloadCrumb() {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        List<ArticleBase> articles = getArticles();\r\n        if (Objects.nonNull(articles)) {\r\n            details.reload(() -> articles);\r\n            Boolean value = getParameter(FileParam.BASE_ASSORTMENT, assortment);\r\n            if (Objects.nonNull(value) && !value.booleanValue() && articles.isEmpty()) {\r\n                setBoxVisible(getAssigmnedPanel(), false);\r\n                open(getS3CatalogPanel());\r\n            } else {\r\n                setBoxVisible(getAssigmnedPanel(), true);\r\n                loadAssigned();\r\n            }\r\n            if (getCtx().getUserSession().exists(Params.ACTIVE_S3_CATALOG)) {\r\n                setBoxVisible(getS3CatalogPanel(), true);\r\n                loadS3Catalogs();\r\n            } else {\r\n                setBoxVisible(getS3CatalogPanel(), false);\r\n            }\r\n\r\n            List<Filterbase> bases = new ArrayList<Filterbase>();\r\n            if (Objects.nonNull(assortment)) {\r\n                bases.addAll(getServices().getFilterBaseService().findAllByAssortmentAndDirectionAndDelete(assortment, Filterbase.ADD, false));\r\n                CompUtils.sortFilterBase(bases);\r\n            }\r\n            rightFilterGrid.setDataProvider(DataProvider.ofCollection(bases));\r\n            showExportPanels(getAccordion());\r\n\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public void goToNext() {\r\n        checkBefore(() -> {\r\n            ToREMOVECrumbDialog dialog = new ToREMOVECrumbDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    @Override\r\n    public void goToLast() {\r\n        checkBefore(() -> {\r\n            FromADDToINDIVIDUALCrumbDialog dialog = new FromADDToINDIVIDUALCrumbDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    @Override\r\n    public void goFinish() {\r\n        checkBefore(() -> {\r\n            SaveArticlesToAssortmentDialog dialog = new SaveArticlesToAssortmentDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    // things to do Before Jump to individual Save'N'Finish\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        FilterBaseUpdateRepository repo = getServices().getFilterBaseUpdateService();\r\n        for (FilterType type : FilterType.values()) {\r\n            if (FilterUtils.isValidProof(type)) {\r\n                dialog.setLabel(TMS.setProof(type));\r\n                repo.addArticleByFilter(getCtx(), type, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n            }\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FilterAddCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FilterIndividualCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.la.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.components.interfaces.GridReloadService;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToAssortmentDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SetIndividualFilterCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.html.Paragraph;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.splitlayout.SplitLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.Objects;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_FILTER_FINISH)\r\npublic class FilterIndividualCrumb extends FilterCrumb implements FileInputLoader, GridReloadService<ArticleBase> {\r\n\r\n    private List<ArticleBase> articles;\r\n    private final ArticleDetailBox details;\r\n\r\n    private GridPro<ArticleBase> rightGrid;\r\n    private final VerticalLayout rightBox = new VerticalLayout();\r\n    private DownloadButton downloadBtn;\r\n    private final Paragraph foundArticle = new Paragraph(\"\");\r\n\r\n    public FilterIndividualCrumb(Context ctx) {\r\n        super(ctx, new Accordion());\r\n\r\n        articles = getArticles();\r\n        if (Objects.isNull(articles)) {\r\n            articles = new ArrayList<ArticleBase>();\r\n        }\r\n\r\n        getAccordion().add(buildIndividualPanel(this));\r\n        getAccordion().add(buildRemovePanel());\r\n        getAccordion().add(buildImportPanel());\r\n        getAccordion().add(buildNotInPimPanel());\r\n        getAccordion().add(buildNotApprovalPanel());\r\n        getAccordion().add(buildNotInPositivPanel());\r\n        getAccordion().add(buildRemoveByPositivPanel());\r\n        getAccordion().add(buildInvalidVtlStatusPanel());\r\n\r\n        rightBox.add(getPanelHeader(TMS.FILTER_PANEL_INDIVIDUAL_LIST));\r\n        setRightGrid();\r\n\r\n        SplitLayout boxes = new SplitLayout();\r\n        boxes.setSizeFull();\r\n\r\n        reload(null);\r\n\r\n        details = new ArticleDetailBox(getCtx(), articles);\r\n        add(details, boxes);\r\n\r\n        boxes.addToPrimary(getAccordion());\r\n        boxes.addToSecondary(rightBox);\r\n        rightBox.getStyle().set(\"margin\", \"0em\");\r\n        rightBox.getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        DnDUtils.dragNaddRemoved(UI.getCurrent(), getCtx(), getRemoveGrid().getGrid(), rightGrid);\r\n        DnDUtils.dragNImportOrDelete(UI.getCurrent(), getCtx(), getImportGrid().getGrid(), rightGrid);\r\n    }\r\n\r\n    private void setRightGrid() {\r\n        Button deleteBtn = new Button();\r\n        deleteBtn.setIcon(VaadinIcon.CLOSE.create());\r\n\r\n        deleteBtn.addClickListener(event -> {\r\n            SetIndividualFilterCrumb dialog = new SetIndividualFilterCrumb(getCtx(), rightGrid.getSelectedItems(), this);\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n\r\n        HorizontalLayout buttonBay = new HorizontalLayout();\r\n        CompUtils.removeMSP(buttonBay, \"MP\");\r\n        downloadBtn = new DownloadButton(getCtx(), TMS.FILTER_INDIVIDUAL_DOWNLOAD_TOOLTIP);\r\n        buttonBay.add(deleteBtn, downloadBtn, foundArticle);\r\n        downloadBtn.setVisible(false);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_INDIVIDUAL_DOWNLOAD, downloadBtn);\r\n\r\n        rightGrid = new GridPro<ArticleBase>();\r\n\r\n        String notFound = getTranslation(TMS.FILTER_INDIVIDUAL_NO_PRODUCT_NAME_FOUND, getLocale(), getCtx()) + \"(\"\r\n                + getLocale().toLanguageTag() + \")\";\r\n        rightGrid.addColumn(ArticleBase::getArticleNr)\r\n                .setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_ARTICLE_NR, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setFlexGrow(1);\r\n        rightGrid.addColumn(item -> {\r\n                    String value = item.getProductName();\r\n                    if (value.isEmpty()) {\r\n                        value = notFound;\r\n                    }\r\n                    return value;\r\n                }).setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_PRODUCT_NAME, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setFlexGrow(4);\r\n\r\n        rightGrid.setSelectionMode(SelectionMode.MULTI);\r\n        rightBox.add(buttonBay, rightGrid);\r\n    }\r\n\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(true);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            List<ArticleBase> articles = getArticles();\r\n            if (Objects.nonNull(articles)) {\r\n                details.reload(() -> articles);\r\n                // reload\r\n                loadIndividual();\r\n                loadRemoved();\r\n                loadImport();\r\n                reload(null);\r\n\r\n                showExportPanels(getAccordion());\r\n                onFoundChanged();\r\n            }\r\n        });\r\n    }\r\n\r\n    // things to do Before Jump to Save'N'Finish\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        FilterRunUtils.reloadIndividualFilter(getCtx(), dialog);\r\n    }\r\n\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    @Override\r\n    public void goFinish() {\r\n        checkBefore(() -> {\r\n            SaveArticlesToAssortmentDialog dialog = new SaveArticlesToAssortmentDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightGrid.getDataProvider());\r\n    }\r\n\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n    }\r\n\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = new ArrayList<ArticleBase>();\r\n        dialog.getTable().forEach(row -> articles.add(setPrice(row, dialog)));\r\n        getImportGrid().reload(articles);\r\n    }\r\n\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n\r\n        if (dialog.getColumns()[0] > -1) {\r\n            price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n        }\r\n        return price;\r\n    }\r\n\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        getImportGrid().reload(articles);\r\n    }\r\n\r\n    @Override\r\n    public void onFoundChanged() {\r\n        UI.getCurrent().access(() -> {\r\n            foundArticle.setText(CompUtils.filterGridObjects(getCtx(), rightGrid));\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void reload(List<ArticleBase> items) {\r\n        if (Objects.isNull(items) || items.isEmpty()) {\r\n            getCtx().getUserSession().remove(Params.ACTIVE_INDIVIDUAL_PROVIDER);\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            items = articleService.findAllByFilterStatus(getCtx(), \"IN\", FilterStatus.DEFAULT);\r\n        }\r\n        rightGrid.setDataProvider(DataProvider.ofCollection(items));\r\n    }\r\n\r\n    @SuppressWarnings(\"unchecked\")\r\n    @Override\r\n    public ListDataProvider<ArticleBase> getDataProvider() {\r\n        return (ListDataProvider<ArticleBase>) rightGrid.getDataProvider();\r\n    }\r\n\r\n    @Override\r\n    public <F> void setDataProvider(DataProvider<ArticleBase, F> dataProvider) {\r\n        rightGrid.setDataProvider(dataProvider);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FilterIndividualCrumb.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-rdKhTYTLiG7LzUlQyfOQQ6uQ3ixgwJnN",
    "created" : 1762171802,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"src/main/java/com/hom/ebmw/view/sortment/eshop/crumb/LoaderCrumb.java\",\n  \"issues\": [\n    {\n      \"severity\": \"High\",\n      \"problem\": \"NullPointerException risk: downloadBtn is accessed before initialization\",\n      \"justification\": \"setAssortmentGrid() registers a selection listener that calls downloadBtn.setEnabled(false) while downloadBtn is still null (initialised later in setRightButtons()). This will throw NPE during UI construction.\",\n      \"action\": \"Initialize downloadBtn before registering the listener or move listener registration after setRightButtons(). Add a nullcheck guard if downloadBtn may be absent.\",\n      \"source\": \"setAssortmentGrid()  line where downloadBtn.setEnabled(false)\",\n      \"component\": \"UI/LoaderCrumb\",\n      \"impact_scope\": \"prodrelevant, UI crash\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Threading misuse in PreviewCrumb.loadGrid (also affects LoaderCrumb indirectly)\",\n      \"justification\": \"Spawning raw Thread to update Vaadin UI may violate Vaadins singlethread rule, causing race conditions, UI inconsistencies, and possible memory leaks if threads accumulate.\",\n      \"action\": \"Replace raw Thread with UI.access() inside a background ExecutorService or Vaadins UI background task (e.g., @Push + UI.access). Ensure threads are terminated and limit concurrency.\",\n      \"source\": \"PreviewCrumb.loadGrid()  new Thread(() -> { ui.access(...); }).start()\",\n      \"component\": \"PreviewCrumb\",\n      \"impact_scope\": \"prodrelevant, performance and stability\",\n      \"relations\": \"Duplicate of issue 1 (thread safety)\",\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Assumption of nonempty articles list in setDefaultParameterToDataFile\",\n      \"justification\": \"Method accesses articles.get(0) without checking size, leading to IndexOutOfBoundsException when the list is empty (e.g., user uploads an empty file).\",\n      \"action\": \"Validate that articles is not empty before using articles.get(0); fallback to defaults or abort with user-friendly error.\",\n      \"source\": \"setDefaultParameterToDataFile(List<ArticleBase> articles, AstFile save)\",\n      \"component\": \"LoaderCrumb\",\n      \"impact_scope\": \"prodrelevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Potential unchecked NullPointerException in reloadDatafileGrid / reloadAssortmentGrid filtering\",\n      \"justification\": \"The lambda checks ObjectType value = getParameter(...); then calls value.equals(...). If getParameter returns null, NPE occurs.\",\n      \"action\": \"Replace value.equals(...) with Objects.equals(value, ObjectType.IMPEX_INPUT) or add null guard before equals.\",\n      \"source\": \"reloadDatafileGrid() and reloadAssortmentGrid() filters\",\n      \"component\": \"LoaderCrumb\",\n      \"impact_scope\": \"prodrelevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Swallowing generic Exception in openAssortment\",\n      \"justification\": \"Catching generic Exception and only logging debug hides real errors from the user and makes debugging harder.\",\n      \"action\": \"Catch specific exceptions, surface userfriendly error notifications, and log at WARN/ERROR level.\",\n      \"source\": \"openAssortment()  catch (Exception e)\",\n      \"component\": \"LoaderCrumb\",\n      \"impact_scope\": \"maintenance\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Missing confirmation dialog before bulk delete in setLeftButtons.deleteVersion\",\n      \"justification\": \"User can accidentally delete multiple DataFile entries without prompt, leading to data loss.\",\n      \"action\": \"Add a ConfirmDialog asking for confirmation before performing delete; abort if cancelled.\",\n      \"source\": \"setLeftButtons()  deleteVersion button click handler\",\n      \"component\": \"UI/LoaderCrumb\",\n      \"impact_scope\": \"userexperience\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Potential memory leak: dataProvider objects recreated frequently without disposal\",\n      \"justification\": \"Methods like reloadDatafileGrid/create new DataProvider.ofCollection() on each refresh may retain old references, increasing GC pressure.\",\n      \"action\": \"Reuse existing DataProvider where possible or call setItems() on the same provider; ensure old providers are dereferenced.\",\n      \"source\": \"reloadDatafileGrid(), reloadAssortmentGrid()\",\n      \"component\": \"LoaderCrumb\",\n      \"impact_scope\": \"performance\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Hardcoded magic numbers in UI component sizing (e.g., setFlexGrow values)\",\n      \"justification\": \"Magic numbers reduce readability and make UI adjustments errorprone.\",\n      \"action\": \"Replace with named constants or configuration values; document intent.\",\n      \"source\": \"setDatafileGrid() and setAssortmentGrid() column definitions\",\n      \"component\": \"UI/LoaderCrumb\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Inconsistent naming: variable serviceXcross vs serviceXCross\",\n      \"justification\": \"Inconsistent naming hampers maintainability and may cause confusion.\",\n      \"action\": \"Rename to a consistent, descriptive name (e.g., assortmentDataFileDao).\",\n      \"source\": \"copyAssortment()  AssortmentDataFileDAO serviceXcross\",\n      \"component\": \"LoaderCrumb\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Lack of input validation for parameters passed to setParameter\",\n      \"justification\": \"Parameters like ObjectType, Dates, etc., are set without validation, risking invalid session state.\",\n      \"action\": \"Add validation checks before calling setParameter; reject or correct invalid values; write unit tests for parameter handling.\",\n      \"source\": \"Various setParameter calls throughout the class\",\n      \"component\": \"LoaderCrumb\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"2\",\n    \"top_todos\": [\n      \"Initialize downloadBtn before using it in assortment grid listener to prevent NPE\",\n      \"Replace raw Thread usage with proper Vaadin UI background tasks to avoid threading issues\",\n      \"Add nullguards for getParameter() results before calling equals\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to output JSON with analysis of each file/chunk? The instruction: \"Du analysierst jeweils einen Code-Chunk.\" It seems we need to produce one JSON object per file? Probably combine? The schema includes \"file\": string. Could provide for each file separate? Probably we need one JSON per file. But output must be a single JSON object. Could include multiple issues across files? Usually one per file. But we have many files; maybe produce one JSON for each file separately? The spec says answer must be a single JSON object. So maybe we should pick the main file (LoaderCrumb) and produce analysis. But could also aggregate across all files? Might be too many issues. Let's focus on LoaderCrumb.java as primary.\n\nWe'll generate issues up to 10. Identify problems:\n\n1. Potential NPE: downloadBtn may be null when used in setAssortmentGrid selection listener before init. In setAssortmentGrid, downloadBtn.setEnabled(false) before downloadBtn initialized in setRightButtons (called later). However setAssortmentGrid called in constructor before setRightButtons, leading NPE. Severity High.\n\n2. Thread usage in PreviewCrumb loadGrid: new Thread accesses UI without proper UI lock; may cause concurrency issues. Also no thread pool, possible resource leak.\n\n3. In LoaderCrumb, setDatafileGrid selection listener stores List<DataFile> into session; storing mutable list may cause concurrency issues.\n\n4. In directSave and doOnSave, use ExportFileUtils.buildImpexFile which may produce large files on UI thread, could block UI.\n\n5. In setDefaultParameterToDataFile, assumes articles list non-empty (articles.get(0)) without check leads IndexOutOfBounds if empty.\n\n6. In setDatafileGrid, dataFileGrid.setSelectionMode(MULTI) but later selection handling expects list of selected items; potential large memory.\n\n7. In openAssortment, catch generic Exception and just log debug; may swallow errors.\n\n8. In copyAssortment, using serviceXcross variable naming inconsistent.\n\n9. In LoaderCrumb.reloadAssortmentGrid, uses getParameter(FileParam.FILE_TYPE, item) but may be null leading to NPE later when calling equals.\n\n10. In setLeftButtons deleteVersion, deletes selected items but no confirmation dialog; risk accidental deletion.\n\nWe'll produce JSON with these issues.\n\nAdd summary rating maybe 2 stars.\n\nNow craft JSON."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 2014,
      "prompt_tokens" : 25987,
      "total_tokens" : 28001
    },
    "timings" : {
      "cache_n" : 62,
      "prompt_n" : 25925,
      "prompt_ms" : 19287.331,
      "prompt_per_token_ms" : 0.7439664802314367,
      "prompt_per_second" : 1344.1465799492942,
      "predicted_n" : 2014,
      "predicted_ms" : 24336.186,
      "predicted_per_token_ms" : 12.083508440913606,
      "predicted_per_second" : 82.75742139709156
    }
  }
}