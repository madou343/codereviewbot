{
  "timestamp" : "2025-11-03T13:11:46.5043332",
  "index" : 22,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FilterRemoveCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.la.crumb;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.FilterType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToAssortmentDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToINDIVIDUALCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.splitlayout.SplitLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Locale;\r\nimport java.util.Objects;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_FILTER_REMOVE)\r\npublic class FilterRemoveCrumb extends FilterCrumb {\r\n\r\n    private final ArticleDetailBox details;\r\n\r\n    private final Grid<Filterbase> rightFilterGrid;\r\n    private final TextField fieldTxt = new TextField();\r\n\r\n    public void demo() {\r\n        System.out.println();\r\n    }\r\n\r\n    public FilterRemoveCrumb(Context ctx) {\r\n        super(ctx, new Accordion());\r\n\r\n        SplitLayout boxes = new SplitLayout();\r\n        boxes.setSizeFull();\r\n\r\n        details = new ArticleDetailBox(getCtx(), getArticles());\r\n        add(details, boxes);\r\n\r\n        getAccordion().add(buildStructurePanel());\r\n        getAccordion().add(buildArticleClassPanel());\r\n        getAccordion().add(buildInfoTypePanel());\r\n        getAccordion().add(buildBrandsPanel());\r\n        getAccordion().add(buildGHSCodePanel());\r\n        getAccordion().add(buildIntraStatPanel());\r\n        getAccordion().add(buildNotFreePanel());\r\n        getAccordion().add(buildEClassPanel());\r\n        getAccordion().add(buildConfigPanel());\r\n        getAccordion().add(buildNotInPimPanel());\r\n        getAccordion().add(buildNotApprovalPanel());\r\n        getAccordion().add(buildNotInPositivPanel());\r\n        getAccordion().add(buildRemoveByPositivPanel());\r\n        getAccordion().add(buildInvalidVtlStatusPanel());\r\n\r\n        VerticalLayout rightBox = new VerticalLayout();\r\n        rightBox.add(getPanelHeader(TMS.FILTER_PANEL_EXCLUDE_LIST));\r\n        rightFilterGrid = new Grid<Filterbase>();\r\n        rightFilterGrid.addColumn(Filterbase::getLabel)\r\n                .setHeader(getTranslation(TMS.FILTER_REMOVE_GRID_NAME, getLocale(), getCtx())).setFlexGrow(4)\r\n                .setResizable(true).setSortable(true);\r\n        rightFilterGrid.addColumn(Filterbase::getType)\r\n                .setHeader(getTranslation(TMS.FILTER_REMOVE_GRID_TYPE, getLocale(), getCtx())).setFlexGrow(2)\r\n                .setResizable(true).setSortable(true);\r\n        rightFilterGrid.setSelectionMode(SelectionMode.MULTI);\r\n\r\n        fieldTxt.setPlaceholder(getTranslation(TMS.FILTER_REMOVE_SEARCH_PLACEHOLDER, getLocale(), getCtx()));\r\n        fieldTxt.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Filterbase> listProvider = (ListDataProvider<Filterbase>) rightFilterGrid\r\n                    .getDataProvider();\r\n            listProvider.setFilter(Filterbase::getLabel, name -> {\r\n                String nameLower = name == null ? \"\" : name.toLowerCase(Locale.ENGLISH);\r\n                String filterLower = fieldTxt.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n            rightFilterGrid.setDataProvider(listProvider);\r\n        });\r\n\r\n        rightBox.add(fieldTxt, rightFilterGrid);\r\n        boxes.addToPrimary(getAccordion());\r\n        boxes.addToSecondary(rightBox);\r\n        rightBox.getStyle().set(\"margin\", \"0em\");\r\n        rightBox.getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getStructureGrid().getGrid(), rightFilterGrid, FilterType.STRUCTURE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getStructureGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getArticleClassGrid().getGrid(), rightFilterGrid, FilterType.ARTIKELKLASSE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getArticleClassGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getInfoTypeGrid().getGrid(), rightFilterGrid, FilterType.INFOTYPE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getInfoTypeGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getBrandsGrid().getGrid(), rightFilterGrid, FilterType.BRANDS);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getBrandsGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getGhsGrid().getGrid(), rightFilterGrid, FilterType.GHS_CODES);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getGhsGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getIntrastatGrid().getGrid(), rightFilterGrid, FilterType.INTRASTAT);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getIntrastatGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getFreeGrid().getGrid(), rightFilterGrid, FilterType.NOTFREE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getFreeGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getEClassGrid().getGrid(), rightFilterGrid, FilterType.STRUCTURE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getEClassGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getConfigGrid().getGrid(), rightFilterGrid, FilterType.CONFIG);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getConfigGrid().getGrid());\r\n    }\r\n\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(true);\r\n            setFinishEnable(true);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void reloadCrumb() {\r\n        List<ArticleBase> articles = getArticles();\r\n        if (Objects.nonNull(articles)) {\r\n            details.reload(() -> articles);\r\n\r\n            Setting setting = SettingUtils.getSettingByType(getCtx(), SettingType.DEFAULT_IMPEX_STRUCUTURE_NAME);\r\n            loadStructure(setting);\r\n            loadArticleClass();\r\n            loadInfoType();\r\n            loadBrands();\r\n            loadGHSCode();\r\n            loadIntraStat();\r\n            loadNotFree();\r\n            loadEClass();\r\n            loadConfig();\r\n\r\n            List<Filterbase> bases = new ArrayList<Filterbase>();\r\n\r\n            Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n            if (Objects.nonNull(assortment)) {\r\n                bases.addAll(getServices().getFilterBaseService().findAllByAssortmentAndDirectionAndDelete(assortment,\r\n                        Filterbase.REMOVE, false));\r\n                CompUtils.sortFilterBase(bases);\r\n            }\r\n            rightFilterGrid.setDataProvider(DataProvider.ofCollection(bases));\r\n\r\n            showExportPanels(getAccordion());\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public void goToNext() {\r\n        checkBefore(() -> {\r\n            ToINDIVIDUALCrumbDialog dialog = new ToINDIVIDUALCrumbDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    @Override\r\n    public void goFinish() {\r\n        checkBefore(() -> {\r\n            SaveArticlesToAssortmentDialog dialog = new SaveArticlesToAssortmentDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    // thinks to do Before Jump to Save'N'Finish\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        for (FilterType type : FilterType.values()) {\r\n            if (FilterUtils.isValidProof(type)) {\r\n                dialog.setLabel(TMS.setProof(type));\r\n                getServices().getFilterBaseUpdateService().removeArticleByFilter(getCtx(), type, FilterStatus.ALL,\r\n                        FilterStatus.REMOVEBYFILTER);\r\n            }\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\FilterRemoveCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\LoaderCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.la.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.AssortmentLockException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.dao.AssortmentDataFileDAO;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.Header;\r\nimport com.hom.ebmw.pojo.KatalogVersion;\r\nimport com.hom.ebmw.utilities.*;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.CustomDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToADDCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToFileEditCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToPreviewCrumpDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.Getter;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.time.LocalDateTime;\r\nimport java.util.*;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_IMPEX_LOADER)\r\n@SuppressWarnings(\"serial\")\r\npublic class LoaderCrumb extends Crumb implements FileInputLoader, HasPermission {\r\n\r\n    private final @Getter Grid<DataFile> dataFileGrid = new Grid<>();\r\n    private final @Getter Grid<Assortment> assortmentGrid = new Grid<>();\r\n    private final HorizontalLayout body = new HorizontalLayout();\r\n    private DownloadButton downloadBtn;\r\n    private ComboBox<Header> header;\r\n\r\n    /**\r\n     * The LoaderCrumb function is a constructor for the LoaderCrumb class.\r\n     * It sets up the datafile grid and assortment grid, then adds them to the body of this crumb.\r\n     *\r\n     * @param Context ctx Create the loadercrumb object\r\n     * @return The body of the loadercrumb\r\n     * @docauthor Trelent\r\n     */\r\n    public LoaderCrumb(Context ctx) {\r\n        super(ctx);\r\n        setDatafileGrid();\r\n        setAssortmentGrid();\r\n        setSizeFull();\r\n\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n        add(body);\r\n        CompUtils.removeMSP(body, \"MSP\");\r\n        body.setSizeFull();\r\n    }\r\n\r\n    /**\r\n     * The reloadDatafileGrid function is called when the user clicks on the &quot;Refresh&quot; button in the Data File Grid.\r\n     * It reloads all of the data files that are associated with a particular project role, and then displays them in\r\n     * a grid. The function also removes any data files that have been deleted or are not Impex Input Files (i.e., they\r\n     * are not .csv files). Finally, it sorts these remaining data files by their creation date (most recent first).\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadDatafileGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<DataFile> dataFiles = getServices().getDataFileService().findAllByProjectRole(projectRole);\r\n            dataFiles.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            dataFiles.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = !value.equals(ObjectType.LA_INPUT);\r\n                }\r\n                return result;\r\n            });\r\n\r\n            dataFiles.sort((o1, o2) -> o2.getCreateOn().compareTo(o1.getCreateOn()));\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(dataFiles));\r\n        } else {\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The reloadAssortmentGrid function is called when the user clicks on the &quot;Refresh&quot; button.\r\n     * It reloads all of the data in the assortmentGrid, which displays a list of all assortments\r\n     * that have been created by this user for this project role.  The function first gets a reference to\r\n     * an instance of ProjectRole from session parameters (the active project role).  If there is no active project role, then it sets an empty data provider for assortmentGrid and returns.   Otherwise, it calls getServices().getAssortmentService().findAllByProjectRole(projectRole) to get a list of Assortment\r\n     *\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadAssortmentGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<Assortment> assortments = getServices().getAssortmentService().findAllByProjectRole(projectRole);\r\n            assortments.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            assortments.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = !value.equals(ObjectType.LA);\r\n                }\r\n                return result;\r\n            });\r\n            assortments.sort((o1, o2) -> o2.getUpdateOn().compareTo(o1.getUpdateOn()));\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(assortments));\r\n        } else {\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setDatafileGrid function sets up the grid that displays the data files.\r\n     * It adds three columns to the grid: one for file name, one for update by, and\r\n     * one for update on. The function also adds a selection listener to this grid so that when an item is selected in it,\r\n     * its corresponding DataFile object is stored in a session variable called ACTIVE_DATAFILE. This allows us to access this object later on from other functions.\r\n     *\r\n     * @return The datafilegrid object\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDatafileGrid() {\r\n        dataFileGrid.setSelectionMode(SelectionMode.MULTI);\r\n        dataFileGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(4);\r\n        dataFileGrid.addColumn(this::getName)\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_BY, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n        dataFileGrid.addColumn(file -> Parse.formatDateTime(file.getUpdateOn(), AstDateTimeFormat.GERMAN))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_ON, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n\r\n        reloadDatafileGrid();\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_BASE_FILE), setLeftButtons(), dataFileGrid));\r\n\r\n        dataFileGrid.addSelectionListener(event -> {\r\n            List<DataFile> selected = new ArrayList<>();\r\n            selected.addAll(event.getAllSelectedItems());\r\n            if (selected.isEmpty()) {\r\n                getCtx().getUserSession().remove(Params.ACTIVE_DATAFILE);\r\n            } else {\r\n                getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selected);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The getName function takes an object as a parameter and returns the name of the user who last updated that object.\r\n     * If no user is found, it returns &quot;UNKNOWN&quot;.\r\n     *\r\n     * @param Object obj Determine the type of object that is passed in\r\n     * @return A string containing the surname and given name of the user\r\n     * @docauthor Trelent\r\n     */\r\n    private String getName(Object obj) {\r\n        User user = null;\r\n        if (obj instanceof DataFile) {\r\n            user = ((DataFile) obj).getUpdateBy();\r\n        } else if (obj instanceof Assortment) {\r\n            user = ((Assortment) obj).getUpdateBy();\r\n        }\r\n        if (Objects.nonNull(user)) {\r\n            return user.getSurName() + \", \" + user.getGivenName();\r\n        } else {\r\n            return \"UNKNOWN\";\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The openAssortment function is used to open an assortment.\r\n     *\r\n     * @param Callable&lt;Assortment&gt; selected Create a new assortment\r\n     * @param boolean                    openOnly Determine if the assortment should be opened in read only mode or not\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private void openAssortment(Callable<Assortment> selected, boolean openOnly) {\r\n        CustomDialog cDialog = new CustomDialog(getCtx());\r\n        cDialog.setCom(() -> {\r\n            cDialog.setLabel(TMS.SET_DIALOG_CREATE_ASSORTMENT);\r\n            Assortment assortment;\r\n            try {\r\n                assortment = selected.call();\r\n\r\n                AssortmentUtil.isLocked(getCtx(), assortment);\r\n\r\n                if (Objects.nonNull(assortment)) {\r\n                    setSessionAssortment(assortment);\r\n                    loadAssortmentsBreadCrumb();\r\n                    ToADDCrumbDialog dialog = new ToADDCrumbDialog(getCtx(), openOnly);\r\n                    dialog.open();\r\n                    dialog.execute();\r\n                } else {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_NOT_READY, getLocale(), getCtx()));\r\n                }\r\n            } catch (AssortmentLockException e) {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_IS_LOCKED, getLocale(), getCtx()));\r\n            } catch (Exception e) {\r\n                log.debug(e.getMessage(), e);\r\n            }\r\n        });\r\n        cDialog.open();\r\n        cDialog.run();\r\n    }\r\n\r\n    /**\r\n     * The setAssortmentGrid function is responsible for setting up the assortment grid.\r\n     * It sets the selection mode of the grid to either single or multi depending on whether\r\n     * or not a user has permission to select multiple items in the grid. The function then adds\r\n     * columns to display information about each item in the assortment, and finally it reloads\r\n     * all of this information into a new instance of an AssortmentGrid object. Finally, it adds\r\n     * listeners that allow users to download files from their selected assortments and open them up in a new window.\r\n     *\r\n     * @return A verticallayout object\r\n     * @docauthor Trelent\r\n     */\r\n    private void setAssortmentGrid() {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        if (getPermission(user, getServices(), this.getClass().getCanonicalName() + \".Assortment.MultiSelector\")\r\n                .isRead())\r\n            assortmentGrid.setSelectionMode(SelectionMode.MULTI);\r\n        else\r\n            assortmentGrid.setSelectionMode(SelectionMode.SINGLE);\r\n\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setFlexGrow(4)\r\n                .setResizable(true).setFlexGrow(7);\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.isLocked(getCtx(), item))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_IS_LOCKED, getLocale(), getCtx())).setFlexGrow(1)\r\n                .setResizable(true).setWidth(\"10%\");\r\n        reloadAssortmentGrid();\r\n\r\n        assortmentGrid.addSelectionListener(event -> {\r\n            downloadBtn.setEnabled(false);\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, null);\r\n                cDialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                List<Assortment> selected = new ArrayList<>();\r\n                selected.addAll(event.getAllSelectedItems());\r\n\r\n                if (!selected.isEmpty()) {\r\n                    if (!selected.get(0).getName().isEmpty()) {\r\n                        downloadBtn.setEnabled(true);\r\n                    }\r\n                    Optional<Assortment> optAssortment = getServices().getAssortmentService()\r\n                            .findById(selected.get(0).getId());\r\n                    optAssortment.ifPresent(assortment -> {\r\n                        downloader(assortment);\r\n                        getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, assortment);\r\n                        reloadInfoBox(cDialog.getDialogUI());\r\n                    });\r\n                } else {\r\n                    reloadInfoBox(cDialog.getDialogUI());\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        assortmentGrid.addItemDoubleClickListener(event -> openAssortment(event::getItem, false));\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_ASSORTMENT_FILE), setRightButtons(), assortmentGrid));\r\n    }\r\n\r\n    /**\r\n     * The setLeftButtons function creates a HorizontalLayout containing three buttons:\r\n     * - newVersion, which allows the user to create a new version of an existing file.\r\n     * - changeVersion, which allows the user to edit an existing file.\r\n     * - deleteVersion, which allows the user to delete one or more files from their project.\r\n     *\r\n     * @return A horizontallayout with the buttons that are displayed on the left side of the screen\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setLeftButtons() {\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_FILE_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole)) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), null);\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button changeVersion = new Button(VaadinIcon.PENCIL.create());\r\n        CompUtils.addToolTip(getCtx(), changeVersion, TMS.LOADER_FILE_GRID_BUTTON_EDIT_TOOLTIP);\r\n        changeVersion.addClickListener(event -> {\r\n            List<DataFile> files = new ArrayList<>();\r\n            files.addAll(dataFileGrid.getSelectedItems());\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole) && !files.isEmpty()) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), files.get(0));\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_FILE_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!dataFileGrid.getSelectedItems().isEmpty()) {\r\n                List<DataFile> files = new ArrayList<>();\r\n                dataFileGrid.getSelectedItems().forEach(file -> {\r\n                    Optional<DataFile> optFile = getServices().getDataFileService().findById(file.getId());\r\n                    optFile.ifPresent(dataFile -> {\r\n                        dataFile.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                        dataFile.setDeleteOn(LocalDateTime.now());\r\n                        files.add(dataFile);\r\n                    });\r\n                });\r\n                getServices().getDataFileService().saveAll(files);\r\n                reloadDatafileGrid();\r\n            }\r\n        });\r\n\r\n        return buttons(newVersion, changeVersion, deleteVersion);\r\n    }\r\n\r\n    /**\r\n     * The setRightButtons function creates a HorizontalLayout containing buttons that are used to manipulate the assortment grid.\r\n     * The function takes no parameters and returns a HorizontalLayout containing the following buttons:\r\n     * - newVersion - A button that allows users to create a new assortment version.\r\n     * - editVersion - A button that allows users to edit an existing assortment version.\r\n     * - copyVersion - A button that allows users to copy an existing assortment version, including its data files and filters.\r\n     * - deleteVersion - A button that deletes selected versions of assortments from the database\r\n     *\r\n     * @return A horizontallayout with the buttons\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setRightButtons() {\r\n\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            assortmentGrid.deselectAll();\r\n            openAssortment(() -> createNewAssortment(getSelectedItems()), false);\r\n        });\r\n\r\n        Button editVersion = new Button(VaadinIcon.PENCIL.create());\r\n        CompUtils.addToolTip(getCtx(), editVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_EDIT_TOOLTIP);\r\n        editVersion.addClickListener(event -> {\r\n            List<DataFile> selectedDataFile = new ArrayList<>(getSelectedItems());\r\n            if (selectedDataFile.isEmpty()) {\r\n                openAssortment(() -> {\r\n                    Assortment result = null;\r\n                    List<Assortment> selected = new ArrayList<>();\r\n                    if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                        selected.addAll(assortmentGrid.getSelectedItems());\r\n                        result = selected.get(0);\r\n                        setSessionAssortment(result);\r\n                    }\r\n                    return result;\r\n                }, true);\r\n            } else {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(TMS.ERROR_MSG_NO_NEW_PRICE_FILE_EXCEPT);\r\n            }\r\n        });\r\n\r\n        Button copyVersion = new Button(VaadinIcon.COPY.create());\r\n        CompUtils.addToolTip(getCtx(), copyVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_COPY_TOOLTIP);\r\n        copyVersion.addClickListener(event -> {\r\n\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n\r\n                // Selected Assortment\r\n                List<Assortment> selection = new ArrayList<>();\r\n                selection.addAll(assortmentGrid.getSelectedItems());\r\n                final Assortment selected = selection.get(0);\r\n\r\n                // Selected DataFiles\r\n                List<DataFile> selectedDataFile = new ArrayList<>();\r\n                selectedDataFile.addAll(getSelectedItems());\r\n                if (selectedDataFile.isEmpty()) {\r\n                    List<AssortmentDatafile> xCross = getCtx().getServices().getAssortmentDataFileService()\r\n                            .findAllByAssortment(selected);\r\n                    xCross.forEach(item -> {\r\n                        if (item.getAstFile() instanceof DataFile) {\r\n                            selectedDataFile.add((DataFile) item.getAstFile());\r\n                        }\r\n                    });\r\n                }\r\n\r\n                checkFilter(() -> openAssortment(() -> copyAssortment(selection.get(0), selectedDataFile), false),\r\n                        selected, \"eshop\");\r\n            }\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                    assortment.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                    assortment.setDeleteOn(LocalDateTime.now());\r\n                });\r\n                getServices().getAssortmentService().saveAll(assortmentGrid.getSelectedItems());\r\n                reloadAssortmentGrid();\r\n            }\r\n        });\r\n\r\n        downloader(null);\r\n\r\n        Button unlockVersion = new Button(VaadinIcon.UNLOCK.create());\r\n        CompUtils.addToolTip(getCtx(), unlockVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_LOCK_TOOLTIP);\r\n        unlockVersion.addClickListener(event -> {\r\n\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                    assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                        AssortmentUtil.unLock(getCtx(), assortment);\r\n                        reloadAssortmentGrid();\r\n                        assortmentGrid.select(assortment);\r\n                    });\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        Button uploadVersion = new Button(VaadinIcon.UPLOAD_ALT.create());\r\n        CompUtils.addToolTip(getCtx(), uploadVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_UPLOAD_TOOLTIP);\r\n\r\n        uploadVersion.addClickListener(event -> {\r\n            final Map<String, Boolean> ready = new HashMap<>();\r\n            User user = getCtx().getSession().getCurrentUser(getCtx());\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOAD_ASSORTMENT);\r\n                new Thread(() -> {\r\n                    List<Assortment> selected = new ArrayList<>();\r\n\r\n                    selected.addAll(getAssortmentGrid().getSelectedItems());\r\n                    if (SchedulerUtils.isValid(getCtx(), selected.get(0))) {\r\n                        setParameter(FileParam.QUEUE_BY, user, selected.get(0));\r\n                        setParameter(FileParam.QUEUE_ON, LocalDateTime.now(), selected.get(0));\r\n                    } else {\r\n                        AssortmentUtil.upload(getCtx(), selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_BY, user, selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_ON, LocalDateTime.now(), selected.get(0));\r\n                    }\r\n\r\n                    reloadInfoBox(dialog.getDialogUI());\r\n\r\n                    dialog.showUploadSuccess();\r\n                    ready.put(\"error\", false);\r\n                    dialog.uiClose();\r\n                }).start();\r\n            });\r\n\r\n            dialog.open();\r\n            dialog.execute();\r\n\r\n            ready.forEach((k, v) -> {\r\n                if (k.equals(\"error\")) {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_CREATE_ASSORTMENT_FIRST, getLocale(), getCtx()));\r\n                }\r\n            });\r\n        });\r\n\r\n        Button previewVersion = new Button(VaadinIcon.EYE.create());\r\n        previewVersion.setId(\"assortment-file-preview\");\r\n        CompUtils.addToolTip(getCtx(), previewVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_PREVIEW_TOOLTIP);\r\n        previewVersion.addClickListener(event -> {\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n                if (Objects.nonNull(assortment) && !assortment.getName().isEmpty()) {\r\n                    loadPreviewBreadCrumb();\r\n                    ToPreviewCrumpDialog pDialog = new ToPreviewCrumpDialog(getCtx());\r\n                    pDialog.open();\r\n                    pDialog.run();\r\n                }\r\n            });\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n\r\n        downloadBtn = new DownloadButton(getCtx(), TMS.LOADER_ASSORTMENT_GRID_BUTTON_DOWNLOAD_TOOLTIP);\r\n        return buttons(newVersion, editVersion, copyVersion, deleteVersion, unlockVersion, downloadBtn, uploadVersion,\r\n                previewVersion);\r\n    }\r\n\r\n    /**\r\n     * The downloader function is responsible for downloading the assortment as a zip file.\r\n     * It does this by first building the name of the zip file, and then calling reloadAsFile on downloadBtn.\r\n     * The reloadAsFile function takes two functions as parameters: one that returns a String (the filename), and another that returns an InputStream (the contents of the file).\r\n     *\r\n     * @param Assortment assortment Get the assortment id and name\r\n     * @return A supplier&lt;inputstream&gt; that is used to create a file download\r\n     * @docauthor Trelent\r\n     */\r\n    private void downloader(Assortment assortment) {\r\n        if (Objects.nonNull(assortment)) {\r\n            final String zipFileName = ExportFileUtils.buildZIPFileName(getCtx(), assortment);\r\n            downloadBtn.reloadAsFile(() -> zipFileName, () -> AssortmentUtil.zip(getCtx(), assortment));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The createNewAssortment function creates a new assortment and saves it to the database.\r\n     *\r\n     * @param List&lt;DataFile&gt; selectedFiles Set the data files to the assortment\r\n     *                             public assortment setdatafilestoassortment(assortment assortment, list&lt;datafile&gt; selectedfiles) {\r\n     *                             for (datafile file : selectedfiles) {\r\n     *                             file\r\n     * @return An assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    public Assortment createNewAssortment(List<DataFile> selectedFiles) {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        Assortment assortment = new Assortment();\r\n        assortment.setDate(user);\r\n        assortment.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        assortment = getServices().getAssortmentService().save(assortment);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.IMPEX, assortment);\r\n        setSessionAssortment(assortment);\r\n        return setDataFilesToAssortment(assortment, selectedFiles);\r\n    }\r\n\r\n\r\n    /**\r\n     * The setDataFilesToAssortment function takes an assortment and a list of datafiles as parameters.\r\n     * It then checks if the selected files are valid, and if they are it adds them to the assortment.\r\n     *\r\n     * @param Assortment           assortment Get the assortment object from the database\r\n     * @param List&lt;DataFile&gt; selectedFiles Get the selected files from the grid\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment setDataFilesToAssortment(Assortment assortment, List<DataFile> selectedFiles) {\r\n        Assortment result = null;\r\n        List<AstFile> datafiles = getAstFileTypeFromAssortment(assortment, DataFile.class);\r\n        boolean valid = false;\r\n        for (DataFile datafile : selectedFiles) {\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, datafile);\r\n            if (type.equals(ObjectType.IMPEX_INPUT)) {\r\n                valid = true;\r\n            }\r\n        }\r\n\r\n        if (valid) {\r\n            selectedFiles.forEach(dataFile -> {\r\n                boolean notValid = false;\r\n                for (AstFile datafile : datafiles) {\r\n                    if (datafile.getId() == dataFile.getId()) {\r\n                        notValid = true;\r\n                        break;\r\n                    }\r\n                }\r\n                if (!notValid) {\r\n                    AssortmentDatafile xrossFile = new AssortmentDatafile();\r\n                    xrossFile.setAssortment(assortment);\r\n                    xrossFile.setAstFile(dataFile);\r\n                    getServices().getAssortmentDataFileService().save(xrossFile);\r\n                }\r\n            });\r\n            result = assortment;\r\n\r\n            // reloadTable\r\n            reloadAssortmentGrid();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The copyAssortment function is used to copy an assortment.\r\n     *\r\n     * @param Assortment           fromCopy Copy the assortment from the source to a new one\r\n     * @param List&lt;DataFile&gt; newDatafiles Store the new datafiles that are created by the user\r\n     * @return The new assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment copyAssortment(Assortment fromCopy, List<DataFile> newDatafiles) {\r\n        Assortment result = new Assortment();\r\n        loadAssortmentsBreadCrumb();\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n\r\n        AssortmentDataFileDAO serviceXcross = getCtx().getServices().getAssortmentDataFileService();\r\n\r\n        result.setDate(user);\r\n        result.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        Assortment assortment = getServices().getAssortmentService().save(result);\r\n        CompUtils.cloneParameter(getCtx(), FileParam.FILE_TYPE, fromCopy, assortment);\r\n\r\n        newDatafiles.forEach(item -> {\r\n            AssortmentDatafile file = new AssortmentDatafile();\r\n            file.setAssortment(assortment);\r\n            file.setAstFile(item);\r\n            serviceXcross.save(file);\r\n        });\r\n\r\n        getCtx().getServices().getFilterBaseCustomService().clone(fromCopy, assortment);\r\n\r\n        List<AssortmentFilter> preFilters = getCtx().getServices().getAssortmentFilterService()\r\n                .findAllByAssortment(fromCopy);\r\n        preFilters.forEach(item -> {\r\n            AssortmentFilter assortmentFilter = new AssortmentFilter();\r\n            assortmentFilter.setCreateBy(user);\r\n            assortmentFilter.setFilter(item.getFilter());\r\n            assortmentFilter.setAssortment(assortment);\r\n            getCtx().getServices().getAssortmentFilterService().save(assortmentFilter);\r\n        });\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, newDatafiles);\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reload the buttons on the screen.\r\n     * This function is called when a new page has been loaded, and it sets all of\r\n     * the buttons to be disabled except for &quot;Exit&quot;. The reason that this function\r\n     * exists is because we want to make sure that no other button can be clicked until\r\n     * after a user has finished answering questions on a given page. This prevents users from skipping ahead in the survey or going back before they have answered all of their questions.\r\n     *\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the assortment grid and datafile grid, as well as resets the breadcrumbs to their first state.\r\n     *\r\n     * @return The current ui\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            reloadAssortmentGrid();\r\n            reloadDatafileGrid();\r\n            reset2BreadCrumbFirst();\r\n        });\r\n        reloadInfoBox(UI.getCurrent());\r\n    }\r\n\r\n    /**\r\n     * The reset2BreadCrumbFirst function is called when the user clicks on a breadcrumb.\r\n     * It removes all breadcrumbs after the clicked one, and then reloads the buttons in\r\n     * order to update them with their new values. Finally, it calls initial() on the box\r\n     * so that it can be updated with its new values as well. The box is then put back into\r\n     * UserSession so that it can be accessed by other functions later on if needed.\r\n     *\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    private void reset2BreadCrumbFirst() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            if (!box.getCrumbs().contains(this))\r\n                box.getCrumbs().add(this);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            reloadButtons();\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadAssortmentsBreadCrumb function is responsible for loading the breadcrumbs that are displayed on the top of\r\n     * the Assortments page. The function first removes all crumbs from the BreadBox except for LoaderCrumb, which is a\r\n     * special type of Crumb that cannot be removed. Then, it adds three new crumbs to represent each filter option: FilterAddCrumb,\r\n     * FilterRemoveCrumb and FilterIndividualCrumb. Finally, it initializes these new crumbs so they can be used by calling their respective functions in their classes.\r\n     *\r\n     * @return The following:\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadAssortmentsBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            box.getCrumbs().add(new FilterAddCrumb(getCtx()));\r\n            box.getCrumbs().add(new FilterRemoveCrumb(getCtx()));\r\n            box.getCrumbs().add(new FilterIndividualCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadFileEditBreadCrumb function is called when the user clicks on a file in the FileListView.\r\n     * It loads a new breadcrumb into the BreadBox, which will be displayed at the top of the screen.\r\n     * The breadcrumb contains an icon and text that indicates to users what they are currently viewing.\r\n     *\r\n     * @return A breadcrumb with a fileeditcrumb\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadFileEditBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new FileEditCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadPreviewBreadCrumb function is called when the user clicks on the Preview button.\r\n     * It loads a new breadcrumb into the BreadBox, which is then displayed in the UI.\r\n     *\r\n     * @return A breadcrumb with the name &quot;preview&quot;\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadPreviewBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new PreviewCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the CrumbProgressDialog.\r\n     * It sets the label of the dialog to &quot;Set Proof&quot; and calls getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n     *\r\n     * @param CrumbProgressDialog dialog Set the label of the dialog\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        dialog.setLabel(TMS.setProof(FilterType.ZUORDNUNG_MATERIAL));\r\n        getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL,\r\n                FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     *\r\n     * @return The value that the dialog returns\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the checkboxes for each of the values that can be imported.\r\n     * The first parameter in each dialog.addValueCbx call is a string representing one of the values that can be imported,\r\n     * and it must match one of the strings defined in TMS.java (e.g., &quot;FILE_IMPORTER_ARTICLE_NR&quot;).  The second parameter\r\n     * determines whether or not this value will be required when importing data from a file; if true, then an error message will appear if no column has been selected for this value during importation; otherwise, no error message\r\n     *\r\n     * @param FileImportDialog dialog Get the values of the checkboxes\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CURRENCY, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_TERRITORY, false);\r\n        header = dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in a FileImportDialog.\r\n     * It takes all of the data from each row in the table and creates an ArticleBase object for each one.\r\n     * Then, it checks to see if there is a header (if so, then it's a price file). If there isn't, then\r\n     * it's an impex file. The function also sets default parameters for both types of files (price and impex)\r\n     *\r\n     * @param FileImportDialog dialog Access the data of the table\r\n     * @return A list of articles\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        dialog.getTable().forEach(row -> {\r\n            ArticleBase price = setPrice(row, dialog);\r\n            if (Objects.nonNull(price)) {\r\n                articles.add(price);\r\n            }\r\n        });\r\n\r\n        if (!articles.isEmpty()) {\r\n            UI.getCurrent().access(() -> {\r\n                dialog.removeAll();\r\n                dialog.init();\r\n                dialog.setLabel(TMS.LOADER_DIALOG_CONVERT_FILE);\r\n\r\n                DataFile dataFile = new DataFile();\r\n                dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n                dataFile = getCtx().getServices().getDataFileService().save(dataFile);\r\n\r\n                setParameter(FileParam.FILE_TYPE, ObjectType.IMPEX_INPUT, dataFile);\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                File fi = null;\r\n                if (Objects.nonNull(header.getValue())) {\r\n                    setParameter(FileParam.HAS_PRICE, Boolean.TRUE, dataFile);\r\n\r\n                    fi = ExportFileUtils.buildPriceFile(getCtx(), articles, ASTConst.DEFAULT, dataFile);\r\n                } else {\r\n\r\n                    fi = ExportFileUtils.buildImpexFile(getCtx(), articles, ASTConst.DEFAULT, dataFile);\r\n                }\r\n                dataFile.setName(ExportFileUtils.buildPositivFileName(getCtx(), dataFile));\r\n                dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n                dataFile = getServices().getDataFileService().save(dataFile);\r\n                saveStorage(dataFile, fi);\r\n\r\n                final DataFile dFile = dataFile;\r\n                Map<Integer, String> colString = dialog.getTable().get(0);\r\n                // CURRENCY\r\n                if (dialog.getColumns()[1] > -1) {\r\n                    String currency = dialog.getColumnsByIdx(colString, 1);\r\n                    if (!currency.isEmpty()) {\r\n                        List<Currency> items = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n                        Optional<Currency> opt = items.stream().filter(item -> item.getKey().equals(currency))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.CURRENCY, value, dFile));\r\n                    }\r\n                }\r\n                // LANGUAGE\r\n                if (dialog.getColumns()[2] > -1) {\r\n                    String language = dialog.getColumnsByIdx(colString, 2);\r\n                    if (!language.isEmpty()) {\r\n                        List<Language> items = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n                        Optional<Language> opt = items.stream().filter(item -> item.getLabel().contains(language))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.LANGUAGE, value, dFile));\r\n                    }\r\n                }\r\n                // TERRITORY\r\n                if (dialog.getColumns()[3] > -1) {\r\n                    String territory = dialog.getColumnsByIdx(colString, 3);\r\n                    if (!territory.isEmpty()) {\r\n                        List<Territory> items = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n                        Optional<Territory> opt = items.stream().filter(item -> item.getKey().equals(territory))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.TERRITORY, value, dFile));\r\n                    }\r\n                }\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                reloadDatafileGrid();\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setPrice function takes the column string and the dialog as parameters.\r\n     * It then creates a new ArticleBase object, which is an assortment of prices.\r\n     * If there are any columns in the column string, it will set them to their respective values:\r\n     * - The article number (column 0) will be set to price's article number.\r\n     * - The first price (column 4) will be set to price's first price.\r\n     * - The Xth Price (column 5) will be set to price's Xth Price.\r\n     *\r\n     * @param Map&lt;Integer   Map the column index to a string value\r\n     * @param String&gt;       colString Get the values from the csv file\r\n     * @param FileImportDialog dialog Get the column values from the file\r\n     * @return An articlebase object\r\n     * @docauthor Trelent\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n\r\n        if (Objects.nonNull(colString)) {\r\n            if (dialog.getColumns()[0] > -1) {\r\n                price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n            }\r\n            if (dialog.getColumns()[4] > -1) {\r\n                price.setPriceFirst(dialog.getColumnsByIdx(colString, 4));\r\n            }\r\n            if (dialog.getColumns()[5] > -1) {\r\n                price.setPriceX(dialog.getColumnsByIdx(colString, 5));\r\n            }\r\n            if (dialog.getColumns()[6] > -1) {\r\n                price.setPriceType(dialog.getColumnsByIdx(colString, 6));\r\n            }\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It saves a DataFile object to the database, and then calls setParameter() to set its file type as an IMPEX_INPUT.\r\n     * Then it calls saveStorage() with two parameters: dataFile and ExportFileUtils.buildImpexFile(getCtx(), articles, ASTConst.DEFAULT, dataFile).\r\n     * The buildImpex function returns a String containing all of the articles that were imported from Excel into Hybris Management Console (HMC).\r\n     *\r\n     * @param FileImportDialog        dialog Get the file name and content of the uploaded file\r\n     * @param List&lt;ArticleBase&gt; articles Get the list of articles to be exported\r\n     * @return The list of articles to be saved\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        DataFile dataFile = new DataFile();\r\n        dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n\r\n        dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        dataFile = getServices().getDataFileService().save(dataFile);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.IMPEX_INPUT, dataFile);\r\n        setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n        dataFile.setName(ExportFileUtils.buildImpexFileName(getCtx(), dataFile));\r\n        saveStorage(dataFile, ExportFileUtils.buildImpexFile(getCtx(), articles, ASTConst.DEFAULT, dataFile));\r\n        getServices().getDataFileService().save(dataFile);\r\n\r\n        setLanguageParamByCustomer(dataFile);\r\n\r\n        reloadDatafileGrid();\r\n    }\r\n\r\n    /**\r\n     * The setSessionAssortment function is used to set the active assortment in the user session.\r\n     *\r\n     * @param Assortment assortment Find the assortment object in the database and then put it into the usersession\r\n     * @return The active assortment\r\n     * @docauthor Trelent\r\n     */\r\n    private void setSessionAssortment(Assortment assortment) {\r\n        Optional<Assortment> optAssortment = getServices().getAssortmentService().findById(assortment.getId());\r\n        optAssortment.ifPresent(item -> getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, item));\r\n    }\r\n\r\n    /**\r\n     * The getSelectedItems function returns a list of DataFile objects that have been selected in the data file grid.\r\n     * The function first creates an empty ArrayList object called selectedFiles, which will be populated with the\r\n     * DataFile objects that are returned by the getSelectedItems method of the data file grid.  This method returns a set\r\n     * of items from its internal selection model, and these items are added to our new ArrayList object.\r\n     * Next we iterate through each item in this list using Java 8's forEach lambda expression syntax (which is equivalent to:  for(DataFile item : selectedFiles) {\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    private List<DataFile> getSelectedItems() {\r\n        List<DataFile> selectedFiles = new ArrayList<>();\r\n        selectedFiles.addAll(dataFileGrid.getSelectedItems());\r\n        selectedFiles.forEach(item -> {\r\n            Optional<DataFile> optDatafile = getCtx().getServices().getDataFileService().findById(item.getId());\r\n            if (optDatafile.isPresent())\r\n                item = optDatafile.get();\r\n        });\r\n        return selectedFiles;\r\n    }\r\n\r\n    /**\r\n     * The setDefaultParameterToDataFile function is used to set the default parameters for a data file.\r\n     * The function takes in two arguments: articles and save.\r\n     * Articles is a list of ArticleBase objects, which are the articles that will be saved into the database.\r\n     * Save is an AstFile object, which represents the data file that will be saved into the database.\r\n     * The function sets default values for currency, territory, language (if applicable), KatalogVersion (which version of Katalog this data file belongs to), validFrom date (the date when this version of Katalog became valid) and validTo date (the date\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Get the first article in the list and use it to set parameters\r\n     *                                private void setdefaultparametertodatafile(list&lt;articlebase&gt; articles, astfile save) {\r\n     *                                articlebase first = articles\r\n     * @param AstFile                 save Set the parameters in the astfile\r\n     * @return The currency, territory, language, version and valid from/to dates\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDefaultParameterToDataFile(List<ArticleBase> articles, AstFile save) {\r\n        ArticleBase first = articles.get(0);\r\n\r\n        List<Currency> currencies = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n        List<Language> languages = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n        List<Territory> territories = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n\r\n        if (!first.getCurrency().isEmpty() && Objects.isNull(getParameter(FileParam.CURRENCY, save))) {\r\n            Optional<Currency> optCurr = currencies.stream().filter(item -> item.getKey().equals(first.getCurrency()))\r\n                    .findFirst();\r\n            optCurr.ifPresent(item -> setParameter(FileParam.CURRENCY, item, save));\r\n        }\r\n        if (!first.getTerritory().isEmpty() && Objects.isNull(getParameter(FileParam.TERRITORY, save))) {\r\n            String territory = first.getTerritory();\r\n            if (territory.contains(\"-\") && Objects.isNull(getParameter(FileParam.LANGUAGE, save))) {\r\n                String language = territory.split(\"-\")[0];\r\n                territory = territory.split(\"-\")[2];\r\n                Optional<Language> optLang = languages.stream().filter(item -> item.getKey().equals(language))\r\n                        .findFirst();\r\n                optLang.ifPresent(item -> setParameter(FileParam.LANGUAGE, item, save));\r\n            }\r\n            String finalTerr = territory;\r\n            Optional<Territory> optTerr = territories.stream().filter(item -> item.getKey().equals(finalTerr))\r\n                    .findFirst();\r\n            optTerr.ifPresent(item -> setParameter(FileParam.TERRITORY, item, save));\r\n        }\r\n\r\n        KatalogVersion version = CompUtils.getKatalogVersion(getCtx(), save);\r\n\r\n        setParameter(FileParam.KATALOG_VERSION, version, save);\r\n\r\n        if (!first.getValidFrom().isEmpty()) {\r\n            setParameter(FileParam.VALID_FROM, first.getValidFromAsLocalDate(), save);\r\n        } else {\r\n            setParameter(FileParam.VALID_FROM, version.getValidFrom(), save);\r\n        }\r\n\r\n        if (!first.getValidTo().isEmpty()) {\r\n            setParameter(FileParam.VALID_TO, first.getValidToAsLocalDate(), save);\r\n        } else {\r\n            setParameter(FileParam.VALID_TO, version.getValidTo(), save);\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\LoaderCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\PreviewCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.la.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.ExcelUtils;\r\nimport com.hom.ebmw.utilities.InternalUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.TabBox;\r\nimport com.hom.ebmw.view.dialogs.FileConvertDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseQuickDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.Component;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.progressbar.ProgressBar;\r\nimport com.vaadin.flow.component.tabs.Tab;\r\nimport com.vaadin.flow.component.tabs.Tabs;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.HashMap;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_PREVIEW)\r\npublic class PreviewCrumb extends Crumb {\r\n\r\n    private final Tabs tabBay = new Tabs();\r\n    private final Div pages = new Div();\r\n    private final Map<Tab, VerticalLayout> tabMap = new HashMap<Tab, VerticalLayout>();\r\n    private final ArticleDetailBox details;\r\n    private Assortment assortment = null;\r\n\r\n    public PreviewCrumb(Context ctx) {\r\n        super(ctx);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_UI, UI.getCurrent());\r\n        this.assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        details = new ArticleDetailBox(getCtx(), new ArrayList<ArticleBase>());\r\n        add(details, tabBay, pages);\r\n        pages.setSizeFull();\r\n\r\n        tabBay.addSelectedChangeListener(event -> {\r\n            tabMap.forEach((k, v) -> {\r\n                v.setVisible(false);\r\n            });\r\n            Component selectedPage = tabMap.get(tabBay.getSelectedTab());\r\n            selectedPage.setVisible(true);\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void reloadCrumb() {\r\n        final UI ui = UI.getCurrent();\r\n\r\n        ui.access(() -> {\r\n            tabBay.removeAll();\r\n            pages.removeAll();\r\n            tabMap.clear();\r\n\r\n            addTabPriceList(assortment);\r\n            addTabRemoved(assortment);\r\n        });\r\n\r\n        details.reload(() -> getServices().getArticleBaseService().findAllInArchivByAssortment(assortment));\r\n    }\r\n\r\n    private void addTabPriceList(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_PRICELIST, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setKey(\"articleNr\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n\r\n        box.setLoad(loadGrid(box.getGrid(), () -> {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, false);\r\n            box.getDownload().reloadAsFile(() -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT,\r\n                            box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        Button customExport = new Button(getTranslation(TMS.GENERATE_DIALOG_RENDER_EXPORT, getLocale(), getCtx()));\r\n        customExport.addClickListener(event -> {\r\n            FileConvertDialog dialog = new FileConvertDialog(getCtx());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        box.getButtons().add(customExport);\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    private void addTabRemoved(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_REMOVED, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setKey(\"articleNr\");\r\n        box.getGrid().addColumn(ArticleBase::getComment)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_COMMENT, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setKey(\"comment\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n\r\n        box.setLoad(loadGrid(box.getGrid(), () -> {\r\n\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, true);\r\n            box.getDownload().reloadAsFile(() -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT,\r\n                            box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    private <E> ProgressBar loadGrid(Grid<E> grid, Callable<List<E>> list) {\r\n        ProgressBar progress = new ProgressBar();\r\n        progress.setIndeterminate(true);\r\n        final UI ui = UI.getCurrent();\r\n\r\n        new Thread(() -> {\r\n            ui.access(() -> {\r\n                progress.setVisible(true);\r\n                try {\r\n                    List<E> buffer = list.call();\r\n                    grid.setDataProvider(DataProvider.ofCollection(buffer));\r\n                } catch (Exception e) {\r\n                    log.error(e.getLocalizedMessage());\r\n                    log.debug(e.toString());\r\n                }\r\n                progress.setVisible(false);\r\n            });\r\n        }).start();\r\n        return progress;\r\n    }\r\n\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setExitEnable(true);\r\n            setNextEnable(false);\r\n            setLastEnable(false);\r\n            setFinishEnable(false);\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public void exit() {\r\n        CloseQuickDialog dialog = new CloseQuickDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\crumb\\PreviewCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\LAPresenter.java =====\n```\npackage com.hom.ebmw.view.sortment.la;\r\n\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.view.sortment.la.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\n\r\nimport java.util.Locale;\r\nimport java.util.Objects;\r\n\r\npublic class LAPresenter {\r\n\r\n    private LoaderCrumb loader;\r\n    private Importer importer;\r\n    private InfoBox info;\r\n    private LocalCustomer localCustomer;\r\n\r\n    private Context ctx = new Context();\r\n\r\n    public LAPresenter(Context ctx) {\r\n        this.ctx = ctx;\r\n    }\r\n\r\n    public void setLoader(LoaderCrumb loader) {\r\n        this.loader = loader;\r\n    }\r\n\r\n    public void setInfo(InfoBox info) {\r\n        this.info = info;\r\n    }\r\n\r\n    public InfoBox getInfo() {\r\n        return info;\r\n    }\r\n\r\n    public void setImporter(Importer importer) {\r\n        this.importer = importer;\r\n    }\r\n\r\n    public void setChangeValue(LocalCustomer customer) {\r\n        if (Objects.nonNull(customer)) {\r\n            importer.getUploader().setVisible(true);\r\n            localCustomer = customer;\r\n            CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n            loader.reloadDatafileGrid();\r\n            loader.reloadAssortmentGrid();\r\n        } else {\r\n            importer.getUploader().setVisible(false);\r\n        }\r\n    }\r\n\r\n    public void setStartedEvent(Locale locale) {\r\n        //CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\LAPresenter.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\LAView.java =====\n```\npackage com.hom.ebmw.view.sortment.la;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.BaseLayout;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.la.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\nimport com.vaadin.flow.router.*;\r\n\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.Objects;\r\n\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_LA;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_LA;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_LA, layout = MainView.class)\r\n@PageTitle(TITLE_LA)\r\npublic class LAView extends BaseLayout implements HasPermission, HasUrlParameter<String> {\r\n\r\n    private final LAPresenter presenter;\r\n    private final Context ctx = new Context();\r\n    private final Importer importer;\r\n\r\n    public LAView(Services services) {\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        LocalCustomer customer = ctx.getHttpAttribute(SessionParams.ACTIVE_CUSTOMER);\r\n        if (Objects.nonNull(customer) && customer.getCustomerId().equals(ASTConst.PROMOTION_CUSTOMER))\r\n            ctx.putHttpAttribute(SessionParams.ACTIVE_CUSTOMER, null);\r\n        ctx.getUserSession().put(Params.ACTIVE_TYPE, ObjectType.IMPEX);\r\n        this.presenter = new LAPresenter(ctx);\r\n        importer = new Importer(ctx);\r\n\r\n        setLeftSection();\r\n        setMiddleSection();\r\n        setRightSection();\r\n    }\r\n\r\n    private void setMiddleSection() {\r\n        LoaderCrumb loader = new LoaderCrumb(ctx);\r\n        presenter.setLoader(loader);\r\n\r\n        BreadBox breadBox = new BreadBox(ctx);\r\n        breadBox.setDefaultCrumb(loader);\r\n\r\n        breadBox.getCrumbs().add(loader);\r\n        breadBox.initial();\r\n\r\n        getMiddleSection().add(breadBox);\r\n\r\n        breadBox.setContent(loader);\r\n        loader.reloadButtons();\r\n        loader.reloadCrumb();\r\n    }\r\n\r\n    private void setLeftSection() {\r\n\r\n        presenter.setImporter(importer);\r\n\r\n        importer.addCustomerValueChangeListener(e ->\r\n                presenter.setChangeValue(e.getValue())\r\n        );\r\n\r\n        importer.addRoleValueChangeListener(e -> {\r\n            if (Objects.nonNull(importer.getSelected()))\r\n                presenter.setChangeValue(importer.getSelected());\r\n            importer.reloadCustomer();\r\n        });\r\n\r\n        importer.getUploader().addStartedListener(e ->\r\n                presenter.setStartedEvent(getLocale())\r\n        );\r\n\r\n        importer.getUploader().addSucceededListener(e -> {\r\n            FileImportDialog dialog = new FileImportDialog(ctx, e, importer.getMemoryFileBuffer());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        getLeftSection().add(importer);\r\n    }\r\n\r\n    private void setRightSection() {\r\n        InfoBox info = new InfoBox(ctx);\r\n\r\n        ctx.getUserSession().put(Params.ACTIVE_INFO_BOX, info);\r\n\r\n        presenter.setInfo(info);\r\n        getRightSection().add(info);\r\n    }\r\n\r\n    @Override\r\n    public void setParameter(BeforeEvent event, @OptionalParameter String parameter) {\r\n        QueryParameters parameters = event.getLocation().getQueryParameters();\r\n\r\n        /*\r\n        TODO: Baue eine Url welche alle Paramter mitfhrt um ein Basis Sortiment anzulegen.\r\n            Nach Ticket LA-375\r\n            ?customer=M364&catalog-version=K54&valid-from=1-1-2023&valid-to=31-7-2023&country=DE&language=deu&currency=eur\r\n        */\r\n\r\n\r\n        Map<String, List<String>> parametersMap = parameters.getParameters();\r\n        if (parametersMap.containsKey(\"customer\")) {\r\n            ctx.getUserSession().put(Params.ACTIVE_PAGE_PARAMETERS, parametersMap);\r\n            LocalCustomer paramCustomer = CompUtils.setSessionProjectByCustomerParameter(ctx);\r\n            importer.setSelectedLocalCustomer(paramCustomer);\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\la\\LAView.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-MAQBiUyMWU8mNQPGtrStaJijhvfCLn4G",
    "created" : 1762171906,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"multiple\",\n  \"issues\": [\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"ClassCastException risk in FilterRemoveCrumb fieldTxt value change listener\",\n      \"justification\": \"The listener casts the Grid's DataProvider to ListDataProvider without checking its actual type; if the provider changes, a ClassCastException will be thrown.\",\n      \"action\": \"Add an instanceof check before casting and fallback to a compatible DataProvider or recreate a ListDataProvider; write unit test verifying behavior with different provider types.\",\n      \"source\": \"FilterRemoveCrumb.fieldTxt.addValueChangeListener, Zeilen 70-80\",\n      \"component\": \"UI-Filter\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Missing null check for fieldTxt.getValue() in filter predicate\",\n      \"justification\": \"If the TextField value is null, toLowerCase() would throw NPE; Vaadin usually returns empty string but explicit check improves robustness.\",\n      \"action\": \"Guard against null: String filterLower = Optional.ofNullable(fieldTxt.getValue()).orElse(\\\"\\\").toLowerCase(Locale.ENGLISH); add test for null input.\",\n      \"source\": \"FilterRemoveCrumb.fieldTxt.addValueChangeListener, Zeile 78\",\n      \"component\": \"UI-Filter\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Potential performance issue: rightFilterGrid loads entire filter list without pagination\",\n      \"justification\": \"When many Filterbase entries exist, loading all rows can cause UI lag and high memory consumption.\",\n      \"action\": \"Introduce lazy loading / pagination (e.g., using DataProvider with offset/limit) and add performance test for >10k entries.\",\n      \"source\": \"FilterRemoveCrumb.reloadCrumb, Zeile 106-115\",\n      \"component\": \"UI-Grid\",\n      \"impact_scope\": \"performancekritisch\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Unused demo() method with System.out.println\",\n      \"justification\": \"Dead code increases maintenance burden and may expose internal state in production logs.\",\n      \"action\": \"Remove demo() method or replace with proper logging if needed; add unit test confirming its removal.\",\n      \"source\": \"FilterRemoveCrumb.demo(), Zeile 25-27\",\n      \"component\": null,\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Missing emptylist check before accessing articles.get(0) in LoaderCrumb.setDefaultParameterToDataFile\",\n      \"justification\": \"If the articles list is empty, IndexOutOfBoundsException will crash the UI when saving files.\",\n      \"action\": \"Validate that articles.isEmpty() before accessing first element; throw a domainspecific exception or show user error; add test for empty list scenario.\",\n      \"source\": \"LoaderCrumb.setDefaultParameterToDataFile, Zeile 820-822\",\n      \"component\": \"File-Import\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Potential NPE in LoaderCrumb.doOnSave when header.getValue() is null\",\n      \"justification\": \"header is a ComboBox; if no selection is made, getValue() returns null, causing NullPointerException on subsequent calls.\",\n      \"action\": \"Add null check before using header.getValue(); disable pricespecific processing when null; add UI test covering noselection case.\",\n      \"source\": \"LoaderCrumb.doOnSave, Zeile 580-590\",\n      \"component\": \"File-Import\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Incorrect string replacement in PreviewCrumb.addTabPriceList / addTabRemoved\",\n      \"justification\": \"Expression '+assortment.getId() + \\\"#\\\"' uses unary plus, producing a numeric value, then replace() receives a number instead of a string, leading to NoSuchMethodError or wrong output.\",\n      \"action\": \"Change to String.valueOf(assortment.getId()) + \\\"#\\\"; add unit test verifying article number formatting.\",\n      \"source\": \"PreviewCrumb.addTabPriceList / addTabRemoved, Zeile 100-108\",\n      \"component\": \"Preview-Tab\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Thread leakage in PreviewCrumb.loadGrid (new Thread per grid load)\",\n      \"justification\": \"Spawning a raw Thread for each grid load can exhaust system resources under heavy usage and hinders graceful shutdown.\",\n      \"action\": \"Replace raw Thread with ExecutorService (e.g., UI access via CompletableFuture) and ensure proper shutdown; add concurrency test.\",\n      \"source\": \"PreviewCrumb.loadGrid, Zeile 140-155\",\n      \"component\": \"Preview-Grid\",\n      \"impact_scope\": \"performancekritisch\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"LAPresenter creates a new Context instance then immediately overwrites it in constructor\",\n      \"justification\": \"Redundant object creation wastes memory and may hide bugs if the default Context is later needed.\",\n      \"action\": \"Remove field initialization or assign directly in constructor; add test verifying only one Context instance is used.\",\n      \"source\": \"LAPresenter.ctx field and constructor, Zeile 12-20\",\n      \"component\": \"Presenter\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Insufficient validation of URL parameters in LAView.setParameter\",\n      \"justification\": \"Directly trusting query parameters (e.g., 'customer') may allow injection attacks or malformed values leading to unexpected behavior.\",\n      \"action\": \"Validate parameter format (e.g., regex for customer code), sanitize before use, and handle missing/invalid values gracefully; add integration test for malformed URLs.\",\n      \"source\": \"LAView.setParameter, Zeile 210-226\",\n      \"component\": \"Routing\",\n      \"impact_scope\": \"sicherheitskritisch\",\n      \"relations\": null,\n      \"evidence\": null\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"3\",\n    \"top_todos\": [\n      \"Add typesafe checks for DataProvider casting and null handling in FilterRemoveCrumb.\",\n      \"Fix emptylist access and header null checks in LoaderCrumb.\",\n      \"Correct string replacement bug in PreviewCrumb and replace raw Threads with executorbased loading.\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to produce JSON review for each file? The instructions: \"You are a senior code reviewer. You analyze each code chunk.\" The user provided multiple files. We must output a single JSON object? It says \"Your answer must be a single JSON object exactly in this structure.\" It seems we can include multiple files as separate issues? The schema has \"file\": string - path of file or chunk ID. So maybe we need separate JSON for each file? But only one JSON allowed. Could we combine multiple issues across files with file field indicating each? Probably we need separate JSON objects per file, but constraint says single JSON object. Could embed array of files? Not in schema. Maybe we need to produce separate JSON objects per file sequentially? But rule 1: \"Antworte immer als ein einziges JSON-Objekt\". So we need to output one JSON that perhaps covers one file (maybe the main file). Could combine all issues but file field maybe generic. Might list issues with source indicating file.\n\nProbably best to output for each file separate entry? Could set file to \"multiple\". But better to produce separate JSON objects concatenated? That would violate rule. I think we need to output one JSON per file, but user gave multiple files, maybe we need to produce multiple JSON objects? The rules ambiguous. Many previous tasks expect one JSON per file. But they say \"Issues per file/chunk\". Probably we should produce an array? Not allowed.\n\nI'll produce one JSON that aggregates issues for each file, using file field as the specific file and issues list per that file. But schema only allows one issues array per file. Could we embed multiple objects in an outer array? Not allowed. Might produce a JSON where \"file\" is null and issues contain entries referencing each file in source.\n\nI'll choose to produce a summary for each file as separate entries in \"issues\" with source indicating file. \"file\": \"multiple\". Provide issues across all.\n\nLet's craft up to 10 issues per file, total maybe 12? Must limit total issues to 10 per file/chunk, but overall could be >10. We'll produce maybe 2-3 per file.\n\nLet's identify key issues:\n\nFilterRemoveCrumb:\n- Potential NPE: getStructureGrid().getGrid() might be null if not initialized? But inherited. Not obvious.\n- Using UI.getCurrent() inside access may cause deadlock if not UI thread; okay.\n- Drag-and-drop utils may not validate null; but okay.\n- fieldTxt value change listener uses cast to ListDataProvider without checking type; could cause ClassCastException if provider not ListDataProvider.\n- rightFilterGrid data provider set each change; performance fine.\n- No pagination for large filter list -> performance issue.\n- No input validation for filterLower null? getValue may be null; but getValue returns empty string not null.\n- Use of System.out.println in demo method (unused) - minor.\n- Potential memory leak: rightFilterGrid reference to UI? not.\n\nWe'll produce issues: FieldTxt listener ClassCast, no null checks for getValue, missing pagination.\n\nLoaderCrumb:\n- reloadDatafileGrid and reloadAssortmentGrid use removeIf with lambda that may cause ConcurrentModification? they operate on list, safe.\n- In setDatafileGrid selection listener stores list of selected items in session; could be large.\n- getSelectedItems iterates and reassigns item variable but does not affect list; returns original items (maybe stale) - bug.\n- directSave and doOnSave use ExportFileUtils building files on UI thread via UI.access -> blocking UI.\n- In setPrice method, assume dialog.getColumns() array length enough; could cause ArrayIndexOutOfBounds if not.\n- In setDefaultParameterToDataFile, first = articles.get(0) without checking empty list => NPE.\n- In doOnSave, header.getValue() may be null leading NullPointerException.\n- In loader Crumb, many UI access calls inside loops may cause thread safety issues.\n\nPreviewCrumb:\n- loadGrid creates new Thread per load, may cause thread leak; UI access from non-UI thread ok but using new Thread for each load is heavy.\n- In addTabPriceList and addTabRemoved, item.getArticleNr().replace(+assortment.getId() + \"#\", \"\") uses unary plus causing numeric expression, likely bug: should be String concat. This is a bug.\n- In loadGrid, progress bar visibility changes inside UI thread but progress not added to layout; maybe not displayed.\n- Potential memory leak: storing Tab->Layout map without removal.\n- No handling of cancelled threads.\n\nLAPresenter:\n- ctx initialized new Context then overwritten in constructor; redundant.\n- setStartedEvent does nothing; maybe missing logic.\n\nLAView:\n- In constructor, creates new Context each view instance; fine.\n- setParameter uses parametersMap.containsKey(\"customer\") but no validation of list size.\n- Potential security: active customer from request parameter not validated.\n\nWe'll produce JSON with file field per file, maybe separate objects. But rule says single JSON object. Maybe we can include multiple file entries as array under \"files\"? Not allowed.\n\nAlternative: Provide one JSON per file as separate responses? Not possible.\n\nThus maybe they expect one JSON per file, but the system will accept multiple messages. But we need to output just one JSON. Let's choose to output for the first file only (FilterRemoveCrumb). However user provided multiple files, likely expects review for all.\n\nWe can combine issues per file in issues array and include \"file\" as \"multiple\". Provide source includes file name. Let's do that.\n\nWe'll list issues with source indicating file path and line.\n\nNow craft JSON."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 2711,
      "prompt_tokens" : 17337,
      "total_tokens" : 20048
    },
    "timings" : {
      "cache_n" : 62,
      "prompt_n" : 17275,
      "prompt_ms" : 12695.653,
      "prompt_per_token_ms" : 0.7349147901591896,
      "prompt_per_second" : 1360.7019662556938,
      "predicted_n" : 2711,
      "predicted_ms" : 31788.026,
      "predicted_per_token_ms" : 11.725572113611214,
      "predicted_per_second" : 85.28368512093202
    }
  }
}