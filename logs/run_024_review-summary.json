{
  "timestamp" : "2025-11-03T13:13:57.887707",
  "index" : 24,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\crumb\\LoaderCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.promotion.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.AssortmentLockException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.Header;\r\nimport com.hom.ebmw.utilities.*;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.CustomDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.PromotionBuilderDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToFileEditCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToPreviewCrumpDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.time.LocalDateTime;\r\nimport java.util.*;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_PROM_LOADER)\r\n@SuppressWarnings(\"serial\")\r\npublic class LoaderCrumb extends Crumb implements FileInputLoader {\r\n\r\n    private final Grid<DataFile> dataFileGrid = new Grid<>();\r\n    private final Grid<Assortment> assortmentGrid = new Grid<>();\r\n    private DownloadButton downloadBtn;\r\n    private final HorizontalLayout body = new HorizontalLayout();\r\n    private ComboBox<Header> priceHeader = null;\r\n\r\n    /**\r\n     * The LoaderCrumb function is a constructor for the LoaderCrumb class.\r\n     * It sets up the datafile grid and assortment grid, then adds them to the body of this crumb.\r\n     *\r\n     * @param Context ctx Create a new instance of the loadercrumb class\r\n     * @return A component\r\n     * @docauthor Trelent\r\n     */\r\n    public LoaderCrumb(Context ctx) {\r\n        super(ctx);\r\n        setDatafileGrid();\r\n        setAssortmentGrid();\r\n        setSizeFull();\r\n\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n        add(body);\r\n        CompUtils.removeMSP(body, \"MSP\");\r\n        body.setSizeFull();\r\n    }\r\n\r\n    /**\r\n     * The reloadDatafileGrid function is called when the user clicks on the &quot;Upload&quot; button.\r\n     * It reloads the datafile grid with all of the files that have been uploaded by this user.\r\n     *\r\n     * @return The datafilegrid object\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadDatafileGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<DataFile> dataFiles = getServices().getDataFileService().findAllByProjectRole(projectRole);\r\n            dataFiles.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            dataFiles.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = !value.equals(ObjectType.PROMOTION_INPUT);\r\n                }\r\n                return result;\r\n            });\r\n\r\n            dataFiles.sort((o1, o2) -> o2.getCreateOn().compareTo(o1.getCreateOn()));\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(dataFiles));\r\n        } else {\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The reloadAssortmentGrid function is called when the user clicks on the &quot;Refresh&quot; button.\r\n     * It reloads all of the Assortments that are associated with a ProjectRole, and then displays them in a grid.\r\n     *\r\n     * @return A list of assortment objects\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadAssortmentGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<Assortment> assortments = getServices().getAssortmentService().findAllByProjectRole(projectRole);\r\n            assortments.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            assortments.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = !value.equals(ObjectType.PROMOTION);\r\n                }\r\n                return result;\r\n            });\r\n            assortments.sort((o1, o2) -> o2.getUpdateOn().compareTo(o1.getUpdateOn()));\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(assortments));\r\n        } else {\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setDatafileGrid function sets up the grid that displays the data files.\r\n     * It adds three columns to the grid: one for file name, one for update by, and\r\n     * one for update on. The function also adds a selection listener to this grid so that when an item is selected in it,\r\n     * its corresponding DataFile object is stored in a session variable called ACTIVE_DATAFILE. This allows us to access this object later on from other functions.\r\n     *\r\n     * @return A grid with the datafile information\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDatafileGrid() {\r\n        dataFileGrid.setSelectionMode(SelectionMode.MULTI);\r\n        dataFileGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(4);\r\n        dataFileGrid.addColumn(this::getName)\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_BY, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n        dataFileGrid.addColumn(file -> Parse.formatDateTime(file.getUpdateOn(), AstDateTimeFormat.GERMAN))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_ON, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n\r\n        reloadDatafileGrid();\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_BASE_FILE), setLeftButtons(), dataFileGrid));\r\n\r\n        dataFileGrid.addSelectionListener(event -> {\r\n            List<DataFile> selected = new ArrayList<>();\r\n            selected.addAll(event.getAllSelectedItems());\r\n            if (selected.isEmpty()) {\r\n                getCtx().getUserSession().remove(Params.ACTIVE_DATAFILE);\r\n            } else {\r\n                getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selected);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The getName function takes an object as a parameter and returns the name of the user who last updated that object.\r\n     * If no user is found, it returns &quot;UNKNOWN&quot;.\r\n     *\r\n     * @param Object obj Determine the type of object that is passed in\r\n     * @return The user's surname and given name\r\n     * @docauthor Trelent\r\n     */\r\n    private String getName(Object obj) {\r\n        User user = null;\r\n        if (obj instanceof DataFile) {\r\n            user = ((DataFile) obj).getUpdateBy();\r\n        } else if (obj instanceof Assortment) {\r\n            user = ((Assortment) obj).getUpdateBy();\r\n        }\r\n        if (Objects.nonNull(user)) {\r\n            return user.getSurName() + \", \" + user.getGivenName();\r\n        } else {\r\n            return \"UNKNOWN\";\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The openAssortment function is called when the user clicks on an assortment in the Assortment Tree.\r\n     * It opens a new window that allows the user to edit and save changes to that assortment.\r\n     *\r\n     * @param Callable&lt;Assortment&gt; selected Get the assortment selected in the assortmenttreedialog\r\n     * @return An assortment\r\n     * @docauthor Trelent\r\n     */\r\n    private void openAssortment(Callable<Assortment> selected) {\r\n        CustomDialog cDialog = new CustomDialog(getCtx());\r\n        cDialog.setCom(() -> {\r\n            cDialog.setLabel(TMS.SET_DIALOG_CREATE_ASSORTMENT);\r\n            Assortment assortment;\r\n            try {\r\n                assortment = selected.call();\r\n\r\n                AssortmentUtil.isLocked(getCtx(), assortment);\r\n\r\n                if (Objects.nonNull(assortment)) {\r\n                    setSessionAssortment(assortment);\r\n                    loadAssortmentsBreadCrumb();\r\n                    PromotionBuilderDialog dialog = new PromotionBuilderDialog(getCtx(), assortment);\r\n                    dialog.open();\r\n                    dialog.execute();\r\n                } else {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_NOT_READY, getLocale(), getCtx()));\r\n                }\r\n            } catch (AssortmentLockException e) {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_IS_LOCKED, getLocale(), getCtx()));\r\n            } catch (Exception e) {\r\n                log.debug(e.getMessage(), e);\r\n            }\r\n        });\r\n        cDialog.open();\r\n        cDialog.run();\r\n    }\r\n\r\n    /**\r\n     * The setAssortmentGrid function is responsible for setting up the assortment grid.\r\n     * It sets the selection mode to single, adds a component column with a tooltip,\r\n     * and then reloads the assortment grid.  It also adds a selection listener that will download an assortment file when selected.\r\n     *\r\n     * @return A component that is added to the body\r\n     * @docauthor Trelent\r\n     */\r\n    private void setAssortmentGrid() {\r\n        assortmentGrid.setSelectionMode(SelectionMode.SINGLE);\r\n\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setFlexGrow(4)\r\n                .setResizable(true).setFlexGrow(7);\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.isLocked(getCtx(), item))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_IS_LOCKED, getLocale(), getCtx())).setFlexGrow(1)\r\n                .setResizable(true).setWidth(\"10%\");\r\n        reloadAssortmentGrid();\r\n\r\n        assortmentGrid.addSelectionListener(event -> {\r\n            downloadBtn.setEnabled(false);\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                cDialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                List<Assortment> selected = new ArrayList<>();\r\n                selected.addAll(event.getAllSelectedItems());\r\n\r\n                if (!selected.isEmpty()) {\r\n                    if (!selected.get(0).getName().isEmpty()) {\r\n                        downloadBtn.setEnabled(true);\r\n                    }\r\n                    Optional<Assortment> optAssortment = getServices().getAssortmentService()\r\n                            .findById(selected.get(0).getId());\r\n                    optAssortment.ifPresent(assortment -> {\r\n                        downloader(assortment);\r\n                        getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, assortment);\r\n                        reloadInfoBox(cDialog.getDialogUI());\r\n                    });\r\n                } else {\r\n                    reloadInfoBox(cDialog.getDialogUI());\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        assortmentGrid.addItemDoubleClickListener(event -> openAssortment(event::getItem));\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_ASSORTMENT_FILE), setRightButtons(), assortmentGrid));\r\n    }\r\n\r\n    /**\r\n     * The setLeftButtons function creates a HorizontalLayout containing three buttons:\r\n     * - newVersion, which allows the user to create a new version of an existing file.\r\n     * - changeVersion, which allows the user to edit an existing file.\r\n     * - deleteVersion, which allows the user to delete one or more files from their project.\r\n     *\r\n     * @return A horizontallayout\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setLeftButtons() {\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_FILE_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole)) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), null);\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button changeVersion = new Button(VaadinIcon.PENCIL.create());\r\n        CompUtils.addToolTip(getCtx(), changeVersion, TMS.LOADER_FILE_GRID_BUTTON_EDIT_TOOLTIP);\r\n        changeVersion.addClickListener(event -> {\r\n            List<DataFile> files = new ArrayList<>();\r\n            files.addAll(dataFileGrid.getSelectedItems());\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole) && !files.isEmpty()) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), files.get(0));\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_FILE_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!dataFileGrid.getSelectedItems().isEmpty()) {\r\n                List<DataFile> files = new ArrayList<>();\r\n                dataFileGrid.getSelectedItems().forEach(file -> {\r\n                    Optional<DataFile> optFile = getServices().getDataFileService().findById(file.getId());\r\n                    optFile.ifPresent(dataFile -> {\r\n                        dataFile.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                        dataFile.setDeleteOn(LocalDateTime.now());\r\n                        files.add(dataFile);\r\n                    });\r\n                });\r\n                getServices().getDataFileService().saveAll(files);\r\n                reloadDatafileGrid();\r\n            }\r\n        });\r\n\r\n        return buttons(newVersion, changeVersion, deleteVersion);\r\n    }\r\n\r\n    /**\r\n     * The setRightButtons function creates the buttons that are displayed on the right side of the assortment grid.\r\n     * The function returns a HorizontalLayout containing all of these buttons.\r\n     *\r\n     * @return A horizontallayout with buttons\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setRightButtons() {\r\n\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            assortmentGrid.deselectAll();\r\n            openAssortment(() -> createNewAssortment(getSelectedItems()));\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                    assortment.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                    assortment.setDeleteOn(LocalDateTime.now());\r\n                });\r\n                getServices().getAssortmentService().saveAll(assortmentGrid.getSelectedItems());\r\n                reloadAssortmentGrid();\r\n            }\r\n        });\r\n\r\n        downloader(null);\r\n\r\n        Button unlockVersion = new Button(VaadinIcon.UNLOCK.create());\r\n        CompUtils.addToolTip(getCtx(), unlockVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_LOCK_TOOLTIP);\r\n        unlockVersion.addClickListener(event -> {\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                    assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                        AssortmentUtil.unLock(getCtx(), assortment);\r\n                        reloadAssortmentGrid();\r\n                        assortmentGrid.select(assortment);\r\n                    });\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        Button uploadVersion = new Button(VaadinIcon.UPLOAD_ALT.create());\r\n        CompUtils.addToolTip(getCtx(), uploadVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_UPLOAD_TOOLTIP);\r\n\r\n        uploadVersion.addClickListener(event -> {\r\n            final Map<String, Boolean> ready = new HashMap<>();\r\n            User user = getCtx().getSession().getCurrentUser(getCtx());\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOAD_ASSORTMENT);\r\n                new Thread(() -> {\r\n                    List<Assortment> selected = new ArrayList<>();\r\n\r\n                    selected.addAll(getAssortmentGrid().getSelectedItems());\r\n                    if (SchedulerUtils.isValid(getCtx(), selected.get(0))) {\r\n                        setParameter(FileParam.QUEUE_BY, user, selected.get(0));\r\n                        setParameter(FileParam.QUEUE_ON, LocalDateTime.now(), selected.get(0));\r\n                    } else {\r\n                        AssortmentUtil.upload(getCtx(), selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_BY, user, selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_ON, LocalDateTime.now(), selected.get(0));\r\n                    }\r\n\r\n                    reloadInfoBox(dialog.getDialogUI());\r\n\r\n                    dialog.showUploadSuccess();\r\n                    ready.put(\"error\", false);\r\n                    dialog.uiClose();\r\n                }).start();\r\n            });\r\n\r\n            dialog.open();\r\n            dialog.execute();\r\n\r\n            ready.forEach((k, v) -> {\r\n                if (k.equals(\"error\")) {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_CREATE_ASSORTMENT_FIRST, getLocale(), getCtx()));\r\n                }\r\n            });\r\n        });\r\n\r\n        Button previewVersion = new Button(VaadinIcon.EYE.create());\r\n        previewVersion.setId(\"assortment-file-preview\");\r\n        CompUtils.addToolTip(getCtx(), previewVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_PREVIEW_TOOLTIP);\r\n        previewVersion.addClickListener(event -> {\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n                if (Objects.nonNull(assortment) && !assortment.getName().isEmpty()) {\r\n                    loadPreviewBreadCrumb();\r\n                    ToPreviewCrumpDialog pDialog = new ToPreviewCrumpDialog(getCtx());\r\n                    pDialog.open();\r\n                    pDialog.run();\r\n                }\r\n            });\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n\r\n        downloadBtn = new DownloadButton(getCtx(), TMS.LOADER_ASSORTMENT_GRID_BUTTON_DOWNLOAD_TOOLTIP);\r\n        return buttons(newVersion, deleteVersion, unlockVersion, downloadBtn, uploadVersion, previewVersion);\r\n    }\r\n\r\n    /**\r\n     * The downloader function is responsible for downloading the assortment as a zip file.\r\n     * It does this by first building the name of the zip file, then reloading it as a downloadable file.\r\n     * The downloadBtn is an instance of {\r\n     *\r\n     * @param Assortment assortment Get the assortment name and id\r\n     * @return A function that returns a file name and a function that returns the content of the zip file\r\n     * @docauthor Trelent\r\n     */\r\n    private void downloader(Assortment assortment) {\r\n        if (Objects.nonNull(assortment)) {\r\n            final String zipFileName = ExportFileUtils.buildZIPFileName(getCtx(), assortment);\r\n            downloadBtn.reloadAsFile(() -> zipFileName, () -> AssortmentUtil.zip(getCtx(), assortment));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The createNewAssortment function creates a new assortment object and saves it to the database.\r\n     *\r\n     * @param List&lt;DataFile&gt; selectedFiles Pass the list of selected files to the createnewassortment function\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    public Assortment createNewAssortment(List<DataFile> selectedFiles) {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        Assortment assortment = new Assortment();\r\n        assortment.setDate(user);\r\n        assortment.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        assortment = getServices().getAssortmentService().save(assortment);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.PROMOTION, assortment);\r\n        setSessionAssortment(assortment);\r\n        return setDataFilesToAssortment(assortment, selectedFiles);\r\n    }\r\n\r\n    /**\r\n     * The setDataFilesToAssortment function takes an assortment and a list of datafiles as parameters.\r\n     * It then checks if the selected files are valid, and if they are it adds them to the assortment.\r\n     *\r\n     * @param Assortment           assortment Get the assortment id and name\r\n     * @param List&lt;DataFile&gt; selectedFiles Add the selected files to the assortment\r\n     * @return An assortment\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment setDataFilesToAssortment(Assortment assortment, List<DataFile> selectedFiles) {\r\n        Assortment result = null;\r\n        List<AstFile> datafiles = getAstFileTypeFromAssortment(assortment, DataFile.class);\r\n        boolean valid = false;\r\n        for (DataFile datafile : selectedFiles) {\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, datafile);\r\n            if (type.equals(ObjectType.PROMOTION_INPUT)) {\r\n                valid = true;\r\n            }\r\n        }\r\n\r\n        if (valid) {\r\n            selectedFiles.forEach(dataFile -> {\r\n                boolean notValid = false;\r\n                for (AstFile datafile : datafiles) {\r\n                    if (datafile.getId() == dataFile.getId()) {\r\n                        notValid = true;\r\n                        break;\r\n                    }\r\n                }\r\n                if (!notValid) {\r\n                    AssortmentDatafile xrossFile = new AssortmentDatafile();\r\n                    xrossFile.setAssortment(assortment);\r\n                    xrossFile.setAstFile(dataFile);\r\n                    getServices().getAssortmentDataFileService().save(xrossFile);\r\n                }\r\n            });\r\n            result = assortment;\r\n\r\n            // reloadTable\r\n            reloadAssortmentGrid();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The getDatafileGrid function returns the dataFileGrid object.\r\n     *\r\n     * @return The datafilegrid\r\n     * @docauthor Trelent\r\n     */\r\n    public Grid<DataFile> getDatafileGrid() {\r\n        return dataFileGrid;\r\n    }\r\n\r\n    /**\r\n     * The getAssortmentGrid function returns the assortmentGrid object.\r\n     *\r\n     * @return The assortmentgrid\r\n     * @docauthor Trelent\r\n     */\r\n    public Grid<Assortment> getAssortmentGrid() {\r\n        return assortmentGrid;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reload the buttons on the screen.\r\n     * This function is called when a new page has been loaded, and it sets all of\r\n     * the buttons to be disabled except for &quot;Exit&quot;. The reason that this function\r\n     * exists is because we want to make sure that no other button can be clicked until\r\n     * after a user has finished answering questions on a given page. This prevents users from skipping ahead in the survey or going back before they have answered all of their questions.\r\n     *\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the assortment grid and datafile grid, as well as resets the breadcrumbs to their first state.\r\n     *\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            reloadAssortmentGrid();\r\n            reloadDatafileGrid();\r\n            reset2BreadCrumbFirst();\r\n        });\r\n        reloadInfoBox(UI.getCurrent());\r\n    }\r\n\r\n    /**\r\n     * The reset2BreadCrumbFirst function is called when the user clicks on a breadcrumb.\r\n     * It removes all breadcrumbs after the clicked one, and then reloads the buttons in\r\n     * order to update them with their new values. Finally, it calls initial() on the box\r\n     * so that it can be updated with its new values as well. The box is then put back into\r\n     * UserSession so that it can be accessed by other functions later on if needed.\r\n     *\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    private void reset2BreadCrumbFirst() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            if (!box.getCrumbs().contains(this))\r\n                box.getCrumbs().add(this);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            reloadButtons();\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadAssortmentsBreadCrumb function is a helper function that loads the breadcrumb for the Assortments page.\r\n     *\r\n     * @return The loadpreviewbreadcrumb function\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadAssortmentsBreadCrumb() {\r\n        loadPreviewBreadCrumb();\r\n    }\r\n\r\n    /**\r\n     * The loadFileEditBreadCrumb function is called when the user clicks on a file in the FileListView.\r\n     * It loads a new breadcrumb into the BreadBox, which will be displayed at the top of the screen.\r\n     * The breadcrumb contains an icon and text that indicates to users what they are currently viewing.\r\n     *\r\n     * @return A breadbox object\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadFileEditBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new FileEditCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadPreviewBreadCrumb function is called when the user clicks on the Preview button.\r\n     * It loads a new breadcrumb into the BreadBox, which is then displayed in the UI.\r\n     *\r\n     * @return A breadbox object\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadPreviewBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new PreviewCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    // thinks to do Before Jump to Individual or Save'N'Finish\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the CrumbProgressDialog.\r\n     * It sets the label of the dialog to &quot;Set Proof&quot; and calls getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n     *\r\n     * @param CrumbProgressDialog dialog Update the progress bar\r\n     * @return\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        dialog.setLabel(TMS.setProof(FilterType.ZUORDNUNG_MATERIAL));\r\n        getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL,\r\n                FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     *\r\n     * @return A boolean\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is called by the FileImportDialog class to initialize the layout of this\r\n     * specific importer. The function adds a number of checkboxes to the dialog, each representing a\r\n     * column in an imported file. The user can then select which columns should be used for what purpose.\r\n     *\r\n     * @param FileImportDialog dialog Access the dialog's components\r\n     * @return A value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        /* 00 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        /* 01 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CURRENCY, false);\r\n        /* 02 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, false);\r\n        /* 03 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_TERRITORY, false);\r\n        /* 04 */\r\n        priceHeader = dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, false);\r\n        /* 05 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n        /* 06 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n        /* 07 */\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_AW_NUMBER, false);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It takes all of the data from each row in a table and creates an ArticleBase object for each one,\r\n     * then adds it to a list of ArticleBase objects. If there are any articles in this list, it will create\r\n     * a DataFile object and set its date to be equal to that of today's date (using getCtx().getSession().getCurrentUser(getCtx())).\r\n     * Then, it calls setDefaultParameterToDataFile() with this DataFile object as well\r\n     *\r\n     * @param FileImportDialog dialog Get the data from the file\r\n     * @return A list of articlebase\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        dialog.getTable().forEach(row -> {\r\n            ArticleBase price = setPrice(row, dialog);\r\n            if (Objects.nonNull(price)) {\r\n                articles.add(price);\r\n            }\r\n        });\r\n\r\n        if (!articles.isEmpty()) {\r\n            UI.getCurrent().access(() -> {\r\n                dialog.removeAll();\r\n                dialog.init();\r\n                dialog.setLabel(TMS.LOADER_DIALOG_CONVERT_FILE);\r\n\r\n                DataFile dataFile = new DataFile();\r\n                dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                dataFile = getCtx().getServices().getDataFileService().save(dataFile);\r\n\r\n                File fi = ExportFileUtils.buildPromotionFile(getCtx(), articles, ASTConst.DEFAULT, dataFile);\r\n                setParameter(FileParam.FILE_TYPE, ObjectType.PROMOTION_INPUT, dataFile);\r\n                if (priceHeader.getOptionalValue().isPresent()) {\r\n                    setParameter(FileParam.HAS_PRICE, Boolean.TRUE, dataFile);\r\n                }\r\n                dataFile.setName(ExportFileUtils.buildPromotionFileName(getCtx(), dataFile));\r\n                dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n                dataFile = getServices().getDataFileService().save(dataFile);\r\n                saveStorage(dataFile, fi);\r\n\r\n                final DataFile dFile = dataFile;\r\n                Map<Integer, String> colString = dialog.getTable().get(0);\r\n\r\n                // CURRENCY\r\n                if (dialog.getColumns()[1] > -1) {\r\n                    String currency = dialog.getColumnsByIdx(colString, 1);\r\n                    if (!currency.isEmpty()) {\r\n                        List<Currency> items = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n                        Optional<Currency> opt = items.stream().filter(item -> item.getKey().equals(currency))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.CURRENCY, value, dFile));\r\n                    }\r\n                }\r\n                // LANGUAGE\r\n                if (dialog.getColumns()[2] > -1) {\r\n                    String language = dialog.getColumnsByIdx(colString, 2);\r\n                    if (!language.isEmpty()) {\r\n                        List<Language> items = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n                        Optional<Language> opt = items.stream().filter(item -> item.getLabel().contains(language))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.LANGUAGE, value, dFile));\r\n                    }\r\n                }\r\n                // TERRITORY\r\n                if (dialog.getColumns()[3] > -1) {\r\n                    String territory = dialog.getColumnsByIdx(colString, 3);\r\n                    if (!territory.isEmpty()) {\r\n                        List<Territory> items = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n                        Optional<Territory> opt = items.stream().filter(item -> item.getKey().equals(territory))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.TERRITORY, value, dFile));\r\n                    }\r\n                }\r\n                // AW_NUMBER\r\n                if (dialog.getColumns()[7] > -1) {\r\n                    String awNumber = dialog.getColumnsByIdx(colString, 7);\r\n                    if (!awNumber.isEmpty()) {\r\n                        setParameter(FileParam.AW_NUMBER, awNumber, dFile);\r\n                    }\r\n                }\r\n\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                reloadDatafileGrid();\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setPrice function takes the data from the file and sets it to a new ArticleBase object.\r\n     *\r\n     * @param Map&lt;Integer   Map the columns in the file to a specific column in the database\r\n     * @param String&gt;       colString Get the data from the file\r\n     * @param FileImportDialog dialog Get the column indexes\r\n     *                         private articlebase setarticle(map&lt;integer, string&gt; colstring, fileimportdialog dialog) {\r\n     *                         assortment assortment = getctx()\r\n     * @return An articlebase object\r\n     * @docauthor Trelent\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n\r\n        if (Objects.nonNull(colString)) {\r\n            if (dialog.getColumns()[0] > -1) {\r\n                price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n            }\r\n            if (dialog.getColumns()[4] > -1) {\r\n                price.setPriceFirst(dialog.getColumnsByIdx(colString, 4));\r\n            }\r\n            if (dialog.getColumns()[5] > -1) {\r\n                price.setPriceX(dialog.getColumnsByIdx(colString, 5));\r\n            }\r\n            if (dialog.getColumns()[6] > -1) {\r\n                price.setScalelimit(dialog.getColumnsByIdx(colString, 6));\r\n            }\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It saves a DataFile object to the database, and then calls ExportFileUtils.buildPromotionFile() to create an Excel file containing all of\r\n     * the articles that were imported from a CSV file by calling readCSV(). This function also sets some parameters for this DataFile object, such as its language and type (PROMOTION_INPUT).\r\n     *\r\n     * @param FileImportDialog        dialog Get the file name and path of the uploaded file\r\n     * @param List&lt;ArticleBase&gt; articles Get the list of articles to be saved\r\n     * @return The datafile object\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        DataFile dataFile = new DataFile();\r\n        dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n\r\n        dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        dataFile = getServices().getDataFileService().save(dataFile);\r\n        setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n        dataFile.setName(ExportFileUtils.buildPromotionFileName(getCtx(), dataFile));\r\n        saveStorage(dataFile, ExportFileUtils.buildPromotionFile(getCtx(), articles, ASTConst.DEFAULT, dataFile));\r\n        getServices().getDataFileService().save(dataFile);\r\n\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.PROMOTION_INPUT, dataFile);\r\n        setLanguageParamByCustomer(dataFile);\r\n\r\n        reloadDatafileGrid();\r\n    }\r\n\r\n    /**\r\n     * The setSessionAssortment function is used to set the active assortment in the user session.\r\n     *\r\n     * @param Assortment assortment Set the active assortment in the session\r\n     * @return An optional&lt;assortment&gt; object\r\n     * @docauthor Trelent\r\n     */\r\n    private void setSessionAssortment(Assortment assortment) {\r\n        Optional<Assortment> optAssortment = getServices().getAssortmentService().findById(assortment.getId());\r\n        optAssortment.ifPresent(item ->\r\n                getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, item)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The getSelectedItems function returns a list of DataFile objects that have been selected in the data file grid.\r\n     * The function first creates an empty ArrayList object called selectedFiles, which will be populated with the\r\n     * DataFile objects that are returned by the getSelectedItems method of the data file grid.  This method returns a set\r\n     * of items from within its internal selection model, and these items are then added to our new ArrayList object.\r\n     * Next we iterate through each item in this list using Java 8's forEach lambda expression syntax (which is equivalent to:  for(DataFile item : selectedFiles\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    private List<DataFile> getSelectedItems() {\r\n        List<DataFile> selectedFiles = new ArrayList<>(dataFileGrid.getSelectedItems());\r\n        selectedFiles.forEach(item -> {\r\n            Optional<DataFile> optDatafile = getCtx().getServices().getDataFileService().findById(item.getId());\r\n            if (optDatafile.isPresent())\r\n                item = optDatafile.get();\r\n        });\r\n        return selectedFiles;\r\n    }\r\n\r\n    /**\r\n     * The setDefaultParameterToDataFile function is used to set the default parameters for a data file.\r\n     * The function takes in two arguments: articles and save.\r\n     * The first argument, articles, is a list of ArticleBase objects that are being saved into the data file.\r\n     * The second argument, save, is an AstFile object that represents the data file being created or updated with new information from articles.\r\n     * This function sets default values for three parameters: currency (Currency), language (Language), and territory (Territory).\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Get the first article in the list\r\n     * @param AstFile                 save Save the parameters to the file\r\n     * @return The default parameter to the data file\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDefaultParameterToDataFile(List<ArticleBase> articles, AstFile save) {\r\n        ArticleBase first = articles.get(0);\r\n\r\n        List<Currency> currencies = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n        List<Language> languages = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n        List<Territory> territories = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n\r\n        if (!first.getCurrency().isEmpty() && Objects.isNull(getParameter(FileParam.CURRENCY, save))) {\r\n            Optional<Currency> optCurr = currencies.stream().filter(item -> item.getKey().equals(first.getCurrency()))\r\n                    .findFirst();\r\n            optCurr.ifPresent(item -> setParameter(FileParam.CURRENCY, item, save));\r\n        }\r\n        if (!first.getTerritory().isEmpty() && Objects.isNull(getParameter(FileParam.TERRITORY, save))) {\r\n            String territory = first.getTerritory();\r\n            if (territory.contains(\"-\") && Objects.isNull(getParameter(FileParam.LANGUAGE, save))) {\r\n                String language = territory.split(\"-\")[0];\r\n                territory = territory.split(\"-\")[2];\r\n                Optional<Language> optLang = languages.stream().filter(item -> item.getKey().equals(language))\r\n                        .findFirst();\r\n                optLang.ifPresent(item -> setParameter(FileParam.LANGUAGE, item, save));\r\n            }\r\n            String finalTerr = territory;\r\n            Optional<Territory> optTerr = territories.stream().filter(item -> item.getKey().equals(finalTerr))\r\n                    .findFirst();\r\n            optTerr.ifPresent(item -> setParameter(FileParam.TERRITORY, item, save));\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\crumb\\LoaderCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\crumb\\PreviewCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.promotion.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.ExcelUtils;\r\nimport com.hom.ebmw.utilities.InternalUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.TabBox;\r\nimport com.hom.ebmw.view.dialogs.FileConvertDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseQuickDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.Component;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.progressbar.ProgressBar;\r\nimport com.vaadin.flow.component.tabs.Tab;\r\nimport com.vaadin.flow.component.tabs.Tabs;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.HashMap;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_PREVIEW)\r\npublic class PreviewCrumb extends Crumb {\r\n\r\n    private final Tabs tabBay = new Tabs();\r\n    private final Div pages = new Div();\r\n    private final Map<Tab, VerticalLayout> tabMap = new HashMap<Tab, VerticalLayout>();\r\n    private final ArticleDetailBox details;\r\n    private Assortment assortment = null;\r\n\r\n    /**\r\n     * The PreviewCrumb function is a constructor for the PreviewCrumb class.\r\n     * It creates an ArticleDetailBox object, and adds it to the tabBay and pages components.\r\n     * The function also sets up a listener that will change which page is visible when the user selects a different tab in the tabBay component.\r\n     *\r\n     * @param Context ctx Get the user session\r\n     * @return A new previewcrumb object\r\n     * @docauthor Trelent\r\n     */\r\n    public PreviewCrumb(Context ctx) {\r\n        super(ctx);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_UI, UI.getCurrent());\r\n        this.assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        details = new ArticleDetailBox(getCtx(), new ArrayList<ArticleBase>());\r\n        add(details, tabBay, pages);\r\n        pages.setSizeFull();\r\n\r\n        tabBay.addSelectedChangeListener(event -> {\r\n            tabMap.forEach((k, v) -> {\r\n                v.setVisible(false);\r\n            });\r\n            Component selectedPage = tabMap.get(tabBay.getSelectedTab());\r\n            selectedPage.setVisible(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a tab in the\r\n     * assortment view. It removes all tabs and pages from the tabBay, clears\r\n     * all entries from the tabMap, and then adds two new tabs to represent\r\n     * price lists and removed articles. The details page is also reloaded with\r\n     * a list of archived articles for this assortment. This function allows us to\r\n     * switch between assortments without having to refresh or reload any other part of our application.\r\n     *\r\n     * @return The name of the current tab\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        final UI ui = UI.getCurrent();\r\n\r\n        ui.access(() -> {\r\n            tabBay.removeAll();\r\n            pages.removeAll();\r\n            tabMap.clear();\r\n\r\n            addTabPriceList(assortment);\r\n            addTabRemoved(assortment);\r\n        });\r\n\r\n        details.reload(() -> getServices().getArticleBaseService().findAllInArchivByAssortment(assortment));\r\n    }\r\n\r\n    /**\r\n     * The addTabPriceList function adds a tab to the preview window.\r\n     * The tab is labeled &quot;Price List&quot; and contains a grid with columns for:\r\n     * Customer Article Number, Article Number, Price First (with thousand separator),\r\n     * Price X (with thousand separator), Scale Limit.  The grid is populated by all articles in the assortment that are not comments.\r\n     *\r\n     * @param Assortment assortment Get the assortment id\r\n     *                   private void addtabpricelistwithscale(assortment assortment) {\r\n     *                   tabbox&lt;articlebase&gt; box = new tabbox&lt;articlebase&gt;(getctx());\r\n     *                   box\r\n     * @return A tabbox&lt;articlebase&gt;\r\n     * @docauthor Trelent\r\n     */\r\n    private void addTabPriceList(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_PRICELIST, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(ArticleBase::getCustomerArticleNr)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_CUSTOMER_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"customerArticleNr\");\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"articleNr\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceFirstWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_FIRST, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                .setSortable(true)\r\n                .setKey(\"priceFirst\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceXWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_SCALE, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX()))\r\n                .setSortable(true)\r\n                .setKey(\"priceX\");\r\n        box.getGrid().addColumn(ArticleBase::getScalelimit)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_SCALE_LIMIT, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"scalelimit\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n\r\n        box.setLoad(loadGrid(box, () -> {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, false);\r\n            box.getDownload().reloadAsFile(() -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\", () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT, box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        Button customExport = new Button(getTranslation(TMS.GENERATE_DIALOG_RENDER_EXPORT, getLocale(), getCtx()));\r\n        customExport.addClickListener(event -> {\r\n            FileConvertDialog dialog = new FileConvertDialog(getCtx());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        box.getButtons().add(customExport);\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    /**\r\n     * The addTabRemoved function adds a tab to the preview page.\r\n     * The tab is labeled &quot;Removed&quot; and contains a grid with all articles that have been removed from the assortment.\r\n     * The grid has columns for customer article number, article number, price first, price scale, scale limit and comment.\r\n     *\r\n     * @param Assortment assortment Get the assortment id and to get the articles that belong to this assortment\r\n     *                   private void addtabchanged(assortment assortment) {\r\n     *                   tabbox&lt;articlebase&gt; box = new tabbox&lt;articlebase&gt;(getctx());\r\n     *                   box\r\n     * @return A tab with the removed articles\r\n     * @docauthor Trelent\r\n     */\r\n    private void addTabRemoved(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_REMOVED, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(ArticleBase::getCustomerArticleNr)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_CUSTOMER_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"customerArticleNr\");\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"articleNr\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceFirstWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_FIRST, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                .setSortable(true)\r\n                .setKey(\"priceFirst\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceXWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_SCALE, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX()))\r\n                .setSortable(true)\r\n                .setKey(\"priceX\");\r\n        box.getGrid().addColumn(ArticleBase::getScalelimit)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_SCALE_LIMIT, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"scalelimit\");\r\n        box.getGrid().addColumn(ArticleBase::getComment)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_COMMENT, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"comment\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n        box.setLoad(loadGrid(box, () -> {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, true);\r\n            box.getDownload().reloadAsFile(\r\n                    () -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT, box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    /**\r\n     * The loadGrid function is a helper function that takes in a TabBox and Callable.\r\n     * The TabBox is the grid that will be loaded with data from the callable.\r\n     * The callable returns a list of objects, which are then used to populate the grid.\r\n     *\r\n     * @param TabBox&lt;E&gt;               box Pass the tabbox object to the loadgrid function\r\n     * @param Callable&lt;List&lt;E&gt;&gt; list Pass a list of articles to the loadgrid function\r\n     * @return A progress bar, but i don't know how to use it\r\n     * @docauthor Trelent\r\n     */\r\n    private <E> ProgressBar loadGrid(TabBox<E> box, Callable<List<E>> list) {\r\n        ProgressBar progress = new ProgressBar();\r\n        progress.setIndeterminate(true);\r\n        final UI ui = UI.getCurrent();\r\n\r\n        new Thread(() -> {\r\n            ui.access(() -> {\r\n                progress.setVisible(true);\r\n                try {\r\n                    List<E> buffer = list.call();\r\n                    box.setDataProvider(DataProvider.ofCollection(buffer));\r\n                    box.runFoundArticle();\r\n                } catch (Exception e) {\r\n                    log.error(e.getLocalizedMessage());\r\n                    log.debug(e.toString());\r\n                }\r\n                progress.setVisible(false);\r\n            });\r\n        }).start();\r\n        return progress;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reset the buttons on the bottom of the screen.\r\n     * It sets all buttons to their default state, which is:\r\n     * - Exit button enabled (true)\r\n     * - Next button disabled (false)\r\n     * - Last button disabled (false)\r\n     *\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setExitEnable(true);\r\n            setNextEnable(false);\r\n            setLastEnable(false);\r\n            setFinishEnable(false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user clicks on the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then closes the program.\r\n     *\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        CloseQuickDialog dialog = new CloseQuickDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\crumb\\PreviewCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\PromotionPresenter.java =====\n```\npackage com.hom.ebmw.view.sortment.promotion;\r\n\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.view.sortment.promotion.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\n\r\nimport java.util.Locale;\r\nimport java.util.Objects;\r\n\r\npublic class PromotionPresenter {\r\n\r\n    private LoaderCrumb loader;\r\n    private Importer importer;\r\n    private InfoBox info;\r\n    private LocalCustomer localCustomer;\r\n\r\n    private Context ctx = new Context();\r\n\r\n    /**\r\n     * The PromotionPresenter function is a constructor that takes in the context of the activity\r\n     * and sets it to this.ctx.\r\n     *\r\n     * @param Context ctx Get the application context\r\n     * @return A new instance of the promotionpresenter class\r\n     * @docauthor Trelent\r\n     */\r\n    public PromotionPresenter(Context ctx) {\r\n        this.ctx = ctx;\r\n    }\r\n\r\n    /**\r\n     * The setLoader function sets the loader variable to a new LoaderCrumb object.\r\n     *\r\n     * @param LoaderCrumb loader Set the loader of the current crumb\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    public void setLoader(LoaderCrumb loader) {\r\n        this.loader = loader;\r\n    }\r\n\r\n    /**\r\n     * The setInfo function sets the info box to a new InfoBox object.\r\n     *\r\n     * @param InfoBox info Set the info field to the value of\r\n     *                info\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    public void setInfo(InfoBox info) {\r\n        this.info = info;\r\n    }\r\n\r\n    /**\r\n     * The getInfo function returns the infoBox object associated with this node.\r\n     *\r\n     * @return The info box\r\n     * @docauthor Trelent\r\n     */\r\n    public InfoBox getInfo() {\r\n        return info;\r\n    }\r\n\r\n    /**\r\n     * The setImporter function sets the importer variable to the Importer object passed in as a parameter.\r\n     *\r\n     * @param Importer importer Set the importer for this class\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    public void setImporter(Importer importer) {\r\n        this.importer = importer;\r\n    }\r\n\r\n    /**\r\n     * The setChangeValue function is called when the user selects a customer from the dropdown menu.\r\n     * It sets the localCustomer variable to be equal to whatever customer was selected, and then calls\r\n     * reloadDatafileGrid() and reloadAssortmentGrid(). These functions are defined in Loader.java,\r\n     * which is where all of our data loading code lives. The setChangeValue function also makes sure that\r\n     * our uploader component (which allows users to upload files) is visible if a customer has been selected,\r\n     * but invisible otherwise. This prevents users from uploading files before they have chosen a project/customer.\r\n     *\r\n     * @param LocalCustomer customer Set the localcustomer variable\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    public void setChangeValue(LocalCustomer customer) {\r\n        if (Objects.nonNull(customer)) {\r\n            importer.getUploader().setVisible(true);\r\n            localCustomer = customer;\r\n            CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n            loader.reloadDatafileGrid();\r\n            loader.reloadAssortmentGrid();\r\n        } else {\r\n            importer.getUploader().setVisible(false);\r\n        }\r\n    }\r\n\r\n    public void setStartedEvent(Locale locale) {\r\n        //CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\PromotionPresenter.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\PromotionView.java =====\n```\npackage com.hom.ebmw.view.sortment.promotion;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.BaseLayout;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.promotion.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\n\r\nimport java.util.Objects;\r\nimport java.util.Optional;\r\n\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_PROMOTION;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_PROMOTION;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_PROMOTION, layout = MainView.class)\r\n@PageTitle(TITLE_PROMOTION)\r\npublic class PromotionView extends BaseLayout implements HasPermission {\r\n\r\n    private final PromotionPresenter presenter;\r\n    private final Context ctx = new Context();\r\n    private final Importer importer;\r\n\r\n\r\n    /**\r\n     * The PromotionView function is the constructor for the PromotionView class.\r\n     * It sets up all of the sections of a PromotionView, including:\r\n     * - The left section (which contains a list of promotions)\r\n     * - The right section (which contains information about an individual promotion)\r\n     * - The middle section (which allows users to create new promotions and edit existing ones)\r\n     *\r\n     * @param @Autowired Services services Inject the services bean into this class\r\n     * @return A view object\r\n     * @docauthor Trelent\r\n     */\r\n    public PromotionView(@Autowired Services services) {\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        this.presenter = new PromotionPresenter(ctx);\r\n        ctx.getUserSession().put(Params.ACTIVE_TYPE, ObjectType.PROMOTION);\r\n        importer = new Importer(ctx);\r\n\r\n        setLeftSection();\r\n        setMiddleSection();\r\n        setRightSection();\r\n    }\r\n\r\n    /**\r\n     * The setMiddleSection function is responsible for creating the middle section of the GUI.\r\n     * The middle section contains a BreadBox, which in turn contains a LoaderCrumb.\r\n     * The LoaderCrumb is used to load and display all other Crumbs that are created by this program.\r\n     *\r\n     * @return A breadbox\r\n     * @docauthor Trelent\r\n     */\r\n    private void setMiddleSection() {\r\n        LoaderCrumb loader = new LoaderCrumb(ctx);\r\n        presenter.setLoader(loader);\r\n\r\n        Optional<LocalCustomer> customer = ctx.getServices().getLocalCustomerService().findByCustomerId(ASTConst.PROMOTION_CUSTOMER);\r\n        customer.ifPresent(cust -> {\r\n            importer.setSelectedLocalCustomer(cust);\r\n            importer.disableCustomerView();\r\n        });\r\n\r\n        BreadBox breadBox = new BreadBox(ctx);\r\n        breadBox.setDefaultCrumb(loader);\r\n\r\n        breadBox.getCrumbs().add(loader);\r\n        breadBox.initial();\r\n\r\n        getMiddleSection().add(breadBox);\r\n\r\n        breadBox.setContent(loader);\r\n        loader.reloadButtons();\r\n        loader.reloadCrumb();\r\n    }\r\n\r\n    /**\r\n     * The setLeftSection function is responsible for setting the left section of the view.\r\n     * It does this by adding a new Importer object to it, and then adding listeners to that importer.\r\n     * The first listener is added to the CustomerValueChangeListener, which calls setChangeValue on presenter with e.getValue().\r\n     * The second listener is added to RoleValueChangeListener, which checks if importer has a selected value or not before calling setChangeValue on presenter with importer's selected value.  If there was no selected value in importer, it reloads customer instead of calling setChang\r\n     *\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    private void setLeftSection() {\r\n\r\n        presenter.setImporter(importer);\r\n\r\n        importer.addCustomerValueChangeListener(e ->\r\n                presenter.setChangeValue(e.getValue())\r\n        );\r\n\r\n        importer.addRoleValueChangeListener(e -> {\r\n            if (Objects.nonNull(importer.getSelected()))\r\n                presenter.setChangeValue(importer.getSelected());\r\n            importer.reloadCustomer();\r\n        });\r\n\r\n        importer.getUploader().addStartedListener(e ->\r\n                presenter.setStartedEvent(getLocale())\r\n        );\r\n\r\n        importer.getUploader().addSucceededListener(e -> {\r\n            FileImportDialog dialog = new FileImportDialog(ctx, e, importer.getMemoryFileBuffer());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        getLeftSection().add(importer);\r\n    }\r\n\r\n    /**\r\n     * The setRightSection function is called by the setRightSection function.\r\n     * It creates a new InfoBox object, and then adds it to the right section of the page.\r\n     *\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    private void setRightSection() {\r\n        InfoBox info = new InfoBox(ctx);\r\n\r\n        ctx.getUserSession().put(Params.ACTIVE_INFO_BOX, info);\r\n\r\n        presenter.setInfo(info);\r\n        getRightSection().add(info);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\promotion\\PromotionView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\SortmentHeader.java =====\n```\npackage com.hom.ebmw.view.sortment;\r\n\r\npublic class SortmentHeader {\r\n    /*\r\n    is used asPermission object\r\n     */\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\SortmentHeader.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subservice\\CustomerOffsetService.java =====\n```\npackage com.hom.ebmw.view.sortment.subservice;\r\n\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.stream.Stream;\r\n\r\npublic class CustomerOffsetService {\r\n\r\n    private List<LocalCustomer> customers = new ArrayList<LocalCustomer>();\r\n\r\n    /**\r\n     * The CustomerOffsetService function takes a list of LocalCustomer objects and returns the offset\r\n     * between the customer's latitude and longitude coordinates. The function is used to determine\r\n     * which customers are within 100km of Dublin, Ireland.\r\n     *\r\n     * @param List&lt;LocalCustomer&gt; customers Pass the list of customers from the main method to this class\r\n     * @return A list of localcustomers\r\n     * @docauthor Trelent\r\n     */\r\n    public CustomerOffsetService(List<LocalCustomer> customers) {\r\n        this.customers = customers;\r\n    }\r\n\r\n    /**\r\n     * The fetch function is used to retrieve a list of customers from the database.\r\n     * The function takes in three parameters: filter, offset, and limit.\r\n     * The filter parameter is used to search for a specific customer by their code name or full name.\r\n     * The offset parameter determines how many results are skipped before returning the first result (used for pagination).\r\n     * The limit parameter determines how many results are returned after skipping the specified number of results (also used for pagination).\r\n     *\r\n     * @param String filter Filter the results\r\n     * @param int    offset Skip the first offset number of elements in the stream\r\n     * @param int    limit Limit the number of results returned\r\n     * @return A stream of localcustomer objects\r\n     * @docauthor Trelent\r\n     */\r\n    public Stream<LocalCustomer> fetch(String filter, int offset, int limit) {\r\n        return customers.stream()\r\n                .filter(customer -> filter == null || customer\r\n                        .getCodeName().toLowerCase().contains(filter.toLowerCase()))\r\n                .skip(offset)\r\n                .limit(limit);\r\n    }\r\n\r\n    /**\r\n     * The count function returns the number of customers in the list.\r\n     *\r\n     * @param String filter Filter the customers by their code name\r\n     * @return The number of customers that match the filter\r\n     * @docauthor Trelent\r\n     */\r\n    public int count(String filter) {\r\n        return (int) customers.stream()\r\n                .filter(customer -> filter == null || customer.getCodeName()\r\n                        .toLowerCase().contains(filter.toLowerCase()))\r\n                .count();\r\n    }\r\n\r\n    /**\r\n     * The count function returns the number of customers in the list.\r\n     *\r\n     * @return The number of customers in the queue\r\n     * @docauthor Trelent\r\n     */\r\n    public int count() {\r\n        return customers.size();\r\n    }\r\n\r\n    /**\r\n     * The fetchAll function returns a list of all customers in the database.\r\n     *\r\n     * @return A list of all the customers in the database\r\n     * @docauthor Trelent\r\n     */\r\n    public List<LocalCustomer> fetchAll() {\r\n        return customers;\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subservice\\CustomerOffsetService.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subview\\ArticleDetailBox.java =====\n```\npackage com.hom.ebmw.view.sortment.subview;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.html.Span;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.progressbar.ProgressBar;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.*;\r\nimport java.util.concurrent.Callable;\r\n\r\nimport static com.hom.ebmw.utilities.CompUtils.addLine;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\npublic class ArticleDetailBox\r\n        extends\r\n        VerticalLayout {\r\n    private int importValue = 0;\r\n    private int offValue = 0;\r\n    private int notInValue = 0;\r\n    private int wOValue = 0;\r\n    private int validValue = 0;\r\n    private final Map<String, Integer> spezials = new HashMap<>();\r\n    private final Div body = new Div();\r\n    private ProgressBar progress = null;\r\n    private final Context ctx;\r\n\r\n    /**\r\n     * The ArticleDetailBox function is a constructor for the ArticleDetailBox class.\r\n     * It creates an instance of the ArticleDetailBox class, which is used to display\r\n     * information about articles in a list. The function takes two parameters: ctx and currentList.\r\n     * Ctx is a Context object that contains information about the user's session, such as their username and password.\r\n     * CurrentList is a List&lt;ArticleBase&gt; object that contains all of the articles currently being displayed on screen by\r\n     * other components (such as an article list). The function sets up some basic properties of this component, including its size and\r\n     *\r\n     * @param Context                 ctx Get the current context of the application\r\n     * @param List&lt;ArticleBase&gt; currentList Initialize the articledetailbox\r\n     * @return A horizontallayout\r\n     * @docauthor Trelent\r\n     */\r\n    public ArticleDetailBox(\r\n            Context ctx,\r\n            List<ArticleBase> currentList) {\r\n        this.ctx = ctx;\r\n        body.setSizeFull();\r\n        progress = new ProgressBar();\r\n        progress.setVisible(false);\r\n        refresh();\r\n        CompUtils.removeMSP(this, \"MP\");\r\n        setHeight(\"20px\");\r\n        setWidth(\"100%\");\r\n        add(body, progress);\r\n        getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        if (!currentList.isEmpty()) {\r\n            reload(() -> currentList);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The refresh function is used to update the values of the article details.\r\n     * It removes all components from the body and adds new ones with updated values.\r\n     *\r\n     * @return The result of the addline function\r\n     * @docauthor Trelent\r\n     */\r\n    public void refresh() {\r\n        body.removeAll();\r\n        HorizontalLayout row1 = new HorizontalLayout();\r\n        row1.add(addLine(ctx, TMS.ARTICLE_DETAIL_IMPORT, importValue, 100, \"%\"));\r\n        row1.add(addLine(ctx, TMS.ARTICLE_DETAIL_REMOVED, offValue, 100, \"%\"));\r\n        row1.add(addLine(ctx, TMS.ARTICLE_DETAIL_NOT_IN_PIM, notInValue, 100, \"%\"));\r\n        row1.add(addLine(ctx, TMS.ARTICLE_DETAIL_NOT_APPROVAL, wOValue, 100, \"%\"));\r\n        row1.add(addLine(ctx, TMS.ARTICLE_DETAIL_VALID, validValue, 100, \"%\"));\r\n        HorizontalLayout row2 = new HorizontalLayout();\r\n        row2.add(addSpezials(TMS.ARTICLE_DETAIL_SPECIAL, spezials));\r\n        body.add(row1);\r\n        row1.setSizeFull();\r\n        CompUtils.removeMSP(row1, \"MP\");\r\n    }\r\n\r\n    /**\r\n     * The reloadInner function is used to update the values of the statistics.\r\n     * It takes a list of ArticleBase objects as an argument and uses it to calculate\r\n     * new values for all statistics. The function first creates a buffer list, which is\r\n     * then filled with all elements from currentList. Then, using lambda expressions,\r\n     * each statistic's value is calculated by removing certain elements from the buffer list:&lt;br&gt;\r\n     * &lt;ul&gt;\t\t&lt;li&gt;&lt;b&gt;importValue&lt;/b&gt;: The number of articles in currentList.&lt;/li&gt;\r\n     * <p>\r\n     * &lt;li&gt;&lt;b&gt;offValue&lt;/b&gt;: All articles in currentList\r\n     *\r\n     * @param List&lt;ArticleBase&gt; currentList Reload the inner values\r\n     * @return The following values:\r\n     * @docauthor Trelent\r\n     */\r\n    private void reloadInner(List<ArticleBase> currentList) {\r\n        List<ArticleBase> buffer = new ArrayList<>();\r\n\r\n        importValue = currentList.size();\r\n\r\n        // REMOVED\r\n        buffer.clear();\r\n        buffer.addAll(currentList);\r\n        buffer.removeIf(item -> item.getComment().isEmpty());\r\n        offValue = buffer.size();\r\n\r\n        // NOT IN PIM\r\n        buffer.clear();\r\n        buffer.addAll(currentList);\r\n        buffer.removeIf(item -> !item.getFoundArticleFilterStatus().equals(FilterStatus.NOTPIM));\r\n        notInValue = buffer.size();\r\n\r\n        // NOT APPROVAL\r\n        buffer.clear();\r\n        buffer.addAll(currentList);\r\n        buffer.removeIf(item -> !item.getFoundArticleFilterStatus().equals(FilterStatus.NOTAPPROVAL));\r\n        wOValue = buffer.size();\r\n\r\n        // VALID\r\n        buffer.clear();\r\n        buffer.addAll(currentList);\r\n        buffer.removeIf(item -> !item.getFoundArticleFilterStatus().equals(FilterStatus.DEFAULT));\r\n        validValue = buffer.size();\r\n\r\n        spezials.clear();\r\n        buffer.clear();\r\n        buffer.addAll(currentList);\r\n        buffer.removeIf(item -> !item.getFoundArticleFilterStatus().equals(FilterStatus.DEFAULT));\r\n        buffer.removeIf(item -> !item.isSpecial());\r\n        buffer.forEach(item -> {\r\n            String key = item.getArticleNr().substring(0, 1);\r\n\r\n            if (Objects.isNull(spezials.get(key))) {\r\n                spezials.put(key, 1);\r\n            } else {\r\n                int value = spezials.get(key);\r\n                value++;\r\n                spezials.put(key, value);\r\n            }\r\n\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to update the list of articles in the ArticleList.\r\n     * It takes a Callable&lt;List&lt;ArticleBase&gt;&gt; as an argument, which is a function that returns\r\n     * a List of ArticleBase objects. The reload function then calls this function and uses its return value to\r\n     * update the list of articles in this component. This allows for asynchronous loading, so that if it takes some time\r\n     * for the callable to return (for example if it needs to make an API call), then we can show progress while waiting for it\r\n     * instead of blocking until we get results back from our API\r\n     *\r\n     * @param Callable&lt;List&lt;ArticleBase&gt;&gt; list Retrieve the list of articles from the database\r\n     * @return A list of articles, which is the same as the input\r\n     * @docauthor Trelent\r\n     */\r\n    public void reload(Callable<List<ArticleBase>> list) {\r\n        progress.setIndeterminate(true);\r\n        final UI ui = UI.getCurrent();\r\n        ui.access(() -> {\r\n            progress.setVisible(true);\r\n            body.setVisible(false);\r\n        });\r\n        new Thread(() -> {\r\n            try {\r\n                List<ArticleBase> buffer = list.call();\r\n                ui.access(() -> {\r\n                    reloadInner(buffer);\r\n                    refresh();\r\n                });\r\n            } catch (Exception e) {\r\n                log.error(e.getLocalizedMessage());\r\n                log.debug(e.toString());\r\n            }\r\n            ui.access(() -> {\r\n                progress.setVisible(false);\r\n                body.setVisible(true);\r\n            });\r\n        }).start();\r\n    }\r\n\r\n    /**\r\n     * The addSpezials function takes a String and a Map as parameters.\r\n     * The String is the label for the special abilities, which will be translated into the current locale.\r\n     * The Map contains all of the special abilities and their values, which are then displayed in an ordered list.\r\n     *\r\n     * @param String        tmsLabel Get the translation of the label\r\n     * @param Map&lt;String Store the specializations and their values\r\n     * @param Integer&gt;   spezials Store the special abilities of a character\r\n     * @return A horizontallayout with a span and a span\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout addSpezials(String tmsLabel, Map<String, Integer> spezials) {\r\n        HorizontalLayout block = new HorizontalLayout();\r\n        Span first = new Span(getTranslation(tmsLabel, getLocale(), ctx) + \": \");\r\n        String spcResult = \"\";\r\n        StringBuilder build = new StringBuilder();\r\n        spezials.forEach((k, v) ->\r\n                build.append((build.length() > 0 ? \" | \" : \"\") + k + \" (\" + v + \")\")\r\n        );\r\n        spcResult = build.toString();\r\n\r\n        Span second = new Span(spcResult);\r\n        first.setWidth(\"70%\");\r\n        second.setWidth(\"30%\");\r\n\r\n        block.add(first, second);\r\n        block.setSizeFull();\r\n        CompUtils.removeMSP(block, \"MP\");\r\n        return block;\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subview\\ArticleDetailBox.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subview\\CustomerLabelLayout.java =====\n```\npackage com.hom.ebmw.view.sortment.subview;\r\n\r\nimport com.hom.ebmw.jpa.dao.LocalCustomerDAO;\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.jpa.model.User;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.UserParameterUtils;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.utilities.enums.UserParameterType;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.components.CustomerFilterField;\r\nimport com.hom.ebmw.view.dialogs.CustomerDialog;\r\nimport com.hom.ebmw.view.sortment.subservice.CustomerOffsetService;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.notification.Notification;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\n\r\nimport java.util.List;\r\nimport java.util.Objects;\r\nimport java.util.Optional;\r\n\r\nimport static com.hom.ebmw.utilities.CompUtils.addLine;\r\n\r\npublic class CustomerLabelLayout extends VerticalLayout implements HasPermission {\r\n\r\n    /**\r\n     *\r\n     */\r\n    private static final long serialVersionUID = 7171291666054006264L;\r\n\r\n    private final VerticalLayout infoBox = new VerticalLayout();\r\n\r\n    private final ComboBox<LocalCustomer> customerCbx = new ComboBox<>();\r\n    private final Button newCustomer = new Button(VaadinIcon.FILE_ADD.create());\r\n    private final Button editCustomer = new Button(VaadinIcon.PENCIL.create());\r\n    private final Button deleteCustomer = new Button(VaadinIcon.TRASH.create());\r\n    private final CustomerFilterField customerFilter;\r\n    private final HorizontalLayout headLine;\r\n    private final Context ctx;\r\n    private final CustomerDialog dialog;\r\n\r\n    /**\r\n     * The CustomerLabelLayout function is a constructor for the CustomerLabelLayout class.\r\n     * It initializes the context, dialog, and customerFilter variables.\r\n     * It also sets the size of this object to undefined and removes margins from it.\r\n     * Then it calls setInfoLabel(), setCustomerCbx(), and initialComponent() functions to initialize them as well.\r\n     *\r\n     * @param Context ctx Create a new customerdialog object\r\n     * @return A horizontallayout\r\n     * @docauthor Trelent\r\n     */\r\n    public CustomerLabelLayout(Context ctx) {\r\n        this.ctx = ctx;\r\n        dialog = new CustomerDialog(ctx, this);\r\n        customerFilter = new CustomerFilterField(ctx, null);\r\n        setSizeUndefined();\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n\r\n        setInfoLabel();\r\n        setCustomerCbx();\r\n\r\n        headLine = new HorizontalLayout();\r\n        CompUtils.removeMSP(headLine, \"MSP\");\r\n        headLine.setSizeFull();\r\n\r\n        initialComponent();\r\n\r\n        add(headLine, infoBox);\r\n        infoBox.setDefaultHorizontalComponentAlignment(Alignment.STRETCH);\r\n        CompUtils.removeMSP(infoBox, \"MSP\");\r\n    }\r\n\r\n    /**\r\n     * The initialComponent function is used to initialize the components of the CustomerPanel.\r\n     * It adds a customerCbx, newCustomer, editCustomer and deleteCustomer to headLine.\r\n     *\r\n     * @return A component\r\n     * @docauthor Trelent\r\n     */\r\n    public void initialComponent() {\r\n        headLine.removeAll();\r\n        headLine.add(customerCbx);\r\n        User user = ctx.getSession().getCurrentUser(ctx);\r\n\r\n        Boolean isNew = UserParameterUtils.getParameter(ctx, UserParameterType.CUSTOMER_WRITE, user);\r\n        if (Objects.nonNull(isNew) && Boolean.TRUE.equals(isNew)) {\r\n            setNewCustomer();\r\n            headLine.add(newCustomer);\r\n        }\r\n        Boolean isEdit = UserParameterUtils.getParameter(ctx, UserParameterType.CUSTOMER_EDITABLE, user);\r\n        if (Objects.nonNull(isEdit) && Boolean.TRUE.equals(isEdit)) {\r\n            setEditCustomer();\r\n            headLine.add(editCustomer);\r\n        }\r\n        Boolean isDelete = UserParameterUtils.getParameter(ctx, UserParameterType.CUSTOMER_DELETE, user);\r\n        if (Objects.nonNull(isDelete) && Boolean.TRUE.equals(isDelete)) {\r\n            setDeleteCustomer();\r\n            headLine.add(deleteCustomer);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setNewCustomer function adds a tooltip to the newCustomer button, sets its ID, and adds a click listener.\r\n     * The click listener opens the dialog window with no customer information passed in.\r\n     *\r\n     * @return A button that is used to create a new customer\r\n     * @docauthor Trelent\r\n     */\r\n    private void setNewCustomer() {\r\n        CompUtils.addToolTip(ctx, newCustomer, TMS.LAYOUT_CUSTOMER_NEW_TOOLTIP);\r\n        newCustomer.setId(TMS.LAYOUT_CUSTOMER_NEW);\r\n        newCustomer.addClickListener(event -> {\r\n            dialog.initLayout(ctx, null);\r\n            dialog.open();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setEditCustomer function is used to set the editCustomer button.\r\n     * The function adds a tooltip to the button, sets its id, and adds a click listener.\r\n     * When clicked, it opens up the dialog box with information about that customer.\r\n     *\r\n     * @return Void, so the return type of seteditcustomer is void\r\n     * @docauthor Trelent\r\n     */\r\n    private void setEditCustomer() {\r\n        CompUtils.addToolTip(ctx, editCustomer, TMS.LAYOUT_CUSTOMER_EDIT_TOOLTIP);\r\n        editCustomer.setId(TMS.LAYOUT_CUSTOMER_EDIT);\r\n        editCustomer.addClickListener(event -> {\r\n            dialog.initLayout(ctx, ctx.getHttpAttribute(SessionParams.ACTIVE_CUSTOMER));\r\n            dialog.open();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setDeleteCustomer function is used to delete a customer from the database.\r\n     * It first checks if the customer exists in the database, and if it does, then it sets its &quot;delete&quot; attribute to true.\r\n     * If not, then an error message is displayed saying that this particular customer only exists in PIM and cannot be deleted.\r\n     *\r\n     * @return The deletecustomer object\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDeleteCustomer() {\r\n        CompUtils.addToolTip(ctx, deleteCustomer, TMS.LAYOUT_CUSTOMER_DELETE_TOOLTIP);\r\n        deleteCustomer.setId(TMS.LAYOUT_CUSTOMER_DELETE);\r\n        deleteCustomer.addClickListener(event -> {\r\n            LocalCustomer customer = ctx.getHttpAttribute(SessionParams.ACTIVE_CUSTOMER);\r\n            LocalCustomerDAO customerService = ctx.getServices().getLocalCustomerService();\r\n            Optional<LocalCustomer> optCustomer = customerService.findByCustomerId(customer.getCustomerId());\r\n            if (optCustomer.isPresent()) {\r\n                LocalCustomer localCustomer = optCustomer.get();\r\n                localCustomer.setDelete(true);\r\n                customerService.save(localCustomer);\r\n            } else {\r\n                Notification.show(getTranslation(TMS.ERROR_CUSTOMER_EXISTS_ONLY_IN_PIM, getLocale(), ctx));\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setCustomerCbx function sets the customerCbx ComboBox to display a list of customers.\r\n     * It also adds a ValueChangeListener to the customerCbx ComboBox, which makes it so that when\r\n     * an item is selected from the dropdown menu, two buttons appear: editCustomer and deleteCustomer.\r\n     *\r\n     * @return A combobox&lt;localcustomer&gt;\r\n     * @docauthor Trelent\r\n     */\r\n    private void setCustomerCbx() {\r\n        customerCbx.setClearButtonVisible(true);\r\n        customerCbx.setWidth(\"100%\");\r\n        customerCbx.setItemLabelGenerator(LocalCustomer::getCodeName);\r\n        customerCbx.setAllowCustomValue(false);\r\n        customerCbx.setClearButtonVisible(true);\r\n        if (Objects.isNull(customerCbx.getValue())) {\r\n            editCustomer.setVisible(false);\r\n            deleteCustomer.setVisible(false);\r\n        }\r\n        customerCbx.addValueChangeListener(event -> {\r\n\r\n            if (Objects.nonNull(event.getValue())) {\r\n                editCustomer.setVisible(true);\r\n                deleteCustomer.setVisible(true);\r\n            } else {\r\n                editCustomer.setVisible(false);\r\n                deleteCustomer.setVisible(false);\r\n            }\r\n        });\r\n\r\n        reload();\r\n    }\r\n\r\n    /**\r\n     * The setInfoLabel function is used to display the information of a customer in the infoBox.\r\n     * The function uses an addValueChangeListener to listen for changes in the value of customerCbx.\r\n     * If there is a change, it will get all information from that specific customer and put it into\r\n     * different lines in infoBox. It also checks if user has permission to see CustomerFilter, and if so,\r\n     * adds this component as well. If no value is selected (null), then remove all components from infoBox.\r\n     *\r\n     * @return A label with the customer's information\r\n     * @docauthor Trelent\r\n     */\r\n    private void setInfoLabel() {\r\n        customerCbx.addValueChangeListener(event -> {\r\n            if (!Objects.isNull(event.getValue())) {\r\n                LocalCustomer customer = event.getValue();\r\n                ctx.putHttpAttribute(SessionParams.ACTIVE_CUSTOMER, customer);\r\n                infoBox.removeAll();\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_NR, customer.getCustomerId()));\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_NAME, customer.getName()));\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_STREET, customer.getStreet()));\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_POSTAL, TMS.CUSTOMER_CITY,\r\n                        customer.getPostal() + \" \" + customer.getCity()));\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_BRANCH, customer.getCompanyBranch()));\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_E_BUSINESS, customer.getEBusiness()));\r\n                infoBox.add(addLine(ctx, TMS.CUSTOMER_KAM, customer.getKam()));\r\n                User user = ctx.getSession().getCurrentUser(ctx);\r\n                if (getPermission(user, ctx.getServices(), this.getClass().getCanonicalName() + \".CustomerFilter\").isRead()) {\r\n                    infoBox.add(customerFilter);\r\n                    customerFilter.reload(customer);\r\n                }\r\n            } else {\r\n                infoBox.removeAll();\r\n            }\r\n        });\r\n    }\r\n\r\n    //private HorizontalLayout selectActiveFilter() {}\r\n\r\n    /**\r\n     * The reload function is used to refresh the data in the customerCbx.\r\n     * It does this by first getting a list of all LocalCustomers from the database,\r\n     * then removing any LocalCustomer with an ID equal to ASTConst.PROMOTION_CUSTOMER (which is &quot;Promotion&quot;).\r\n     * Then it creates a new CustomerOffsetService object and sets its data provider using that object's fetch and count functions.\r\n     *\r\n     * @return A list of customers\r\n     * @docauthor Trelent\r\n     */\r\n    public void reload() {\r\n        List<LocalCustomer> localCustomer = ctx.getServices().getLocalCustomerCustomService().findAll();\r\n        localCustomer.removeIf(item -> item.getCustomerId().equals(ASTConst.PROMOTION_CUSTOMER));\r\n        CustomerOffsetService service = new CustomerOffsetService(localCustomer);\r\n        customerCbx.setDataProvider(service::fetch, service::count);\r\n    }\r\n\r\n    /**\r\n     * The getCustomerFilter function returns an Optional object that contains the CustomerFilterField object.\r\n     * If the customerFilter field is null, then it will return an empty Optional.\r\n     *\r\n     * @return An optional object\r\n     * @docauthor Trelent\r\n     */\r\n    public Optional<CustomerFilterField> getCustomerFilter() {\r\n        if (Objects.nonNull(customerFilter)) {\r\n            return Optional.of(customerFilter);\r\n        } else {\r\n            return Optional.empty();\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * The getCustomerCbx function returns the customerCbx variable.\r\n     *\r\n     * @return The customercbx object\r\n     * @docauthor Trelent\r\n     */\r\n    public ComboBox<LocalCustomer> getCustomerCbx() {\r\n        return customerCbx;\r\n    }\r\n\r\n    /**\r\n     * The setSelectedLocalCustomer function is used to set the value of the customerCbx ComboBox.\r\n     *\r\n     * @param LocalCustomer localCustomer Set the value of customercbx\r\n     *                      public void setselectedlocalcustomer(localcustomer localcustomer) {\r\n     *                      customercbx\r\n     * @return The value of the localcustomer object\r\n     * @docauthor Trelent\r\n     */\r\n    public void setSelectedLocalCustomer(LocalCustomer localCustomer) {\r\n        customerCbx.setValue(localCustomer);\r\n    }\r\n}\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subview\\CustomerLabelLayout.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subview\\Importer.java =====\n```\npackage com.hom.ebmw.view.sortment.subview;\r\n\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.jpa.model.Role;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.view.components.RoleChanger;\r\nimport com.vaadin.flow.component.AbstractField.ComponentValueChangeEvent;\r\nimport com.vaadin.flow.component.HasValue.ValueChangeListener;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.upload.Upload;\r\nimport com.vaadin.flow.component.upload.receivers.MultiFileMemoryBuffer;\r\nimport lombok.Getter;\r\n\r\nimport java.util.Objects;\r\n\r\n/**\r\n * @author robergf This is the LeftDrawer Select Current Customer with Detail\r\n * Upload (Drag 'n' Drop Area) Active at Import (=Startarea AST 1.0) and\r\n * Detail (=CustomerConfigurationArea AST 1.0) Reason: Filelist could\r\n * not remove, currently (08.01.2020) no other Solution\r\n */\r\n@SuppressWarnings(\"serial\")\r\npublic class Importer extends VerticalLayout {\r\n\r\n    private final @Getter Upload uploader;\r\n    private final CustomerLabelLayout customerLyt;\r\n    private final MultiFileMemoryBuffer memoryFileBuffer;\r\n    private final RoleChanger roleChanger;\r\n\r\n    /**\r\n     * The Importer function is used to import data from a file into the database.\r\n     * The Importer function takes in a Context object as an argument and returns nothing.\r\n     * The Importer function creates a MultiFileMemoryBuffer object, which is used to store files that are uploaded by the user.\r\n     * It also creates CustomerLabelLayout, Upload and RoleChanger objects, which are all components of the UI that allow users to upload files for importing data into the database.\r\n     *\r\n     * @param Context ctx Get the user session and active customer\r\n     *                public void setcontext(context ctx) {\r\n     *                if (objects\r\n     * @return A verticallayout\r\n     * @docauthor Trelent\r\n     */\r\n    public Importer(Context ctx) {\r\n        memoryFileBuffer = new MultiFileMemoryBuffer();\r\n        customerLyt = new CustomerLabelLayout(ctx);\r\n        uploader = new Upload(memoryFileBuffer);\r\n        uploader.setId(TMS.IMPORTER_UPLOAD);\r\n        CompUtils.addToolTip(ctx, uploader, TMS.IMPORTER_UPLOAD_TOOLTIP);\r\n\r\n        uploader.setVisible(false);\r\n        LocalCustomer optCustomer = null;\r\n        if (Objects.nonNull(ctx.getUserSession())) {\r\n            optCustomer = ctx.getHttpAttribute(SessionParams.ACTIVE_CUSTOMER);\r\n        }\r\n        if (Objects.nonNull(optCustomer)) {\r\n            customerLyt.getCustomerCbx().setValue(optCustomer);\r\n            uploader.setVisible(true);\r\n        }\r\n\r\n        roleChanger = new RoleChanger(ctx);\r\n        roleChanger.getRoleCombo().addValueChangeListener(event ->\r\n                customerLyt.getCustomerFilter().ifPresent(item -> {\r\n                    item.reload(event.getValue());\r\n                })\r\n        );\r\n\r\n        add(customerLyt, uploader, roleChanger);\r\n\r\n        getStyle().set(\"padding\", \"0em 0.2em\");\r\n    }\r\n\r\n    /**\r\n     * The getSelected function returns the selected customer from the combobox.\r\n     *\r\n     * @return The selected customer from the combobox\r\n     * @docauthor Trelent\r\n     */\r\n    public LocalCustomer getSelected() {\r\n        return customerLyt.getCustomerCbx().getValue();\r\n    }\r\n\r\n    /**\r\n     * The setSelectedLocalCustomer function is used to set the selected local customer in the CustomerLayout class.\r\n     *\r\n     * @param LocalCustomer customer Pass the customer object to the setselectedlocalcustomer function\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    public void setSelectedLocalCustomer(LocalCustomer customer) {\r\n        customerLyt.setSelectedLocalCustomer(customer);\r\n    }\r\n\r\n    /**\r\n     * The disableCustomerView function sets the customerLyt layout to invisible.\r\n     * This is used when a user logs out of their account, and the program needs to hide all information related to that user.\r\n     *\r\n     * @return Nothing\r\n     * @docauthor Trelent\r\n     */\r\n    public void disableCustomerView() {\r\n        customerLyt.setVisible(false);\r\n    }\r\n\r\n    /**\r\n     * The addCustomerValueChangeListener function adds a listener to the customerCbx ComboBox.\r\n     *\r\n     * @param ValueChangeListener&lt;? super ComponentValueChangeEvent&lt;ComboBox&lt;LocalCustomer&gt; Listen to the value change event of the customer combo box\r\n     * @param LocalCustomer&gt;&gt;    listener Pass the customer object to the listener\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    public void addCustomerValueChangeListener(\r\n            ValueChangeListener<? super ComponentValueChangeEvent<ComboBox<LocalCustomer>, LocalCustomer>> listener) {\r\n        customerLyt.getCustomerCbx().addValueChangeListener(listener);\r\n    }\r\n\r\n    /**\r\n     * The addRoleValueChangeListener function adds a listener to the roleChanger's ComboBox.\r\n     *\r\n     * @param ValueChangeListener&lt;? super ComponentValueChangeEvent&lt;ComboBox&lt;Role&gt; Listen to the change in value of the combobox&lt;role&gt;\r\n     *                                 public void adduservaluechangelistener(\r\n     *                                 valuechangelistener&lt;? super componentvaluechangeevent&lt;combobox&lt;user&gt;, user&gt;&gt; listener) {\r\n     *                                 userchanger\r\n     * @param Role&gt;&gt;             listener Listen for changes in the role combo box\r\n     * @return A void\r\n     * @docauthor Trelent\r\n     */\r\n    public void addRoleValueChangeListener(\r\n            ValueChangeListener<? super ComponentValueChangeEvent<ComboBox<Role>, Role>> listener) {\r\n        roleChanger.getRoleCombo().addValueChangeListener(listener);\r\n    }\r\n\r\n    /**\r\n     * The getMemoryFileBuffer function returns the memoryFileBuffer object.\r\n     *\r\n     * @return A multifilememorybuffer object\r\n     * @docauthor Trelent\r\n     */\r\n    public MultiFileMemoryBuffer getMemoryFileBuffer() {\r\n        return memoryFileBuffer;\r\n    }\r\n\r\n    /**\r\n     * The reloadCustomer function is used to reload the customerLyt object.\r\n     * This function is called when a new customer has been added or deleted from the database.\r\n     *\r\n     * @return A customer layout\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadCustomer() {\r\n        customerLyt.initialComponent();\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\subview\\Importer.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-jeZK5xgG7DPEwke2X3AnX3PU4f9pA1Me",
    "created" : 1762172037,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"Multiple files (LoaderCrumb.java, PreviewCrumb.java, PromotionView.java, CustomerLabelLayout.java, etc.)\",\n  \"issues\": [\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Potential NullPointerException due to downloadBtn being null when accessed in assortmentGrid selection listener\",\n      \"justification\": \"downloadBtn is instantiated in setRightButtons() after setAssortmentGrid() registers a selection listener that calls downloadBtn.setEnabled(...). If a user selects a row before the right buttons are added, a NPE occurs, crashing the UI.\",\n      \"action\": \"Initialize downloadBtn before registering the selection listener or guard calls with nullcheck; add a test that selects a row before UI fully rendered and expects no exception.\",\n      \"source\": \"LoaderCrumb.setAssortmentGrid(), line with downloadBtn.setEnabled(false)\",\n      \"component\": \"promotion-loader\",\n      \"impact_scope\": \"prodrelevant, UI crash\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Threadsafety violations: UI components are accessed from background threads (e.g., uploadVersion click listener, loadGrid thread)\",\n      \"justification\": \"Vaadin UI is not threadsafe; updating components like Dialog, ProgressBar, or Grid from a raw Thread without UI.access can cause race conditions and inconsistent UI state.\",\n      \"action\": \"Wrap all UI updates inside UI.getCurrent().access(() -> {  }) and ensure threads are properly managed; add unit tests with VaadinTestBench to verify no IllegalStateException when actions run.\",\n      \"source\": \"LoaderCrumb.setRightButtons()  uploadVersion.addClickListener, PreviewCrumb.loadGrid()\",\n      \"component\": \"promotion-loader / preview-crumb\",\n      \"impact_scope\": \"prodrelevant, stability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Missing null/empty check on articles list in setDefaultParameterToDataFile\",\n      \"justification\": \"Method accesses articles.get(0) without verifying the list is nonempty, leading to IndexOutOfBoundsException when called with an empty list (e.g., after a failed import).\",\n      \"action\": \"Add guard: if (articles == null || articles.isEmpty()) return; and write tests covering empty article list scenario.\",\n      \"source\": \"LoaderCrumb.setDefaultParameterToDataFile()\",\n      \"component\": \"promotion-loader\",\n      \"impact_scope\": \"prodrelevant, crash\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Improper ID comparison using '==' for Long objects in setDataFilesToAssortment\",\n      \"justification\": \"Using '==' compares object references, not values, which may incorrectly treat distinct Long instances as unequal, causing duplicate entries or missed associations.\",\n      \"action\": \"Replace 'datafile.getId() == dataFile.getId()' with 'Objects.equals(datafile.getId(), dataFile.getId())'; add unit test with different Long instances.\",\n      \"source\": \"LoaderCrumb.setDataFilesToAssortment()\",\n      \"component\": \"promotion-loader\",\n      \"impact_scope\": \"data integrity\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Potential IndexOutOfBounds in getSelectedItems due to ineffective replacement of list items\",\n      \"justification\": \"The lambda 'item = optDatafile.get();' does not modify the list, leaving stale DataFile objects which may lack refreshed state.\",\n      \"action\": \"Rewrite to map IDs to fresh entities and replace list entries, e.g., selectedFiles.replaceAll(df -> ctx.getServices().getDataFileService().findById(df.getId()).orElse(df)); add tests verifying refreshed data.\",\n      \"source\": \"LoaderCrumb.getSelectedItems()\",\n      \"component\": \"promotion-loader\",\n      \"impact_scope\": \"data consistency\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Unvalidated user input when creating new Assortment (createNewAssortment)\",\n      \"justification\": \"The method does not verify that selectedFiles are not null or that the user has permission to create an assortment, opening a security/logic gap.\",\n      \"action\": \"Add null checks for selectedFiles, validate user permissions via HasPermission, and write tests for unauthorized attempts.\",\n      \"source\": \"LoaderCrumb.createNewAssortment()\",\n      \"component\": \"promotion-loader\",\n      \"impact_scope\": \"security, business rule\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Redundant call to CompUtils.removeMSP() with same argument in several methods\",\n      \"justification\": \"Repeatedly removing the same CSS margin/padding may be unnecessary and hurts readability.\",\n      \"action\": \"Consolidate styling adjustments into a single utility call or CSS class; update code style guide and add lint rule.\",\n      \"source\": \"Multiple locations (e.g., setDatafileGrid, setAssortmentGrid)\",\n      \"component\": null,\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Potential NPE in PromotionView constructor when ctx.getSession() is null\",\n      \"justification\": \"ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession()) assumes a Session object exists; during early initialization it may be null, causing a crash.\",\n      \"action\": \"Initialize SessionUtils only after confirming ctx.getSession() != null or lazily create session on first use; add unit test for view construction without prior session.\",\n      \"source\": \"PromotionView constructor\",\n      \"component\": \"promotion-view\",\n      \"impact_scope\": \"prodrelevant if session creation order changes\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Memory leak risk: raw Thread creation without termination in loadGrid and uploadVersion listeners\",\n      \"justification\": \"Threads are started for each grid reload/upload but never joined or managed, potentially accumulating threads under heavy use.\",\n      \"action\": \"Replace raw Thread with ExecutorService (singlethread pool) and shutdown on component detach; add integration test simulating rapid reloads.\",\n      \"source\": \"PreviewCrumb.loadGrid(), LoaderCrumb.uploadVersion click listener\",\n      \"component\": \"preview-crumb / promotion-loader\",\n      \"impact_scope\": \"performance\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Inconsistent naming: loadAssortmentsBreadCrumb calls loadPreviewBreadCrumb, misleading purpose\",\n      \"justification\": \"Method name suggests loading assortment breadcrumbs but actually loads preview breadcrumb, reducing code clarity.\",\n      \"action\": \"Rename method to reflect actual behavior or adjust call to load appropriate crumb; add documentation and unit test for breadcrumb navigation.\",\n      \"source\": \"LoaderCrumb.loadAssortmentsBreadCrumb()\",\n      \"component\": \"promotion-loader\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"2\",\n    \"top_todos\": [\n      \"Fix NPE risk with downloadBtn by initializing it before selection listeners.\",\n      \"Wrap all UI updates from background threads in UI.access to ensure thread safety.\",\n      \"Add null/empty checks in setDefaultParameterToDataFile to prevent IndexOutOfBounds.\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to produce JSON review for each file? The schema expects a single JSON object per response. Probably need separate JSON per file? The instruction: \"Du analysierst jeweils einen Code-Chunk.\" So likely one JSON per file/chunk. The user provided multiple files. Might need one combined JSON with file field indicating each? Probably separate objects? But schema has single file field. Could combine all issues across all files, with file maybe \"multiple\" but better produce separate? The instruction \"Deine Antwort MUSS exakt dieses JSON-Schema haben.\" So only one object. Could choose to aggregate across all files, but file field maybe a generic identifier. Could list issues from multiple files, but source includes file/class/line. So we can include issues across files. We'll produce overall rating and top todos. Limit 10 issues total. Prioritize high severity.\n\nIdentify issues:\n\nLoaderCrumb:\n- downloadBtn may be null when used in selection listener before initialized (downloadBtn set in setRightButtons after selection listener added? Actually setAssortmentGrid adds selection listener that calls downloadBtn.setEnabled(false); downloadBtn may be null because setRightButtons called after setAssortmentGrid? In setAssortmentGrid, downloadBtn not yet set, but selection listener runs on UI events later after right buttons added, so maybe okay. But downloadBtn used in selection listener before being assigned (downloadBtn set in setRightButtons after adding listener). If user selects before setRightButtons called? setAssortmentGrid called before setRightButtons in constructor? In constructor: setDatafileGrid(); setAssortmentGrid(); add(body); then later setAssortmentGrid adds selection listener referencing downloadBtn (null). Then later setRightButtons is called later in setMiddleSection after loader created. So selection could happen before downloadBtn init, causing NPE. High.\n\n- In setLeftButtons, deleteVersion listener modifies dataFile.setDeleteBy(...). But DataFile may be detached; no transaction handling. Potential data consistency issue.\n\n- In setRightButtons, downloadBtn instantiated after calling downloader(null) which uses downloadBtn (null) leads to NPE because downloader checks if assortment non-null, but downloadBtn used inside downloader (downloadBtn.reloadAsFile) but downloadBtn may be null at that time. downloader(null) called before downloadBtn initialized, causing NPE. Actually downloader(null) just does if (Objects.nonNull(assortment)) { ... } So safe.\n\n- In setRightButtons, uploadVersion click listener spawns new Thread and accesses UI components (dialog) not using UI.access, leading to thread-safety issues. Also ready map usage flawed.\n\n- In getSelectedItems, they create buffer list and then iterate and assign item = optDatafile.get(); but this does not modify the list; the lambda variable not used. So selectedFiles may contain stale objects. Not critical but bug.\n\n- In setDataFilesToAssortment: uses '==' to compare ids (datafile.getId() == dataFile.getId()) which is okay for primitives but id may be Long object; use equals. Potential bug.\n\n- In setDataFilesToAssortment: reloadAssortmentGrid called inside method, which may cause UI thread issues (needs UI.access). Also method returns null if not valid, callers may not check.\n\n- In setDefaultParameterToDataFile: assumes articles not empty; if empty will throw IndexOutOfBounds.\n\n- In reloadButtons of LoaderCrumb disables exit button (setExitEnable(false)). Might be unintended.\n\n- In loadAssortmentsBreadCrumb calls loadPreviewBreadCrumb, naming mismatch.\n\nPreviewCrumb:\n- In addTabPriceList and addTabRemoved, item.getArticleNr().replace(+assortment.getId() + \"#\", \"\") uses unary + causing numeric conversion? Actually +assortment.getId() yields long, concatenated with \"#\" results string, okay.\n\n- In loadGrid: creates new Thread and accesses UI inside ui.access but thread not daemon; may leak threads if many calls. Also progress bar never added to UI.\n\n- In loadGrid returns ProgressBar but caller doesn't use it.\n\n- In addTabPriceList, box.setLoad(loadGrid(...)) but loadGrid returns ProgressBar; setLoad expects maybe something else? Not clear.\n\n- In loadGrid, catches generic Exception, logs but doesn't inform UI.\n\n- In addTabPriceList and addTabRemoved, use lambda that captures assortment variable which may be null if not set before reloadCrumb; reloadCrumb may call before assortment initialized? In constructor, assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT); could be null initially causing NullPointer in grid loading.\n\n- In reloadCrumb, after UI.access they call details.reload(() -> getServices().getArticleBaseService().findAllInArchivByAssortment(assortment)); if assortment null leads to service call error.\n\n- Potential memory leak: threads not terminated.\n\nPromotionPresenter:\n- ctx new Context() but later overwritten; maybe okay.\n\n- No null checks for loader before calling reload.\n\nPromotionView:\n- ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession()); ctx.getSession() may be null before init -> NPE.\n\n- In setMiddleSection, after creating loader, they set breadBox content etc. They call loader.reloadButtons() and loader.reloadCrumb() before adding to UI? Might be okay.\n\n- In setLeftSection, role value change listener: if importer.getSelected() is null they call importer.reloadCustomer() but also still maybe call setChangeValue? fine.\n\n- In setLeftSection, uploader listeners use UI components but not UI.access maybe fine.\n\nCustomerOffsetService:\n- fetch uses filter == null check; but filter param may be null, fine.\n\n- Not thread safe but okay.\n\nArticleDetailBox:\n- In addSpezials, build string may be large but okay.\n\n- In reload, progress set visible then start thread; UI.access used correctly.\n\nCustomerLabelLayout:\n- setDeleteCustomer uses LocalCustomerDAO directly; no permission check.\n\n- In setCustomerCbx, setClearButtonVisible called twice.\n\n- In setInfoLabel, adds customerFilter component directly to infoBox without removing previous; okay.\n\n- In reload, uses getServices().getLocalCustomerCustomService().findAll() may load large list into memory.\n\n- Potential NPE: ctx.getSession() may be null.\n\nOverall issues.\n\nWe'll craft up to 10 issues focusing on highest severity.\n\nNow produce JSON."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 3018,
      "prompt_tokens" : 22744,
      "total_tokens" : 25762
    },
    "timings" : {
      "cache_n" : 62,
      "prompt_n" : 22682,
      "prompt_ms" : 17023.722,
      "prompt_per_token_ms" : 0.7505388413720131,
      "prompt_per_second" : 1332.376080859403,
      "predicted_n" : 3018,
      "predicted_ms" : 36082.208,
      "predicted_per_token_ms" : 11.955668654738236,
      "predicted_per_second" : 83.64233142273333
    }
  }
}