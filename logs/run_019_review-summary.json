{
  "timestamp" : "2025-11-03T13:07:44.7740238",
  "index" : 19,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FilterIndividualCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.components.interfaces.GridReloadService;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToAssortmentDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SetIndividualFilterCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.html.Paragraph;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.splitlayout.SplitLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.Objects;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_FILTER_FINISH)\r\npublic class FilterIndividualCrumb extends FilterCrumb implements FileInputLoader, GridReloadService<ArticleBase> {\r\n\r\n    private List<ArticleBase> articles;\r\n    private final ArticleDetailBox details;\r\n    private GridPro<ArticleBase> rightGrid;\r\n    private final VerticalLayout rightBox = new VerticalLayout();\r\n    private DownloadButton downloadBtn;\r\n    private final Paragraph foundArticle = new Paragraph(\"\");\r\n\r\n    /**\r\n     * The FilterIndividualCrumb function is a constructor for the FilterIndividualCrumb class.\r\n     * It creates an Accordion object, and then adds several panels to it:\r\n     * - buildIndividualPanel(this)\r\n     * - buildRemovePanel()\r\n     * - buildImportPanel()\r\n     * - buildNotInPimPanel()\r\n     * - buildNotApprovalPanel()\r\n     *\r\n     * @param Context ctx Get the current ui\r\n     * @return The filterindividualcrumb object\r\n     */\r\n    public FilterIndividualCrumb(Context ctx) {\r\n        super(ctx, new Accordion());\r\n\r\n        articles = getArticles();\r\n        if (Objects.isNull(articles)) {\r\n            articles = new ArrayList<ArticleBase>();\r\n        }\r\n\r\n        getAccordion().add(buildIndividualPanel(this));\r\n        getAccordion().add(buildRemovePanel());\r\n        getAccordion().add(buildImportPanel());\r\n        getAccordion().add(buildNotInPimPanel());\r\n        getAccordion().add(buildNotApprovalPanel());\r\n        getAccordion().add(buildNotInPositivPanel());\r\n        getAccordion().add(buildRemoveByPositivPanel());\r\n        getAccordion().add(buildInvalidVtlStatusPanel());\r\n\r\n        rightBox.add(getPanelHeader(TMS.FILTER_PANEL_INDIVIDUAL_LIST));\r\n        setRightGrid();\r\n\r\n        SplitLayout boxes = new SplitLayout();\r\n        boxes.setSizeFull();\r\n\r\n        reload(null);\r\n\r\n        details = new ArticleDetailBox(getCtx(), articles);\r\n        add(details, boxes);\r\n\r\n        boxes.addToPrimary(getAccordion());\r\n        boxes.addToSecondary(rightBox);\r\n        rightBox.getStyle().set(\"margin\", \"0em\");\r\n        rightBox.getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        DnDUtils.dragNaddRemoved(UI.getCurrent(), getCtx(), getRemoveGrid().getGrid(), rightGrid);\r\n        DnDUtils.dragNImportOrDelete(UI.getCurrent(), getCtx(), getImportGrid().getGrid(), rightGrid);\r\n    }\r\n\r\n    /**\r\n     * The setRightGrid function creates a grid that displays the articles in the right side of the screen.\r\n     * The grid is created with columns for customer article number, article number, product name, price first and price scale.\r\n     * It also has a button to delete selected items from this list.\r\n     */\r\n    private void setRightGrid() {\r\n        Button deleteBtn = new Button();\r\n        deleteBtn.setIcon(VaadinIcon.CLOSE.create());\r\n\r\n        deleteBtn.addClickListener(event -> {\r\n            SetIndividualFilterCrumb dialog = new SetIndividualFilterCrumb(getCtx(), rightGrid.getSelectedItems(), this);\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n\r\n        HorizontalLayout buttonBay = new HorizontalLayout();\r\n        CompUtils.removeMSP(buttonBay, \"MP\");\r\n        downloadBtn = new DownloadButton(getCtx(), TMS.FILTER_INDIVIDUAL_DOWNLOAD_TOOLTIP);\r\n        buttonBay.add(deleteBtn, downloadBtn, foundArticle);\r\n        downloadBtn.setVisible(false);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_INDIVIDUAL_DOWNLOAD, downloadBtn);\r\n\r\n        String notFound = getTranslation(TMS.FILTER_INDIVIDUAL_NO_PRODUCT_NAME_FOUND, getLocale(), getCtx()) + \"(\"\r\n                + getLocale().toLanguageTag() + \")\";\r\n        rightGrid = new GridPro<ArticleBase>();\r\n        rightGrid.addColumn(ArticleBase::getCustomerArticleNr)\r\n                .setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_CUSTOMER_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true).setSortable(true).setFlexGrow(1);\r\n        rightGrid.addColumn(ArticleBase::getArticleNr)\r\n                .setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_ARTICLE_NR, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setFlexGrow(1);\r\n        rightGrid.addColumn(item -> {\r\n                    String value = item.getProductName();\r\n                    if (value.isEmpty()) {\r\n                        value = notFound;\r\n                    }\r\n                    return value;\r\n                }).setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_PRODUCT_NAME, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setFlexGrow(2);\r\n        rightGrid.addColumn(ArticleBase::getPriceFirstWithThousend)\r\n                .setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_PRICE_FIRST, getLocale(), getCtx())).setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                .setSortable(true).setFlexGrow(1);\r\n        rightGrid.addColumn(ArticleBase::getPriceXWithThousend)\r\n                .setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_PRICE_SCALE, getLocale(), getCtx())).setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX())).setSortable(true)\r\n                .setFlexGrow(1);\r\n        rightGrid.addColumn(ArticleBase::getScalelimit)\r\n                .setHeader(getTranslation(TMS.FILTER_INDIVIDUAL_SCALE_LIMIT, getLocale(), getCtx())).setResizable(true)\r\n                .setSortable(true).setFlexGrow(1);\r\n        rightGrid.setSelectionMode(SelectionMode.MULTI);\r\n        rightBox.add(buttonBay, rightGrid);\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is called when the user clicks on a button in the UI.\r\n     * It sets all buttons to disabled except for &quot;Finish&quot; and &quot;Exit&quot;.\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(true);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the articles, details, and accordion panels to reflect any changes that may have been made by other users.\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        // reload\r\n        loadRemoved();\r\n        loadIndividual();\r\n        loadImport();\r\n\r\n        UI.getCurrent().access(() -> {\r\n            articles = getArticles();\r\n            details.reload(() -> articles);\r\n\r\n            showExportPanels(getAccordion());\r\n        });\r\n\r\n        reload(null);\r\n        reloadInfoBox(UI.getCurrent());\r\n        onFoundChanged();\r\n    }\r\n\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the wizard is\r\n     * executed. This function can be used to perform any necessary actions that must\r\n     * be completed before moving on to the next step. For example, if a user has\r\n     * selected an option in one of the steps, this function could be used to save\r\n     * that selection so it can later be accessed by another step or even by a filter.\r\n     *\r\n     * @param CrumbProgressDialog dialog Update the progress bar\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        FilterRunUtils.reloadIndividualFilter(getCtx(), dialog);\r\n    }\r\n\r\n    /**\r\n     * The goFinish function is called when the user clicks on the &quot;Finish&quot; button.\r\n     * It checks if there are any articles in the right grid, and if so, it opens a dialog to save them to an assortment.\r\n     */\r\n    @Override\r\n    public void goFinish() {\r\n        checkBefore(() -> {\r\n            SaveArticlesToAssortmentDialog dialog = new SaveArticlesToAssortmentDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightGrid.getDataProvider());\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is called by the FileImportDialog class when it\r\n     * creates a new instance of this class. The function adds a checkbox to the\r\n     * dialog, which allows the user to specify whether or not they want article\r\n     * numbers imported from their file. This is done using an addValueCbx call,\r\n     * which takes two parameters: A string specifying what type of value should be\r\n     * added (in this case TMS.FILE_IMPORTER_ARTICLE_NR), and a boolean indicating\r\n     * whether or not that value should be checked by default (true in this case).\r\n     *\r\n     * @param FileImportDialog dialog Add the checkbox to the dialog\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in\r\n     * the FileImportDialog. It takes all of the rows from that dialog's table and\r\n     * adds them to a list of ArticleBase objects, which are then added to this\r\n     * class' importGrid. The setPrice function is used to set each article's price\r\n     * based on its type (ArticleType). If an article has no price, it will be given\r\n     * a default value of 0.00f. This function also checks if any articles have been\r\n     * imported before by checking if there are any articles in this\r\n     *\r\n     * @param FileImportDialog dialog Get the table from the dialog\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = new ArrayList<ArticleBase>();\r\n        dialog.getTable().forEach(row -> articles.add(setPrice(row, dialog)));\r\n        getImportGrid().reload(articles);\r\n    }\r\n\r\n    /**\r\n     * The setPrice function is used to set the price of an article.\r\n     *\r\n     * @param Map&lt;Integer   Map the columns to their values\r\n     * @param String&gt;       colString Get the values from the file\r\n     * @param FileImportDialog dialog Get the column indexes from the dialog\r\n     * @return The articlebase object\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n        if (dialog.getColumns()[0] > -1) {\r\n            price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in\r\n     * a FileImportDialog. The function takes two parameters:\r\n     * - dialog: A reference to the FileImportDialog that was used to import articles.\r\n     * - articles: A list of ArticleBase objects that were imported from a file. This list may be empty, if no articles were imported (e.g., because an error occurred).\r\n     *\r\n     * @param FileImportDialog        dialog Get the file name and path\r\n     * @param List&lt;ArticleBase&gt; articles Pass the list of articles to be saved\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        getImportGrid().reload(articles);\r\n    }\r\n\r\n    /**\r\n     * The onFoundChanged function is called when the filter changes.\r\n     * It updates the foundArticle label to display how many articles are currently being displayed in the right grid.\r\n     */\r\n    @Override\r\n    public void onFoundChanged() {\r\n        UI.getCurrent().access(() -> {\r\n            foundArticle.setText(CompUtils.filterGridObjects(getCtx(), rightGrid));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to refresh the data in the grid.\r\n     * It can be called from a button click or other event handler,\r\n     * and it will fetch new data from the server and update all of\r\n     * the rows in this grid. The reload function takes an optional list of items as a parameter, which will be used to replace any existing items in this grid with those provided. If no list is provided, then all existing items are removed and replaced with new ones fetched from the server using whatever filter was last applied to this grid (if any). This function returns nothing.\r\n     *\r\n     * @param List&lt;ArticleBase&gt; items Set the data provider for the grid\r\n     */\r\n    @Override\r\n    public void reload(List<ArticleBase> items) {\r\n        if (Objects.isNull(items) || items.isEmpty()) {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            items = articleService.findAllByFilterStatus(getCtx(), \"IN\", FilterStatus.DEFAULT);\r\n        }\r\n        rightGrid.setDataProvider(DataProvider.ofCollection(items));\r\n    }\r\n\r\n    /**\r\n     * The getDataProvider function returns the data provider of the rightGrid.\r\n     *\r\n     * @return A listdataprovider, which is a subclass of dataprovider\r\n     */\r\n    @SuppressWarnings(\"unchecked\")\r\n    @Override\r\n    public ListDataProvider<ArticleBase> getDataProvider() {\r\n        return (ListDataProvider<ArticleBase>) rightGrid.getDataProvider();\r\n    }\r\n\r\n    /**\r\n     * The setDataProvider function is used to set the data provider for the grid.\r\n     * The data provider is a class that provides access to all of the items in\r\n     * a collection, and allows you to fetch them one by one. It also allows you\r\n     * to filter and sort those items, so that only some of them are shown in your\r\n     * grid at any given time. In this example we use an {\r\n     *\r\n     * @param DataProvider&lt;ArticleBase Set the data provider for the grid\r\n     * @param F&gt;                       dataProvider Set the dataprovider for the grid\r\n     */\r\n    @Override\r\n    public <F> void setDataProvider(DataProvider<ArticleBase, F> dataProvider) {\r\n        rightGrid.setDataProvider(dataProvider);\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FilterIndividualCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FilterRemoveCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.FilterType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToAssortmentDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToINDIVIDUALCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.splitlayout.SplitLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Locale;\r\nimport java.util.Objects;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_FILTER_REMOVE)\r\npublic class FilterRemoveCrumb extends FilterCrumb {\r\n\r\n    private final ArticleDetailBox details;\r\n\r\n    private final Grid<Filterbase> rightFilterGrid;\r\n    private final TextField fieldTxt = new TextField();\r\n\r\n    /**\r\n     * The FilterRemoveCrumb function is a constructor for the FilterRemoveCrumb class.\r\n     * It creates an Accordion object, and then adds it to the FilterRemoveCrumb object.\r\n     * Then, it creates a SplitLayout object called boxes, and sets its size to full.\r\n     * Next, it creates an ArticleDetailBox object called details using the getArticles() function from this class as input parameter (which returns all articles in the database), and adds that box to both itself (the FilterRemoveCrumb) and boxes (the SplitLayout).\r\n     * Then, it calls add on its Accordion with buildStructurePanel(),\r\n     *\r\n     * @param Context ctx Create the filterremovecrumb object\r\n     */\r\n    public FilterRemoveCrumb(Context ctx) {\r\n        super(ctx, new Accordion());\r\n\r\n        SplitLayout boxes = new SplitLayout();\r\n        boxes.setSizeFull();\r\n\r\n        details = new ArticleDetailBox(getCtx(), getArticles());\r\n        add(details, boxes);\r\n\r\n        getAccordion().add(buildStructurePanel());\r\n        getAccordion().add(buildArticleClassPanel());\r\n        getAccordion().add(buildInfoTypePanel());\r\n        getAccordion().add(buildBrandsPanel());\r\n        getAccordion().add(buildGHSCodePanel());\r\n        getAccordion().add(buildIntraStatPanel());\r\n        getAccordion().add(buildNotFreePanel());\r\n        getAccordion().add(buildEClassPanel());\r\n        getAccordion().add(buildConfigPanel());\r\n        getAccordion().add(buildNotInPimPanel());\r\n        getAccordion().add(buildNotApprovalPanel());\r\n        getAccordion().add(buildNotInPositivPanel());\r\n        getAccordion().add(buildRemoveByPositivPanel());\r\n        getAccordion().add(buildInvalidVtlStatusPanel());\r\n\r\n        VerticalLayout rightBox = new VerticalLayout();\r\n        rightBox.add(getPanelHeader(TMS.FILTER_PANEL_EXCLUDE_LIST));\r\n        rightFilterGrid = new Grid<Filterbase>();\r\n        rightFilterGrid.addColumn(Filterbase::getLabel)\r\n                .setHeader(getTranslation(TMS.FILTER_REMOVE_GRID_NAME, getLocale(), getCtx())).setFlexGrow(4)\r\n                .setResizable(true).setSortable(true);\r\n        rightFilterGrid.addColumn(Filterbase::getType)\r\n                .setHeader(getTranslation(TMS.FILTER_REMOVE_GRID_TYPE, getLocale(), getCtx(), Grid.class))\r\n                .setFlexGrow(2).setResizable(true).setSortable(true);\r\n        rightFilterGrid.setSelectionMode(SelectionMode.MULTI);\r\n\r\n        fieldTxt.setPlaceholder(\r\n                getTranslation(TMS.FILTER_REMOVE_SEARCH_PLACEHOLDER, getLocale(), getCtx(), TextField.class));\r\n        fieldTxt.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Filterbase> listProvider = (ListDataProvider<Filterbase>) rightFilterGrid\r\n                    .getDataProvider();\r\n            listProvider.setFilter(Filterbase::getLabel, name -> {\r\n                String nameLower = name == null ? \"\" : name.toLowerCase(Locale.ENGLISH);\r\n                String filterLower = fieldTxt.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n            rightFilterGrid.setDataProvider(listProvider);\r\n        });\r\n\r\n        rightBox.add(fieldTxt, rightFilterGrid);\r\n        boxes.addToPrimary(getAccordion());\r\n        boxes.addToSecondary(rightBox);\r\n        rightBox.getStyle().set(\"margin\", \"0em\");\r\n        rightBox.getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getStructureGrid().getGrid(), rightFilterGrid, FilterType.STRUCTURE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getStructureGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getArticleClassGrid().getGrid(), rightFilterGrid, FilterType.ARTIKELKLASSE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getArticleClassGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getInfoTypeGrid().getGrid(), rightFilterGrid, FilterType.INFOTYPE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getInfoTypeGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getBrandsGrid().getGrid(), rightFilterGrid, FilterType.BRANDS);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getBrandsGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getGhsGrid().getGrid(), rightFilterGrid, FilterType.GHS_CODES);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getGhsGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getIntrastatGrid().getGrid(), rightFilterGrid, FilterType.INTRASTAT);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getIntrastatGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getFreeGrid().getGrid(), rightFilterGrid, FilterType.NOTFREE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getFreeGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getEClassGrid().getGrid(), rightFilterGrid, FilterType.STRUCTURE);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getEClassGrid().getGrid());\r\n        DnDUtils.dragNdropToRemove(UI.getCurrent(), getCtx(), getConfigGrid().getGrid(), rightFilterGrid, FilterType.CONFIG);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getConfigGrid().getGrid());\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is called by the controller to update the buttons on the view.\r\n     * The function sets all of the buttons to be enabled or disabled based on whether they are needed at that time.\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(true);\r\n            setFinishEnable(true);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the data in the grid and sets up all of the filters for that particular article.\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        List<ArticleBase> articles = getArticles();\r\n        if (Objects.nonNull(articles)) {\r\n            details.reload(() -> articles);\r\n            Setting setting = SettingUtils.getSettingByType(getCtx(), SettingType.DEFAULT_ECAT_STRUCUTURE_NAME);\r\n            loadStructure(setting);\r\n            loadArticleClass();\r\n            loadInfoType();\r\n            loadBrands();\r\n            loadGHSCode();\r\n            loadIntraStat();\r\n            loadNotFree();\r\n            loadEClass();\r\n            loadConfig();\r\n\r\n            List<Filterbase> bases = new ArrayList<Filterbase>();\r\n\r\n            Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n            if (Objects.nonNull(assortment)) {\r\n                bases.addAll(getServices().getFilterBaseService().findAllByAssortmentAndDirectionAndDelete(assortment,\r\n                        Filterbase.REMOVE, false));\r\n                CompUtils.sortFilterBase(bases);\r\n            }\r\n            rightFilterGrid.setDataProvider(DataProvider.ofCollection(bases));\r\n\r\n            showExportPanels(getAccordion());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The goToNext function is called when the user clicks on the &quot;Next&quot; button.\r\n     * It checks to see if there are any rows in the right grid that have not been\r\n     * selected, and if so, it opens a dialog box asking whether or not they want to\r\n     * continue without selecting all of them. If they do want to continue, then it\r\n     * calls goToNext() from CrumbDialogBase which will open up a new crumb dialog\r\n     */\r\n    @Override\r\n    public void goToNext() {\r\n        checkBefore(() -> {\r\n            ToINDIVIDUALCrumbDialog dialog = new ToINDIVIDUALCrumbDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    /**\r\n     * The goFinish function is called when the user clicks on the &quot;Finish&quot; button.\r\n     * It checks if there are any articles in the right grid, and if so, it opens a dialog window to save them to an assortment.\r\n     */\r\n    @Override\r\n    public void goFinish() {\r\n        checkBefore(() -> {\r\n            SaveArticlesToAssortmentDialog dialog = new SaveArticlesToAssortmentDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    // thinks to do Before Jump to Save'N'Finish\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the CrumbProgressDialog.\r\n     * It removes all articles that are not valid proofs from the database.\r\n     *\r\n     * @param CrumbProgressDialog dialog Update the progress dialog\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        for (FilterType type : FilterType.values()) {\r\n            if (FilterUtils.isValidProof(type)) {\r\n                dialog.setLabel(TMS.setProof(type));\r\n                getServices().getFilterBaseUpdateService().removeArticleByFilter(getCtx(), type, FilterStatus.ALL,\r\n                        FilterStatus.REMOVEBYFILTER);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FilterRemoveCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\LoaderCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.AssortmentLockException;\r\nimport com.hom.ebmw.exceptions.AstFileNotExistsException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.dao.AssortmentDataFileDAO;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.KatalogVersion;\r\nimport com.hom.ebmw.utilities.*;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.dialogs.CustomDialog;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.*;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport lombok.Getter;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.time.LocalDateTime;\r\nimport java.util.*;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_ECAT_LOADER)\r\n@SuppressWarnings(\"serial\")\r\npublic class LoaderCrumb extends Crumb implements FileInputLoader, HasPermission {\r\n\r\n    private final @Getter Grid<DataFile> dataFileGrid = new Grid<>();\r\n    private final @Getter Grid<Assortment> assortmentGrid = new Grid<>();\r\n    private DownloadButton downloadBtn;\r\n    private final HorizontalLayout body = new HorizontalLayout();\r\n\r\n    /**\r\n     * The LoaderCrumb function is a constructor for the LoaderCrumb class.\r\n     * It sets up the datafile grid and assortment grid, then adds them to the body of this crumb.\r\n     *\r\n     * @param Context ctx Create the loadercrumb object\r\n     * @return A component\r\n     * @docauthor Trelent\r\n     */\r\n    public LoaderCrumb(Context ctx) {\r\n        super(ctx);\r\n        setDatafileGrid();\r\n        setAssortmentGrid();\r\n        setSizeFull();\r\n\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n        add(body);\r\n        CompUtils.removeMSP(body, \"MSP\");\r\n        body.setSizeFull();\r\n    }\r\n\r\n    /**\r\n     * The reloadDatafileGrid function is called when the user clicks on the &quot;Refresh&quot; button in the Data File Grid.\r\n     * It reloads all of the data files that are associated with a particular project role, and then displays them in\r\n     * a grid. The function first gets an instance of ProjectRole from SessionParams, which is stored as an HTTP attribute.\r\n     * If this object exists (i.e., if it's not null), then we use it to get all of our data files using findAllByProjectRole().\r\n     * We remove any items from this list that have been deleted or whose file type equals IMP\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadDatafileGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<DataFile> files = getServices().getDataFileService().findAllByProjectRole(projectRole);\r\n            files.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            files.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = getParameter(FileParam.FILE_TYPE, item).equals(ObjectType.IMPEX_INPUT);\r\n                }\r\n                return result;\r\n            });\r\n            files.sort((o1, o2) -> o2.getCreateOn().compareTo(o1.getCreateOn()));\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(files));\r\n        } else {\r\n            dataFileGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The reloadAssortmentGrid function is called when the user clicks on the &quot;Refresh&quot; button.\r\n     * It reloads all of the Assortments that are associated with a ProjectRole, and then displays them in a grid.\r\n     *\r\n     * @return The assortmentgrid object\r\n     * @docauthor Trelent\r\n     */\r\n    public void reloadAssortmentGrid() {\r\n        ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n        if (Objects.nonNull(projectRole)) {\r\n            List<Assortment> assortments = getServices().getAssortmentService().findAllByProjectRole(projectRole);\r\n            assortments.removeIf(item -> Objects.nonNull(item.getDeleteOn()));\r\n            assortments.removeIf(item -> {\r\n                boolean result = false;\r\n                ObjectType value = getParameter(FileParam.FILE_TYPE, item);\r\n                if (Objects.nonNull(value)) {\r\n                    result = getParameter(FileParam.FILE_TYPE, item).equals(ObjectType.IMPEX);\r\n                }\r\n                return result;\r\n            });\r\n\r\n            assortments.sort((o1, o2) -> o2.getUpdateOn().compareTo(o1.getUpdateOn()));\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(assortments));\r\n        } else {\r\n            assortmentGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<>()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setDatafileGrid function is responsible for setting up the grid that displays all of the data files\r\n     * in a given directory. It sets up three columns: one for file name, one for update by, and one for update on.\r\n     * The function also adds a selection listener to the grid so that when an item is selected it will be added to\r\n     * user session as an active data file. If no items are selected then any active data files will be removed from\r\n     * user session. Finally, this function calls reloadDatafileGrid which populates the grid with all of the files in\r\n     * a given directory (the default\r\n     *\r\n     * @return A grid of data files\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDatafileGrid() {\r\n        dataFileGrid.setId(\"data-file-grid\");\r\n        dataFileGrid.setSelectionMode(SelectionMode.MULTI);\r\n        dataFileGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(4);\r\n        dataFileGrid.addColumn(this::getName)\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_BY, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n        dataFileGrid.addColumn(file -> Parse.formatDateTime(file.getUpdateOn(), AstDateTimeFormat.GERMAN))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_UPDATE_ON, getLocale(), getCtx())).setResizable(true)\r\n                .setFlexGrow(1);\r\n\r\n        reloadDatafileGrid();\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_BASE_FILE), setLeftButtons(), dataFileGrid));\r\n\r\n        dataFileGrid.addSelectionListener(event -> {\r\n            List<DataFile> selected = new ArrayList<>();\r\n            selected.addAll(event.getAllSelectedItems());\r\n            if (selected.isEmpty()) {\r\n                getCtx().getUserSession().remove(Params.ACTIVE_DATAFILE);\r\n            } else {\r\n                getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selected);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The getName function takes an object as a parameter and returns the name of the user who last updated that object.\r\n     * If no user is found, it returns &quot;UNKNOWN&quot;.\r\n     *\r\n     * @param Object obj Determine which type of object is being passed in\r\n     * @return The name of the user who last updated the file\r\n     * @docauthor Trelent\r\n     */\r\n    private String getName(Object obj) {\r\n        User user = null;\r\n        if (obj instanceof DataFile) {\r\n            user = ((DataFile) obj).getUpdateBy();\r\n        } else if (obj instanceof Assortment) {\r\n            user = ((Assortment) obj).getUpdateBy();\r\n        }\r\n        if (Objects.nonNull(user)) {\r\n            return user.getSurName() + \", \" + user.getGivenName();\r\n        } else {\r\n            return \"UNKNOWN\";\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The openAssortment function is used to open an assortment.\r\n     *\r\n     * @param Callable&lt;Assortment&gt; selected Create a new assortment\r\n     * @param boolean                    openOnly Determine if the assortment should be opened in read-only mode or not\r\n     * @return The assortment that was selected\r\n     * @docauthor Trelent\r\n     */\r\n    private void openAssortment(Callable<Assortment> selected, boolean openOnly) {\r\n        CustomDialog cDialog = new CustomDialog(getCtx());\r\n        cDialog.setCom(() -> {\r\n            cDialog.setLabel(TMS.SET_DIALOG_CREATE_ASSORTMENT);\r\n            Assortment assortment;\r\n            try {\r\n                assortment = selected.call();\r\n\r\n                AssortmentUtil.isLocked(getCtx(), assortment);\r\n\r\n                if (Objects.nonNull(assortment)) {\r\n                    getCtx().getUserSession().put(\"HELLO_WORLD\", \"TEST_TEST\");\r\n                    setSessionAssortment(getCtx(), assortment);\r\n                    loadAssortmentsBreadCrumb();\r\n                    ToADDCrumbDialog dialog = new ToADDCrumbDialog(getCtx(), openOnly);\r\n                    dialog.open();\r\n                    dialog.execute();\r\n                } else {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_NOT_READY, getLocale(), getCtx()));\r\n                }\r\n            } catch (AssortmentLockException e) {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_ASSORTMENT_IS_LOCKED, getLocale(), getCtx()));\r\n            } catch (AstFileNotExistsException e) {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_BASE_FILE_NOT_EXISTS, getLocale(), getCtx()));\r\n            } catch (Exception e) {\r\n                log.debug(e.getMessage(), e);\r\n            }\r\n        });\r\n        cDialog.open();\r\n        cDialog.run();\r\n    }\r\n\r\n    /**\r\n     * The setAssortmentGrid function is responsible for setting up the assortment grid.\r\n     * It sets the id of the grid, and then checks if a user has permission to multi-select items in it.\r\n     * If they do, it enables multi-selection mode; otherwise, single selection mode is enabled.\r\n     * The function then adds columns to display file name and whether or not an item is locked (by another user).\r\n     *\r\n     * @return A componentrenderer&lt;component, assortment&gt;\r\n     * @docauthor Trelent\r\n     */\r\n    private void setAssortmentGrid() {\r\n        assortmentGrid.setId(\"assortmentGrid\");\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        if (getPermission(user, getServices(), this.getClass().getCanonicalName() + \".Assortment.MultiSelector\")\r\n                .isRead())\r\n            assortmentGrid.setSelectionMode(SelectionMode.MULTI);\r\n        else\r\n            assortmentGrid.setSelectionMode(SelectionMode.SINGLE);\r\n\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.addColumnToolTip(getCtx(), item.getName(), ASTConst.EMPTY))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_FILENAME, getLocale(), getCtx())).setFlexGrow(4)\r\n                .setResizable(true).setFlexGrow(7);\r\n        assortmentGrid.addComponentColumn(item -> CompUtils.isLocked(getCtx(), item))\r\n                .setHeader(getTranslation(TMS.LOADER_GRID_IS_LOCKED, getLocale(), getCtx())).setFlexGrow(1)\r\n                .setResizable(true).setWidth(\"10%\");\r\n        reloadAssortmentGrid();\r\n\r\n        assortmentGrid.addSelectionListener(event -> {\r\n            downloadBtn.setEnabled(false);\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, null);\r\n                cDialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                List<Assortment> selected = new ArrayList<>();\r\n                selected.addAll(event.getAllSelectedItems());\r\n\r\n                if (!selected.isEmpty()) {\r\n                    if (!selected.get(0).getName().isEmpty()) {\r\n                        downloadBtn.setEnabled(true);\r\n                    }\r\n                    setSessionAssortment(selected.get(0));\r\n                    downloader(getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT));\r\n                    reloadInfoBox(cDialog.getDialogUI());\r\n                } else {\r\n                    reloadInfoBox(cDialog.getDialogUI());\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n        // check if Locked\r\n        assortmentGrid.addItemDoubleClickListener(event -> openAssortment(event::getItem, false));\r\n\r\n        body.add(box(getPanelHeader(TMS.LOADER_PANEL_ASSORTMENT_FILE), setRightButtons(), assortmentGrid));\r\n\r\n    }\r\n\r\n    /**\r\n     * The setLeftButtons function creates a HorizontalLayout containing three buttons:\r\n     * - newVersion, which allows the user to create a new DataFile object.\r\n     * - changeVersion, which allows the user to edit an existing DataFile object.\r\n     * - deleteVersion, which allows the user to delete an existing DataFile object.\r\n     *\r\n     * @return A horizontallayout, which is a layout component\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setLeftButtons() {\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_FILE_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.setId(\"data-file-new\");\r\n        newVersion.addClickListener(event -> {\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole)) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), null);\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button changeVersion = new Button(VaadinIcon.PENCIL.create());\r\n        changeVersion.setId(\"data-file-edit\");\r\n        CompUtils.addToolTip(getCtx(), changeVersion, TMS.LOADER_FILE_GRID_BUTTON_EDIT_TOOLTIP);\r\n        changeVersion.addClickListener(event -> {\r\n            List<DataFile> files = new ArrayList<>();\r\n            files.addAll(dataFileGrid.getSelectedItems());\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            if (Objects.nonNull(projectRole) && !files.isEmpty()) {\r\n                loadFileEditBreadCrumb();\r\n                ToFileEditCrumbDialog dialog = new ToFileEditCrumbDialog(getCtx(), files.get(0));\r\n                dialog.open();\r\n                dialog.run();\r\n            }\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        deleteVersion.setId(\"data-file-delete\");\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_FILE_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!dataFileGrid.getSelectedItems().isEmpty()) {\r\n                List<DataFile> files = new ArrayList<>();\r\n                dataFileGrid.getSelectedItems().forEach(file -> {\r\n                    Optional<DataFile> optFile = getServices().getDataFileService().findById(file.getId());\r\n                    optFile.ifPresent(dataFile -> {\r\n                        dataFile.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                        dataFile.setDeleteOn(LocalDateTime.now());\r\n                        files.add(dataFile);\r\n                    });\r\n                });\r\n                getServices().getDataFileService().saveAll(files);\r\n                reloadDatafileGrid();\r\n            }\r\n        });\r\n\r\n        return buttons(newVersion, changeVersion, deleteVersion);\r\n    }\r\n\r\n    /**\r\n     * The setRightButtons function creates a HorizontalLayout containing buttons that are used to manipulate the assortment grid.\r\n     * The function returns this layout, which is then added to the right side of the assortment grid.\r\n     *\r\n     * @return A horizontallayout\r\n     * @docauthor Trelent\r\n     */\r\n    private HorizontalLayout setRightButtons() {\r\n\r\n        Button newVersion = new Button(VaadinIcon.FILE_ADD.create());\r\n        newVersion.setId(\"assortment-file-new\");\r\n        CompUtils.addToolTip(getCtx(), newVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_NEW_TOOLTIP);\r\n        newVersion.addClickListener(event -> {\r\n            assortmentGrid.deselectAll();\r\n            openAssortment(() -> createNewAssortment(getSelectedItems()), false);\r\n        });\r\n\r\n        Button editVersion = new Button(VaadinIcon.PENCIL.create());\r\n        editVersion.setId(\"assortment-file-edit\");\r\n        CompUtils.addToolTip(getCtx(), editVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_EDIT_TOOLTIP);\r\n        editVersion.addClickListener(event -> {\r\n            List<DataFile> selectedDataFile = new ArrayList<>(getSelectedItems());\r\n            if (selectedDataFile.isEmpty()) {\r\n                openAssortment(() -> {\r\n                    Assortment result = null;\r\n                    List<Assortment> selected = new ArrayList<>();\r\n                    if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                        selected.addAll(assortmentGrid.getSelectedItems());\r\n                        result = selected.get(0);\r\n                        setSessionAssortment(result);\r\n                    }\r\n                    return result;\r\n                }, false);\r\n            } else {\r\n                AstNotification notify = new AstNotification(getCtx());\r\n                notify.errorMessage(TMS.ERROR_MSG_NO_NEW_PRICE_FILE_EXCEPT);\r\n            }\r\n        });\r\n\r\n        Button copyVersion = new Button(VaadinIcon.COPY.create());\r\n        copyVersion.setId(\"assortment-file-copy\");\r\n        CompUtils.addToolTip(getCtx(), copyVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_COPY_TOOLTIP);\r\n        copyVersion.addClickListener(event -> {\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                // Selected Assortment\r\n                List<Assortment> selection = new ArrayList<>();\r\n                selection.addAll(assortmentGrid.getSelectedItems());\r\n                final Assortment selected = selection.get(0);\r\n\r\n                // Selected DataFiles\r\n                List<DataFile> selectedDataFile = new ArrayList<>();\r\n                selectedDataFile.addAll(getSelectedItems());\r\n                if (selectedDataFile.isEmpty()) {\r\n                    List<AssortmentDatafile> xCross = getCtx().getServices().getAssortmentDataFileService()\r\n                            .findAllByAssortment(selected);\r\n                    xCross.forEach(item -> {\r\n                        if (item.getAstFile() instanceof DataFile) {\r\n                            selectedDataFile.add((DataFile) item.getAstFile());\r\n                        }\r\n                    });\r\n                }\r\n\r\n                checkFilter(() -> openAssortment(() -> copyAssortment(selected, selectedDataFile), false), selected,\r\n                        \"ecat\");\r\n            }\r\n        });\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        RolePermission autoSortPerm = getPermission(user, getCtx().getServices(), AutoSortingDialog.class);\r\n\r\n        Button autoBuild = new Button(getTranslation(TMS.LOADER_BUTTON_AUTO_SORTING, getLocale(), getCtx()));\r\n        autoBuild.setVisible(autoSortPerm.isRead());\r\n        autoBuild.setId(\"assortment-file-auto\");\r\n        CompUtils.addToolTip(getCtx(), autoBuild, TMS.LOADER_ASSORTMENT_GRID_BUTTON_AUTO_SORTING_TOOLTIP);\r\n        autoBuild.addClickListener(event -> {\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                cDialog.setLabel(TMS.SET_DIALOG_CREATE_ASSORTMENT);\r\n                try {\r\n                    final Assortment assortment = createNewAssortment(getSelectedItems());\r\n                    if (autoSortPerm.isEdit()) {\r\n                        if (Objects.nonNull(assortment)) {\r\n                            AutoSortingDialog dialog = new AutoSortingDialog(getCtx());\r\n                            dialog.open();\r\n                            dialog.execute();\r\n                        } else {\r\n                            AstNotification notify = new AstNotification(getCtx());\r\n                            notify.errorMessage(\r\n                                    getTranslation(TMS.ERROR_MSG_ASSORTMENT_NOT_READY, getLocale(), getCtx()));\r\n                        }\r\n                    } else {\r\n                        FilterRunUtils.setDefaultAutoSorting(getCtx());\r\n                        BuildAutoSortingDialog dialog = new BuildAutoSortingDialog(getCtx(), assortment);\r\n                        dialog.getArticles().clear();\r\n                        dialog.open();\r\n                        dialog.run();\r\n                    }\r\n                } catch (NullPointerException e) {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(\r\n                            getTranslation(TMS.ERROR_MSG_NO_DEFAULT_AUTO_FILTER_SET, getLocale(), getCtx()));\r\n                    log.error(e.getLocalizedMessage(), e);\r\n//\t\t\t\t} catch (AstFileNotExistsException e) {\r\n//\t\t\t\t\tAstNotification notify = new AstNotification(getCtx());\r\n//\t\t\t\t\tnotify.errorMessage(getTranslation(TMS.ERROR_MSG_BASE_FILE_NOT_EXISTS, getLocale(), getCtx()));\r\n//\t\t\t\t} catch (Exception e) {\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        Button deleteVersion = new Button(VaadinIcon.CLOSE_BIG.create());\r\n        deleteVersion.setId(\"assortment-file-delete\");\r\n        CompUtils.addToolTip(getCtx(), deleteVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_DETETE_TOOLTIP);\r\n        deleteVersion.addClickListener(event -> {\r\n            if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                    assortment.setDeleteBy(getCtx().getSession().getCurrentUser(getCtx()));\r\n                    assortment.setDeleteOn(LocalDateTime.now());\r\n                });\r\n                getServices().getAssortmentService().saveAll(assortmentGrid.getSelectedItems());\r\n                reloadAssortmentGrid();\r\n            }\r\n        });\r\n\r\n        downloader(null);\r\n\r\n        Button unlockVersion = new Button(VaadinIcon.UNLOCK.create());\r\n        unlockVersion.setId(\"assortment-file-unlock\");\r\n        CompUtils.addToolTip(getCtx(), unlockVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_LOCK_TOOLTIP);\r\n        unlockVersion.addClickListener(event -> {\r\n            CustomDialog cDialog = new CustomDialog(getCtx());\r\n            cDialog.setCom(() -> {\r\n                if (!assortmentGrid.getSelectedItems().isEmpty()) {\r\n                    assortmentGrid.getSelectedItems().forEach(assortment -> {\r\n                        AssortmentUtil.unLock(getCtx(), assortment);\r\n                        reloadAssortmentGrid();\r\n                        assortmentGrid.select(assortment);\r\n                    });\r\n                }\r\n            });\r\n            cDialog.open();\r\n            cDialog.run();\r\n        });\r\n\r\n        Button createZinfo = new Button(getTranslation(TMS.LOADER_BUTTON_ZINFO, getLocale(), getCtx()));\r\n        createZinfo.setId(\"assortment-file-zInfo\");\r\n        CompUtils.addToolTip(getCtx(), createZinfo, TMS.LOADER_ASSORTMENT_GRID_BUTTON_ZINFO_TOOLTIP);\r\n        createZinfo.addClickListener(event -> {\r\n            getCtx().getUserSession().remove(Params.ACTIVE_ASSORTMENT);\r\n            List<Assortment> selected = new ArrayList<>();\r\n            selected.addAll(getAssortmentGrid().getSelectedItems());\r\n            if (!selected.isEmpty() && !selected.get(0).getName().isEmpty()) {\r\n                setSessionAssortment(selected.get(0));\r\n                createZinfo();\r\n                ToZinfoCrumpDialog zDialog = new ToZinfoCrumpDialog(getCtx());\r\n                zDialog.open();\r\n                zDialog.run();\r\n            }\r\n        });\r\n\r\n        Button uploadVersion = new Button(VaadinIcon.UPLOAD_ALT.create());\r\n        uploadVersion.setId(\"assortment-file-upload\");\r\n        CompUtils.addToolTip(getCtx(), uploadVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_UPLOAD_TOOLTIP);\r\n\r\n        uploadVersion.addClickListener(event -> {\r\n            final Map<String, Boolean> ready = new HashMap<>();\r\n\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOAD_ASSORTMENT);\r\n                new Thread(() -> {\r\n                    List<Assortment> selected = new ArrayList<>();\r\n\r\n                    selected.addAll(getAssortmentGrid().getSelectedItems());\r\n                    if (SchedulerUtils.isValid(getCtx(), selected.get(0))) {\r\n                        setParameter(FileParam.QUEUE_BY, user, selected.get(0));\r\n                        setParameter(FileParam.QUEUE_ON, LocalDateTime.now(), selected.get(0));\r\n                    } else {\r\n                        AssortmentUtil.upload(getCtx(), selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_BY, user, selected.get(0));\r\n                        setParameter(FileParam.UPLOAD_ON, LocalDateTime.now(), selected.get(0));\r\n                    }\r\n\r\n                    reloadInfoBox(dialog.getDialogUI());\r\n\r\n                    dialog.showUploadSuccess();\r\n                    ready.put(\"error\", false);\r\n                    dialog.uiClose();\r\n                }).start();\r\n            });\r\n\r\n            dialog.open();\r\n            dialog.execute();\r\n\r\n            ready.forEach((k, v) -> {\r\n                if (k.equals(\"error\")) {\r\n                    AstNotification notify = new AstNotification(getCtx());\r\n                    notify.errorMessage(getTranslation(TMS.ERROR_MSG_CREATE_ASSORTMENT_FIRST, getLocale(), getCtx()));\r\n                }\r\n            });\r\n        });\r\n\r\n        Button previewVersion = new Button(VaadinIcon.EYE.create());\r\n        previewVersion.setId(\"assortment-file-preview\");\r\n        CompUtils.addToolTip(getCtx(), previewVersion, TMS.LOADER_ASSORTMENT_GRID_BUTTON_PREVIEW_TOOLTIP);\r\n        previewVersion.addClickListener(event -> {\r\n            CustomDialog dialog = new CustomDialog(getCtx());\r\n            dialog.setCom(() -> {\r\n                dialog.setLabel(TMS.LOADER_DIALOG_LOADING);\r\n                Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n                if (Objects.nonNull(assortment) && !assortment.getName().isEmpty()) {\r\n                    loadPreviewBreadCrumb();\r\n                    ToPreviewCrumpDialog pDialog = new ToPreviewCrumpDialog(getCtx());\r\n                    pDialog.open();\r\n                    pDialog.run();\r\n                }\r\n            });\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n\r\n        downloadBtn = new DownloadButton(getCtx(), TMS.LOADER_ASSORTMENT_GRID_BUTTON_DOWNLOAD_TOOLTIP);\r\n        downloadBtn.setId(\"assortment-file-download\");\r\n        return buttons(newVersion, editVersion, copyVersion, autoBuild, deleteVersion, unlockVersion, createZinfo,\r\n                downloadBtn, uploadVersion, previewVersion);\r\n    }\r\n\r\n    /**\r\n     * The createZinfo function creates the Zinfo breadcrumb.\r\n     *\r\n     * @return A string of the breadcrumb\r\n     * @docauthor Trelent\r\n     */\r\n    private void createZinfo() {\r\n        loadZinfoBreadCrumb();\r\n    }\r\n\r\n    /**\r\n     * The dataFiles function is used to retrieve the data files associated with an assortment.\r\n     *\r\n     * @param Assortment assortment Determine the data files that should be included in the zip file\r\n     * @return A list of files that are the datafiles for a given assortment\r\n     * @docauthor Trelent\r\n     */\r\n    @SuppressWarnings(\"unused\") // PDM-2618\r\n    private List<File> dataFiles(Assortment assortment) {\r\n        List<File> result = new ArrayList<>();\r\n\r\n        // DataFile\r\n        List<File> zInfos = new ArrayList<>();\r\n        if (Objects.nonNull(assortment)) {\r\n            List<AssortmentDatafile> xFiles = getServices().getAssortmentDataFileService()\r\n                    .findAllByAssortment(assortment);\r\n            xFiles.forEach(item -> {\r\n                if (item.getAstFile() instanceof DataFile && Objects.isNull(item.getAstFile().getDeleteBy())) {\r\n                    File fiZinfo = new File(\r\n                            SettingUtils.getTempFolder(getCtx()) + File.separator + item.getAstFile().getName());\r\n                    Storage zInfoStorage = getStorage(item.getAstFile());\r\n                    Blob.loadFromCompressedFile(zInfoStorage.getFileblob(), fiZinfo);\r\n                    zInfos.add(fiZinfo);\r\n                }\r\n            });\r\n        }\r\n\r\n        result.addAll(zInfos);\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The downloader function is responsible for downloading the assortment as a zip file.\r\n     * It takes an assortment object and uses it to build a filename, which is then used in the reloadAsFile function of the downloadBtn button.\r\n     * The reloadAsFile function takes two functions: one that returns a string (the filename) and another that returns an InputStream (the contents of the file).\r\n     *\r\n     * @param Assortment assortment Get the assortment id to be used in the downloader function\r\n     * @return A zip file\r\n     * @docauthor Trelent\r\n     */\r\n    private void downloader(Assortment assortment) {\r\n        if (Objects.nonNull(assortment)) {\r\n            String zipFileName = ExportFileUtils.buildZIPFileName(getCtx(), assortment);\r\n            downloadBtn.reloadAsFile(() -> zipFileName, () -> AssortmentUtil.zip(getCtx(), assortment));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The createNewAssortment function creates a new assortment and saves it to the database.\r\n     *\r\n     * @param List&lt;DataFile&gt; selectedFiles Set the selected files to the assortment\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    public Assortment createNewAssortment(List<DataFile> selectedFiles) {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        Assortment assortment = new Assortment();\r\n        assortment.setDate(user);\r\n        assortment.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        assortment = getServices().getAssortmentService().save(assortment);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.ECAT, assortment);\r\n        setSessionAssortment(assortment);\r\n        return setDataFilesToAssortment(assortment, selectedFiles);\r\n    }\r\n\r\n    /**\r\n     * The setDataFilesToAssortment function takes an assortment and a list of datafiles as parameters.\r\n     * It then checks if the selected files are valid, i.e., they are either ECAT_INPUT or ECAT_INPUT_POSITIV files.\r\n     * If they are not valid, it returns null and displays an error message to the user; otherwise, it adds each file in\r\n     * the list to the assortment's datafile collection (if that file is not already present) and reloads the table grid\r\n     * with this new information. Finally, it returns a reference to this updated assortment object so that other functions can use\r\n     *\r\n     * @param Assortment           assortment Get the assortment id\r\n     *                             private assortment setdatafilestoassortment(assortment assortment, list&lt;datafile&gt; selectedfiles) {\r\n     *                             astnotification notify = new astnotification(getctx());\r\n     *                             assortment result = null;\r\n     * @param List&lt;DataFile&gt; selectedFiles Get the selected files from the file grid\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment setDataFilesToAssortment(Assortment assortment, List<DataFile> selectedFiles) {\r\n        AstNotification notify = new AstNotification(getCtx());\r\n        Assortment result = null;\r\n        List<AstFile> datafiles = getAstFileTypeFromAssortment(assortment, DataFile.class);\r\n        boolean valid = false;\r\n        for (DataFile datafile : selectedFiles) {\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, datafile);\r\n            if (type.equals(ObjectType.ECAT_INPUT) || type.equals(ObjectType.ECAT_INPUT_POSITIV)) {\r\n                valid = true;\r\n            }\r\n        }\r\n\r\n        if (valid) {\r\n            selectedFiles.forEach(dataFile -> {\r\n                boolean notValid = false;\r\n                for (AstFile datafile : datafiles) {\r\n                    if (datafile.getId() == dataFile.getId()) {\r\n                        notValid = true;\r\n                        break;\r\n                    }\r\n                }\r\n                if (!notValid) {\r\n                    AssortmentDatafile xrossFile = new AssortmentDatafile();\r\n                    xrossFile.setAssortment(assortment);\r\n                    xrossFile.setAstFile(dataFile);\r\n                    getServices().getAssortmentDataFileService().save(xrossFile);\r\n                }\r\n            });\r\n            result = assortment;\r\n\r\n            // reloadTable\r\n            reloadAssortmentGrid();\r\n        } else {\r\n            result = null;\r\n            notify.errorMessage(getTranslation(TMS.ERROR_MSG_NO_VALID_PRICEFILE_SELECTED, getLocale(), getCtx()));\r\n        }\r\n        return result;\r\n    }\r\n\r\n\r\n    /**\r\n     * The copyAssortment function is used to copy an assortment.\r\n     *\r\n     * @param Assortment           fromCopy Copy the assortment\r\n     * @param List&lt;DataFile&gt; newDatafiles Pass the list of datafiles to be copied\r\n     * @return The assortment object\r\n     * @docauthor Trelent\r\n     */\r\n    private Assortment copyAssortment(Assortment fromCopy, List<DataFile> newDatafiles) {\r\n\r\n        Assortment result = new Assortment();\r\n        loadAssortmentsBreadCrumb();\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n\r\n        AssortmentDataFileDAO serviceXcross = getCtx().getServices().getAssortmentDataFileService();\r\n\r\n        result.setDate(user);\r\n        result.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        Assortment assortment = getServices().getAssortmentService().save(result);\r\n        CompUtils.cloneParameter(getCtx(), FileParam.FILE_TYPE, fromCopy, assortment);\r\n\r\n        newDatafiles.forEach(item -> {\r\n            AssortmentDatafile file = new AssortmentDatafile();\r\n            file.setAssortment(assortment);\r\n            file.setAstFile(item);\r\n            serviceXcross.save(file);\r\n        });\r\n\r\n        getCtx().getServices().getFilterBaseCustomService().clone(fromCopy, assortment);\r\n\r\n        List<AssortmentFilter> preFilters = getCtx().getServices().getAssortmentFilterService()\r\n                .findAllByAssortment(fromCopy);\r\n        preFilters.forEach(item -> {\r\n            AssortmentFilter assortmentFilter = new AssortmentFilter();\r\n            assortmentFilter.setCreateBy(user);\r\n            assortmentFilter.setFilter(item.getFilter());\r\n            assortmentFilter.setAssortment(assortment);\r\n            getCtx().getServices().getAssortmentFilterService().save(assortmentFilter);\r\n        });\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, newDatafiles);\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is called whenever the user navigates to a new page.\r\n     * It checks the current breadbox and determines whether or not it should enable/disable\r\n     * certain buttons based on how many crumbs are in the breadbox. If there are more than one,\r\n     * then we know that there is at least one previous page, so we can enable the &quot;Last&quot; button.\r\n     *\r\n     * @return A boolean\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            if (box.getCrumbs().size() > 1) {\r\n                setLastEnable(false);\r\n                setNextEnable(true);\r\n                setFinishEnable(false);\r\n                setExitEnable(true);\r\n            } else {\r\n                setLastEnable(false);\r\n                setNextEnable(false);\r\n                setFinishEnable(false);\r\n                setExitEnable(false);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the assortment grid and datafile grid, as well as resets the breadcrumbs to their first state.\r\n     *\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            reloadAssortmentGrid();\r\n            reloadDatafileGrid();\r\n            reset2BreadCrumbFirst();\r\n        });\r\n        reloadInfoBox(UI.getCurrent());\r\n    }\r\n\r\n    /**\r\n     * The reset2BreadCrumbFirst function is called when the user clicks on a breadcrumb.\r\n     * It removes all breadcrumbs after the clicked one, and then reloads the buttons in\r\n     * order to update them with their new values. Finally, it calls initial() on the box\r\n     * so that it can be updated with its new values as well. The box is then put back into\r\n     * UserSession so that it can be accessed by other functions later on if needed.\r\n     *\r\n     * @return The first breadcrumb in the list of crumbs\r\n     * @docauthor Trelent\r\n     */\r\n    private void reset2BreadCrumbFirst() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            if (!box.getCrumbs().contains(this))\r\n                box.getCrumbs().add(this);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            reloadButtons();\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadAssortmentsBreadCrumb function is responsible for loading the breadcrumbs that are displayed on the top of\r\n     * the Assortments page. The function first removes all crumbs from the BreadBox except for LoaderCrumb, then adds\r\n     * FilterAddCrumb, FilterRemoveCrumb and FilterIndividualCrumb to it. Finally, it initializes (i.e., displays)\r\n     * these crumbs in their proper order on top of the Assortments page.\r\n     *\r\n     * @return The following:\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadAssortmentsBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().removeIf(crumb -> !(crumb instanceof LoaderCrumb));\r\n            box.getCrumbs().add(new FilterAddCrumb(getCtx()));\r\n            box.getCrumbs().add(new FilterRemoveCrumb(getCtx()));\r\n            box.getCrumbs().add(new FilterIndividualCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadZinfoBreadCrumb function is called when the user clicks on the Zinfo button in the top menu.\r\n     * It loads a new BreadBox object into UserSession, which contains a list of Crumbs that are displayed\r\n     * as links at the top of each page. The first Crumb in this list is always &quot;Home&quot;, and clicking it will\r\n     * take you back to your home page (the one with all your projects). The second Crumb is always &quot;Zinfo&quot;,\r\n     * and clicking it will take you back to this page (the Zinfo main menu). After that, any additional crumbs\r\n     * are added by\r\n     *\r\n     * @return A breadbox object\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadZinfoBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new ZinfoCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadFileEditBreadCrumb function is called when the user clicks on a file in the FileListView.\r\n     * It loads a new breadcrumb into the BreadBox, which will be displayed at the top of the screen.\r\n     * The breadcrumb contains an icon and text that indicates to users what they are currently viewing.\r\n     *\r\n     * @return A breadbox object\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadFileEditBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new FileEditCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The loadPreviewBreadCrumb function is called when the user clicks on the Preview button.\r\n     * It loads a new breadcrumb into the BreadBox, which is then displayed in the UI.\r\n     *\r\n     * @return A breadbox object\r\n     * @docauthor Trelent\r\n     */\r\n    private void loadPreviewBreadCrumb() {\r\n        UI.getCurrent().access(() -> {\r\n            BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n            box.getCrumbs().clear();\r\n            box.getCrumbs().add(new PreviewCrumb(getCtx()));\r\n            box.initial();\r\n            getCtx().getUserSession().put(Params.ACTIVE_BREADBOX, box);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the CrumbProgressDialog.\r\n     * It sets the label of the dialog to &quot;Set Proof&quot; and calls getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n     *\r\n     * @param CrumbProgressDialog dialog Update the progress bar\r\n     * @return A boolean value\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        dialog.setLabel(TMS.setProof(FilterType.ZUORDNUNG_MATERIAL));\r\n        getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL,\r\n                FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     *\r\n     * @return False if the user cancels the exit dialog,\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the necessary fields for this importer.\r\n     * The first parameter of each dialog.addValueCbx() call is a String that represents the name of a field in the database, and must match exactly with one of those names (case sensitive).\r\n     * The second parameter determines whether or not that field should be required by default when importing files using this importer.  If it's true, then it will be required; if false, then it won't be required by default but can still be selected as an option during importation.\r\n     *\r\n     * @param FileImportDialog dialog Access the values of the checkboxes\r\n     * @return A list of the fields that need to be filled in by the user\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CUSTOMER_ARTICLE_NR, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CURRENCY, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, false);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_TERRITORY, false);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It takes all of the data from each row in a table and creates an ArticleBase object for each one,\r\n     * then adds it to a list of articles. If there are any articles, it will create a new DataFile object\r\n     * and set its date to today's date. Then, it sets some default parameters for that DataFile (such as file type).\r\n     * Next, if there is any currency information provided by the user in column 5 of their input file (the 6th column),\r\n     *\r\n     * @param FileImportDialog dialog Get the data from the table\r\n     * @return A list of articlebase objects\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        dialog.getTable().forEach(row -> articles.add(setPrice(row, dialog)));\r\n\r\n        if (!articles.isEmpty()) {\r\n            UI.getCurrent().access(() -> {\r\n                dialog.removeAll();\r\n                dialog.init();\r\n                dialog.setLabel(TMS.LOADER_DIALOG_CONVERT_FILE);\r\n\r\n                // Create new DataFile\r\n                DataFile dataFile = new DataFile();\r\n                dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n\r\n                // create DataBase Object\r\n                dataFile = getServices().getDataFileService().save(dataFile);\r\n                setParameter(FileParam.FILE_TYPE, ObjectType.ECAT_INPUT, dataFile);\r\n\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n                dataFile.setName(ExportFileUtils.buildPriceFileName(getCtx(), dataFile));\r\n                File fi = ExportFileUtils.buildPriceFile(getCtx(), articles, ASTConst.DEFAULT, dataFile);\r\n                dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n\r\n                final DataFile dFile = dataFile;\r\n                Map<Integer, String> colString = dialog.getTable().get(0);\r\n                // CURRENCY\r\n                if (dialog.getColumns()[5] > -1) {\r\n                    String currency = dialog.getColumnsByIdx(colString, 5);\r\n                    if (!currency.isEmpty()) {\r\n                        List<Currency> items = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n                        Optional<Currency> opt = items.stream().filter(item -> item.getKey().equals(currency))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.CURRENCY, value, dFile));\r\n                    }\r\n                }\r\n                // LANGUAGE\r\n                if (dialog.getColumns()[6] > -1) {\r\n                    String language = dialog.getColumnsByIdx(colString, 6);\r\n                    if (!language.isEmpty()) {\r\n                        List<Language> items = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n                        Optional<Language> opt = items.stream().filter(item -> item.getLabel().contains(language))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.LANGUAGE, value, dFile));\r\n                    }\r\n                }\r\n                // TERRITORY\r\n                if (dialog.getColumns()[7] > -1) {\r\n                    String territory = dialog.getColumnsByIdx(colString, 7);\r\n                    if (!territory.isEmpty()) {\r\n                        List<Territory> items = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n                        Optional<Territory> opt = items.stream().filter(item -> item.getKey().equals(territory))\r\n                                .findFirst();\r\n                        opt.ifPresent(value -> setParameter(FileParam.TERRITORY, value, dFile));\r\n                    }\r\n                }\r\n\r\n                // save Last Changes\r\n                getServices().getDataFileService().save(dataFile);\r\n                setParameter(FileParam.FILE_TYPE, FileUtils.getFileType(fi), dataFile);\r\n                saveStorage(dataFile, fi);\r\n                setDefaultParameterToDataFile(articles, dataFile);\r\n\r\n                reloadDatafileGrid();\r\n\r\n            });\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * The setPrice function takes the column string and file import dialog as parameters.\r\n     * It then creates a new ArticleBase object, which is used to store the price information.\r\n     * The function then checks if each of the columns in the CSV file are set to - 1 or not,\r\n     * and if they are not it sets them equal to their respective values in that row of data.\r\n     *\r\n     * @param Map&lt;Integer   Get the value of a specific column\r\n     * @param String&gt;       colString Get the values from the file\r\n     * @param FileImportDialog dialog Get the column indexes\r\n     * @return A articlebase object, which is a price\r\n     * @docauthor Trelent\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n        if (dialog.getColumns()[0] > -1) {\r\n            price.setCustomerArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n        }\r\n        if (dialog.getColumns()[1] > -1) {\r\n            price.setArticleNr(dialog.getColumnsByIdx(colString, 1));\r\n        }\r\n        if (dialog.getColumns()[2] > -1) {\r\n            price.setPriceFirst(dialog.getColumnsByIdx(colString, 2));\r\n        }\r\n        if (dialog.getColumns()[3] > -1) {\r\n            price.setPriceX(dialog.getColumnsByIdx(colString, 3));\r\n        }\r\n        if (dialog.getColumns()[4] > -1) {\r\n            price.setScalelimit(dialog.getColumnsByIdx(colString, 4));\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * The function takes two parameters: a dialog and a list of articles.\r\n     * <p>\r\n     * The dialog parameter is an instance of FileImportDialog, which contains information about what kind of file was imported (e.g., price or positiv).  This information can be accessed using getters such as getFileType().\r\n     * For example, if you wanted to know whether this was a price or positiv file, you could call: dialog.getFileType() == ObjectType.ECAT_INPUT_POS\r\n     *\r\n     * @param FileImportDialog        dialog Get the selected file from the user\r\n     * @param List&lt;ArticleBase&gt; articles Get the price of the first article in the list\r\n     * @return The file name of the saved file\r\n     * @docauthor Trelent\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        DataFile dataFile = new DataFile();\r\n        dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n\r\n        dataFile.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        dataFile = getServices().getDataFileService().save(dataFile);\r\n\r\n        String price = articles.get(0).getPriceFirst();\r\n        double dPrice = Parse.toDouble(price);\r\n\r\n        if (dPrice == 0.0) {\r\n            setParameter(FileParam.FILE_TYPE, ObjectType.ECAT_INPUT_POSITIV, dataFile);\r\n            dataFile.setName(ExportFileUtils.buildPositivFileName(getCtx(), dataFile));\r\n            saveStorage(dataFile, ExportFileUtils.buildPositivFile(getCtx(), articles, ASTConst.DEFAULT));\r\n        } else {\r\n            setParameter(FileParam.FILE_TYPE, ObjectType.ECAT_INPUT, dataFile);\r\n            setDefaultParameterToDataFile(articles, dataFile);\r\n            dataFile.setName(ExportFileUtils.buildPriceFileName(getCtx(), dataFile));\r\n            saveStorage(dataFile, ExportFileUtils.buildPriceFile(getCtx(), articles, ASTConst.DEFAULT, dataFile));\r\n        }\r\n        getServices().getDataFileService().save(dataFile);\r\n        setLanguageParamByCustomer(dataFile);\r\n\r\n        reloadDatafileGrid();\r\n    }\r\n\r\n    /**\r\n     * The setSessionAssortment function sets the assortment in the session.\r\n     *\r\n     * @param Assortment assortment Set the session assortment\r\n     * @return Void\r\n     * @docauthor Trelent\r\n     */\r\n    private void setSessionAssortment(Assortment assortment) {\r\n        setSessionAssortment(getCtx(), assortment);\r\n    }\r\n\r\n    /**\r\n     * The setSessionAssortment function is used to set the active assortment in the user session.\r\n     *\r\n     * @param Context    ctx Get the services and user session\r\n     * @param Assortment assortment Set the active assortment in the user session\r\n     * @return An optional assortment\r\n     * @docauthor Trelent\r\n     */\r\n    private void setSessionAssortment(Context ctx, Assortment assortment) {\r\n        Optional<Assortment> optAssortment = ctx.getServices().getAssortmentService().findById(assortment.getId());\r\n        if (optAssortment.isPresent()) {\r\n            ctx.getUserSession().put(Params.ACTIVE_ASSORTMENT, optAssortment.get());\r\n        } else {\r\n            ctx.getUserSession().put(Params.ACTIVE_ASSORTMENT, assortment);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The getSelectedItems function returns a list of DataFile objects that have been selected in the data file grid.\r\n     * The function first creates an empty ArrayList object called selectedFiles, which will be populated with the\r\n     * DataFile objects that are returned by the getSelectedItems method of the data file grid.  This method returns a set\r\n     * of items from type Object, so each item is cast to type DataFile and added to the list.\r\n     * Next, for each item in this list (which is now guaranteed to be a DataFile), we use Java 8's Optional class and its findById() method\r\n     *\r\n     * @return A list of datafile objects\r\n     * @docauthor Trelent\r\n     */\r\n    private List<DataFile> getSelectedItems() {\r\n        List<DataFile> selectedFiles = new ArrayList<>();\r\n        selectedFiles.addAll(dataFileGrid.getSelectedItems());\r\n        selectedFiles.forEach(item -> {\r\n            Optional<DataFile> optDatafile = getCtx().getServices().getDataFileService().findById(item.getId());\r\n            if (optDatafile.isPresent())\r\n                item = optDatafile.get();\r\n        });\r\n\r\n        return selectedFiles;\r\n    }\r\n\r\n    /**\r\n     * The setDefaultParameterToDataFile function is used to set the default parameters for a data file.\r\n     * The function takes in two arguments: articles and save.\r\n     * Articles is a list of ArticleBase objects, which are the articles that will be saved into the data file.\r\n     * Save is an AstFile object, which represents the data file that will be created from this function call.\r\n     * The first thing this function does is check if there are any articles in its argument list; if not, it returns immediately without doing anything else (since there's no point in setting default parameters for an empty article list). If there are items in its\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Get the first article in the list\r\n     * @param AstFile                 save Save the parameters to the database\r\n     * @return An empty list\r\n     * @docauthor Trelent\r\n     */\r\n    private void setDefaultParameterToDataFile(List<ArticleBase> articles, AstFile save) {\r\n        if (!articles.isEmpty()) {\r\n            ArticleBase first = articles.get(0);\r\n\r\n            List<Currency> currencies = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n            List<Language> languages = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n            List<Territory> territories = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n\r\n            if (!first.getCurrency().isEmpty() && Objects.isNull(getParameter(FileParam.CURRENCY, save))) {\r\n                Optional<Currency> optCurr = currencies.stream()\r\n                        .filter(item -> item.getKey().equals(first.getCurrency())).findFirst();\r\n                optCurr.ifPresent(item -> setParameter(FileParam.CURRENCY, item, save));\r\n            }\r\n            if (!first.getTerritory().isEmpty() && Objects.isNull(getParameter(FileParam.TERRITORY, save))) {\r\n                String territory = first.getTerritory();\r\n                if (territory.contains(\"-\") && Objects.isNull(getParameter(FileParam.LANGUAGE, save))) {\r\n                    String language = territory.split(\"-\")[0];\r\n                    territory = territory.split(\"-\")[2];\r\n                    Optional<Language> optLang = languages.stream().filter(item -> item.getKey().equals(language))\r\n                            .findFirst();\r\n                    optLang.ifPresent(item -> setParameter(FileParam.LANGUAGE, item, save));\r\n                }\r\n                String finalTerr = territory;\r\n                Optional<Territory> optTerr = territories.stream().filter(item -> item.getKey().equals(finalTerr))\r\n                        .findFirst();\r\n                optTerr.ifPresent(item -> setParameter(FileParam.TERRITORY, item, save));\r\n            }\r\n\r\n            KatalogVersion version = CompUtils.getKatalogVersion(getCtx(), save);\r\n\r\n            setParameter(FileParam.KATALOG_VERSION, version, save);\r\n\r\n            if (!first.getValidFrom().isEmpty()) {\r\n                setParameter(FileParam.VALID_FROM, first.getValidFromAsLocalDate(), save);\r\n            } else {\r\n                setParameter(FileParam.VALID_FROM, version.getValidFrom(), save);\r\n            }\r\n\r\n            if (!first.getValidTo().isEmpty()) {\r\n                setParameter(FileParam.VALID_TO, first.getValidToAsLocalDate(), save);\r\n            } else {\r\n                setParameter(FileParam.VALID_TO, version.getValidTo(), save);\r\n            }\r\n\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\LoaderCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\PreviewCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.dao.impl.ZinfoCustomRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Zinfo;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.ExcelUtils;\r\nimport com.hom.ebmw.utilities.InternalUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.TabBox;\r\nimport com.hom.ebmw.view.dialogs.FileConvertDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseQuickDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.Component;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.progressbar.ProgressBar;\r\nimport com.vaadin.flow.component.tabs.Tab;\r\nimport com.vaadin.flow.component.tabs.Tabs;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.function.ValueProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.*;\r\nimport java.util.concurrent.Callable;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\n@BreadCrumb(TMS.CRB_PREVIEW)\r\npublic class PreviewCrumb\r\n        extends\r\n        Crumb {\r\n\r\n    private final Tabs tabBay = new Tabs();\r\n    private final Div pages = new Div();\r\n    private final Map<Tab, VerticalLayout> tabMap = new HashMap<Tab, VerticalLayout>();\r\n    private final ArticleDetailBox details;\r\n    private Assortment assortment = null;\r\n\r\n    /**\r\n     * The PreviewCrumb function is a constructor for the PreviewCrumb class.\r\n     * It creates an instance of the ArticleDetailBox class, and adds it to the tabBay and pages components.\r\n     * The function also sets up a listener that will change which page is visible when tabs are selected in tabBay.\r\n     *\r\n     * @param Context ctx Get the current user session\r\n     * @return A component\r\n     */\r\n    public PreviewCrumb(\r\n            Context ctx) {\r\n        super(ctx);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_UI, UI.getCurrent());\r\n        this.assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        details = new ArticleDetailBox(getCtx(), new ArrayList<ArticleBase>());\r\n        add(details, tabBay, pages);\r\n        pages.setSizeFull();\r\n\r\n        tabBay.addSelectedChangeListener(event -> {\r\n            tabMap.forEach((k, v) -> {\r\n                v.setVisible(false);\r\n            });\r\n            Component selectedPage = tabMap.get(tabBay.getSelectedTab());\r\n            selectedPage.setVisible(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a tab in the\r\n     * AssortmentView. It removes all tabs from the TabSheet, and then adds back\r\n     * only those that are relevant to this assortment. This allows for dynamic\r\n     * updating of tabs based on what assortment is selected by the user. The first\r\n     * two tabs added are always PriceList and Removed, but after that it depends on\r\n     * which zInfo files exist for this particular assortment (which can be found in\r\n     * getServices().getZinfoCustomerSerivce().findAllByAssortment(assortment)).\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        final UI ui = UI.getCurrent();\r\n\r\n        ui.access(() -> {\r\n            tabBay.removeAll();\r\n            pages.removeAll();\r\n            tabMap.clear();\r\n\r\n            addTabPriceList(assortment);\r\n            addTabRemoved(assortment);\r\n\r\n            Map<String, Integer> zInfos = getServices().getZinfoCustomerSerivce().findAllByAssortment(assortment);\r\n            if (Objects.nonNull(zInfos) && !zInfos.isEmpty()) {\r\n                zInfos.forEach((k, v) -> {\r\n                    addTabZinfo(assortment, k);\r\n                });\r\n            }\r\n        });\r\n\r\n        details.reload(() -> getServices().getArticleBaseService().findAllInArchivByAssortment(assortment));\r\n    }\r\n\r\n    /**\r\n     * The addTabPriceList function adds a tab to the preview window.\r\n     * The tab is labeled &quot;Price List&quot; and contains a grid with columns for customer article number,\r\n     * article number, price first (with thousand separator), price scale (with thousand separator), and scale limit.\r\n     * The grid can be sorted by any of these columns.  It also has an export button that allows the user to download it as an Excel file.\r\n     *\r\n     * @param Assortment assortment Get the assortment id\r\n     */\r\n    private void addTabPriceList(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_PRICELIST, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(ArticleBase::getCustomerArticleNr)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_CUSTOMER_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"customerArticleNr\");\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"articleNr\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceFirstWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_FIRST, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                .setSortable(true)\r\n                .setKey(\"priceFirst\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceXWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_SCALE, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX()))\r\n                .setSortable(true)\r\n                .setKey(\"priceX\");\r\n        box.getGrid().addColumn(ArticleBase::getScalelimit)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_SCALE_LIMIT, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"scalelimit\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n\r\n        box.setLoad(loadGrid(box, () -> {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, false);\r\n            box.getDownload().reloadAsFile(() -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\", () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT, box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        Button customExport = new Button(getTranslation(TMS.GENERATE_DIALOG_RENDER_EXPORT, getLocale(), getCtx()));\r\n        customExport.addClickListener(event -> {\r\n            FileConvertDialog dialog = new FileConvertDialog(getCtx());\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        box.getButtons().add(customExport);\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    /**\r\n     * The addTabRemoved function adds a tab to the preview page.\r\n     * The tab is labeled &quot;Removed&quot; and contains a grid with all articles that have been removed from the assortment.\r\n     * The grid has columns for customer article number, article number, price first, price scale, scale limit and comment.\r\n     *\r\n     * @param Assortment assortment Get the assortment id and to replace it in the articlenr\r\n     */\r\n    private void addTabRemoved(Assortment assortment) {\r\n        TabBox<ArticleBase> box = new TabBox<ArticleBase>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_REMOVED, getLocale(), getCtx())));\r\n\r\n        box.setGrid(new Grid<ArticleBase>());\r\n        box.getGrid().addColumn(ArticleBase::getCustomerArticleNr)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_CUSTOMER_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"customerArticleNr\");\r\n        box.getGrid().addColumn(item -> item.getArticleNr().replace(+assortment.getId() + \"#\", \"\"))\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"articleNr\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceFirstWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_FIRST, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                .setSortable(true)\r\n                .setKey(\"priceFirst\");\r\n        box.getGrid().addColumn(ArticleBase::getPriceXWithThousend)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_PRICE_SCALE, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX()))\r\n                .setSortable(true)\r\n                .setKey(\"priceX\");\r\n        box.getGrid().addColumn(ArticleBase::getScalelimit)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_SCALE_LIMIT, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"scalelimit\");\r\n        box.getGrid().addColumn(ArticleBase::getComment)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_COMMENT, getLocale(), getCtx()))\r\n                .setResizable(true)\r\n                .setSortable(true)\r\n                .setKey(\"comment\");\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(ArticleBase::getArticleNr);\r\n        box.setLoad(loadGrid(box, () -> {\r\n            final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n            List<ArticleBase> data = articleService.findAllByAssortmentAndIsCommet(assortment, true);\r\n            box.getDownload().reloadAsFile(\r\n                    () -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfArticleListPlain(getCtx(), data, ASTConst.DEFAULT, box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n    /**\r\n     * The addTabZinfo function adds a tab to the preview window.\r\n     * The tab is labeled with the type of assortment (e.g., &quot;Zinfo&quot;) and the type of article (e.g., &quot;A&quot;).\r\n     * The grid in each tab contains three columns: ArticleNr, ArticleDescription, and Comment.\r\n     * Each column can be sorted by clicking on its header; each column can also be resized by dragging its right border left or right with a mouse click-and-hold action.\r\n     *\r\n     * @param Assortment assortment Get the assortment from the database\r\n     * @param String     type Determine which tab to add\r\n     */\r\n    private void addTabZinfo(Assortment assortment, String type) {\r\n        TabBox<Zinfo> box = new TabBox<Zinfo>(getCtx());\r\n        box.setTab(new Tab(getTranslation(TMS.PREVIEW_TAB_ZINFO, getLocale(), getCtx()) + type));\r\n\r\n        box.setGrid(new Grid<Zinfo>());\r\n        box.getGrid().addColumn(Zinfo::getArticleNr)\r\n                .setSortable(true)\r\n                .setResizable(true)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_NR, getLocale(), getCtx()))\r\n                .setKey(\"articleNr\");\r\n        box.getGrid().addColumn(Zinfo::getArticleDescription)\r\n                .setSortable(true)\r\n                .setResizable(true)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_ARTICLE_DESCRIPTION, getLocale(), getCtx()))\r\n                .setKey(\"articleDescription\");\r\n        box.getGrid().addColumn(Zinfo::getComment)\r\n                .setSortable(true)\r\n                .setResizable(true)\r\n                .setHeader(getTranslation(TMS.PREVIEW_GRID_COMMENT, getLocale(), getCtx()))\r\n                .setKey(\"comment\");\r\n\r\n        box.getGrid().setSizeFull();\r\n\r\n        box.setSearchField(Zinfo::getArticleNr);\r\n        box.getSearchField().addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Zinfo> gridDataProvider = (ListDataProvider<Zinfo>) box.getGrid().getDataProvider();\r\n            box.getFoundArticle().setText(String.valueOf(gridDataProvider.getItems().size()));\r\n        });\r\n\r\n        box.setLoad(loadGrid(box, () -> {\r\n            final ZinfoCustomRepository zinfoService = getCtx().getServices().getZinfoCustomerSerivce();\r\n            List<Zinfo> data = zinfoService.findAllByAssortmentAndType(assortment, type);\r\n            box.getDownload().reloadAsFile(\r\n                    () -> InternalUtils.replaceSpecials(box.getTab().getLabel()) + \".xlsx\",\r\n                    () -> ExcelUtils.writeExcelFileOfZinfoList(getCtx(), data, ASTConst.DEFAULT, box.getTab().getLabel()));\r\n            return data;\r\n        }));\r\n\r\n        box.setLayout();\r\n        tabMap.put(box.getTab(), box.getLayout());\r\n        tabBay.add(box.getTab());\r\n        pages.add(box.getLayout());\r\n    }\r\n\r\n\r\n    /**\r\n     * The getSearchField function is used to create a search field for the TabBox.\r\n     * The function takes in two parameters: the TabBox and a ValueProvider.\r\n     * The ValueProvider is used to filter through the data in order to find what you are looking for.\r\n     * It then adds an event listener that filters through all of the data using CompUtils' searchWithParameters function, which uses Java's String class' contains method with ignore case enabled (so it doesn't matter if you type capital or lowercase letters).\r\n     *\r\n     * @param TabBox&lt;E&gt;    box Get the data provider and filter it\r\n     * @param ValueProvider&lt;E Define the type of data that will be used in the search\r\n     * @param V&gt;              provider Filter the data in the list\r\n     * @return A textfield component with a listener that filters the data provider of the tabbox\r\n     */\r\n    @SuppressWarnings(\"unused\")\r\n    private <E, V> TextField getSearchField(TabBox<E> box, ValueProvider<E, V> provider) {\r\n        TextField fieldTxt = new TextField();\r\n        fieldTxt.setPlaceholder(getTranslation(TMS.PREVIEW_SEARCH_PLACEHOLDER, getLocale(), getCtx()));\r\n        fieldTxt.addValueChangeListener(event -> {\r\n            ListDataProvider<E> listProvider = box.getDataProvider();\r\n            listProvider.setFilter(provider, value -> CompUtils.searchWithParameters(value, fieldTxt));\r\n            box.setDataProvider(listProvider);\r\n            box.runFoundArticle();\r\n        });\r\n\r\n        return fieldTxt;\r\n    }\r\n\r\n    /**\r\n     * The loadGrid function is a helper function that takes in a TabBox and Callable.\r\n     * The TabBox is the grid that will be loaded with data from the callable.\r\n     * The callable returns a list of objects, which are then used to populate the grid.\r\n     *\r\n     * @param TabBox&lt;E&gt;               box Set the dataprovider of the tabbox\r\n     * @param Callable&lt;List&lt;E&gt;&gt; list Get the data from a database\r\n     * @return A progress bar, which is then added to the layout\r\n     */\r\n    private <E> ProgressBar loadGrid(TabBox<E> box, Callable<List<E>> list) {\r\n        ProgressBar progress = new ProgressBar();\r\n        progress.setIndeterminate(true);\r\n        final UI ui = UI.getCurrent();\r\n\r\n        new Thread(() -> {\r\n            ui.access(() -> {\r\n                progress.setVisible(true);\r\n                try {\r\n                    List<E> buffer = list.call();\r\n                    box.setDataProvider(DataProvider.ofCollection(buffer));\r\n                    box.runFoundArticle();\r\n                } catch (Exception e) {\r\n                    log.error(e.getLocalizedMessage());\r\n                    log.debug(e.toString());\r\n                }\r\n                progress.setVisible(false);\r\n            });\r\n        }).start();\r\n        return progress;\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is used to reset the buttons on the bottom of\r\n     * the screen. It sets all buttons to disabled except for exit, which is set\r\n     * to enabled. This function is called when a new page loads in order to ensure\r\n     * that no button can be pressed until it has been properly initialized by its\r\n     * corresponding class.\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setExitEnable(true);\r\n            setNextEnable(false);\r\n            setLastEnable(false);\r\n            setFinishEnable(false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        CloseQuickDialog dialog = new CloseQuickDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\PreviewCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\ZinfoCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Zinfo;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.*;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_ZINFO)\r\npublic class ZinfoCrumb extends FilterCrumb implements FileInputLoader {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private final HorizontalLayout body = new HorizontalLayout();\r\n\r\n    /**\r\n     * The ZinfoCrumb function is a constructor for the ZinfoCrumb class.\r\n     * It creates an Accordion object, and adds it to the body of the ZinfoCrumb object.\r\n     * The Accordion object is then populated with information from loadZinfo().\r\n     *\r\n     * @param Context ctx Get the usersession and activeassortment\r\n     * @return a Crumb\r\n     */\r\n    public ZinfoCrumb(Context ctx) {\r\n        super(ctx, new Accordion());\r\n        Assortment assortment = ctx.getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        body.add(loadZinfo(assortment));\r\n        setSizeFull();\r\n\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n        add(body);\r\n        CompUtils.removeMSP(body, \"MP\");\r\n        body.setSizeFull();\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is called when the user clicks on a button in the wizard.\r\n     * It sets all buttons to disabled, and then enables only those that are appropriate for\r\n     * the current state of the wizard.  This function is called by each of its subclasses,\r\n     * which override it to enable additional buttons as needed.  For example, if you want to add a &quot;Save&quot; button that appears on every page except for Page 1 (the first page), you would do this:&lt;br&gt;&lt;br&gt;\r\n     * &lt;code&gt;\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user clicks on the exit button.\r\n     * It creates a new CloseDialog object and opens it, then runs it.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        CloseDialog dialog = new CloseDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is called by the FileImportDialog class when it creates a new instance of this class.\r\n     * The function adds checkboxes to the dialog, which are used to determine what data should be imported from the file.\r\n     * In this case, we add two checkboxes: one for article numbers and one for comments.\r\n     *\r\n     * @param FileImportDialog dialog Add the fields that are to be imported\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_COMMENT, true);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the save button in\r\n     * the FileImportDialog. The function takes a FileImportDialog as an argument,\r\n     * and uses it to get all of its rows. It then iterates through each row, and\r\n     * gets its key-value pair using getKeyValue(). This key-value pair is then put into a cache map.\r\n     * After this, we create an empty list of Zinfo objects called currentList. We use this list to store all of our Zinfo objects from our grid (which we will be updating).\r\n     * Then we create another ListDataProvider\r\n     *\r\n     * @param FileImportDialog dialog Get the table from the dialog\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        Map<String, String> cache = new HashMap<>();\r\n\r\n        dialog.getTable().forEach(row -> {\r\n            KeyValue kv = getKeyValue(row, dialog);\r\n            cache.put(kv.getKey(), kv.getValue());\r\n        });\r\n\r\n        GridPro<Zinfo> zinfogrid = getCtx().getUserSession().get(Params.ACTIVE_ZINFO_GRID);\r\n\r\n        List<Zinfo> currentList = new ArrayList<>();\r\n        try {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Zinfo> dataProvider = (ListDataProvider<Zinfo>) zinfogrid.getDataProvider();\r\n            currentList.addAll(dataProvider.getItems());\r\n            dialog.removeAll();\r\n            dialog.init();\r\n            dialog.setLabel(TMS.ZINFO_DIALOG_START_COMPARE);\r\n\r\n            currentList.forEach(zinfo -> {\r\n                String articleNr = zinfo.getArticleNr();\r\n                String comment = cache.get(articleNr);\r\n                if (Objects.nonNull(comment)) {\r\n                    zinfo.setComment(comment);\r\n                }\r\n            });\r\n            getZinfoGrid().reload(currentList);\r\n            getCtx().getUserSession().put(Params.ACTIVE_ZINFO_GRID, zinfogrid);\r\n        } catch (NullPointerException e) {\r\n            log.error(\"Grid is Empty\");\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * The getKeyValue function takes a map of integers to strings and a FileImportDialog object as parameters.\r\n     * It returns an instance of the KeyValue class, which is used to store key-value pairs in the database.\r\n     * The function first checks if there is data in column 0 (ArticleNr) and stores it as the key value if so.\r\n     * Then it checks if there is data in column 1 (priceFirst aka Comment) and stores it as the value, after replacing new line feed/carriage return characters with nothing.\r\n     *\r\n     * @param Map&lt;Integer   Get the value of a column\r\n     * @param String&gt;       colString Get the value of a specific column\r\n     * @param FileImportDialog dialog Get the column values from the file\r\n     * @return A keyvalue object, which is a simple pojo with two fields\r\n     */\r\n    private KeyValue getKeyValue(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        KeyValue result = new KeyValue();\r\n        // ArticleNr\r\n        if (dialog.getColumns()[0] > -1) {\r\n            result.setKey(dialog.getColumnsByIdx(colString, 0));\r\n        }\r\n        // priceFirst aka Comment\r\n        if (dialog.getColumns()[1] > -1) {\r\n            // PDM-2246\r\n            String value = dialog.getColumnsByIdx(colString, 1);\r\n            // PDM-2527\r\n            if (Objects.isNull(value))\r\n                value = \"\";\r\n            // Replace new Line Feed \\ Carriage Return to Nothing\r\n            value = value.replace(\"\\n\\r\", \"\");\r\n            value = value.replace(\"\\r\\n\", \"\");\r\n            value = value.replace(\"\\n\", \"\");\r\n            value = value.replace(\"\\r\", \"\");\r\n\r\n            result.setValue(value);\r\n        }\r\n        return result;\r\n    }\r\n\r\n    private class KeyValue {\r\n        private String key;\r\n        private String value;\r\n\r\n        public String getKey() {\r\n            return key;\r\n        }\r\n\r\n        public void setKey(String key) {\r\n            this.key = key;\r\n        }\r\n\r\n        public String getValue() {\r\n            return value;\r\n        }\r\n\r\n        public void setValue(String value) {\r\n            this.value = value;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The directSave function is used to save the articles directly into the database.\r\n     * This function is not in use for this plugin, as it does not need to be called.\r\n     *\r\n     * @param FileImportDialog        dialog Get the file name and path\r\n     * @param List&lt;ArticleBase&gt; articles Pass the list of articles to be saved\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        log.debug(\"not in use\");\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\ZinfoCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\ECatPresenter.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat;\r\n\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.view.sortment.ecat.crumb.LoaderCrumb;\r\nimport com.hom.ebmw.view.sortment.subview.Importer;\r\nimport com.hom.ebmw.view.sortment.subview.InfoBox;\r\n\r\nimport java.util.Locale;\r\nimport java.util.Objects;\r\n\r\n\r\npublic class ECatPresenter {\r\n\r\n    private LoaderCrumb loader;\r\n    private Importer importer;\r\n    private InfoBox info;\r\n    private LocalCustomer localCustomer;\r\n    private Context ctx = new Context();\r\n\r\n    /**\r\n     * The ECatPresenter function is a constructor for the ECatPresenter class.\r\n     * It takes in a Context object as an argument and assigns it to the ctx variable.\r\n     *\r\n     * @param Context ctx Get the context of the activity that is calling this class\r\n     * @return A list of categories\r\n     */\r\n    public ECatPresenter(Context ctx) {\r\n        this.ctx = ctx;\r\n    }\r\n\r\n    /**\r\n     * The setLoader function sets the loader variable to the LoaderCrumb object passed in as a parameter.\r\n     *\r\n     * @param LoaderCrumb loader Set the loader variable\r\n     */\r\n    public void setLoader(LoaderCrumb loader) {\r\n        this.loader = loader;\r\n    }\r\n\r\n    /**\r\n     * The setInfo function sets the info box to a new value.\r\n     *\r\n     * @param InfoBox info Set the info variable to the infobox object that is passed in\r\n     */\r\n    public void setInfo(InfoBox info) {\r\n        this.info = info;\r\n    }\r\n\r\n    /**\r\n     * The getInfo function returns the info box of the current object.\r\n     *\r\n     * @return The info object\r\n     */\r\n    public InfoBox getInfo() {\r\n        return info;\r\n    }\r\n\r\n    /**\r\n     * The setImporter function sets the importer variable to the Importer object passed in as a parameter.\r\n     *\r\n     * @param Importer importer Set the importer variable to the value of importer\r\n     */\r\n    public void setImporter(Importer importer) {\r\n        this.importer = importer;\r\n    }\r\n\r\n    /**\r\n     * The setChangeValue function is called when the user selects a customer from the dropdown menu.\r\n     * It sets the localCustomer variable to be equal to whatever customer was selected, and then calls\r\n     * reloadDatafileGrid() and reloadAssortmentGrid(). These functions are defined in Loader.java, which\r\n     * is used as an interface between this class (ImporterView) and ImporterPresenter. The purpose of these\r\n     * two functions is to update both grids on screen with data that corresponds with whichever customer was selected.\r\n     *\r\n     * @param LocalCustomer customer Set the localcustomer variable\r\n     */\r\n    public void setChangeValue(LocalCustomer customer) {\r\n        if (Objects.nonNull(customer)) {\r\n            importer.getUploader().setVisible(true);\r\n            localCustomer = customer;\r\n            CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n            loader.reloadDatafileGrid();\r\n            loader.reloadAssortmentGrid();\r\n        } else {\r\n            importer.getUploader().setVisible(false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setStartedEvent function is called when the user clicks on the &quot;Started&quot; button.\r\n     * It sets a session variable to indicate that this event has been started, and then\r\n     * redirects to the main page.  The main page will check for this session variable and\r\n     * display an appropriate message if it exists.  This function also sets a cookie with\r\n     * information about which customer was selected by the user, so that we can remember their choice later on.\r\n     *\r\n     * @param Locale locale Set the language of the application\r\n     */\r\n    public void setStartedEvent(Locale locale) {\r\n        //CompUtils.setSessionProjectByCustomer(ctx, localCustomer);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\ECatPresenter.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-jjw5Hu6vLDsOcQQetgGG3fkeXMLvh3pu",
    "created" : 1762171664,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"multiple\",\n  \"issues\": [\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Potential IndexOutOfBounds in LoaderCrumb.directSave when articles list is empty\",\n      \"justification\": \"The method accesses articles.get(0) without checking list size, causing runtime exception if no rows were imported.\",\n      \"action\": \"Add a guard: if (articles.isEmpty()) { show user error and abort; } before accessing index 0; add unit test for empty import case.\",\n      \"source\": \"LoaderCrumb.directSave(FileImportDialog dialog, List<ArticleBase> articles), line with articles.get(0)\",\n      \"component\": \"loader-crumb\",\n      \"impact_scope\": \"prod-relevant, crashes UI\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Possible NullPointerException in setDefaultParameterToDataFile when first.getCurrency() or first.getTerritory() is null\",\n      \"justification\": \"The method assumes non-null strings; if the first article lacks these fields, calling isEmpty() throws NPE, breaking the import flow.\",\n      \"action\": \"Guard each field: if (first.getCurrency() != null && !first.getCurrency().isEmpty()) { ... } and similarly for territory; add tests for articles with missing values.\",\n      \"source\": \"LoaderCrumb.setDefaultParameterToDataFile(List<ArticleBase> articles, AstFile save)\",\n      \"component\": \"loader-crumb\",\n      \"impact_scope\": \"prod-relevant, import failures\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Unrestricted UI access from background threads in PreviewCrumb.loadGrid\",\n      \"justification\": \"Creating new Thread and calling ui.access may lead to race conditions and UI updates after the session is detached, causing memory leaks or UI errors.\",\n      \"action\": \"Replace raw Thread with UI.accessSynchronously or use Vaadin's BackgroundTaskExecutor; ensure UI access is only performed when UI is attached; add integration tests for async loading.\",\n      \"source\": \"PreviewCrumb.loadGrid(TabBox<E> box, Callable<List<E>> list)\",\n      \"component\": \"preview-crumb\",\n      \"impact_scope\": \"performance and stability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Missing nullcheck on GridPro.getSelectedItems() in FilterIndividualCrumb.deleteBtn click listener\",\n      \"justification\": \"If the grid has no selection, getSelectedItems() returns an empty set but the dialog still opens; also possible NPE if rightGrid is null before initialization.\",\n      \"action\": \"Validate that rightGrid is nonnull and selectedItems is not empty before opening SetIndividualFilterCrumb; disable delete button when no selection.\",\n      \"source\": \"FilterIndividualCrumb.setRightGrid() -> deleteBtn click listener\",\n      \"component\": \"filter-individual-crumb\",\n      \"impact_scope\": \"usability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Potential NPE in PreviewCrumb.addTabPriceList / addTabRemoved when ArticleBase.getArticleNr() returns null\",\n      \"justification\": \"The code calls item.getArticleNr().replace(...), which throws NPE if getArticleNr() is null, breaking preview tabs.\",\n      \"action\": \"Guard with null check: String nr = item.getArticleNr(); if (nr != null) { nr.replace(...)} else { nr = \\\"\\\"; } and add test case for articles with missing numbers.\",\n      \"source\": \"PreviewCrumb.addTabPriceList(Assortment assortment) and addTabRemoved(Assortment assortment)\",\n      \"component\": \"preview-crumb\",\n      \"impact_scope\": \"prod-relevant, UI crash\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Broad catch of generic Exception in LoaderCrumb.openAssortment hides errors\",\n      \"justification\": \"Catching Exception and only logging debug makes troubleshooting difficult and may swallow critical failures.\",\n      \"action\": \"Catch specific exceptions; rethrow or show user-friendly error dialog; log at error level; add unit test verifying exception handling.\",\n      \"source\": \"LoaderCrumb.openAssortment(Callable<Assortment> selected, boolean openOnly)\",\n      \"component\": \"loader-crumb\",\n      \"impact_scope\": \"maintainability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Potential ArrayIndexOutOfBounds in ZinfoCrumb.getKeyValue when dialog columns array is shorter than expected\",\n      \"justification\": \"The method accesses dialog.getColumns()[0] and [1] without verifying the array length, which can throw at runtime for malformed imports.\",\n      \"action\": \"Check dialog.getColumns().length > required index before accessing; provide validation error to user; add tests for short column definitions.\",\n      \"source\": \"ZinfoCrumb.getKeyValue(Map<Integer, String> colString, FileImportDialog dialog)\",\n      \"component\": \"zinfo-crumb\",\n      \"impact_scope\": \"prod-relevant, import crashes\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Context object instantiated inside ECatPresenter without injection, potentially leading to misconfigured state\",\n      \"justification\": \"A new Context() may lack necessary session or service references, causing NullPointerExceptions when presenter methods are called.\",\n      \"action\": \"Require Context via constructor injection only; remove default instantiation; add null checks; write tests for presenter initialization.\",\n      \"source\": \"ECatPresenter class, field declaration \\\"private Context ctx = new Context();\\\"\",\n      \"component\": \"ecat-presenter\",\n      \"impact_scope\": \"maintainability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Inconsistent use of UI.getCurrent() inside background threads can lead to detached UI access\",\n      \"justification\": \"Methods like LoaderCrumb.setRightButtons create UI.access callbacks inside new Threads without verifying UI is still attached, risking IllegalStateException.\",\n      \"action\": \"Capture UI reference before starting thread and check ui.isClosing() or ui.getSession().hasLock(); consider using Vaadin's @Push or ExecutorService; add integration tests for session timeout.\",\n      \"source\": \"LoaderCrumb.setRightButtons() -> uploadVersion click listener thread usage\",\n      \"component\": \"loader-crumb\",\n      \"impact_scope\": \"stability\",\n      \"relations\": null,\n      \"evidence\": null\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"3\",\n    \"top_todos\": [\n      \"Add proper null/empty checks for list accesses in LoaderCrumb (directSave, setDefaultParameterToDataFile).\",\n      \"Guard null values in PreviewCrumb tab creation to prevent NPE on missing article numbers.\",\n      \"Replace raw Thread UI updates with Vaadin's background task mechanisms to avoid race conditions.\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to produce JSON review for each file? The schema expects single object with file path and issues. Could combine multiple? The instruction: \"Du analysierst jeweils einen Code-Chunk.\" So per file. Probably output one JSON per file? But only one JSON allowed as answer. Might need to include issues for each file within same JSON? The schema only has \"file\" field, not list. So perhaps we output for each file separately. But we must output a single JSON object. Might choose to output for first file only? The prompt gave multiple files; maybe we need to output combined issues per file? Could set file as \"multiple\" but not ideal.\n\nProbably we need to produce separate JSON objects? The rule says answer must be a single JSON object. So maybe we need to create array of objects? Not allowed.\n\nThus maybe we need to produce a combined report where \"file\" is a generic identifier and issues list contains entries per file with source indicating file. But schema expects \"source\" as location. Could include file name.\n\nI'll output for each file as separate issue entries, include file path in source. But \"file\" field will be something like \"multiple\". Accept.\n\nLet's craft issues focusing on major problems across these classes.\n\nIdentify issues:\n\n- FilterIndividualCrumb: potential NPE when rightGrid null before set? In constructor setRightGrid() before rightGrid init? setRightGrid creates rightGrid, okay.\n\n- In setRightGrid, deleteBtn opens dialog and uses rightGrid.getSelectedItems() before checking null; but rightGrid always set.\n\n- In reload(List) if items null, articleService.findAllByFilterStatus(... \"IN\") maybe filter status string constant? Might be ok.\n\n- Missing input validation for parameters from dialogs; risk of injection? Not relevant.\n\n- Potential memory leak: adding UI.access listeners without removal? Not major.\n\n- In LoaderCrumb: many UI.access and new Thread without proper handling; possible concurrency issues, UI access from background thread must use UI.accessLock? Using ui.access inside new Thread is okay but no UI.detach. Could cause race.\n\n- In setDatafileGrid, reloadDatafileGrid called before body added; ok.\n\n- In openAssortment, catches generic Exception and just logs debug; may hide errors.\n\n- In directSave (LoaderCrumb) uses articles.get(0) without checking list non-empty => possible IndexOutOfBounds.\n\n- In setDefaultParameterToDataFile: first.getCurrency() may be null leading NPE.\n\n- In setPrice in FilterIndividualCrumb: only sets articleNr, no validation.\n\n- In PreviewCrumb: loadGrid creates new Thread but UI access inside may cause concurrency; also using UI.getCurrent() inside thread might be null after session ends.\n\n- In addTabPriceList: replace(+assortment.getId() + \"#\", \"\") uses unary plus on long? Might be bug: +assortment.getId() is unary plus, fine.\n\n- In addTabPriceList and addTabRemoved: item.getArticleNr().replace(+assortment.getId() + \"#\", \"\") could cause NPE if getArticleNr null.\n\n- In ZinfoCrumb: getKeyValue uses dialog.getColumns()[1] may be out of bounds if columns length smaller.\n\n- In ZinfoCrumb doOnSave catches NullPointerException but not other.\n\n- In ECatPresenter: ctx new Context() default maybe not initialized; not thread safe.\n\nPrioritize.\n\nLet's create up to 10 issues overall.\n\nWill output JSON with file \"Multiple\". Provide issues list."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 2297,
      "prompt_tokens" : 26637,
      "total_tokens" : 28934
    },
    "timings" : {
      "cache_n" : 527,
      "prompt_n" : 26110,
      "prompt_ms" : 19590.583,
      "prompt_per_token_ms" : 0.7503095748755265,
      "prompt_per_second" : 1332.7832050735806,
      "predicted_n" : 2297,
      "predicted_ms" : 27850.351,
      "predicted_per_token_ms" : 12.12466303874619,
      "predicted_per_second" : 82.47651887762564
    }
  }
}