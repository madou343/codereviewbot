{
  "timestamp" : "2025-11-03T13:06:56.9876388",
  "index" : 18,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\DnDIndividualDialogAddNewArticles.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.exceptions.ArticleBaseQueueException;\r\nimport com.hom.ebmw.exceptions.DoubleFoundException;\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseUpdateRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.User;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.ArticleBaseQueueUtils;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.InternalUtils;\r\nimport com.hom.ebmw.utilities.constans.Table;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.List;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\npublic class DnDIndividualDialogAddNewArticles extends CrumbProgressDialog {\r\n\r\n    private final List<ArticleBase> selected;\r\n\r\n    /**\r\n     * The DnDIndividualDialogAddNewArticles function is a constructor for the DnDIndividualDialogAddNewArticles class.\r\n     * It takes in a Context, List&lt;ArticleBase&gt;, and ListDataProvider&lt;ArticleBase&gt; as parameters.\r\n     * The function sets the selected parameter to be equal to the selected parameter passed into it, and then calls its superclass's constructor with ctx as an argument.\r\n     *\r\n     * @param Context                             ctx Create the dialog\r\n     * @param List&lt;ArticleBase&gt;             selected Pass the list of selected articles to the dialog\r\n     * @param ListDataProvider&lt;ArticleBase&gt; destination Add the selected articles to a list\r\n     * @return A dialog which allows the user to add new articles\r\n     */\r\n    public DnDIndividualDialogAddNewArticles(Context ctx, List<ArticleBase> selected,\r\n                                             ListDataProvider<ArticleBase> destination) {\r\n        super(ctx);\r\n        this.selected = selected;\r\n    }\r\n\r\n    /**\r\n     * The load function is called when the user clicks on the &quot;Load&quot; button.\r\n     * It will first check if there are any articles in the selected lists, and if so, it will add them to a temporary table.\r\n     * Then it will wait for all of those articles to be added before updating their status in PIM and adding them to MAIN.\r\n     * Finally, it reloads all filters that were previously applied by calling FilterRunUtils methods (reloadAddFilter(), reloadRemoveFilter(), etc.)\r\n     */\r\n    @Override\r\n    protected void load() throws DoubleFoundException, ArticleBaseQueueException {\r\n        final FilterBaseUpdateRepository updateService = getServices().getFilterBaseUpdateService();\r\n        final ArticleBaseRepository articleService = getServices().getArticleBaseService();\r\n\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        new Thread(() -> {\r\n            // insert into new Tabelle\r\n            try {\r\n                ArticleBaseQueueUtils.addQueueTable(getCtx(), user, Table.getTemp(2));\r\n                clearTable(Table.getTemp(2));\r\n                resetProgressMap();\r\n                importLists(selected, Table.getTemp(2));\r\n                InternalUtils.wait(1000);\r\n                waitOfImport();\r\n\r\n                updateService.setArticleInPIM(getCtx(), Table.getTemp(2));\r\n                articleService.addToTable(getCtx(), Table.MAIN, Table.getTemp(2));\r\n\r\n                articleService.resetArticles(getCtx());\r\n                FilterRunUtils.runReload(getCtx(), assortment, this);\r\n\r\n                FilterRunUtils.reloadAddFilter(getCtx(), this);\r\n                FilterRunUtils.reloadRemoveFilter(getCtx(), this);\r\n                FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n\r\n            } catch (ArticleBaseQueueException e) {\r\n                log.error(e.getLocalizedMessage(), e);\r\n            }\r\n\r\n            reloadCrumb();\r\n            uiClose();\r\n        }).start();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\DnDIndividualDialogAddNewArticles.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\DnDIndividualDialogAddRemoved.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.FilterType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\n\r\nimport static com.hom.ebmw.utilities.constans.ASTConst.DB_DELIMITER;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class DnDIndividualDialogAddRemoved extends CrumbProgressDialog {\r\n\r\n    private final List<ArticleBase> selected;\r\n\r\n    /**\r\n     * The DnDIndividualDialogAddRemoved function is a constructor for the DnDIndividualDialogAddRemoved class.\r\n     * It takes in two parameters: a Context object and a List of ArticleBase objects.\r\n     * The function sets the selected parameter to be equal to the list of ArticleBase objects passed into it as an argument.\r\n     *\r\n     * @param Context                 ctx Create the dialog\r\n     * @param List&lt;ArticleBase&gt; selected Store the selected items from the listview\r\n     * @return A list of articles that have been added or removed from the selected list\r\n     */\r\n    public DnDIndividualDialogAddRemoved(Context ctx, List<ArticleBase> selected) {\r\n        super(ctx);\r\n        this.selected = selected;\r\n    }\r\n\r\n    /**\r\n     * The load function is used to add the selected articles from the exclude list to the individual filter.\r\n     * The function first creates a new Filterbase object called revokeByUser, which will be used as a parent for all of\r\n     * the child Filterbase objects that are created in this function.  This is done by checking if there already exists an\r\n     * existing Filterbase with label &quot;REVOKE&quot; and type INDIVIDUAL, and if not then creating one.  Then for each article that was selected in\r\n     * DndDialogAddFromExcludeListView, it creates a new child FilterBase object with label\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        setLabel(TMS.DND_DIALOG_ADD_FROM_EXCLUDE_LIST);\r\n        String revoke = \"REVOKE\";\r\n\r\n        Filterbase revokeByUser = null;\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        List<Filterbase> filters = new ArrayList<Filterbase>();\r\n        filters.addAll(getCtx().getServices().getFilterBaseService().findAllByAssortment(assortment));\r\n        Optional<Filterbase> optFilterbase = filters.stream()\r\n                .filter(item -> item.getLabel().equals(revoke)).findFirst();\r\n        if (optFilterbase.isPresent()) {\r\n            revokeByUser = optFilterbase.get();\r\n        } else {\r\n            revokeByUser = new Filterbase();\r\n            revokeByUser.setAssortment(assortment);\r\n            revokeByUser.setLabel(revoke);\r\n            revokeByUser.setType(FilterType.INDIVIDUAL);\r\n            revokeByUser.setIdentifier(FilterType.INDIVIDUAL.name());\r\n            revokeByUser.setDirection(2);\r\n            revokeByUser.setEntityIdentifier(revoke + DB_DELIMITER + FilterType.INDIVIDUAL.name()\r\n                    + DB_DELIMITER + assortment.getId());\r\n            revokeByUser = getCtx().getServices().getFilterBaseService().save(revokeByUser);\r\n        }\r\n        final Filterbase revokeBase = revokeByUser;\r\n        List<Filterbase> childs = new ArrayList<Filterbase>();\r\n\r\n        selected.forEach(select -> {\r\n            select.setComment(\"\");\r\n            select.setFoundArticleStatus(FilterStatus.DEFAULT);\r\n\r\n            Filterbase child = new Filterbase();\r\n            child.setLabel(revoke);\r\n            child.setType(FilterType.INDIVIDUAL);\r\n            child.setIdentifier(select.getArticleNr());\r\n            child.setDirection(2);\r\n            child.setParent(revokeBase);\r\n            child.setEntityIdentifier(select.getArticleNr() + DB_DELIMITER\r\n                    + FilterType.INDIVIDUAL.name() + DB_DELIMITER + assortment.getId());\r\n            childs.add(child);\r\n        });\r\n        getCtx().getServices().getFilterBaseCustomService().insertFilterBaseIn(childs);\r\n\r\n        FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n        reloadCrumb();\r\n        reloadDetails();\r\n\r\n\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\DnDIndividualDialogAddRemoved.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\FromADDToINDIVIDUALCrumbDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\npublic class FromADDToINDIVIDUALCrumbDialog extends CrumbProgressDialog {\r\n\r\n    /**\r\n     *\r\n     */\r\n    private static final long serialVersionUID = 1L;\r\n\r\n    /**\r\n     * The FromADDToINDIVIDUALCrumpDialog function is a constructor for the FromADDToINDIVIDUALCrumpDialog class.\r\n     * It creates an instance of the FromADDToINDIVIDUALCrumpDialog class, which is a subclass of DialogFragment.\r\n     * The purpose of this function is to create and display a dialog box that allows users to add crumps from their ADD list to their INDIVIDUAL list.\r\n     *\r\n     * @param Context ctx Create a new dialog\r\n     * @return A dialog object\r\n     */\r\n    public FromADDToINDIVIDUALCrumbDialog(Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n    /**\r\n     * The load function is called when the user clicks on a breadcrumb.\r\n     * It loads the data from the database into memory, and then displays it to\r\n     * the user in a table. The load function also sets up all of the buttons that\r\n     * are used by this dialog box, including: add filter button, remove filter button,\r\n     * and individual filter button. These buttons are used to manipulate filters for this dialog box.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n        box.getCurrent().doBeforeNext(this);\r\n\r\n        FilterRunUtils.reloadAddFilter(getCtx(), this);\r\n        FilterRunUtils.reloadRemoveFilter(getCtx(), this);\r\n        FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n\r\n        setLabel(TMS.SET_DIALOG_LOAD_INDIVIDUAL);\r\n        lastUIBreadCrumb();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\FromADDToINDIVIDUALCrumbDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\PromotionBuilderDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.exceptions.*;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.*;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.time.LocalDateTime;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\nimport java.util.UUID;\r\nimport java.util.concurrent.ExecutionException;\r\n\r\n@Slf4j\r\npublic class PromotionBuilderDialog extends CrumbProgressDialog {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n\r\n    private final boolean valid = false;\r\n    private final Assortment assortment;\r\n\r\n    /**\r\n     * The PromotionBuilderDialog function is a constructor for the PromotionBuilderDialog class.\r\n     * It takes in two parameters: a Context object and an Assortment object.\r\n     * The function sets the assortment field to be equal to the parameter assortment, and then calls its superclass's constructor with ctx as its parameter.\r\n     *\r\n     * @param Context    ctx Create the dialog and the assortment assortment parameter is used to get access to the data\r\n     * @param Assortment assortment Create a new assortment object\r\n     * @return A dialog\r\n     */\r\n    public PromotionBuilderDialog(Context ctx, Assortment assortment) {\r\n        super(ctx);\r\n        this.assortment = assortment;\r\n    }\r\n\r\n    /**\r\n     * The load function is called when the dialog is opened.\r\n     * It sets the label of the dialog to &quot;Add Data File&quot; and then calls autoWork() on assortment.\r\n     * If valid is true, it creates a new AstNotification object with getCtx(), and calls errorMessage() on it with a translation of TMS.ERROR_MSG_PRICE_FILE_IS_EMPTY in getLocale(). Then uiClose() is called to close this window.\r\n     */\r\n    @Override\r\n    protected void load() throws DoubleFoundException, ArticleBaseQueueException, ParameterException {\r\n        getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, assortment);\r\n        setParameter(FileParam.LOCK, true, assortment);\r\n\r\n        setLabel(TMS.SET_DIALOG_ADD_DATAFILE);\r\n\r\n        try {\r\n            autoWork(assortment);\r\n        } catch (FileEmptyException | AstFileNotExistsException | InterruptedException | ExecutionException e) {\r\n            log.error(e.getLocalizedMessage());\r\n        }\r\n\r\n        if (valid) {\r\n            AstNotification notify = new AstNotification(getCtx());\r\n            notify.errorMessage(getTranslation(TMS.ERROR_MSG_PRICE_FILE_IS_EMPTY, getLocale(), getCtx()));\r\n            uiClose();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The autoWork function is the main function of the AssortmentAutoWork class.\r\n     * It takes an assortment as a parameter and performs several actions on it,\r\n     * including: uploading files to cache, running filters on them, saving the assortment,\r\n     * copying files to hotfolder and reloading details.  If there are no articles in the list of articles for this assortment then it will delete that assortment from memory.  The autoWork function also has a try/catch block which catches any exceptions thrown by these functions and logs them using log4j2's logger object (log).\r\n     *\r\n     * @param Assortment assortment Get the assortment from the database\r\n     */\r\n    private void autoWork(Assortment assortment) throws DoubleFoundException, ParameterException, FileEmptyException,\r\n            ArticleBaseQueueException, AstFileNotExistsException, InterruptedException, ExecutionException {\r\n        setLabel(TMS.SET_DIALOG_IMPORT_ARTICLES);\r\n\r\n        // Assortment Upload\r\n        List<AssortmentDatafile> assortmentDataFile = getServices().getAssortmentDataFileService()\r\n                .findAllByAssortment(assortment);\r\n\r\n        setLabel(TMS.SET_DIALOG_CLEAR_CACHE);\r\n\r\n        ArticleBaseQueueUtils.resetUserQueues(getCtx());\r\n        // Manachmal ist er zu schnell bevor der Truncate abgeschlossen ist. Daher soll\r\n        // die funktion 1 sek ruhen.\r\n        InternalUtils.wait(1000);\r\n\r\n        setLabel(TMS.SET_DIALOG_LOAD_FILES_TO_CACHE);\r\n        for (AssortmentDatafile xrossFile : assortmentDataFile) {\r\n            AstFile dataFile = xrossFile.getAstFile();\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, dataFile);\r\n            if (type.getName().endsWith(\"INPUT\")) {\r\n                ArticleBaseQueueUtils.createArticleList(getCtx(), xrossFile, getArticles());\r\n            }\r\n\r\n            if (type.getName().endsWith(\"INPUT_POSITIV\")) {\r\n                ArticleBaseQueueUtils.createPositivList(getCtx(), xrossFile, getArticles());\r\n            }\r\n        }\r\n\r\n        assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        articles.addAll(getArticles());\r\n\r\n        if (!articles.isEmpty()) {\r\n            // LIke TO ADD_CRUMB\r\n\r\n            boolean error = FilterRunUtils.runWork(getCtx(), assortment, this);\r\n\r\n            if (!error) {\r\n\r\n                // save Assortment#\r\n                assortment = FilterRunUtils.saveAssortment(getCtx(), this);\r\n\r\n                if (Objects.nonNull(assortment)) {\r\n                    setParameter(FileParam.LOCK, Boolean.FALSE, assortment);\r\n                }\r\n\r\n                // TO uploadFile\r\n                try {\r\n\r\n                    setLabel(TMS.SET_DIALOG_COPY_TO_HOTFOLDER);\r\n                    File fiAssortment = new File(SettingUtils.getTempFolder(getCtx()) + UUID.randomUUID());\r\n                    Storage storage = getStorage(assortment);\r\n                    Blob.loadFromCompressedFile(storage.getFileblob(), fiAssortment);\r\n\r\n                    // Parameterfile\r\n                    String fileName = ExportFileUtils.buildPromotionTitleFileName(getCtx(), assortment);\r\n                    log.info(\"Write eCat-Parameter File\");\r\n                    File fiParameter = ExportFileUtils.buildPromotionTitleFile(getCtx(), fileName, assortment);\r\n                    File dstFiParameter = new File(SettingUtils.getAssortmentFolder(getCtx()) + fileName);\r\n                    FileUtils.copyFileTo(fiParameter, dstFiParameter);\r\n\r\n                    File dstFiAssortment = new File(SettingUtils.getAssortmentFolder(getCtx()) + assortment.getName());\r\n                    FileUtils.copyFileTo(fiAssortment, dstFiAssortment);\r\n\r\n                    setParameter(FileParam.UPLOAD_BY, getCtx().getSession().getCurrentUser(getCtx()), assortment);\r\n                    setParameter(FileParam.UPLOAD_ON, LocalDateTime.now(), assortment);\r\n\r\n                    getServices().getAssortmentService().save(assortment);\r\n                    reloadDetails();\r\n                    showUploadSuccess();\r\n\r\n                } catch (Exception e) {\r\n                    log.error(e.getLocalizedMessage());\r\n                }\r\n\r\n                nextUIBreadCrumb();\r\n                reloadDetails();\r\n                uiClose();\r\n            }\r\n        } else {\r\n            if (Objects.nonNull(assortment)) {\r\n                ArticleBaseQueueUtils.resetUserQueues(getCtx());\r\n            }\r\n\r\n            AssortmentUtil.delete(getCtx());\r\n            firstUIBreadCrumb();\r\n            uiClose();\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\PromotionBuilderDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ReloadAllCrumbDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\npublic class ReloadAllCrumbDialog extends CrumbProgressDialog {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n\r\n    /**\r\n     * The ReloadAllCrumbDialog function is a constructor for the ReloadAllCrumbDialog class.\r\n     * It creates an instance of the ReloadAllCrumbDialog class, which is used to display a dialog box that prompts\r\n     * the user to confirm whether they want to reload all crumbs or not. The dialog box has two buttons: &quot;Yes&quot; and &quot;No&quot;.\r\n     *\r\n     * @param Context ctx Create the dialog\r\n     * @return The dialog\r\n     */\r\n    public ReloadAllCrumbDialog(Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n    /**\r\n     * The load function is responsible for loading the data from the database into\r\n     * a list of objects. The load function also sets up the filter and reloads it\r\n     * if necessary. It then closes out of any open dialog boxes that may be open,\r\n     * and finally calls on uiClose to close out of this window.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        boolean error = FilterRunUtils.runReload(getCtx(), assortment, this);\r\n\r\n        if (!error) {\r\n            FilterRunUtils.reloadAddFilter(getCtx(), this);\r\n            FilterRunUtils.reloadRemoveFilter(getCtx(), this);\r\n            FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n            setLabel(TMS.LOADER_DIALOG_LOADING);\r\n\r\n            reloadCrumb();\r\n            uiClose();\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ReloadAllCrumbDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SaveArticlesToAssortmentDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ArticleBaseRepository;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.ArticleBaseQueueUtils;\r\nimport com.hom.ebmw.utilities.AssortmentUtil;\r\nimport com.hom.ebmw.utilities.ExportFileUtils;\r\nimport com.hom.ebmw.utilities.Parse;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\n\r\n@Slf4j\r\npublic class SaveArticlesToAssortmentDialog\r\n        extends\r\n        CrumbProgressDialog {\r\n\r\n\r\n    private static final long serialVersionUID = 1L;\r\n\r\n\r\n    /**\r\n     * The SaveArticlesToAssortmentDialog function is a constructor for the SaveArticlesToAssortmentDialog class.\r\n     * It creates an instance of the SaveArticlesToAssortmentDialog class, which is used to create a dialog box that allows users to save articles from their search results into an assortment.\r\n     *\r\n     * @param Context ctx Create the dialog\r\n     * @return A dialog\r\n     */\r\n    public SaveArticlesToAssortmentDialog(\r\n            Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n\r\n    /**\r\n     * The load function is the first function to be called when a user clicks on the &quot;Save&quot; button.\r\n     * It sets up all of the necessary variables and objects that will be used in this class, such as\r\n     * User, Assortment, BreadBox, ArticleBaseRepository (which contains all of our articles), and File.\r\n     * The load function also calls other functions within this class: setLabel(), saveStorage(), uiClose()\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        assortment.setDate(user);\r\n        BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n        box.getCurrent().doBeforeNext(this);\r\n\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n\r\n        setLabel(TMS.SET_DIALOG_SAVE_CONTENT);\r\n        final ArticleBaseRepository articleService = getCtx().getServices().getArticleBaseService();\r\n        articles.addAll(articleService.findAllByFilterStatus(getCtx(), \"IN\", FilterStatus.DEFAULT));\r\n\r\n        setParameter(FileParam.ARTICLE_SIZE, articles.size(), assortment);\r\n\r\n        File export = AssortmentUtil.getFile(getCtx(), articles, ASTConst.DEFAULT, assortment);\r\n\r\n        saveStorage(assortment, export);\r\n        Boolean valid = getParameter(FileParam.HAS_PRICE, assortment);\r\n        if (Objects.nonNull(valid) && valid.booleanValue()) {\r\n            ImpexExport imExp = new ImpexExport();\r\n            //Create File\r\n            List<ArticleBase> filtered = articles;\r\n            filtered.removeIf(item -> Parse.toDouble(item.getPriceFirst()) == 0);\r\n            export = ExportFileUtils.buildPriceFile(getCtx(), filtered, ASTConst.DEFAULT, assortment);\r\n            imExp.setName(ExportFileUtils.buildImpexPriceFileName(getCtx(), assortment));\r\n            //Save File\r\n            getCtx().getServices().getAstFileService().save(imExp);\r\n            saveStorage(imExp, export);\r\n            //Create Relation\r\n            AssortmentDatafile xCross = new AssortmentDatafile();\r\n            xCross.setAssortment(assortment);\r\n            xCross.setAstFile(imExp);\r\n            getCtx().getServices().getAssortmentDataFileService().save(xCross);\r\n        }\r\n\r\n        if (Objects.isNull(assortment.getProjectRole())) {\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            assortment.setProjectRole(projectRole);\r\n        }\r\n        setParameter(FileParam.LOCK, Boolean.FALSE, assortment);\r\n\r\n        getServices().getAssortmentService().save(assortment);\r\n        try {\r\n            Thread.sleep(1000);\r\n        } catch (InterruptedException e) {\r\n            log.error(e.getLocalizedMessage());\r\n        }\r\n\r\n        setLabel(TMS.SET_DIALOG_ARCHIV_CONTENT);\r\n        articleService.saveCurrentArticles(getCtx());\r\n\r\n        setLabel(TMS.SET_DIALOG_CLEAR_CACHE);\r\n        ArticleBaseQueueUtils.resetUserQueues(getCtx());\r\n\r\n        firstUIBreadCrumb();\r\n        uiClose();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SaveArticlesToAssortmentDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SaveArticlesToDataFileDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.DataFile;\r\nimport com.hom.ebmw.jpa.model.ProjectRole;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.AssortmentUtil;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\nimport java.io.File;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\n\r\npublic class SaveArticlesToDataFileDialog extends CrumbProgressDialog {\r\n\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private List<DataFile> dataFiles;\r\n    private final ObjectType type;\r\n\r\n    /**\r\n     * The SaveArticlesToDataFileDialog function is a constructor for the SaveArticlesToDataFileDialog class.\r\n     * It takes in a Context, List&lt;ArticleBase&gt;, and ObjectType as parameters. The function then sets the articles\r\n     * to be saved to the list of articles passed into it, and sets its dataFiles variable equal to whatever data file\r\n     * is currently active in the user session. Finally, it sets its type variable equal to whatever object type was passed into it.\r\n     *\r\n     * @param Context                 ctx Get the usersession object\r\n     * @param List&lt;ArticleBase&gt; articles Add the articles to the dialog\r\n     * @param ObjectType              type Determine the type of object that is being saved to a data file\r\n     * @return A dialog\r\n     */\r\n    public SaveArticlesToDataFileDialog(Context ctx, List<ArticleBase> articles, ObjectType type) {\r\n        super(ctx);\r\n        getArticles().clear();\r\n        getArticles().addAll(articles);\r\n        this.dataFiles = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n        this.type = type;\r\n    }\r\n\r\n    /**\r\n     * The load function is used to save the file that was created in the AssortmentUtil class.\r\n     * It also sets a parameter for whether or not this is an initial file, and then closes the dialog.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        DataFile dataFile;\r\n        if (Objects.isNull(dataFiles) || dataFiles.isEmpty()) {\r\n            dataFiles = new ArrayList<>();\r\n            dataFile = new DataFile();\r\n            dataFiles.add(dataFile);\r\n        } else {\r\n            dataFile = dataFiles.get(0);\r\n        }\r\n\r\n        setLabel(TMS.SET_DIALOG_SAVE_CONTENT);\r\n\r\n        dataFile.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n        dataFile = getServices().getDataFileService().save(dataFile);\r\n        setParameter(FileParam.FILE_TYPE, type, dataFile);\r\n\r\n        File export = AssortmentUtil.getFile(getCtx(), getArticles(), ASTConst.DEFAULT, dataFile);\r\n\r\n        if (Objects.nonNull(export)) {\r\n            ProjectRole projectRole = getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE);\r\n            dataFile.setProjectRole(projectRole);\r\n            dataFile = getServices().getDataFileService().save(dataFile);\r\n            setParameter(FileParam.FILE_TYPE, type, dataFile);\r\n            saveStorage(dataFile, export);\r\n            if (getArticles().isEmpty()) {\r\n                setParameter(FileParam.INITIAL, Boolean.TRUE, dataFile);\r\n            } else {\r\n                setParameter(FileParam.INITIAL, Boolean.FALSE, dataFile);\r\n            }\r\n            firstUIBreadCrumb();\r\n        } else {\r\n            getNotify().errorMessage(TMS.ERROR_MSG_UNKNOWN_ERROR);\r\n        }\r\n        uiClose();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SaveArticlesToDataFileDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SaveZinfo.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.ZinfoCustomRepository;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.ExportFileUtils;\r\nimport com.hom.ebmw.utilities.InternalUtils;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\n\r\n@Slf4j\r\npublic class SaveZinfo extends CrumbProgressDialog {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n\r\n    private final GridPro<Zinfo> zinfoGrid;\r\n    private ZinfoFile zinfo;\r\n\r\n    /**\r\n     * The SaveZinfo function saves the Zinfo data to a file.\r\n     *\r\n     * @param Context              ctx Get the context of the activity\r\n     * @param GridPro&lt;Zinfo&gt; zinfoGrid Pass the zinfogrid to the savezinfo class\r\n     * @return A boolean value\r\n     */\r\n    public SaveZinfo(Context ctx, GridPro<Zinfo> zinfoGrid) {\r\n        super(ctx);\r\n        this.zinfoGrid = zinfoGrid;\r\n    }\r\n\r\n    /**\r\n     * The load function is used to load the data from the database into a list.\r\n     * The list is then displayed in a grid on the screen.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        final Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        setLabel(TMS.ZINFO_DIALOG_LOAD_CURRENT_LIST);\r\n        List<Zinfo> zinfos = new ArrayList<Zinfo>();\r\n        @SuppressWarnings(\"unchecked\")\r\n        ListDataProvider<Zinfo> dataProvider = (ListDataProvider<Zinfo>) zinfoGrid.getDataProvider();\r\n        zinfos.addAll(dataProvider.getItems());\r\n\r\n        String zInfoType = zinfos.get(0).getType();\r\n\r\n        setLabel(TMS.SET_DIALOG_SAVE_CONTENT);\r\n\r\n        List<AssortmentDatafile> xFiles = getServices().getAssortmentDataFileService().findAllByAssortment(assortment);\r\n\r\n        log.info(\"ADD Zinfo to Assortment\");\r\n        Optional<AssortmentDatafile> optXcross = xFiles.stream().filter(item -> {\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, item.getAstFile());\r\n            String zType = getParameter(FileParam.ZINFO_TYPE, item.getAstFile());\r\n            return type.equals(ObjectType.ZINFO) && zType.equals(zInfoType);\r\n        }).findFirst();\r\n\r\n        AssortmentDatafile cross = null;\r\n\r\n        if (optXcross.isPresent()) {\r\n            cross = optXcross.get();\r\n            zinfo = (ZinfoFile) cross.getAstFile();\r\n            zinfo.setDeleteBy(null);\r\n            zinfo.setDeleteOn(null);\r\n        } else {\r\n            cross = new AssortmentDatafile();\r\n            cross.setAssortment(assortment);\r\n            zinfo = new ZinfoFile();\r\n        }\r\n        log.info(\"create Zinfo-File\");\r\n        String zInfoName = ExportFileUtils.buildZinfoFileName(getCtx(), zInfoType, assortment);\r\n        File zInfoFile = ExportFileUtils.buildZinfoFile(getCtx(), ASTConst.DEFAULT, zinfos, zInfoType);\r\n\r\n        log.info(\"save Zinfo-File\");\r\n        zinfo.setName(zInfoName);\r\n        setParameter(FileParam.LOCK, Boolean.TRUE, assortment);\r\n        zinfo.setProjectRole(getCtx().getHttpAttribute(SessionParams.ACTIVE_PROJECT_ROLE));\r\n        zinfo.setDate(user);\r\n        zinfo = getServices().getZinfoFileService().save(zinfo);\r\n        saveStorage(zinfo, zInfoFile);\r\n        cross.setAstFile(zinfo);\r\n        setParameter(FileParam.FILE_TYPE, ObjectType.ZINFO, zinfo);\r\n        setParameter(FileParam.ZINFO_TYPE, zInfoType, zinfo);\r\n        getServices().getAssortmentDataFileService().save(cross);\r\n\r\n        final ZinfoFile saver = zinfo;\r\n        zinfos.forEach(item -> item.setZinfoFile(saver));\r\n\r\n        setLabel(TMS.SET_DIALOG_ARCHIV_CONTENT);\r\n\r\n        log.info(\"upload to Zinfo-Archiv\");\r\n        final ZinfoCustomRepository zinfoService = getServices().getZinfoCustomerSerivce();\r\n        zinfoService.clearBy(zinfo);\r\n        int partSize = 1000;\r\n        List<List<Zinfo>> splitList = InternalUtils.listSplitter(zinfos, partSize);\r\n        setProgressMinMax(0.0, splitList.size() * 1.0);\r\n        splitList.forEach(items -> {\r\n            setValue(splitList.indexOf(items));\r\n            zinfoService.insertIntoTable(getCtx().getUserSession(), items);\r\n        });\r\n        log.info(\"upload Finished\");\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SaveZinfo.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SetIndividualFilterCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseCustomRepository;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.interfaces.GridReloadService;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.data.provider.Query;\r\n\r\nimport java.util.*;\r\n\r\npublic class SetIndividualFilterCrumb extends CrumbProgressDialog {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private final List<ArticleBase> selected;\r\n    private final GridReloadService<ArticleBase> gridService;\r\n\r\n    /**\r\n     * The SetIndividualFilterCrumb function is a constructor that takes in the context, selected articles, and grid service.\r\n     * It then sets the selected articles to an array list of article bases.\r\n     *\r\n     * @param Context                              ctx Create a new instance of the filtercrumb class\r\n     * @param Collection&lt;ArticleBase&gt;        selected Set the selected field\r\n     * @param GridReloadService&lt;ArticleBase&gt; gridService Reload the grid after a filter is applied\r\n     */\r\n    public SetIndividualFilterCrumb(Context ctx, Collection<ArticleBase> selected, GridReloadService<ArticleBase> gridService) {\r\n        super(ctx);\r\n        this.selected = new ArrayList<ArticleBase>();\r\n        this.selected.addAll(selected);\r\n        this.gridService = gridService;\r\n    }\r\n\r\n    /**\r\n     * The load function is responsible for loading the data into the grid.\r\n     * It does this by first setting a label to indicate that it is loading,\r\n     * then getting the data provider from the grid service and using it to get\r\n     * a filtered size of all articles in our database. Then we get how many articles are selected,\r\n     * and create an instance of FilterBaseCustomRepository so that we can use its methods later on.\r\n     * We then set another label indicating that we are saving content, and check if there are any filters saved in our session (which would be true if they were just created).\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        setLabel(TMS.SET_DIALOG_LOAD_FILTER);\r\n        ListDataProvider<ArticleBase> dataProvider = gridService.getDataProvider();\r\n        int filteredSize = dataProvider.size(new Query<>(dataProvider.getFilter()));\r\n        int selectedSize = selected.size();\r\n\r\n        final FilterBaseCustomRepository customService = getCtx().getServices().getFilterBaseCustomService();\r\n\r\n        setLabel(TMS.SET_DIALOG_SAVE_CONTENT);\r\n        Map<String, Map<String, String>> filters = getCtx().getUserSession().get(Params.ACTIVE_INDIVIDUAL_FILTER);\r\n        if (selectedSize > 0) {\r\n            if (Objects.nonNull(filters) && filteredSize == selectedSize) {\r\n                customService.insertFilterInFilterBase(getCtx(), filters);\r\n            } else {\r\n                customService.insertArticleInFilterBase(getCtx().getUserSession(), selected);\r\n            }\r\n            setLabel(TMS.SET_DIALOG_SAVE_CONTENT);\r\n            FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n            setLabel(TMS.SET_DIALOG_SAVE_CONTENT);\r\n        }\r\n        getCtx().getUserSession().remove(Params.ACTIVE_INDIVIDUAL_FILTER);\r\n        reloadCrumb();\r\n        reloadDetails();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\SetIndividualFilterCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToADDCrumbDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.exceptions.*;\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseCustomRepository;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.*;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.view.components.BreadBox;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.vaadin.flow.component.Key;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.formlayout.FormLayout;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.radiobutton.RadioButtonGroup;\r\nimport com.vaadin.flow.component.radiobutton.RadioGroupVariant;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.renderer.TextRenderer;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\nimport java.util.Optional;\r\nimport java.util.concurrent.ExecutionException;\r\n\r\nimport static com.hom.ebmw.utilities.CompUtils.addLine;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\npublic class ToADDCrumbDialog extends CrumbProgressDialog {\r\n    private boolean error = false;\r\n    private RadioButtonGroup<Crumb> radioExitPoint;\r\n\r\n    private List<Crumb> nextCrumbs;\r\n    private final Grid<Filterbase> filterBaseGrid = new Grid<>();\r\n    private final Div body = new Div();\r\n    private final Div formDetails = new Div();\r\n    private final boolean openOnly;\r\n\r\n    /**\r\n     * The ToADDCrumbDialog function is a constructor for the ToADDCrumbDialog class.\r\n     * It takes in two parameters: a Context object and a boolean value. The Context object\r\n     * is used to create an instance of the Dialog class, which this function extends. The\r\n     * boolean value determines whether or not only open crumbs are displayed in the dialog box,\r\n     * or if all crumbs are displayed (open and closed). This function also sets an id for this\r\n     * particular dialog box so that it can be referenced later on by other functions/classes.\r\n     *\r\n     * @param Context ctx Create the dialog\r\n     * @param boolean openOnly Determine whether the dialog is opened or closed\r\n     * @return A toaddcrumbdialog object\r\n     */\r\n    public ToADDCrumbDialog(Context ctx, boolean openOnly) {\r\n        super(ctx);\r\n        this.openOnly = openOnly;\r\n        setId(\"to-add-dialog\");\r\n    }\r\n\r\n    /**\r\n     * The load function is used to load the data from the database into a grid.\r\n     */\r\n    @Override\r\n    protected void load() throws DoubleFoundException, ArticleBaseQueueException, ParameterException {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        Role active = getCtx().getHttpAttribute(SessionParams.ACTIVE_ROLE);\r\n\r\n        getCtx().getUserSession().put(Params.ACTIVE_CUSTOMER, getCtx().getHttpAttribute(SessionParams.ACTIVE_CUSTOMER));\r\n\r\n        FilterRunUtils.checkOfDoubles(getCtx(), this);\r\n\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n\r\n        if (Objects.nonNull(assortment)) {\r\n            Boolean lock = getParameter(FileParam.LOCK, assortment);\r\n            if (Objects.isNull(lock) || !lock.booleanValue()) {\r\n                setParameter(FileParam.LOCK, Boolean.TRUE, assortment);\r\n            }\r\n\r\n            // Proof DataFiles\r\n            List<AssortmentDatafile> xCrossFiles = getCtx().getServices().getAssortmentDataFileService()\r\n                    .findAllByAssortment(assortment);\r\n\r\n            DataFile input = null;\r\n            for (AssortmentDatafile xCrossfile : xCrossFiles) {\r\n                AstFile file = xCrossfile.getAstFile();\r\n                ObjectType type = getParameter(FileParam.FILE_TYPE, file);\r\n                if (Objects.nonNull(type))\r\n                    if (type.getName().endsWith(\"INPUT\")) {\r\n                        input = (DataFile) file;\r\n                    }\r\n            }\r\n            if (Objects.nonNull(input)) {\r\n                try {\r\n                    ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.KATALOG_VERSION, input, assortment);\r\n                    ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.LANGUAGE, input, assortment);\r\n                    ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.VALID_FROM, input, assortment);\r\n                    ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.VALID_TO, input, assortment);\r\n                    ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.TERRITORY, input, assortment);\r\n                    ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.CURRENCY, input, assortment);\r\n                    ObjectType type = getParameter(FileParam.FILE_TYPE, input);\r\n                    if (type.equals(ObjectType.IMPEX_INPUT)) {\r\n                        ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.PARTNER_SHORT, input, assortment);\r\n                        ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.CUSTOMER_TYPE, input, assortment);\r\n                        ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.BASE_ASSORTMENT, input, assortment);\r\n                        ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.S3_CATALOG, input, assortment);\r\n                        ArticleBaseQueueUtils.cloneParameter(getCtx(), FileParam.HAS_PRICE, input, assortment);\r\n                    }\r\n                } catch (ParameterException e) {\r\n                    resetCurrentAssortment();\r\n                    getNotify().errorMessage(e.getMessage());\r\n                    uiClose();\r\n                }\r\n            } else {\r\n                resetCurrentAssortment();\r\n                getNotify().errorMessage(new AstFileNotExistsException());\r\n                uiClose();\r\n            }\r\n\r\n            // LoadFilter\r\n            List<Filter> filters = new ArrayList<>();\r\n            filters.addAll(getServices().getFilterService().findAll());\r\n            filters.removeIf(item -> Objects.nonNull(item.getDeleteBy()));\r\n\r\n            ObjectType type = getParameter(FileParam.FILE_TYPE, assortment);\r\n\r\n            switch (type) {\r\n\r\n                default:\r\n\r\n                case ECAT:\r\n                    filters.removeIf(item -> item.getSortType().equals(ObjectType.IMPEX));\r\n                    break;\r\n                case IMPEX:\r\n                    filters.removeIf(item -> item.getSortType().equals(ObjectType.ECAT));\r\n                    break;\r\n            }\r\n\r\n            filters.removeIf(item -> Objects.nonNull(item.getDeleteBy()));\r\n\r\n            filters.removeIf(item -> Objects.nonNull(item.getTeam()) && item.getTeam().getId() != active.getId());\r\n            filters.removeIf(item -> Objects.nonNull(item.getPrivate()) && item.getPrivate().getId() != user.getId());\r\n\r\n            if (!filters.isEmpty() && !openOnly) {\r\n                setProgressVisible(false);\r\n                FormLayout form = new FormLayout();\r\n                ComboBox<Filter> filterBox = new ComboBox<>();\r\n                filterBox.setAllowCustomValue(false);\r\n                getDialogUI().access(() -> form.addFormItem(filterBox,\r\n                        getTranslation(TMS.PROFIL_SELECT_FILTER, getLocale(), getCtx())));\r\n\r\n                Filter emptyFill = new Filter();\r\n                emptyFill.setName(\"- empty -\");\r\n                emptyFill.setGlobal(-1);\r\n                emptyFill.setPrivate(null);\r\n                emptyFill.setTeam(null);\r\n                emptyFill.setActive(false);\r\n\r\n                filters.add(emptyFill);\r\n                filters.sort((o1, o2) -> {\r\n                    Integer g1 = o1.getGlobal();\r\n                    Integer g2 = o2.getGlobal();\r\n                    return g1.compareTo(g2);\r\n                });\r\n\r\n\r\n                filterBox.setItems(filters);\r\n                getDialogUI().access(() -> filterBox.setItemLabelGenerator(Filter::getNameWithPrefix));\r\n                getDialogUI().access(() -> {\r\n                    filterBox.addValueChangeListener(event -> {\r\n                        Filter select = event.getValue();\r\n                        if (select.getPrefix().equals(ASTConst.FILTER_ADM)) {\r\n                            radioExitPoint.setValue(null);\r\n                        } else {\r\n                            radioExitPoint.setValue(nextCrumbs.get(0));\r\n                        }\r\n\r\n                        radioExitPoint.setReadOnly(true);\r\n                        formDetails.removeAll();\r\n                        List<Filterbase> resultSet = new ArrayList<>();\r\n\r\n                        Role role = getCtx().getSession().getCurrentUser(getCtx()).getRole();\r\n\r\n                        boolean roleValid = false;\r\n\r\n                        roleValid = !select.getPrefix().equals(ASTConst.FILTER_ADM);\r\n\r\n                        if (!roleValid && Objects.nonNull(select) && Objects.nonNull(select.getTeam())) {\r\n                            roleValid = select.getTeam().getId() == role.getId();\r\n                        }\r\n\r\n                        int countSetFilter = getCtx().getServices().getFilterBaseCustomService()\r\n                                .countByAssortment(assortment);\r\n                        int countPreFilter = getCtx().getServices().getFilterBaseCustomService().countByFilter(select);\r\n\r\n                        if (countSetFilter != 0 || countPreFilter != 0) {\r\n                            formDetails.add(create(select));\r\n                            radioExitPoint.setReadOnly(false);\r\n                            if (select.getId() != 0) {\r\n                                resultSet.addAll(\r\n                                        getServices().getFilterBaseService().findAllByFilterAndDelete(select, false));\r\n                                CompUtils.sortFilterBase(resultSet);\r\n                            } else {\r\n                                resultSet.addAll(getServices().getFilterBaseService()\r\n                                        .findAllByAssortmentAndDelete(assortment, false));\r\n                                CompUtils.sortFilterBase(resultSet);\r\n                            }\r\n                        }\r\n\r\n                        if (resultSet.stream().noneMatch(item -> item.getDirection() > 0)) {\r\n                            radioExitPoint.setValue(nextCrumbs.get(0));\r\n                            radioExitPoint.setReadOnly(true);\r\n                        }\r\n\r\n                        resultSet.removeIf(item -> Objects.nonNull(item.getParent()));\r\n\r\n                        filterBaseGrid.setDataProvider(DataProvider.ofCollection(resultSet));\r\n                    });\r\n                    Optional<Filter> optFilter = getCurrentCustomerFilter(assortment);\r\n                    filterBox.setValue(emptyFill);\r\n                    optFilter.ifPresent(filterBox::setValue);\r\n                });\r\n\r\n                filterBaseGrid.addComponentColumn(CompUtils::getDirection);\r\n                filterBaseGrid.addColumn(Filterbase::getLabel);\r\n                filterBaseGrid.addColumn(Filterbase::getType);\r\n                filterBaseGrid.setHeight(\"300px\");\r\n                filterBaseGrid.setWidthFull();\r\n\r\n                radioExitPoint = new RadioButtonGroup<>();\r\n                radioExitPoint.addThemeVariants(RadioGroupVariant.LUMO_VERTICAL);\r\n                BreadBox box = getCtx().getUserSession().get(Params.ACTIVE_BREADBOX);\r\n                getDialogUI().access(\r\n                        () -> form.addFormItem(radioExitPoint, getTranslation(TMS.PROFIL_SELECT_FILTER_NEXT_STEP,\r\n                                getSession().getLocale(getCtx()), getCtx())));\r\n\r\n                nextCrumbs = new ArrayList<>();\r\n                nextCrumbs.addAll(box.getCrumbs());\r\n                nextCrumbs.forEach(item -> log.trace(item.getClass().toString()));\r\n                nextCrumbs.removeIf(item -> item.getClass().toString().contains(\"LoaderCrumb\"));\r\n\r\n                radioExitPoint.setItems(nextCrumbs);\r\n                radioExitPoint.setRenderer(new TextRenderer<>(item -> {\r\n                    BreadCrumb breadCrump = item.getClass().getAnnotation(BreadCrumb.class);\r\n                    return getTranslation(TMS.setCrumb(breadCrump), getSession().getLocale(getCtx()), getCtx());\r\n                }));\r\n                radioExitPoint.setValue(nextCrumbs.get(0));\r\n                radioExitPoint.setReadOnly(false);\r\n\r\n                Button okBtn = new Button(\r\n                        getTranslation(TMS.GLB_BUTTON_ACCEPT, getSession().getLocale(getCtx()), getCtx()));\r\n                okBtn.setId(TMS.GLB_BUTTON_ACCEPT);\r\n                okBtn.addClickListener(event -> {\r\n                    remove(body);\r\n\r\n                    Filter filter = filterBox.getValue();\r\n                    if (filter.getId() != 0) {\r\n                        // Set Filter\r\n                        AssortmentFilter assortmentFilter = new AssortmentFilter();\r\n                        assortmentFilter.setCreateBy(user);\r\n                        assortmentFilter.setFilter(filterBox.getValue());\r\n                        assortmentFilter.setAssortment(assortment);\r\n                        getCtx().getServices().getAssortmentFilterService().save(assortmentFilter);\r\n                        Optional<Assortment> optAssortment = getCtx().getServices().getAssortmentService()\r\n                                .findById(assortment.getId());\r\n                        if (optAssortment.isPresent()) {\r\n                            getCtx().getUserSession().put(Params.ACTIVE_ASSORTMENT, optAssortment.get());\r\n                        }\r\n                    }\r\n\r\n                    new Thread(() -> {\r\n                        setProgressVisible(true);\r\n                        Crumb value = radioExitPoint.getValue();\r\n                        final FilterBaseCustomRepository customService = getCtx().getServices()\r\n                                .getFilterBaseCustomService();\r\n\r\n                        if (Objects.nonNull(value) && Objects.nonNull(filterBox.getValue())) {\r\n                            int index = nextCrumbs.indexOf(value) + 1;\r\n                            Filter select = filterBox.getValue();\r\n                            if (select.getId() != 0)\r\n                                customService.cloneFromFilter(filterBox.getValue(), assortment);\r\n\r\n                            switch (index) {\r\n\r\n                                // TO - ADD VIEW\r\n                                case 1:\r\n                                    try {\r\n                                        error = FilterRunUtils.runWork(getCtx(), assortment, this);\r\n                                    } catch (Exception e) {\r\n                                        log.debug(\"Exception[\" + e.getClass().getSimpleName() + \"]\", e);\r\n                                    }\r\n                                    if (!error) {\r\n                                        gotoUIBreadCrumb(value);\r\n                                    }\r\n                                    setLabel(TMS.SET_DIALOG_LOAD_ADD);\r\n                                    reloadDetails();\r\n                                    uiClose();\r\n                                    break;\r\n                                // TO - REMOVE VIEW\r\n                                case 2:\r\n                                    try {\r\n                                        error = FilterRunUtils.runWork(getCtx(), assortment, this);\r\n                                    } catch (Exception e) {\r\n                                        log.debug(\"Exception[\" + e.getClass().getSimpleName() + \"]\", e);\r\n                                    }\r\n                                    if (!error) {\r\n                                        FilterRunUtils.reloadAddFilter(getCtx(), this);\r\n                                        setLabel(TMS.SET_DIALOG_LOAD_REMOVE);\r\n                                        gotoUIBreadCrumb(value);\r\n                                    }\r\n                                    reloadDetails();\r\n                                    uiClose();\r\n                                    break;\r\n\r\n                                // TO - INDIVIDUELL VIEW\r\n                                case 3:\r\n                                    try {\r\n                                        error = FilterRunUtils.runWork(getCtx(), assortment, this);\r\n                                    } catch (Exception e) {\r\n                                        log.debug(\"Exception[\" + e.getClass().getSimpleName() + \"]\", e);\r\n                                    }\r\n                                    if (!error) {\r\n\r\n                                        FilterRunUtils.reloadAddFilter(getCtx(), this);\r\n                                        FilterRunUtils.reloadRemoveFilter(getCtx(), this);\r\n                                        FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n\r\n                                        setLabel(TMS.SET_DIALOG_LOAD_INDIVIDUAL);\r\n                                        gotoUIBreadCrumb(value);\r\n                                    }\r\n                                    reloadDetails();\r\n                                    uiClose();\r\n                                    break;\r\n\r\n                                default:\r\n                                    break;\r\n                            }\r\n                        } else {\r\n                            try {\r\n                                error = FilterRunUtils.runWork(getCtx(), assortment, this);\r\n                            } catch (Exception e) {\r\n                                log.debug(\"Exception[\" + e.getClass().getSimpleName() + \"]\", e);\r\n                            }\r\n                            if (!error)\r\n                                nextUIBreadCrumb();\r\n                            reloadDetails();\r\n                            uiClose();\r\n                        }\r\n                    }).start();\r\n                });\r\n\r\n                Button cancelBtn = new Button(getTranslation(TMS.GLB_BUTTON_CANCEL, getLocale(), getCtx()));\r\n                cancelBtn.addClickListener(event -> {\r\n                    getDialogUI().access(() -> AssortmentUtil.delete(getCtx()));\r\n                    firstUIBreadCrumb();\r\n                    uiClose();\r\n                });\r\n                cancelBtn.addClickShortcut(Key.ESCAPE);\r\n                HorizontalLayout buttons = new HorizontalLayout();\r\n                buttons.add(okBtn, cancelBtn);\r\n                HorizontalLayout headLine = new HorizontalLayout();\r\n                CompUtils.removeMSP(headLine, \"MSP\");\r\n                headLine.add(new Div(form, formDetails), filterBaseGrid);\r\n                body.add(headLine, new VerticalLayout(), buttons);\r\n                getDialogUI().access(() -> add(body));\r\n            } else {\r\n                new Thread(() -> {\r\n                    try {\r\n                        error = FilterRunUtils.runWork(getCtx(), assortment, this);\r\n                    } catch (ArticleBaseQueueException | DoubleFoundException | ParameterException | FileEmptyException\r\n                             | AstFileNotExistsException | ExecutionException e) {\r\n                        log.debug(\"Exception[\" + e.getClass().getSimpleName() + \"]\", e);\r\n                    }\r\n\r\n                    if (!error)\r\n                        nextUIBreadCrumb();\r\n                    reloadDetails();\r\n                    uiClose();\r\n                }).start();\r\n            }\r\n\r\n            if (Objects.nonNull(getThrower())) {\r\n                if (getThrower() instanceof DoubleFoundException) {\r\n                    throw (DoubleFoundException) getThrower();\r\n                }\r\n                if (getThrower() instanceof ArticleBaseQueueException) {\r\n                    throw (ArticleBaseQueueException) getThrower();\r\n                }\r\n                if (getThrower() instanceof ParameterException) {\r\n                    throw (ParameterException) getThrower();\r\n                }\r\n            }\r\n        } else {\r\n            error = true;\r\n        }\r\n\r\n        if (error) {\r\n            resetCurrentAssortment();\r\n            AstNotification notify = new AstNotification(getCtx());\r\n            notify.errorMessage(getTranslation(TMS.ERROR_MSG_PRICE_FILE_IS_EMPTY, getLocale(), getCtx()));\r\n            uiClose();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The create function creates a VerticalLayout and adds the following components to it:\r\n     * - A HorizontalLayout containing two Labels, one for the name of the user who created this filter, and one for their surname.\r\n     * - A Label displaying when this filter was created.\r\n     * - A HorizontalLayout containing two Labels, one for the name of the user who last updated this filter, and one for their surname.\r\n     * - A Label displaying when this filter was last updated.\r\n     *\r\n     * @param Filter filter Get the information from the database\r\n     * @return A verticallayout\r\n     */\r\n    private VerticalLayout create(Filter filter) {\r\n        VerticalLayout form = new VerticalLayout();\r\n        form.setSpacing(false);\r\n        form.setPadding(false);\r\n        User createUser = filter.getCreateBy();\r\n        if (Objects.nonNull(createUser)) {\r\n            form.add(addLine(getCtx(), TMS.PROFIL_CREATE_BY,\r\n                    createUser.getGivenName() + \", \" + createUser.getSurName()));\r\n            form.add(addLine(getCtx(), TMS.PROFIL_CREATE_ON,\r\n                    Parse.formatDateTime(filter.getCreateOn(), AstDateTimeFormat.GERMAN)));\r\n        }\r\n        User updateUser = filter.getUpdateBy();\r\n        if (Objects.nonNull(updateUser)) {\r\n            form.add(addLine(getCtx(), TMS.PROFIL_UPDATE_BY,\r\n                    updateUser.getGivenName() + \", \" + updateUser.getSurName()));\r\n            form.add(addLine(getCtx(), TMS.PROFIL_UPDATE_ON,\r\n                    Parse.formatDateTime(filter.getUpdateOn(), AstDateTimeFormat.GERMAN)));\r\n        }\r\n        return form;\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToADDCrumbDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToFileEditCrumbDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.exceptions.ConvertException;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.DataFile;\r\nimport com.hom.ebmw.jpa.model.Storage;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.Blob;\r\nimport com.hom.ebmw.utilities.ConvertUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.util.*;\r\n\r\n@Slf4j\r\npublic class ToFileEditCrumbDialog\r\n        extends\r\n        CrumbProgressDialog {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private final DataFile datafile;\r\n\r\n    /**\r\n     * The ToFileEditCrumbDialog function is a constructor for the ToFileEditCrumbDialog class.\r\n     * It takes in two parameters: a Context object and a DataFile object.\r\n     * The function sets the datafile variable to be equal to the DataFile parameter passed into it.\r\n     *\r\n     * @param Context  ctx Create the dialog\r\n     * @param DataFile datafile Set the value of the datafile variable\r\n     * @return A dialog\r\n     */\r\n    public ToFileEditCrumbDialog(\r\n            Context ctx,\r\n            DataFile datafile) {\r\n        super(ctx);\r\n        this.datafile = datafile;\r\n    }\r\n\r\n    /**\r\n     * The load function is called by the framework when the dialog is opened.\r\n     * It loads all of the data that will be displayed in this dialog.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n\r\n        if (Objects.nonNull(datafile)) {\r\n            setLabel(TMS.SET_DIALOG_LOAD_FILE);\r\n            Optional<DataFile> optDatafile = getServices().getDataFileService().findById(datafile.getId());\r\n            if (optDatafile.isPresent()) {\r\n                DataFile dFile = optDatafile.get();\r\n                List<DataFile> dFiles = new ArrayList<>();\r\n                dFiles.add(dFile);\r\n                getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, dFiles);\r\n                File file = new File(SettingUtils.getTempFolder(getCtx()) + UUID.randomUUID());\r\n\r\n                Storage storage = getStorage(dFile);\r\n                Blob.loadFromCompressedFile(storage.getFileblob(), file);\r\n\r\n                setLabel(TMS.SET_DIALOG_ARCHIV_CONTENT);\r\n                try {\r\n                    articles = ConvertUtils.convertTxt2Prices(file, null);\r\n                    getCtx().getUserSession().put(Params.ACTIVE_ARTICLES, articles);\r\n                } catch (ConvertException e) {\r\n                    log.error(e.getLocalizedMessage());\r\n                }\r\n            }\r\n        } else {\r\n            getCtx().getUserSession().remove(Params.ACTIVE_ARTICLES);\r\n            getCtx().getUserSession().remove(Params.ACTIVE_DATAFILE);\r\n        }\r\n        nextUIBreadCrumb();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToFileEditCrumbDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToINDIVIDUALCrumbDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.FilterRunUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\npublic class ToINDIVIDUALCrumbDialog extends CrumbProgressDialog {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n\r\n    /**\r\n     * The ToINDIVIDUALCrumbDialog function is a constructor for the ToINDIVIDUALCrumbDialog class.\r\n     * It takes in a Context object and passes it to its superclass, CrumbDialog.\r\n     *\r\n     * @param Context ctx Create a new dialog\r\n     * @return The following:\r\n     */\r\n    public ToINDIVIDUALCrumbDialog(Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n    /**\r\n     * The load function is called when the user clicks on the &quot;Load&quot; button.\r\n     * It should load all of the data from your database into your UI, and then\r\n     * return true if it was successful. If it returns false, then an error message will be displayed to the user.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        FilterRunUtils.reloadRemoveFilter(getCtx(), this);\r\n        /* START INDIVIDUAL */\r\n        FilterRunUtils.reloadIndividualFilter(getCtx(), this);\r\n        /* END INDIVIDUAL */\r\n\r\n        setLabel(TMS.SET_DIALOG_LOAD_INDIVIDUAL);\r\n        nextUIBreadCrumb();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToINDIVIDUALCrumbDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToPreviewCrumpDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class ToPreviewCrumpDialog extends CrumbProgressDialog {\r\n\r\n    /**\r\n     * The ToPreviewCrumpDialog function is a constructor for the ToPreviewCrumpDialog class.\r\n     * It takes in a Context object as an argument and returns nothing.\r\n     *\r\n     * @param Context ctx Get the context of the activity that called this dialog\r\n     * @return A new instance of the topreviewcrumpdialog class\r\n     */\r\n    public ToPreviewCrumpDialog(Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n    /**\r\n     * The load function is called when the page is first loaded.\r\n     * It sets the label of the dialog to &quot;Loading Preview...&quot; and then calls nextUIBreadCrumb()\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        getCtx().getUserSession().put(Params.ACTIVE_CUSTOMER, getCtx().getHttpAttribute(SessionParams.ACTIVE_CUSTOMER));\r\n        setLabel(TMS.SET_DIALOG_LOAD_PREVIEW);\r\n        nextUIBreadCrumb();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToPreviewCrumpDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToREMOVECrumbDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.FilterType;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class ToREMOVECrumbDialog extends CrumbProgressDialog {\r\n\r\n    /**\r\n     * The ToREMOVECrumbDialog function is a constructor for the ToREMOVECrumbDialog class.\r\n     * It takes in a Context object and passes it to its superclass, Dialog.\r\n     *\r\n     * @param Context ctx Create a new alertdialog\r\n     * @return A dialog object\r\n     */\r\n    public ToREMOVECrumbDialog(Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n    /**\r\n     * The load function is used to load the data from the database into memory.\r\n     * It will be called once when the program starts up, and then again every time\r\n     * a new set of filters are applied.  The function should not return until all\r\n     * of its work has been completed.  If it returns before that, then it may be\r\n     * called again while still running in order to apply another set of filters on top of what's already loaded.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        /* START ADD */\r\n        for (FilterType type : FilterType.values()) {\r\n            if (FilterUtils.isValidProof(type)) {\r\n                setLabel(TMS.SET_DIALOG_LOAD_ADD, TMS.setProof(type));\r\n                getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), type, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n            }\r\n        }\r\n        setLabel(TMS.SET_DIALOG_LOAD_REMOVE);\r\n        nextUIBreadCrumb();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToREMOVECrumbDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToZinfoCrumpDialog.java =====\n```\npackage com.hom.ebmw.view.sortment.dialogs;\r\n\r\nimport com.hom.ebmw.exceptions.ArticleBaseQueueException;\r\nimport com.hom.ebmw.jpa.model.User;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.ArticleBaseQueueUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.constans.Table;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SessionParams;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class ToZinfoCrumpDialog extends CrumbProgressDialog {\r\n\r\n    /**\r\n     * The ToZinfoCrumpDialog function is a constructor for the ToZinfoCrumpDialog class.\r\n     * It takes in a Context object and passes it to its superclass, Dialog.\r\n     *\r\n     * @param Context ctx Create a dialog object\r\n     */\r\n    public ToZinfoCrumpDialog(Context ctx) {\r\n        super(ctx);\r\n    }\r\n\r\n    /**\r\n     * The load function is used to load the current list of articles for the active customer.\r\n     * It also resets all user queues and adds a new queue table with the main article price file.\r\n     */\r\n    @Override\r\n    protected void load() {\r\n        User user = getCtx().getSession().getCurrentUser(getCtx());\r\n        try {\r\n            getCtx().getUserSession().put(Params.ACTIVE_CUSTOMER,\r\n                    getCtx().getHttpAttribute(SessionParams.ACTIVE_CUSTOMER));\r\n            setLabel(TMS.SET_DIALOG_CLEAR_CACHE);\r\n\r\n            ArticleBaseQueueUtils.resetUserQueues(getCtx());\r\n            getCtx().getUserSession().remove(Params.ACTIVE_ARTICLE_BASE_TABLE);\r\n            ArticleBaseQueueUtils.addQueueTable(getCtx(), user, Table.MAIN); // ArticlePrice File\r\n\r\n            setLabel(TMS.ZINFO_DIALOG_LOAD_CURRENT_LIST);\r\n            getServices().getZinfoCustomerSerivce().loadCurrentArticles(getCtx().getUserSession());\r\n            nextUIBreadCrumb();\r\n\r\n        } catch (ArticleBaseQueueException e) {\r\n            getNotify().errorPrintMessage(e.getLocalMessage(getCtx()));\r\n        }\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\dialogs\\ToZinfoCrumpDialog.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FileEditCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.exceptions.DoubleFoundException;\r\nimport com.hom.ebmw.ipim.model.Currency;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.KatalogVersion;\r\nimport com.hom.ebmw.utilities.AstNotification;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.FilterUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FileParam;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport com.hom.ebmw.utilities.interfaces.Command;\r\nimport com.hom.ebmw.view.components.Crumb;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.CloseDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToDataFileDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.datepicker.DatePicker;\r\nimport com.vaadin.flow.component.formlayout.FormLayout;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.binder.Binder;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.function.SerializablePredicate;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.*;\r\n\r\n@Slf4j\r\n@BreadCrumb(TMS.CRB_FILE_EDIT)\r\npublic class FileEditCrumb extends Crumb implements FileInputLoader {\r\n\r\n    private static final long serialVersionUID = 1L;\r\n    private final GridPro<ArticleBase> articleGrid = new GridPro<>();\r\n    private ListDataProvider<ArticleBase> dataProvider;\r\n    private SerializablePredicate<ArticleBase> filters = null;\r\n\r\n    private ComboBox<KatalogVersion> katalogVersionCbx;\r\n    private DatePicker fromDate;\r\n    private DatePicker toDate;\r\n    private ComboBox<Language> languageCbx;\r\n    private ComboBox<Territory> territoryCbx;\r\n    private ComboBox<Currency> currencyCbx;\r\n    private ComboBox<ObjectType> typeCbx;\r\n    private Checkbox showDoubles;\r\n    private Button newLine;\r\n    private Button deleteLine;\r\n    private ImageButton saveNclose;\r\n    private TextField fieldTxt;\r\n    private ObjectType selectedType = null;\r\n    private final Binder<DataFile> bDataFile = new Binder<>();\r\n\r\n    private List<DataFile> selection;\r\n    private DataFile selected;\r\n    private KatalogVersion defaultKatalogVersion = null;\r\n    private final Setting sKatalogVersion;\r\n\r\n    /**\r\n     * The FileEditCrumb function is a constructor for the FileEditCrumb class.\r\n     * It initializes the following:\r\n     * &lt;ul&gt;\r\n     * &lt;li&gt;The articleGrid&lt;/li&gt;\r\n     * &lt;li&gt;The selection of DataFiles&lt;/li&gt;\r\n     * &lt;li&gt;&lt;b&gt;(?)&lt;/b&gt;&lt;/li&gt;\r\n     *\r\n     * @param Context ctx Get the current context\r\n     * @return The following:\r\n     */\r\n    public FileEditCrumb(Context ctx) {\r\n        super(ctx);\r\n        articleGrid.setSelectionMode(SelectionMode.MULTI);\r\n\r\n        selection = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n        if (Objects.isNull(selection) || selection.isEmpty()) {\r\n            selected = new DataFile();\r\n            selected.setDate(getCtx().getSession().getCurrentUser(getCtx()));\r\n            selected = getCtx().getServices().getDataFileService().save(selected);\r\n            setParameter(FileParam.FILE_TYPE, ObjectType.ECAT_INPUT, selected);\r\n            if (Objects.isNull(selection))\r\n                selection = new ArrayList<>();\r\n            selection.add(selected);\r\n            getCtx().getUserSession().put(Params.ACTIVE_DATAFILE, selection);\r\n        } else {\r\n            selected = selection.get(0);\r\n        }\r\n        bDataFile.setBean(selected);\r\n\r\n\r\n        sKatalogVersion = SettingUtils.getSettingByType(getCtx(), SettingType.DEFAULT_CATALOGVERSION);\r\n\r\n        Object oVersion = getParameter(FileParam.KATALOG_VERSION, selected);\r\n        Object oFrom = getParameter(FileParam.VALID_FROM, selected);\r\n        Object oTo = getParameter(FileParam.VALID_TO, selected);\r\n\r\n        if (Objects.nonNull(oVersion)) {\r\n            defaultKatalogVersion = (KatalogVersion) oVersion;\r\n        } else {\r\n            defaultKatalogVersion = CompUtils.getKatalogVersion(ctx, selected);\r\n        }\r\n\r\n        int iValid = 0;\r\n        if (Objects.isNull(oFrom)) {\r\n            setParameter(FileParam.VALID_FROM, defaultKatalogVersion.getValidFrom(), selected);\r\n            iValid++;\r\n        }\r\n        if (Objects.isNull(oTo)) {\r\n            setParameter(FileParam.VALID_TO, defaultKatalogVersion.getValidTo(), selected);\r\n            iValid++;\r\n        }\r\n        if (iValid > 1) {\r\n            setParameter(FileParam.KATALOG_VERSION, defaultKatalogVersion, selected);\r\n        }\r\n\r\n        setLanguageParamByCustomer(selected);\r\n\r\n\r\n        initKatalogVersion();\r\n\r\n        initFromDate();\r\n        initToDate();\r\n        initCurrency();\r\n        initTerritory();\r\n        initLanguage();\r\n        initType();\r\n\r\n        initNewBtn();\r\n        initDeleteBtn();\r\n        initSaveBtn();\r\n        initSearchFld();\r\n        initShowDouble();\r\n\r\n        if (Objects.nonNull(selected)) {\r\n            selectedType = getParameter(FileParam.FILE_TYPE, selected);\r\n        } else {\r\n            selectedType = ObjectType.ECAT_INPUT;\r\n        }\r\n        typeCbx.setValue(selectedType);\r\n\r\n        reloadCrumb();\r\n    }\r\n\r\n    /**\r\n     * The loadLayout function is responsible for loading the layout of the file editor.\r\n     * It removes all components from the current view, initializes a new grid, and then adds\r\n     * a vertical layout to which it adds form items (depending on whether or not an ECAT_INPUT file is being edited), buttons, and finally the articleGrid.\r\n     */\r\n    private void loadLayout() {\r\n        if (getComponentCount() > 0) {\r\n            removeAll();\r\n        }\r\n        initGrid();\r\n\r\n        VerticalLayout body = new VerticalLayout();\r\n        CompUtils.removeMSP(body, \"MP\");\r\n\r\n        HorizontalLayout buttons = new HorizontalLayout();\r\n        CompUtils.removeMSP(buttons, \"MSP\");\r\n\r\n        FormLayout form = new FormLayout();\r\n\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            form.addFormItem(katalogVersionCbx, getTranslation(TMS.FILE_EDIT_KATALOG_VERSION, getLocale(), getCtx()));\r\n            form.addFormItem(fromDate, getTranslation(TMS.FILE_EDIT_VALID_FROM, getLocale(), getCtx()));\r\n            form.addFormItem(toDate, getTranslation(TMS.FILE_EDIT_VALID_TO, getLocale(), getCtx()));\r\n            form.addFormItem(languageCbx, getTranslation(TMS.FILE_EDIT_LANGUAGE, getLocale(), getCtx()));\r\n            form.addFormItem(territoryCbx, getTranslation(TMS.FILE_EDIT_TERRITORY, getLocale(), getCtx()));\r\n            form.addFormItem(currencyCbx, getTranslation(TMS.FILE_EDIT_CURRENCY, getLocale(), getCtx()));\r\n        }\r\n\r\n        buttons.add(newLine, deleteLine, saveNclose, fieldTxt, typeCbx, showDoubles);\r\n\r\n        body.add(form, buttons, articleGrid);\r\n        body.setSizeFull();\r\n        add(body);\r\n    }\r\n\r\n    /**\r\n     * The initSearchFld function initializes the search field.\r\n     * The function sets a placeholder for the search field, and adds a value change listener to it.\r\n     * When the value of the textfield changes, it filters out all articles that do not contain\r\n     * what is written in the textfield in their article number. It then updates both dataProvider and articleGrid with this new filter.\r\n     */\r\n    private void initSearchFld() {\r\n        fieldTxt = new TextField();\r\n        fieldTxt.setPlaceholder(getTranslation(TMS.FILE_EDIT_SEARCH_PLACEHOLDER, getLocale(), getCtx()));\r\n        fieldTxt.addValueChangeListener(event -> {\r\n            dataProvider.addFilter(ArticleBase::getArticleNr, name -> {\r\n                String nameLower = (name == null ? \"\" : name.toLowerCase(Locale.ENGLISH));\r\n                String filterLower = fieldTxt.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n            filters = dataProvider.getFilter();\r\n            articleGrid.setDataProvider(dataProvider);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The initLanguage function initializes the languageCbx ComboBox.\r\n     * The ComboBox is populated with all languages from the database, and each item in the list is displayed as a string containing its label (e.g., &quot;en-US&quot;) and its display name (e.g., &quot;English - United States&quot;).\r\n     * The ComboBox is required to be filled out before submitting data to the database, or else an error message will appear stating that it cannot be empty.\r\n     */\r\n    private void initLanguage() {\r\n        languageCbx = new ComboBox<>();\r\n        languageCbx.setClearButtonVisible(true);\r\n        languageCbx.setItems(getServices().getEnumerationService().getAllLanguages());\r\n        languageCbx.setItemLabelGenerator(item -> item.getLabel().split(\"-\")[0] + \" - \"\r\n                + Locale.forLanguageTag(item.getLabel()).getDisplayLanguage(getLocale()));\r\n        languageCbx.setRequired(true);\r\n\r\n        bDataFile.forField(languageCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.LANGUAGE, item), this::setSettingLanguage);\r\n    }\r\n\r\n    /**\r\n     * The initKatalogVersion function initializes the katalogVersionCbx ComboBox.\r\n     * The function first creates a new ComboBox object and sets its clearButtonVisible property to true.\r\n     * It then sets the required property of the katalogVersionCbx object to true, which means that it is mandatory for users to select an item from this dropdown menu before they can proceed with uploading their file.\r\n     * Next, it creates two lists: versions and params. The versions list will contain all KatalogVersions objects that are not of type IMPEX (i.e., only those KatalogVersions objects whose type is either\r\n     */\r\n    private void initKatalogVersion() {\r\n        katalogVersionCbx = new ComboBox<>();\r\n        katalogVersionCbx.setClearButtonVisible(true);\r\n        katalogVersionCbx.setRequired(true);\r\n        List<KatalogVersion> versions = new ArrayList<>();\r\n        List<SettingParameter<KatalogVersion>> params = getCtx().getServices().getSettingParameterService()\r\n                .findAllBySettingOrderByDisplayOrder(sKatalogVersion);\r\n        params.removeIf(item -> item.getValue().getType().equals(ObjectType.IMPEX));\r\n\r\n        params.forEach(item -> versions.add(item.getValue()));\r\n        katalogVersionCbx.setItems(versions);\r\n        katalogVersionCbx.setItemLabelGenerator(KatalogVersion::getVersion);\r\n        bDataFile.forField(katalogVersionCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.KATALOG_VERSION, item),\r\n                        (item, version) -> setParameter(FileParam.KATALOG_VERSION, version, item));\r\n    }\r\n\r\n    /**\r\n     * The initFromDate function initializes the fromDate DatePicker object.\r\n     * The fromDate DatePicker object is used to select a date for the validFrom parameter of a file.\r\n     */\r\n    private void initFromDate() {\r\n        fromDate = new DatePicker();\r\n        fromDate.setRequired(true);\r\n        bDataFile.forField(fromDate)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired()\r\n                .bind(item -> getCurrentDate(FileParam.VALID_FROM, defaultKatalogVersion.getValidFrom(), item),\r\n                        (item, date) -> setParameter(FileParam.VALID_FROM, date, item));\r\n    }\r\n\r\n    /**\r\n     * The initToDate function initializes the toDate DatePicker.\r\n     * The toDate DatePicker is required and must be non-null.\r\n     * If it is null, an error message will appear in the UI.\r\n     */\r\n    private void initToDate() {\r\n        toDate = new DatePicker();\r\n        toDate.setRequired(true);\r\n        bDataFile.forField(toDate)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getCurrentDate(FileParam.VALID_TO, defaultKatalogVersion.getValidTo(), item),\r\n                        (item, date) -> setParameter(FileParam.VALID_TO, date, item));\r\n    }\r\n\r\n    /**\r\n     * The initNewBtn function initializes the newLine button.\r\n     * The newLine button is a plus sign that adds an empty line to the grid when clicked.\r\n     */\r\n    private void initNewBtn() {\r\n        newLine = new Button(VaadinIcon.PLUS.create());\r\n        newLine.addClickListener(event -> {\r\n            List<ArticleBase> articles = getArticles();\r\n            ArticleBase initial = new ArticleBase();\r\n            articles.add(0, initial);\r\n            reload(articles);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The initDeleteBtn function initializes the deleteLine button.\r\n     * The deleteLine button is used to remove articles from the articleGrid.\r\n     */\r\n    private void initDeleteBtn() {\r\n        deleteLine = new Button(VaadinIcon.CLOSE.create());\r\n        deleteLine.addClickListener(event -> {\r\n            List<ArticleBase> curSelected = new ArrayList<>();\r\n            curSelected.addAll(articleGrid.getSelectedItems());\r\n            if (!curSelected.isEmpty()) {\r\n                delArticles(curSelected);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The initSaveBtn function initializes the saveNclose button.\r\n     * The saveNclose button is a floppy disk icon that saves the file and closes it.\r\n     */\r\n    private void initSaveBtn() {\r\n        saveNclose = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        saveNclose.addClickListener(event -> {\r\n\r\n            selectedType = typeCbx.getValue();\r\n            try {\r\n                if (Objects.isNull(selectedType)) {\r\n                    List<DataFile> dFiles = getCtx().getUserSession().get(Params.ACTIVE_DATAFILE);\r\n                    DataFile dFile = dFiles.get(0);\r\n                    selectedType = getParameter(FileParam.FILE_TYPE, dFile);\r\n                }\r\n            } catch (NullPointerException e) {\r\n                selectedType = ObjectType.ECAT_INPUT;\r\n            }\r\n\r\n            switch (selectedType) {\r\n                case ECAT_INPUT:\r\n                    bDataFile.validate();\r\n                    if (bDataFile.isValid()) {\r\n                        buildFile(() -> log.trace(ObjectType.ECAT_INPUT.name()));\r\n                    }\r\n                    break;\r\n\r\n                default:\r\n                case ECAT_INPUT_POSITIV:\r\n                    buildFile(() -> log.trace(ObjectType.ECAT_INPUT_POSITIV.name()));\r\n                    break;\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The buildFile function is used to build a file from the articles in the grid.\r\n     * It first checks if there are any articles in the grid, and if not it displays an error message.\r\n     * If there are articles, it then checks for doubles using FilterUtils.checkIfDouble().  If no doubles are found,\r\n     * it opens a SaveArticlesToDataFileDialog dialog box and runs that dialog box's run() function (which saves the file).\r\n     *\r\n     * @param Command com Execute the command\r\n     */\r\n    private void buildFile(Command com) {\r\n        AstNotification notify = new AstNotification(getCtx());\r\n        try {\r\n            List<ArticleBase> articles = new ArrayList<>();\r\n\r\n            if (Objects.nonNull(dataProvider) && Objects.nonNull(dataProvider.getItems())\r\n                    && !dataProvider.getItems().isEmpty()) {\r\n                articles.addAll(dataProvider.getItems());\r\n                if (typeCbx.getValue().equals(ObjectType.ECAT_INPUT)) {\r\n                    FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_PRICELIST_CONTAINS_DOUBLES);\r\n                } else {\r\n                    FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_POSITIVLIST_CONTAINS_DOUBLES);\r\n                }\r\n                com.execute();\r\n\r\n\r\n                SaveArticlesToDataFileDialog dialog = new SaveArticlesToDataFileDialog(getCtx(), articles,\r\n                        selectedType);\r\n                dialog.open();\r\n                dialog.run();\r\n            } else {\r\n                notify.errorMessage(getTranslation(TMS.ERROR_MSG_PRICE_FILE_IS_EMPTY, getLocale(), getCtx()));\r\n            }\r\n\r\n        } catch (DoubleFoundException e) {\r\n            showDoubles.setValue(true);\r\n            setDoubleFilter(true);\r\n\r\n            notify.errorMessage(getTranslation(TMS.ERROR_MSG_PRICELIST_CONTAINS_DOUBLES, getLocale(), getCtx()) + \": \"\r\n                    + e.getMessage());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The initType function initializes the typeCbx ComboBox.\r\n     * The typeCbx ComboBox is used to select the objectType of a new ECAT_INPUT or ECAT_INPUT_POSITIV object.\r\n     * The initType function sets the items in the typeCbx ComboBox to be ObjectType.ECAT_INPUT and ObjectType.ECAT_INPUT-POSITIV,\r\n     * which are two different types of objects that can be created by this class (the EcatInputEditor).\r\n     */\r\n    private void initType() {\r\n        typeCbx = new ComboBox<>();\r\n        typeCbx.setItems(ObjectType.ECAT_INPUT, ObjectType.ECAT_INPUT_POSITIV);\r\n        typeCbx.setItemLabelGenerator(name -> getTranslation(TMS.getType(name), getLocale(), getCtx()));\r\n        typeCbx.addValueChangeListener(event -> {\r\n            selectedType = event.getValue();\r\n            loadLayout();\r\n        });\r\n        typeCbx.setPlaceholder(ObjectType.ECAT_INPUT.toString());\r\n    }\r\n\r\n    /**\r\n     * The initCurrency function initializes the currencyCbx ComboBox.\r\n     * The ComboBox is populated with all currencies from the database.\r\n     * The itemLabelGenerator of the ComboBox is set to display both key and label of each currency in its dropdown menu.\r\n     * A validator is added to ensure that a value has been selected for this field before saving changes, and an error message will be displayed if no value has been selected when attempting to save changes.\r\n     */\r\n    private void initCurrency() {\r\n        currencyCbx = new ComboBox<>();\r\n        currencyCbx.setClearButtonVisible(true);\r\n        currencyCbx.setItems(getServices().getEnumerationService().getAllCurrencies());\r\n        currencyCbx.setItemLabelGenerator(item -> item.getKey() + \" (\" + item.getLabel() + \")\");\r\n        currencyCbx.setRequired(true);\r\n\r\n        bDataFile.forField(currencyCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.CURRENCY, item),\r\n                        (item, currency) -> setParameter(FileParam.CURRENCY, currency, item));\r\n    }\r\n\r\n    /**\r\n     * The initTerritory function initializes the territoryCbx ComboBox.\r\n     * The ComboBox is populated with all territories from the database.\r\n     * The itemLabelGenerator of the ComboBox is set to display both key and label for each territory in its dropdown menu.\r\n     * A validator is added to ensure that a value has been selected before submitting, and an error message will be displayed if not.\r\n     */\r\n    private void initTerritory() {\r\n        territoryCbx = new ComboBox<>();\r\n        territoryCbx.setClearButtonVisible(true);\r\n        territoryCbx.setItems(getServices().getEnumerationService().getAllTerritories());\r\n        territoryCbx.setItemLabelGenerator(item -> item.getKey() + \" - \" + item.getLabel());\r\n        territoryCbx.setRequired(true);\r\n\r\n        bDataFile.forField(territoryCbx)\r\n                .withValidator(Objects::nonNull,\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, getLocale(), getCtx()))\r\n                .asRequired().bind(item -> getParameter(FileParam.TERRITORY, item),\r\n                        (item, currency) -> setParameter(FileParam.TERRITORY, currency, item));\r\n    }\r\n\r\n    /**\r\n     * The initGrid function initializes the articleGrid.\r\n     * It removes all columns from the grid, and then adds new ones depending on whether or not selectedType is equal to ObjectType.ECAT_INPUT.\r\n     * If it is, then it adds a column for customerArticleNr (which can be edited), articleNr (which can be edited), priceFirstWithThousend (which can be edited), priceXWithThousend (which can be edited) and scalelimit( which can also be editted).\r\n     */\r\n    private void initGrid() {\r\n\r\n        articleGrid.removeAllColumns();\r\n\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            articleGrid.addEditColumn(ArticleBase::getCustomerArticleNr).text(ArticleBase::setCustomerArticleNr)\r\n                    .setHeader(getTranslation(TMS.FILE_EDIT_CUSTOMER_ARTICLE_NR, getLocale(), getCtx()))\r\n                    .setSortable(true);\r\n        }\r\n        articleGrid.addEditColumn(ArticleBase::getArticleNr).text(ArticleBase::setArticleNr)\r\n                .setHeader(getTranslation(TMS.FILE_EDIT_ARTICLE_NR, getLocale(), getCtx())).setSortable(true);\r\n\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            articleGrid.addEditColumn(ArticleBase::getPriceFirstWithThousend).text(ArticleBase::setPriceFirst)\r\n                    .setHeader(getTranslation(TMS.FILE_EDIT_PRICE_FIRST, getLocale(), getCtx()))\r\n                    .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceFirst(), o2.getPriceFirst()))\r\n                    .setSortable(true);\r\n            articleGrid.addEditColumn(ArticleBase::getPriceXWithThousend).text(ArticleBase::setPriceX)\r\n                    .setHeader(getTranslation(TMS.FILE_EDIT_PRICE_SCALE, getLocale(), getCtx()))\r\n                    .setComparator((o1, o2) -> CompUtils.priceCompare(o1.getPriceX(), o2.getPriceX()))\r\n                    .setSortable(true);\r\n            articleGrid.addEditColumn(ArticleBase::getScalelimit).text(ArticleBase::setScalelimit)\r\n                    .setHeader(getTranslation(TMS.FILE_EDIT_SCALE_LIMIT, getLocale(), getCtx())).setSortable(true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The initShowDouble function initializes the showDoubles checkbox.\r\n     * The showDoubles checkbox is used to filter out duplicate files from the file list.\r\n     */\r\n    private void initShowDouble() {\r\n        showDoubles = new Checkbox(getTranslation(TMS.FILE_EDIT_SHOW_DOUBLES, getLocale(), getCtx()));\r\n        showDoubles.addClickListener(event -> setDoubleFilter(event.getSource().getValue()));\r\n    }\r\n\r\n    /**\r\n     * The setDoubleFilter function is used to filter the articles in the grid.\r\n     * If valid is true, then it will check if there are any doubles in the list of articles and throw an exception if so.\r\n     * If valid is false, then it will clear all filters from the dataProvider.\r\n     *\r\n     * @param boolean valid Check if the filter should be applied or not\r\n     */\r\n    private void setDoubleFilter(boolean valid) {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        articles.addAll(dataProvider.getItems());\r\n        if (valid) {\r\n            try {\r\n                if (typeCbx.getValue().equals(ObjectType.ECAT_INPUT)) {\r\n                    FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_PRICELIST_CONTAINS_DOUBLES);\r\n                } else {\r\n                    FilterUtils.checkIfDouble(getCtx(), articles, TMS.ERROR_MSG_POSITIVLIST_CONTAINS_DOUBLES);\r\n                }\r\n\r\n            } catch (DoubleFoundException e) {\r\n                dataProvider.addFilter(ArticleBase::getArticleNr,\r\n                        e.getArticleNrs()::contains\r\n                );\r\n            }\r\n        } else {\r\n            dataProvider.clearFilters();\r\n        }\r\n        articleGrid.setDataProvider(dataProvider);\r\n    }\r\n\r\n    /**\r\n     * The delArticles function is used to remove articles from the grid.\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Remove the selected articles from the grid\r\n     */\r\n    private void delArticles(List<ArticleBase> articles) {\r\n        List<ArticleBase> buffer = new ArrayList<>();\r\n        buffer.addAll(dataProvider.getItems());\r\n        buffer.removeAll(articles);\r\n\r\n        dataProvider = DataProvider.ofCollection(buffer);\r\n        articleGrid.setDataProvider(dataProvider);\r\n        if (Objects.nonNull(filters))\r\n            dataProvider.addFilter(filters);\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to update the grid with new data.\r\n     * It takes a list of articles as an argument and updates the grid's data provider with it.\r\n     * If there are any filters applied, they will be reapplied after updating the data provider.\r\n     *\r\n     * @param List&lt;ArticleBase&gt; articles Set the dataprovider of the grid\r\n     */\r\n    private void reload(List<ArticleBase> articles) {\r\n        if (Objects.nonNull(getArticles()) && Objects.nonNull(articles)) {\r\n            dataProvider = DataProvider.ofCollection(articles);\r\n            articleGrid.setDataProvider(dataProvider);\r\n        }\r\n\r\n        if (Objects.nonNull(filters))\r\n            dataProvider.addFilter(filters);\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user clicks on the exit button.\r\n     * It creates a new CloseDialog object and opens it, then runs it.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        CloseDialog dialog = new CloseDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is called when the user clicks on a button in the wizard.\r\n     * It sets all buttons to disabled, and then enables only those that are appropriate for\r\n     * the current state of the wizard.  This function is called by each of its subclasses,\r\n     * which override it to enable additional buttons as needed.  For example, if you want to add a &quot;Save&quot; button that appears on every page except for Page 1 (the first page), you would do this:&lt;br&gt;&lt;br&gt;\r\n     * &lt;code&gt;\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(false);\r\n            setNextEnable(false);\r\n            setFinishEnable(false);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called by the ArticleCrumb class when a user clicks on an article in the\r\n     * crumb. This function reloads the current page with that article's information.\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n        UI.getCurrent().access(() ->\r\n                reload(getCtx().getUserSession().get(Params.ACTIVE_ARTICLES))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The getArticles function returns a list of ArticleBase objects.\r\n     * If the dataProvider is not null, then it adds all items from the dataProvider to articles.\r\n     * Otherwise, it sets the dataProvider to be equal to DataProvider.ofCollection(articles).\r\n     *\r\n     * @return A list of articles\r\n     */\r\n    @Override\r\n    public List<ArticleBase> getArticles() {\r\n        List<ArticleBase> articles = new ArrayList<>();\r\n        if (Objects.nonNull(dataProvider))\r\n            articles.addAll(dataProvider.getItems());\r\n        else\r\n            dataProvider = DataProvider.ofCollection(articles);\r\n        return articles;\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the checkboxes that are displayed in the FileImportDialog.\r\n     * The first parameter of each dialog.addValueCbx call is a String, which corresponds to a column name in the database table for this object type (e.g., &quot;article_nr&quot; or &quot;price_first&quot;).\r\n     * The second parameter of each dialog.addValueCbx call is a boolean, which determines whether or not that checkbox should be checked by default when it appears on screen (true = checked).\r\n     *\r\n     * @param FileImportDialog dialog Access the values of the\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_CUSTOMER_ARTICLE_NR, false);\r\n        }\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ARTICLE_NR, true);\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_FIRST, true);\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_PRICE_SCALE, false);\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_SCALE_LIMIT, false);\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_CURRENCY, false);\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, false);\r\n            dialog.addValueCbx(TMS.FILE_IMPORTER_TERRITORY, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in\r\n     * the FileImportDialog. The function takes a single argument, which is an instance of\r\n     * FileImportDialog. This dialog contains all of the information that was entered by\r\n     * the user during import, including:\r\n     * - The file that was imported (dialog.getFile())\r\n     * - A list of column names from each row in this file (dialog.getTable().get(0))\r\n     * - A list containing all rows from this file (dialog.getTable())\r\n     *\r\n     * @param FileImportDialog dialog Get the column values of the selected row\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        List<ArticleBase> articles = getArticles();\r\n        dialog.getTable().forEach(row -> {\r\n            ArticleBase item = setPrice(row, dialog);\r\n            articles.add(item);\r\n        });\r\n\r\n        Map<Integer, String> colString = dialog.getTable().get(0);\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            // CURRENCY\r\n            if (dialog.getColumns()[5] > -1) {\r\n                String currency = dialog.getColumnsByIdx(colString, 5);\r\n                if (!currency.isEmpty()) {\r\n                    List<Currency> items = getCtx().getServices().getEnumerationService().getAllCurrencies();\r\n                    Optional<Currency> opt = items.stream().filter(item -> item.getKey().equals(currency)).findFirst();\r\n                    opt.ifPresent(currencyCbx::setValue);\r\n                }\r\n            }\r\n            // LANGUAGE\r\n            if (dialog.getColumns()[6] > -1) {\r\n                String language = dialog.getColumnsByIdx(colString, 6);\r\n                if (!language.isEmpty()) {\r\n                    List<Language> items = getCtx().getServices().getEnumerationService().getAllLanguages();\r\n                    Optional<Language> opt = items.stream().filter(item -> item.getLabel().contains(language))\r\n                            .findFirst();\r\n                    opt.ifPresent(languageCbx::setValue);\r\n                }\r\n            }\r\n            // TERRITORY\r\n            if (dialog.getColumns()[7] > -1) {\r\n                String territory = dialog.getColumnsByIdx(colString, 7);\r\n                if (!territory.isEmpty()) {\r\n                    List<Territory> items = getCtx().getServices().getEnumerationService().getAllTerritories();\r\n                    Optional<Territory> opt = items.stream().filter(item -> item.getKey().equals(territory))\r\n                            .findFirst();\r\n                    opt.ifPresent(territoryCbx::setValue);\r\n                }\r\n            }\r\n        }\r\n\r\n        reload(articles);\r\n        getCtx().getUserSession().remove(Params.ACTIVE_ARTICLES);\r\n    }\r\n\r\n    /**\r\n     * The setPrice function is used to set the price of an article.\r\n     *\r\n     * @param Map&lt;Integer   Get the column number from the file\r\n     * @param String&gt;       colString Get the values from the file\r\n     * @param FileImportDialog dialog Get the column indexes\r\n     * @return An articlebase object\r\n     */\r\n    private ArticleBase setPrice(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n        ArticleBase price = new ArticleBase(assortment);\r\n        if (selectedType.equals(ObjectType.ECAT_INPUT)) {\r\n            if (dialog.getColumns()[0] > -1) {\r\n                price.setCustomerArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n            }\r\n            if (dialog.getColumns()[1] > -1) {\r\n                price.setArticleNr(dialog.getColumnsByIdx(colString, 1));\r\n            }\r\n            if (dialog.getColumns()[2] > -1) {\r\n                price.setPriceFirst(dialog.getColumnsByIdx(colString, 2));\r\n            }\r\n            if (dialog.getColumns()[3] > -1) {\r\n                price.setPriceX(dialog.getColumnsByIdx(colString, 3));\r\n            }\r\n            if (dialog.getColumns()[4] > -1) {\r\n                price.setScalelimit(dialog.getColumnsByIdx(colString, 4));\r\n            }\r\n        } else {\r\n            if (dialog.getColumns()[0] > -1) {\r\n                price.setArticleNr(dialog.getColumnsByIdx(colString, 0));\r\n            }\r\n        }\r\n        return price;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in\r\n     * the FileImportDialog. It takes a list of articles and adds them to this ArticleList's\r\n     * list of articles, then reloads this ArticleList with all its new articles.\r\n     *\r\n     * @param FileImportDialog        dialog Get the file path of the selected file\r\n     * @param List&lt;ArticleBase&gt; articles Pass the articles from the fileimportdialog to this class\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n        List<ArticleBase> cArticles = getArticles();\r\n        cArticles.addAll(articles);\r\n        reload(cArticles);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FileEditCrumb.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FilterAddCrumb.java =====\n```\npackage com.hom.ebmw.view.sortment.ecat.crumb;\r\n\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.Assortment;\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.DnDUtils;\r\nimport com.hom.ebmw.utilities.annotations.BreadCrumb;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.FilterStatus;\r\nimport com.hom.ebmw.utilities.enums.FilterType;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.view.components.FilterCrumb;\r\nimport com.hom.ebmw.view.dialogs.CrumbProgressDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.BreakDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.FromADDToINDIVIDUALCrumbDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.SaveArticlesToAssortmentDialog;\r\nimport com.hom.ebmw.view.sortment.dialogs.ToREMOVECrumbDialog;\r\nimport com.hom.ebmw.view.sortment.subview.ArticleDetailBox;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.accordion.Accordion;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.splitlayout.SplitLayout;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\n\r\n@BreadCrumb(TMS.CRB_FILTER_ADD)\r\n@SuppressWarnings(\"serial\")\r\npublic class FilterAddCrumb\r\n        extends\r\n        FilterCrumb {\r\n\r\n    private final ArticleDetailBox details;\r\n\r\n    private final Grid<Filterbase> rightFilterGrid;\r\n\r\n    /**\r\n     * The FilterAddCrumb function is a constructor for the FilterAddCrumb class.\r\n     * It creates an Accordion object, and then adds several panels to it.\r\n     * The first panel is created by calling buildMaterialAssigmentPanel().\r\n     * The second panel is created by calling buildNotInPimPanel().\r\n     * The third panel is created by calling buildNotApprovalPanel().\r\n     * The fourth panel is created by calling buildNotInPositivPanel().  This function also creates a SplitLayout object, and sets its size to full.  Then it calls add() on itself with details (an ArticleDetailBox)\r\n     *\r\n     * @param Context ctx Get the current context\r\n     * @return The following value\r\n     */\r\n    public FilterAddCrumb(\r\n            Context ctx) {\r\n        super(ctx, new Accordion());\r\n\r\n        SplitLayout boxes = new SplitLayout();\r\n        boxes.setSizeFull();\r\n\r\n        details = new ArticleDetailBox(getCtx(), getArticles());\r\n\r\n        add(details, boxes);\r\n\r\n        getAccordion().add(buildMaterialAssigmentPanel());\r\n        getAccordion().add(buildNotInPimPanel());\r\n        getAccordion().add(buildNotApprovalPanel());\r\n        getAccordion().add(buildNotInPositivPanel());\r\n        getAccordion().add(buildRemoveByPositivPanel());\r\n        getAccordion().add(buildInvalidVtlStatusPanel());\r\n\r\n        VerticalLayout rightBox = new VerticalLayout();\r\n        rightFilterGrid = new Grid<Filterbase>();\r\n        rightFilterGrid.addColumn(Filterbase::getLabel).setHeader(getTranslation(TMS.FILTER_ADD_GRID_NAME, getLocale(), getCtx()));\r\n        rightFilterGrid.addColumn(Filterbase::getType).setHeader(getTranslation(TMS.FILTER_ADD_GRID_TYPE, getLocale(), getCtx()));\r\n        rightFilterGrid.setSelectionMode(SelectionMode.MULTI);\r\n        rightBox.add(getPanelHeader(TMS.FILTER_PANEL_BASE_LIST), rightFilterGrid);\r\n        boxes.addToPrimary(getAccordion());\r\n        boxes.addToSecondary(rightBox);\r\n        rightBox.getStyle().set(\"margin\", \"0em\");\r\n        rightBox.getStyle().set(\"padding\", \"0.1em 0.1em\");\r\n\r\n        DnDUtils.dragNdropToAdd(UI.getCurrent(), getCtx(), getAssigmendGrid().getGrid(), rightFilterGrid, FilterType.ZUORDNUNG_MATERIAL);\r\n        DnDUtils.dragNDelete(UI.getCurrent(), getCtx(), rightFilterGrid, getAssigmendGrid().getGrid());\r\n    }\r\n\r\n    /**\r\n     * The reloadButtons function is called by the WizardController to update the buttons on\r\n     * the wizard. The function sets all of them to be enabled, and then calls setLastEnable,\r\n     * setNextEnable, setFinishEnable and setExitEnable in order to disable any that should not\r\n     * be enabled. This function is called whenever a new page is loaded into the wizard or when\r\n     * a button has been clicked (in which case it will check if there are any pages left). It\r\n     * also checks if there are no more pages left in which case it disables all buttons except for exit.\r\n     */\r\n    @Override\r\n    public void reloadButtons() {\r\n        UI.getCurrent().access(() -> {\r\n            setLastEnable(true);\r\n            setNextEnable(true);\r\n            setFinishEnable(true);\r\n            setExitEnable(true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadCrumb function is called when the user clicks on a breadcrumb.\r\n     * It reloads the data in the grid and accordion, as well as any other components that need to be updated.\r\n     */\r\n    @Override\r\n    public void reloadCrumb() {\r\n\r\n        List<ArticleBase> articles = getArticles();\r\n        if (Objects.nonNull(articles)) {\r\n            details.reload(() -> articles);\r\n            loadAssigned();\r\n\r\n            List<Filterbase> bases = new ArrayList<Filterbase>();\r\n\r\n            Assortment assortment = getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT);\r\n            if (Objects.nonNull(assortment)) {\r\n                bases.addAll(getServices().getFilterBaseService().findAllByAssortmentAndDirectionAndDelete(assortment, Filterbase.ADD, false));\r\n                CompUtils.sortFilterBase(bases);\r\n            }\r\n            rightFilterGrid.setDataProvider(DataProvider.ofCollection(bases));\r\n            showExportPanels(getAccordion());\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The goToNext function is called when the user clicks on the &quot;Next&quot; button.\r\n     * It checks to see if there are any rows in the rightFilterGrid, and if so, it opens a ToREMOVECrumbDialog.\r\n     */\r\n    @Override\r\n    public void goToNext() {\r\n        checkBefore(() -> {\r\n            ToREMOVECrumbDialog dialog = new ToREMOVECrumbDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    /**\r\n     * The goToLast function is used to go to the last page of the grid.\r\n     * It does this by calling checkBefore, which checks if there are any filters applied and then calls a new FromADDToINDIVIDUALCrumpDialog object with getCtx() as its parameter.\r\n     * The dialog is then opened and run.\r\n     */\r\n    @Override\r\n    public void goToLast() {\r\n        checkBefore(() -> {\r\n            FromADDToINDIVIDUALCrumbDialog dialog = new FromADDToINDIVIDUALCrumbDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    /**\r\n     * The goFinish function is called when the user clicks on the &quot;Finish&quot; button.\r\n     * It checks if there are any articles in the right grid, and if so, it opens a dialog to save them to an assortment.\r\n     */\r\n    @Override\r\n    public void goFinish() {\r\n        checkBefore(() -> {\r\n            SaveArticlesToAssortmentDialog dialog = new SaveArticlesToAssortmentDialog(getCtx());\r\n            dialog.open();\r\n            dialog.run();\r\n        }, rightFilterGrid.getDataProvider());\r\n    }\r\n\r\n    // things to do Before Jump to individual Save'N'Finish\r\n\r\n    /**\r\n     * The doBeforeNext function is called before the next step in the wizard.\r\n     * In this case, it will add all articles to the filter that are not already there.\r\n     *\r\n     * @param CrumbProgressDialog dialog Update the progress bar and label\r\n     */\r\n    @Override\r\n    public void doBeforeNext(CrumbProgressDialog dialog) {\r\n        dialog.setLabel(TMS.setProof(FilterType.ZUORDNUNG_MATERIAL));\r\n        getServices().getFilterBaseUpdateService().addArticleByFilter(getCtx(), FilterType.ZUORDNUNG_MATERIAL, FilterStatus.ALL, FilterStatus.REMOVEBYFILTER);\r\n    }\r\n\r\n    /**\r\n     * The exit function is called when the user presses the exit button.\r\n     * It opens a dialog box that asks if they are sure they want to exit, and then exits if so.\r\n     */\r\n    @Override\r\n    public void exit() {\r\n        BreakDialog dialog = new BreakDialog(getCtx());\r\n        dialog.open();\r\n        dialog.run();\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\sortment\\ecat\\crumb\\FilterAddCrumb.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-tr68ymZFtXvsdXufooJyZY9S053AAhR2",
    "created" : 1762171616,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"multiple-dialogs-and-crumbs\",\n  \"issues\": [\n    {\n      \"severity\": \"High\",\n      \"problem\": \"UI updates performed from background Thread\",\n      \"justification\": \"Methods like DnDIndividualDialogAddNewArticles.load(), PromotionBuilderDialog.autoWork(), SaveArticlesToAssortmentDialog.load() start new Thread and later call UI methods (reloadCrumb, uiClose, setLabel) which must run on Vaadin UI thread, causing race conditions and possible UI exceptions.\",\n      \"action\": \"Replace raw Thread usage with UIsafe async execution (e.g., UI.access, Vaadin background tasks, or CompletableFuture). Ensure all UI component calls are wrapped in UI.getCurrent().access(). Add unit tests verifying UI thread confinement.\",\n      \"source\": \"DnDIndividualDialogAddNewArticles.load() line 3155; PromotionBuilderDialog.autoWork() line 74124; SaveArticlesToAssortmentDialog.load() line 5078\",\n      \"component\": \"dialog-layer\",\n      \"impact_scope\": \"prod-relevant, UI stability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Blocking UI thread with Thread.sleep\",\n      \"justification\": \"Sleep calls in PromotionBuilderDialog.load() and SaveArticlesToAssortmentDialog.load() halt the UI event thread, degrading user experience and can cause timeouts in the web container.\",\n      \"action\": \"Remove Thread.sleep; use nonblocking waiting mechanisms (e.g., ScheduledExecutorService) or progress indicators. Add integration tests to ensure UI remains responsive during long operations.\",\n      \"source\": \"PromotionBuilderDialog.load() line 8486; SaveArticlesToAssortmentDialog.load() line 7173\",\n      \"component\": \"dialog-layer\",\n      \"impact_scope\": \"performancecritical\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Constant 'valid' flag never changed in PromotionBuilderDialog\",\n      \"justification\": \"'private final boolean valid = false;' makes the conditional block that shows an error message unreachable, indicating dead code and possible logical bug.\",\n      \"action\": \"Replace with a mutable field or compute validity dynamically. Add unit test asserting correct error handling when no articles are present.\",\n      \"source\": \"PromotionBuilderDialog.load() line 5966\",\n      \"component\": \"promotion-builder\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Potential NullPointerException when accessing assortment or parameters\",\n      \"justification\": \"Several dialogs (e.g., DnDIndividualDialogAddRemoved, ToZinfoCrumpDialog) assume nonnull assortment, user, or parameters without checks, which can cause NPE if session state is incomplete.\",\n      \"action\": \"Add explicit null checks and fallback handling for getCtx().getUserSession().get(Params.ACTIVE_ASSORTMENT) and similar calls. Write tests covering missing session data scenarios.\",\n      \"source\": \"DnDIndividualDialogAddRemoved.load() line 3045; ToZinfoCrumpDialog.load() line 2836\",\n      \"component\": \"session-management\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Inconsistent exception handling in background threads\",\n      \"justification\": \"Background threads catch only specific exceptions (e.g., ArticleBaseQueueException) and silently ignore others, potentially losing error information and leaving UI in undefined state.\",\n      \"action\": \"Catch generic Exception in background tasks, log full stacktrace, and surface userfriendly error messages. Add tests verifying that unexpected exceptions are reported.\",\n      \"source\": \"DnDIndividualDialogAddNewArticles.load() line 3644; ToADDCrumbDialog.load() background thread line 231242\",\n      \"component\": \"error-handling\",\n      \"impact_scope\": \"securityrelevant (information leakage), reliability\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Magic strings for filter status and table names\",\n      \"justification\": \"Hardcoded strings like \\\"IN\\\" in SaveArticlesToAssortmentDialog and Table.getTemp(2) reduce maintainability and increase risk of typos.\",\n      \"action\": \"Replace with enum constants or constants defined in a central class. Add compiletime checks and unit tests for correct values.\",\n      \"source\": \"SaveArticlesToAssortmentDialog.load() line 4648; DnDIndividualDialogAddNewArticles.load() line 1822\",\n      \"component\": \"constants-management\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Potential memory leak with repeatedly recreated DataProvider instances\",\n      \"justification\": \"FileEditCrumb.reload() and delArticles() replace the DataProvider without disposing previous instances, which may retain references to large article lists.\",\n      \"action\": \"Reuse a single ListDataProvider and update its underlying collection, or explicitly clear old providers. Add profiling tests to detect memory growth during repeated edits.\",\n      \"source\": \"FileEditCrumb.reload() line 384392; delArticles() line 353361\",\n      \"component\": \"grid-data\",\n      \"impact_scope\": \"performancecritical\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Lack of input validation for numeric fields\",\n      \"justification\": \"Price fields are set directly from UI input without range or format validation, risking malformed data entering the database.\",\n      \"action\": \"Add binder validators for price fields (e.g., nonnegative, numeric format). Include unit tests for validation rules.\",\n      \"source\": \"FileEditCrumb.initGrid() price column binders line 247260\",\n      \"component\": \"file-edit\",\n      \"impact_scope\": \"securityrelevant (data integrity)\",\n      \"relations\": null,\n      \"evidence\": null\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"3\",\n    \"top_todos\": [\n      \"Migrate raw Thread usage to Vaadin UIsafe async mechanisms and remove Thread.sleep calls\",\n      \"Add proper null checks for session/assortment objects and improve exception handling in background tasks\",\n      \"Fix the immutable 'valid' flag in PromotionBuilderDialog and replace magic strings with constants\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to produce JSON for each file/Chunk? The instruction: \"Du analysierst jeweils einen Code-Chunk.\" Possibly produce one JSON per file? The output must be a single JSON object. Might need to combine issues across all provided files? Could choose one file identifier? Probably need to output for each file? But schema only has single \"file\" field. Could produce summary for each file? Could combine? Probably need separate JSON for each file, but rule says respond with a single JSON object. Could maybe set file to something like \"multiple files\" and list issues across all. We'll create issues from several files but limit to 10 total. Identify critical issues across files.\n\nLet's scan quickly for problems:\n\n1. DnDIndividualDialogAddNewArticles.load(): starts new Thread without handling UI thread safety. Access UI components from background thread (reloadCrumb(), uiClose()) may cause concurrency issues. Also catch only ArticleBaseQueueException; DoubleFoundException not caught, could propagate? But method declares throws both but thread swallow DoubleFoundException. Risk: unchecked exceptions lost. Also using Thread instead of executor, no interruption handling.\n\n2. DnDIndividualDialogAddRemoved: In load(), creates new Filterbase objects and sets many fields, but missing null checks for assortment maybe null. Also uses getParameter without checking null; potential NPE.\n\n3. PromotionBuilderDialog: field \"private final boolean valid = false;\" never changed, logic checks if(valid) then error; but valid always false => unreachable code. Also in load() catches many exceptions but logs only message, no user feedback. Also using Thread.sleep in UI thread? It's in load() which runs likely on UI thread, causing blocking.\n\n4. SaveArticlesToAssortmentDialog: Uses Thread.sleep again, blocking UI. Also uses articleService.findAllByFilterStatus with string \"IN\", maybe magic string. Also sets parameter with assortment but uses setParameter after saving? Potential concurrency.\n\n5. ToFileEditCrumb: many UI updates inside background thread? Some functions call UI.getCurrent().access correctly, but many others manipulate components directly from non-UI thread (e.g., buildFile runs in UI thread). Also potential memory leak: dataProvider re-created many times, not cleared. Also setDoubleFilter uses dataProvider.addFilter each time, may cause duplicate filters.\n\n6. FilterAddCrumb: uses DnDUtils.dragNdropToAdd with UI.getCurrent(), okay. Might have race condition with grid updates.\n\nOverall biggest issues: Thread usage causing UI thread violations, potential NPEs due to unchecked nulls, misuse of final boolean valid, blocking UI with Thread.sleep, missing exception handling.\n\nWe'll produce up to 10 issues.\n\nLet's craft JSON."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 1998,
      "prompt_tokens" : 25952,
      "total_tokens" : 27950
    },
    "timings" : {
      "cache_n" : 527,
      "prompt_n" : 25425,
      "prompt_ms" : 19137.906,
      "prompt_per_token_ms" : 0.75272,
      "prompt_per_second" : 1328.5152513550856,
      "predicted_n" : 1998,
      "predicted_ms" : 24133.534,
      "predicted_per_token_ms" : 12.078845845845846,
      "predicted_per_second" : 82.78936686189432
    }
  }
}