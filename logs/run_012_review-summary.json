{
  "timestamp" : "2025-11-03T13:01:05.0088809",
  "index" : 12,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\globalexclude\\GlobalExcludeView.java =====\n```\npackage com.hom.ebmw.view.admin.globalexclude;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.jpa.dao.impl.FilterBaseCustomRepository;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.ExcelUtils;\r\nimport com.hom.ebmw.utilities.constans.ASTConst;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.*;\r\nimport com.hom.ebmw.utilities.interfaces.HasPermission;\r\nimport com.hom.ebmw.view.BaseLayout;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.formlayout.FormLayout;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.component.upload.Upload;\r\nimport com.vaadin.flow.component.upload.receivers.MultiFileMemoryBuffer;\r\nimport com.vaadin.flow.data.binder.Binder;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\n\r\nimport java.util.*;\r\nimport java.util.stream.Collectors;\r\n\r\nimport static com.hom.ebmw.utilities.constans.ASTConst.FILTER_ADM;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_GLB_EXCLUDE;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_GLB_EXCLUDE;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_GLB_EXCLUDE, layout = MainView.class)\r\n@PageTitle(TITLE_GLB_EXCLUDE)\r\npublic class GlobalExcludeView extends BaseLayout implements HasPermission, FileInputLoader {\r\n\r\n    private String name;\r\n    private Importer importer = null;\r\n    private final Grid<Filter> filterGrid = new Grid<>();\r\n    private final GridPro<Filterbase> filterDetailGrid = new GridPro<>();\r\n    private Filter select = null;\r\n    private final Binder<Filter> binder = new Binder<>();\r\n    private ComboBox<ObjectType> assortmentBox;\r\n    private ComboBox<String> priorityBox;\r\n    private Div filterpart;\r\n    private final VerticalLayout box = new VerticalLayout();\r\n    private final FormLayout form = new FormLayout();\r\n    private Button editBtn = null;\r\n    private ImageButton saveBtn = null;\r\n    private Button deleteBtn = null;\r\n    private Button addBtn = null;\r\n    private ObjectType type = null;\r\n    private final Context ctx = new Context();\r\n\r\n    private UI ui = null;\r\n\r\n    /**\r\n     * The GlobalExcludeView function is the constructor for the GlobalExcludeView class.\r\n     * It sets up all of the components that will be displayed on this view, including:\r\n     * - The left section (which contains a list of all global exclusions)\r\n     * - The middle section (which contains a form to add new global exclusions)\r\n     *\r\n     * @param Services    services Get the userservices object\r\n     * @param UserSession uSession Get the current user session\r\n     * @return The globalexcludeview object\r\n     */\r\n    public GlobalExcludeView(Services services, UserSession uSession) {\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.USER_SESSION, uSession);\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n\r\n        ctx.getUserSession().put(Params.ACTIVE_BREADBOX, this);\r\n        ui = UI.getCurrent();\r\n        if (Objects.isNull(ui)) {\r\n            ui = ctx.getUserSession().get(Params.ACTIVE_UI);\r\n        }\r\n\r\n        setLeftSection();\r\n        setMiddleSection();\r\n        setRightVisible(false);\r\n        importer.setVisible(false);\r\n\r\n        reload();\r\n    }\r\n\r\n    /**\r\n     * The setLeftSection function is responsible for setting up the left section of the FilterView.\r\n     * It sets up a TextField that allows users to search through their filters, and it also sets up\r\n     * a Grid that displays all of the user's filters. The Grid has two columns: one for filter names,\r\n     * and one for filter types (i.e., &quot;Exclude&quot; or &quot;Include&quot;). When a user clicks on an item in this\r\n     * grid, its details are displayed in the right section of this view (see setRightSection). This\r\n     * function also adds an Importer object to allow users to\r\n     */\r\n    private void setLeftSection() {\r\n        binder.setBean(defaultFilter());\r\n\r\n        TextField searchFld = new TextField();\r\n        searchFld.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Filter> listProvider = (ListDataProvider<Filter>) filterGrid.getDataProvider();\r\n            listProvider.setFilter(Filter::getName, filterName -> {\r\n                String nameLower = filterName == null ? \"\" : filterName.toLowerCase(Locale.ENGLISH);\r\n                String filterLower = searchFld.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n        });\r\n\r\n        filterGrid.addSelectionListener(event -> {\r\n            Optional<Filter> optFilter = event.getFirstSelectedItem();\r\n            optFilter.ifPresent(filter -> {\r\n                binder.setBean(filter);\r\n                this.type = filter.getSortType();\r\n                reloadDetailFilter(filter);\r\n                box.setEnabled(false);\r\n                filterpart.setEnabled(true);\r\n                deleteBtn.setVisible(true);\r\n                editBtn.setEnabled(true);\r\n                saveBtn.setEnabled(false);\r\n                addBtn.setVisible(true);\r\n                importer.setVisible(true);\r\n            });\r\n        });\r\n\r\n        importer = new Importer();\r\n        importer.setEnabled(false);\r\n        importer.getUploader().addSucceededListener(event -> {\r\n            FileImportDialog dialog = new FileImportDialog(ctx, event,\r\n                    importer.getMemoryFileBuffer(), this);\r\n            dialog.open();\r\n            dialog.execute();\r\n        });\r\n\r\n        filterGrid.addColumn(Filter::getNameWithPrefix)\r\n                .setHeader(getTranslation(TMS.GLB_EXCLUDE_GRID_NAME, getLocale(), ctx));\r\n        filterGrid.setHeight(\"100%\");\r\n        getLeftSection().add(searchFld, filterGrid);\r\n    }\r\n\r\n    /**\r\n     * The setSaveBtn function creates a new ImageButton object, which is then set to be enabled.\r\n     * The button's click listener is then set to validate the binder and check if it is valid.\r\n     * If the binder is valid, a User object representing the current user in session will be created.\r\n     * Then, resetRightGrid() will be called and select will become equal to whatever bean was bound by the binder.\r\n     * The date of this bean (which represents a Filter) will also be set using information from user (the current user).\r\n     * A Role object representing an active role in session will also be\r\n     *\r\n     * @return An imagebutton\r\n     */\r\n    private ImageButton setSaveBtn() {\r\n        ImageButton button = new ImageButton(CompUtils.getSaveFloppy(ctx), CompUtils.getDisableSaveFloppy(ctx));\r\n        button.setEnabled(true);\r\n        button.addClickListener(event -> {\r\n            button.setEnabled(false);\r\n            binder.validate();\r\n            if (binder.isValid()) {\r\n\r\n                User user = ctx.getSession().getCurrentUser(ctx);\r\n\r\n                resetRightGrid();\r\n                select = binder.getBean();\r\n                select.setDate(user);\r\n                Role role = ctx.getSession().get(SessionParams.ACTIVE_ROLE);\r\n                if (Objects.isNull(role)) {\r\n                    Optional<Role> optRole = ctx.getServices().getRoleService().findByName(\"admin\");\r\n                    if (optRole.isPresent()) {\r\n                        role = optRole.get();\r\n                    }\r\n                }\r\n                select.setTeam(role);\r\n                select.setGlobal(4);\r\n                // create Filter ID\r\n                select = ctx.getServices().getFilterService().save(select);\r\n                reload();\r\n                importer.setVisible(true);\r\n                box.setEnabled(false);\r\n                editBtn.setEnabled(true);\r\n                deleteBtn.setVisible(true);\r\n                addBtn.setVisible(true);\r\n            }\r\n        });\r\n        return button;\r\n    }\r\n\r\n    /**\r\n     * The setReloadBtn function creates a button with the VaadinIcon.REFRESH icon and adds a click listener to it that reloads the grid when clicked.\r\n     *\r\n     * @return A button with a reload icon\r\n     */\r\n    private Button setReloadBtn() {\r\n        Button button = new Button(VaadinIcon.REFRESH.create());\r\n        button.addClickListener(event -> {\r\n            reload();\r\n            filterpart.setEnabled(true);\r\n        });\r\n        return button;\r\n    }\r\n\r\n    /**\r\n     * The setDeleteBtn function creates a button that allows the user to delete a filter.\r\n     *\r\n     * @return A button\r\n     */\r\n    private Button setDeleteBtn() {\r\n        Button button = new Button(VaadinIcon.CLOSE.create());\r\n        button.setVisible(false);\r\n        button.addClickListener(event -> {\r\n            if (Objects.isNull(select)) {\r\n                select = binder.getBean();\r\n            }\r\n\r\n            User user = ctx.getSession().getCurrentUser(ctx);\r\n            select.setDelete(user);\r\n            ctx.getServices().getFilterService().save(select);\r\n            select = null;\r\n            deleteBtn.setVisible(false);\r\n            editBtn.setEnabled(false);\r\n            saveBtn.setEnabled(true);\r\n            box.setEnabled(true);\r\n            binder.setBean(defaultFilter());\r\n            reload();\r\n            reloadDetailFilter(select);\r\n        });\r\n        return button;\r\n    }\r\n\r\n    /**\r\n     * The setAddBtn function creates a new button with the VaadinIcon.PLUS icon, and sets it to invisible.\r\n     * It then adds a click listener that will set the select variable to null, create a new Filter object using\r\n     * defaultFilter(), find an optional Role object with id 1 (the ADMIN role), and set nFilter's team field equal\r\n     * to this Role object. The binder is then set equal to nFilter, editBtn is disabled, saveBtn is enabled, deleteBtn\r\n     * becomes invisible (since we are creating a new filter), box becomes enabled again so that users can\r\n     *\r\n     * @return A button\r\n     */\r\n    private Button setAddBtn() {\r\n        Button button = new Button(VaadinIcon.PLUS.create());\r\n        button.setVisible(false);\r\n        button.addClickListener(event -> {\r\n            select = null;\r\n            Filter nFilter = defaultFilter();\r\n            Optional<Role> optRole = ctx.getServices().getRoleService().findById(1); // ADMIN role\r\n            nFilter.setTeam(optRole.get()); // ADM\r\n            binder.setBean(nFilter);\r\n            editBtn.setEnabled(false);\r\n            saveBtn.setEnabled(true);\r\n            deleteBtn.setVisible(false);\r\n            box.setEnabled(true);\r\n            importer.setVisible(false);\r\n            filterDetailGrid.setDataProvider(DataProvider.ofCollection(new ArrayList<Filterbase>()));\r\n        });\r\n        return button;\r\n    }\r\n\r\n    /**\r\n     * The setEditBtn function creates a button with the pencil icon.\r\n     * The button is disabled by default, and when clicked it enables the deleteBtn, saveBtn and box while disabling itself.\r\n     *\r\n     * @return A button\r\n     */\r\n    private Button setEditBtn() {\r\n        Button button = new Button(VaadinIcon.PENCIL.create());\r\n        button.setEnabled(false);\r\n        button.addClickListener(event -> {\r\n            editBtn.setEnabled(false);\r\n            deleteBtn.setVisible(true);\r\n            saveBtn.setEnabled(true);\r\n            box.setEnabled(true);\r\n            filterpart.setEnabled(false);\r\n        });\r\n        return button;\r\n    }\r\n\r\n    /**\r\n     * The setMiddleSection function is responsible for setting up the middle section of the page.\r\n     * It does this by creating a HorizontalLayout called headValues, which will contain all of the buttons that are used to manipulate filters.\r\n     * The function then creates a TextField called nameTxt, and sets it as required.  It also binds nameTxt to Filter's getName and setName functions using binder.forField().\r\n     * The function then calls setSaveBtn(), setReloadBtn(), setDeleteBtn(), and setAddBtn() in order to create their respective buttons, save them into variables, and add\r\n     */\r\n    private void setMiddleSection() {\r\n        HorizontalLayout headValues = new HorizontalLayout();\r\n\r\n        TextField nameTxt = new TextField();\r\n        nameTxt.setRequired(true);\r\n\r\n        binder.forField(nameTxt)\r\n                .withValidator(item -> !item.isEmpty(),\r\n                        getTranslation(TMS.ERROR_VALIDATION_NOT_EMPTY, ctx.getSession().getLocale(ctx), ctx))\r\n                .withValidator(item -> CompUtils.checkIfProfilNameExists(ctx, binder.getBean(), item),\r\n                        getTranslation(TMS.ERROR_VALIDATION_NAME_EXISTS, getLocale(), ctx))\r\n                .bind(Filter::getName, Filter::setName);\r\n\r\n        saveBtn = setSaveBtn();\r\n        Button reloadBtn = setReloadBtn();\r\n        deleteBtn = setDeleteBtn();\r\n        addBtn = setAddBtn();\r\n        editBtn = setEditBtn();\r\n\r\n        setPrioritybox();\r\n        setRadioInAssortment();\r\n        setFilterDetailGrd();\r\n\r\n        form.addFormItem(nameTxt, getTranslation(TMS.GLB_EXCLUDE_FORM_NAME, ctx.getSession().getLocale(ctx), ctx));\r\n        form.addFormItem(priorityBox,\r\n                getTranslation(TMS.GLB_EXCLUDE_FORM_VISIBLE_FOR, ctx.getSession().getLocale(ctx), ctx));\r\n        form.addFormItem(assortmentBox,\r\n                getTranslation(TMS.GLB_EXCLUDE_FORM_ASSORTMENT_TYPE, ctx.getSession().getLocale(ctx), ctx));\r\n        form.setWidth(\"50%\");\r\n\r\n        Checkbox activeBox = new Checkbox(getTranslation(TMS.PROFIL_USE_AS_TEMPLATE, getLocale(), ctx));\r\n        binder.forField(activeBox).bind(Filter::isActive, Filter::setActive);\r\n\r\n        box.add(form, activeBox);\r\n        HorizontalLayout headline = new HorizontalLayout();\r\n        headline.add(box, importer);\r\n        filterpart = new Div();\r\n        filterpart.setWidth(\"100%\");\r\n        filterpart.setHeight(\"90%\");\r\n\r\n        DownloadButton downloadBtn = new DownloadButton(ctx, TMS.GLB_EXCLUDE_DOWNLOAD_TOOLTIP);\r\n        downloadBtn.reloadAsFile(() -> {\r\n            String result = \"unknown-file\";\r\n\r\n            if (Objects.nonNull(select)) {\r\n                result = select.getNameWithPrefix();\r\n            } else {\r\n                if (Objects.nonNull(binder.getBean())) {\r\n                    result = binder.getBean().getNameWithPrefix();\r\n                    result = (result.isEmpty() ? \"unknown-file\" : result);\r\n                }\r\n            }\r\n\r\n            return result + \".xlsx\";\r\n        }, () -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<Filterbase> dataProvider = (ListDataProvider<Filterbase>) filterDetailGrid\r\n                    .getDataProvider();\r\n            List<Filterbase> items = new ArrayList<>();\r\n            items.addAll(dataProvider.getItems());\r\n            String result = \"Exclude\";\r\n\r\n            return ExcelUtils.writeExcelFileOfFilterbaseExclude(ctx, items, ASTConst.DEFAULT, result);\r\n        });\r\n\r\n        headValues.add(saveBtn, editBtn, reloadBtn, deleteBtn, downloadBtn, addBtn);\r\n        getMiddleSection().add(headline, headValues);\r\n        filterpart.add(filterDetailGrid);\r\n        getMiddleSection().add(filterpart);\r\n    }\r\n\r\n    /**\r\n     * The setPrioritybox function sets the priorityBox ComboBox to a new ComboBox.\r\n     * It then sets the clear button visible, adds items to it, and makes it read only.\r\n     */\r\n    private void setPrioritybox() {\r\n        priorityBox = new ComboBox<>();\r\n        priorityBox.setClearButtonVisible(true);\r\n        priorityBox.setItems(FILTER_ADM);\r\n        priorityBox.setItemLabelGenerator(item -> item.replace(\"_\", \"\"));\r\n        priorityBox.setRequired(true);\r\n        priorityBox.setReadOnly(true);\r\n        priorityBox.setValue(FILTER_ADM);\r\n    }\r\n\r\n    /**\r\n     * The setRadioInAssortment function sets the assortmentBox ComboBox to have three options: ECAT, IMPEX, and PROMOTION.\r\n     * The function also binds the assortmentBox ComboBox to a Filter object's sortType property.\r\n     */\r\n    private void setRadioInAssortment() {\r\n        assortmentBox = new ComboBox<>();\r\n        assortmentBox.setItems(ObjectType.ECAT, ObjectType.IMPEX, ObjectType.PROMOTION);\r\n        assortmentBox.setValue(ObjectType.ECAT);\r\n        assortmentBox.setItemLabelGenerator(ObjectType::name);\r\n        binder.forField(assortmentBox).bind(Filter::getSortType, Filter::setSortType);\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to refresh the data in the filterGrid.\r\n     * It does this by first getting a list of all filters from the database,\r\n     * then filtering out any filters that are not prefixed with &quot;ADM&quot; and have no deleteBy value.\r\n     * Finally, it sets the data provider for filterGrid to be a DataProvider object containing these filtered values.\r\n     */\r\n    private void reload() {\r\n        List<Filter> filters = ctx.getServices().getFilterService().findAll();\r\n        filters = filters.stream()\r\n                .filter(item -> item.getPrefix().equals(FILTER_ADM) && Objects.isNull(item.getDeleteBy()))\r\n                .collect(Collectors.toList());\r\n        filterGrid.setDataProvider(DataProvider.ofCollection(filters));\r\n    }\r\n\r\n    /**\r\n     * The reloadDetailFilter function is called when the user clicks on a filter in the Filter Grid.\r\n     * It takes as input a Filter object, and it returns nothing.\r\n     * The function first creates an empty ArrayList of type Filterbase, which will be used to store all of the filters that are children of the selected filter.\r\n     * If there is actually a selected filter (i.e., if Objects.nonNull(filter) evaluates to true), then we proceed with finding all child filters for this parent filter:  We first find all non-deleted filters whose parent_id field matches that of our selected parent; then we add each\r\n     *\r\n     * @param Filter filter Filter the list of filters\r\n     */\r\n    private void reloadDetailFilter(Filter filter) {\r\n        ui.access(() -> {\r\n            List<Filterbase> result = new ArrayList<>();\r\n            if (Objects.nonNull(filter)) {\r\n                List<Filterbase> filters = ctx.getServices().getFilterBaseService().findAllByFilterAndDelete(select, false);\r\n                filters.forEach(item -> result.addAll(ctx.getServices().getFilterBaseService().findAllByParentAndDelete(item, false)));\r\n                CompUtils.sortFilterBase(filters);\r\n            }\r\n            filterDetailGrid.setDataProvider(DataProvider.ofCollection(result));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setFilterDetailGrd function sets the filterDetailGrid to have an editable column for the identifier,\r\n     * a non-editable column for the type, and sets its width and height. It also allows multiple selections.\r\n     */\r\n    private void setFilterDetailGrd() {\r\n        filterDetailGrid.addEditColumn(Filterbase::getIdentifier).text((item, newValue) -> {\r\n            item.setIdentifier(newValue);\r\n            item.setLabel(newValue);\r\n        });\r\n        filterDetailGrid.addColumn(Filterbase::getType);\r\n        filterDetailGrid.setWidthFull();\r\n        filterDetailGrid.setHeight(\"98.95%\");\r\n        filterDetailGrid.setSelectionMode(SelectionMode.MULTI);\r\n    }\r\n\r\n    /**\r\n     * The resetRightGrid function is called when the user selects a new filter from the left grid.\r\n     * It resets the right grid to display only those filters that are associated with that particular filter.\r\n     */\r\n    private void resetRightGrid() {\r\n        Filter filterBean = binder.getBean();\r\n        if (Objects.nonNull(select))\r\n            type = select.getSortType();\r\n\r\n        if (filterBean.getId() != 0 && !type.equals(filterBean.getSortType())) {\r\n            final FilterBaseCustomRepository customService = ctx.getServices().getFilterBaseCustomService();\r\n            customService.removeByFilter(filterBean);\r\n            reloadDetailFilter(filterBean);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the necessary components to the FileImportDialog.\r\n     * The function takes a FileImportDialog as an argument, and adds a JComboBox with the name &quot;ArticleNr&quot;\r\n     * and sets it's editable property to true. This allows for manual input of article numbers in case they are not present in the file being imported.\r\n     *\r\n     * @param FileImportDialog dialog Add the fields that are to be used in the import\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(\"ArticleNr\", true);\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * The function first creates a new Filterbase object, which will be used as a parent for all of\r\n     * the filters that are imported from an Excel file. Then it creates a Map&lt;String, Filterbase&gt; object\r\n     * named doubles to store all of these filters and their corresponding identifiers (which are stored as keys).\r\n     * Next it iterates through each row in dialog's table and calls setFilterBaseChild() on each row to create\r\n     * child filter objects for every identifier found in that row.\r\n     *\r\n     * @param FileImportDialog dialog Get the table from the dialog\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        ui.access(() -> {\r\n\r\n            List<Filterbase> filters = new ArrayList<>();\r\n            Filter filter = binder.getBean();\r\n\r\n            Filterbase parent = new Filterbase();\r\n            parent.setIdentifier(FilterType.INDIVIDUAL_ADM.name());\r\n            parent.setType(FilterType.INDIVIDUAL_ADM);\r\n            parent.setDirection(Filterbase.REMOVE_INDIVIDUAL);\r\n            parent.setLabel(filter.getName());\r\n            parent.setEntityIdentifier(parent.getIdentifier() + \"#\" + parent.getType() + \"#F\" + filter.getId());\r\n            parent.setFilter(filter);\r\n\r\n            Map<String, Filterbase> doubles = new HashMap<>();\r\n            dialog.getTable().forEach(row -> {\r\n                Filterbase child = setFilterBaseChild(row, dialog);\r\n                doubles.put(child.getIdentifier(), child);\r\n            });\r\n            doubles.forEach((k, v) -> filters.add(v));\r\n\r\n            filters.forEach(child -> {\r\n                child.setParent(parent);\r\n                child.setLabel(child.getIdentifier());\r\n                child.setEntityIdentifier(child.getIdentifier() + \"#\" + child.getType() + \"#F\" + filter.getId());\r\n            });\r\n\r\n            if (!filters.isEmpty()) {\r\n                dialog.removeAll();\r\n                dialog.init();\r\n\r\n                ctx.getServices().getFilterService().save(filter);\r\n                ctx.getServices().getFilterBaseService().save(parent);\r\n                final FilterBaseCustomRepository customService = ctx.getServices().getFilterBaseCustomService();\r\n                customService.insertFilterInFilterBase(filters);\r\n                reloadDetailFilter(filter);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setFilterBaseChild function is a helper function that sets the child filterbase for the individual admixture\r\n     * filter. It takes in a map of integers to strings, and an instance of FileImportDialog as parameters. The map contains\r\n     * column numbers mapped to their corresponding column names, while the dialog parameter is used to get information about\r\n     * which columns are being used by this particular filter. The function returns an instance of Filterbase with its\r\n     * identifier set according to what was selected in the file import dialog box (the first column), and its type set\r\n     * according to whether or not it's removing individuals from analysis or keeping them\r\n     *\r\n     * @param Map&lt;Integer   Set the column number and the string parameter is used to set the name of that column\r\n     * @param String&gt;       colString Get the column names from the file\r\n     * @param FileImportDialog dialog Get the column names and values\r\n     * @return A filterbase object\r\n     */\r\n    private Filterbase setFilterBaseChild(Map<Integer, String> colString, FileImportDialog dialog) {\r\n        Filterbase child = new Filterbase();\r\n        if (dialog.getColumns()[0] > -1) {\r\n            child.setIdentifier(dialog.getColumnsByIdx(colString, 0));\r\n            child.setType(FilterType.INDIVIDUAL_ADM);\r\n            child.setDirection(Filterbase.REMOVE_INDIVIDUAL);\r\n            child.setLabel(name);\r\n        }\r\n        return child;\r\n    }\r\n\r\n    /**\r\n     * The setFilterBaseChild function is used to create a new Filterbase object that will be added to the list of children\r\n     * for this filter. The function takes an ArticleBase object as input and uses its articleNr field as the identifier for\r\n     * the child. It sets type, direction, and label fields based on values from this class's fields.\r\n     *\r\n     * @param ArticleBase article Get the article number of the article\r\n     * @return A filterbase object\r\n     */\r\n    private Filterbase setFilterBaseChild(ArticleBase article) {\r\n        Filterbase child = new Filterbase();\r\n\r\n        child.setIdentifier(article.getArticleNr());\r\n        child.setType(FilterType.INDIVIDUAL_ADM);\r\n        child.setDirection(Filterbase.REMOVE_INDIVIDUAL);\r\n        child.setLabel(name);\r\n\r\n        return child;\r\n    }\r\n\r\n    /**\r\n     * The directSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It takes a list of ArticleBase objects, which are created from each row in an Excel file that was uploaded by\r\n     * a user. The function then creates Filterbase objects for each ArticleBase object and adds them to a list of filters.\r\n     * Then it sets up parent-child relationships between these filters and saves them to the database using services provided by\r\n     * ContextHolder class (which provides access to all services). Finally, it reloads detailFilter with new data from database.\r\n     *\r\n     * @param FileImportDialog dialog Remove the dialog after saving\r\n     * @param final            List&lt;ArticleBase&gt; articles Save the articles in the database\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, final List<ArticleBase> articles) {\r\n\r\n        List<ArticleBase> basic = articles;\r\n        List<Filterbase> filters = new ArrayList<>();\r\n        Filter filter = binder.getBean();\r\n\r\n        Filterbase parent = new Filterbase();\r\n        parent.setIdentifier(FilterType.INDIVIDUAL_ADM.name());\r\n        parent.setType(FilterType.INDIVIDUAL_ADM);\r\n        parent.setDirection(Filterbase.REMOVE_INDIVIDUAL);\r\n        parent.setLabel(filter.getName());\r\n        parent.setEntityIdentifier(parent.getIdentifier() + \"#\" + parent.getType() + \"#F\" + filter.getId());\r\n        parent.setFilter(filter);\r\n\r\n        Map<String, Filterbase> doubles = new HashMap<>();\r\n        basic.forEach(row -> {\r\n            Filterbase child = setFilterBaseChild(row);\r\n            doubles.put(child.getIdentifier(), child);\r\n        });\r\n        doubles.forEach((k, v) -> filters.add(v));\r\n\r\n        filters.forEach(child -> {\r\n            child.setParent(parent);\r\n            child.setLabel(child.getType());\r\n            child.setEntityIdentifier(child.getIdentifier() + \"#\" + child.getType() + \"#F\" + filter.getId());\r\n        });\r\n        ui.access(() -> {\r\n            if (!filters.isEmpty()) {\r\n                dialog.removeAll();\r\n                dialog.init();\r\n\r\n                ctx.getServices().getFilterService().save(filter);\r\n                ctx.getServices().getFilterBaseService().save(parent);\r\n                final FilterBaseCustomRepository customService = ctx.getServices().getFilterBaseCustomService();\r\n                customService.insertFilterInFilterBase(filters);\r\n\r\n                reloadDetailFilter(filter);\r\n\r\n            }\r\n        });\r\n    }\r\n\r\n    private class Importer extends VerticalLayout {\r\n\r\n        private final Upload uploader;\r\n        private final MultiFileMemoryBuffer memoryFileBuffer;\r\n\r\n        /**\r\n         * The Importer function is a constructor for the Importer class.\r\n         * It creates an instance of the MultiFileMemoryBuffer class, and then uses that to create an instance of the Upload class.\r\n         * The Upload object is then made visible on screen.\r\n         *\r\n         * @return A memory file buffer\r\n         */\r\n        public Importer() {\r\n            memoryFileBuffer = new MultiFileMemoryBuffer();\r\n            uploader = new Upload(memoryFileBuffer);\r\n            uploader.setVisible(true);\r\n\r\n            add(uploader);\r\n        }\r\n\r\n        /**\r\n         * The getUploader function returns the uploader object.\r\n         *\r\n         * @return The uploader\r\n         */\r\n        public Upload getUploader() {\r\n            return uploader;\r\n        }\r\n\r\n        /**\r\n         * The getMemoryFileBuffer function returns the memoryFileBuffer object.\r\n         *\r\n         * @return The memoryfilebuffer object\r\n         */\r\n        public MultiFileMemoryBuffer getMemoryFileBuffer() {\r\n            return memoryFileBuffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The defaultFilter function creates a new Filter object and sets the sortType to ObjectType.ECAT,\r\n     * the date to the current user's date, and global to 4. It then returns this filter object.\r\n     *\r\n     * @return A filter object\r\n     */\r\n    private Filter defaultFilter() {\r\n        Filter filter = new Filter();\r\n        filter.setSortType(ObjectType.ECAT);\r\n        filter.setDate(ctx.getSession().getCurrentUser(ctx));\r\n        filter.setGlobal(4);\r\n        return filter;\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\globalexclude\\GlobalExcludeView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\CustomerLanguage_SPGrid.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid;\r\n\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.jpa.model.ArticleBase;\r\nimport com.hom.ebmw.jpa.model.LocalCustomer;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.jpa.model.SettingParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.CustomerLanguage;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.HeaderRow;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.*;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class CustomerLanguage_SPGrid extends SettingParameterGrid<CustomerLanguage> implements FileInputLoader {\r\n\r\n    private final List<LocalCustomer> currentCustomers;\r\n    private final List<Language> currentLanguages;\r\n\r\n    /**\r\n     * The CustomerLanguage_SPGrid function is a constructor for the CustomerLanguage_SPGrid class.\r\n     * It takes in two parameters: ctx and setting.\r\n     * The function creates a grid that displays all of the customers and their languages, as well as buttons to add new customers or delete existing ones.\r\n     *\r\n     * @param Context ctx Get the services from the context\r\n     * @param Setting setting Set the setting for this grid\r\n     * @return A grid with a column for each customer and their language\r\n     */\r\n    public CustomerLanguage_SPGrid(Context ctx, Setting setting) {\r\n        super(ctx, setting);\r\n\r\n        currentCustomers = ctx.getServices().getLocalCustomerCustomService().findAll();\r\n        currentLanguages = ctx.getServices().getEnumerationService().getAllLanguages();\r\n\r\n        Column<SettingParameter<CustomerLanguage>> first = addComponentColumn(item -> {\r\n            final String customerId = item.getParam();\r\n            item.getValue().getCustomer().setCustomerId(customerId);\r\n            Optional<LocalCustomer> customerItem = currentCustomers.stream().filter(filter -> filter.getCustomerId().equals(customerId)).findFirst();\r\n\r\n            LocalCustomer selected = item.getValue().getCustomer();\r\n            if (customerItem.isPresent()) {\r\n                selected = customerItem.get();\r\n            }\r\n            HorizontalLayout result = new HorizontalLayout();\r\n            result.setWidthFull();\r\n            CompUtils.removeMSP(result, \"MP\");\r\n\r\n            CustomerLanguage object = item.getValue();\r\n\r\n            ComboBox<LocalCustomer> customerBox = new ComboBox<>();\r\n            customerBox.setItems(currentCustomers);\r\n            customerBox.setItemLabelGenerator(label -> \"(\" + label.getCustomerId() + \") \" + label.getName());\r\n\r\n            customerBox.setValue(selected);\r\n            customerBox.setWidth(\"77.5%\");\r\n\r\n            ComboBox<Language> languageBox = new ComboBox<>();\r\n            languageBox.setItems(currentLanguages);\r\n            languageBox.setItemLabelGenerator(\r\n                    lang -> Locale.forLanguageTag(lang.getLabel()).getDisplayLanguage(Locale.GERMANY));\r\n            languageBox.setValue(object.getLanguage());\r\n            languageBox.setWidth(\"17.5%\");\r\n\r\n            ImageButton imgBtn = new ImageButton(CompUtils.getSaveFloppy(ctx), CompUtils.getDisableSaveFloppy(ctx));\r\n            imgBtn.addClickListener(event -> {\r\n                object.setCustomer(customerBox.getValue());\r\n                object.setLanguage(languageBox.getValue());\r\n                item.setValue(object);\r\n                item.setParam(object.getCustomer().getCustomerId());\r\n                if (item.getDisplayOrder() == -1)\r\n                    item.setDisplayOrder(getSettingParams().size());\r\n                save(item);\r\n                reload();\r\n            });\r\n            imgBtn.setWidth(\"2em\");\r\n\r\n            result.add(customerBox, languageBox, imgBtn);\r\n            return result;\r\n        }).setHeader(\"\");\r\n\r\n        first.setSortable(true);\r\n        first.setComparator((item1, item2) -> item1.getParam().compareTo(item2.getParam()));\r\n\r\n        HeaderRow head = this.getDefaultHeaderRow();\r\n\r\n        HorizontalLayout box = new HorizontalLayout();\r\n        CompUtils.removeMSP(box, \"MP\");\r\n        TextField searchCustomerFld = new TextField();\r\n        searchCustomerFld.setWidth(\"75%\");\r\n        searchCustomerFld.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<CustomerLanguage>> dataProvider = (ListDataProvider<SettingParameter<CustomerLanguage>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                LocalCustomer customer = item.getValue().getCustomer();\r\n                String text = (\"(\" + item.getParam() + \") \" + customer.getName()).toLowerCase(Locale.ENGLISH);\r\n                String search = event.getValue().toLowerCase(Locale.ENGLISH);\r\n                return text.contains(search);\r\n            });\r\n        });\r\n\r\n        ComboBox<Language> langBox = new ComboBox<Language>();\r\n        List<Language> langs = ctx.getServices().getEnumerationService().getAllLanguages();\r\n        Language reset = new Language();\r\n        reset.setKey(\"-1\");\r\n        reset.setLabel(\"RESET\");\r\n        langs.add(reset);\r\n        Language nullLang = new Language();\r\n        nullLang.setKey(\"0\");\r\n        nullLang.setLabel(\"NULL\");\r\n        langs.add(nullLang);\r\n        langBox.setItems(langs);\r\n        langBox.setItemLabelGenerator(item -> {\r\n            if (item.getLabel().equals(\"RESET\"))\r\n                return \"-RESET-\";\r\n            else if (item.getLabel().equals(\"NULL\"))\r\n                return \"NULL\";\r\n            else\r\n                return Locale.forLanguageTag(item.getLabel()).getDisplayLanguage(getLocale());\r\n        });\r\n        langBox.setAllowCustomValue(false);\r\n        langBox.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<CustomerLanguage>> dataProvider = (ListDataProvider<SettingParameter<CustomerLanguage>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                Language lang = item.getValue().getLanguage();\r\n                Language search = event.getValue();\r\n                if (search.getLabel().equals(\"RESET\")) {\r\n                    return true;\r\n                } else if (search.getLabel().equals(\"NULL\")) {\r\n                    return Objects.isNull(lang);\r\n                } else {\r\n                    if (Objects.nonNull(lang)) {\r\n                        Locale data = Locale.forLanguageTag(lang.getLabel());\r\n                        Locale searchL = Locale.forLanguageTag(search.getLabel());\r\n                        return data.getLanguage().equals(searchL.getLanguage());\r\n                    } else {\r\n                        return false;\r\n                    }\r\n                }\r\n            });\r\n        });\r\n        langBox.setWidth(\"25%\");\r\n\r\n        box.add(searchCustomerFld, langBox);\r\n        head.getCell(first).setComponent(box);\r\n    }\r\n\r\n    /**\r\n     * The setEmptyRow function is used to add an empty row to the table.\r\n     * This allows for a user to add a new entry into the database without having\r\n     * to navigate away from the page they are currently on. The function first creates\r\n     * a SettingParameter object, which contains all of the information needed by JSF in order\r\n     * to display and manipulate data within a table. It then sets this object's value field equal to null, so that it will be displayed as an empty row in our table. Next, it sets its setting field equal to getSetting(), which returns our current setting (in this\r\n     */\r\n    @Override\r\n    public void setEmptyRow() {\r\n        SettingParameter<CustomerLanguage> params = new SettingParameter<CustomerLanguage>();\r\n        CustomerLanguage object = new CustomerLanguage();\r\n        object.setCustomer(null);\r\n        object.setLanguage(null);\r\n        params.setValue(object);\r\n        params.setSetting(getSetting());\r\n        params.setDisplayOrder(-1);\r\n        if (Objects.isNull(getSettingParams()) || getSettingParams().isEmpty()) {\r\n            setSettingParams(new ArrayList<SettingParameter<CustomerLanguage>>());\r\n            getSettingParams().add(0, params);\r\n        } else if (getSettingParams().get(0).getDisplayOrder() != -1) {\r\n            getSettingParams().add(0, params);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The onSave function is called when the user clicks on the &quot;Save&quot; button.\r\n     * It saves the selected language to a setting parameter, which can be accessed by other classes.\r\n     */\r\n    @Override\r\n    public void onSave() {\r\n        List<SettingParameter<CustomerLanguage>> selected = getSelectedParameters();\r\n        if (Objects.nonNull(selected) && !selected.isEmpty()) {\r\n            getSetting().setValue(selected.get(0).getParam());\r\n            getCtx().getServices().getSettingServices().save(getSetting());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is called by the FileImportDialog class when it is\r\n     * instantiated. It adds a checkbox for each of the fields that are to be imported,\r\n     * and sets them all to true (checked) by default. The user can then uncheck any\r\n     * fields they do not wish to import. This function also calls addValueCbx() on\r\n     * the dialog object, which creates a new checkbox with text corresponding to each field name in TMS.java, and adds it as an item in the dialog box's layout gridbaglayout object (which was created in FileImportDialog).\r\n     *\r\n     * @param FileImportDialog dialog Add the fields to the dialog\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CUSTOMER_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_LANGUAGE, true);\r\n    }\r\n\r\n    /**\r\n     * The directSave function is used to save the articles directly into the database.\r\n     * This function is called when a user selects &quot;Save&quot; from the FileImportDialog.\r\n     *\r\n     * @param FileImportDialog        dialog Display the progress of the import\r\n     * @param List&lt;ArticleBase&gt; articles Pass the list of articles to be saved\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It takes a single argument, which is an instance of FileImportDialog.\r\n     * The function iterates through each row in the table and calls getSettingParameter to create a SettingParameter object for that row.\r\n     * If this object exists, it saves it using SettingParameterService's save method.\r\n     *\r\n     * @param FileImportDialog dialog Get the table from the dialog\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        Setting current = SettingUtils.getSettingByType(getCtx(), SettingType.CUSTOMER_LANGUAGE);\r\n        dialog.getTable().forEach(row -> {\r\n            SettingParameter<CustomerLanguage> object = getSettingParameter(row, dialog, current);\r\n            if (Objects.nonNull(object))\r\n                getCtx().getServices().getSettingParameterService().save(object);\r\n        });\r\n\r\n    }\r\n\r\n    /**\r\n     * The getSettingParameter function is used to create a SettingParameter object from the data in the file being imported.\r\n     * The function takes three parameters: colString, dialog, and setting.\r\n     * colString is a Map&lt;Integer, String&gt; that contains all of the columns in each row of data from the file being imported.\r\n     * dialog is an instance of FileImportDialog that contains information about how to import this particular type of file (CustomerLanguage).\r\n     * setting is an instance of Setting which represents one specific customer's settings for CustomerLanguage objects. This parameter will be null if we are importing new customers'\r\n     *\r\n     * @param Map&lt;Integer   Get the column values from the file\r\n     * @param String&gt;       colString Get the values from the fileimportdialog\r\n     * @param FileImportDialog dialog Get the column values from the file\r\n     * @param Setting          setting Get the setting from the database\r\n     */\r\n    private SettingParameter<CustomerLanguage> getSettingParameter(Map<Integer, String> colString,\r\n                                                                   FileImportDialog dialog, Setting setting) throws NullPointerException {\r\n        SettingParameter<CustomerLanguage> param = new SettingParameter<CustomerLanguage>();\r\n        CustomerLanguage object = new CustomerLanguage();\r\n        String customerID = \"\";\r\n        if (dialog.getColumns()[0] > -1) {\r\n            customerID = dialog.getColumnsByIdx(colString, 0);\r\n            Optional<SettingParameter<CustomerLanguage>> optCusLand = getCtx().getServices()\r\n                    .getSettingParameterService().findByParamAndSetting(customerID, setting);\r\n            if (optCusLand.isPresent()) {\r\n                param = optCusLand.get();\r\n                object = param.getValue();\r\n            } else {\r\n                Optional<LocalCustomer> optCustomer = getCtx().getServices().getLocalCustomerCustomService()\r\n                        .findByCustomerNr(customerID);\r\n                optCustomer.ifPresent(object::setCustomer);\r\n            }\r\n        }\r\n\r\n        if (dialog.getColumns()[1] > -1) {\r\n            String language = dialog.getColumnsByIdx(colString, 1);\r\n            Optional<Language> optLanguage;\r\n            if (language.contains(\"-\")) {\r\n                optLanguage = currentLanguages.stream()\r\n                        .filter(item -> item.getLabel().equalsIgnoreCase(language)).findFirst();\r\n            } else {\r\n                optLanguage = currentLanguages.stream()\r\n                        .filter(item -> item.getLabel().toLowerCase().split(\"-\")[0].equals(language.toLowerCase()))\r\n                        .findFirst();\r\n            }\r\n            optLanguage.ifPresent(object::setLanguage);\r\n        }\r\n        param.setValue(object);\r\n        param.setParam(customerID);\r\n        param.setSetting(setting);\r\n        param.setDisplayOrder(-1);\r\n\r\n        if (Objects.isNull(object.getCustomer())) {\r\n            param = null;\r\n        }\r\n\r\n        return param;\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\CustomerLanguage_SPGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\CustomerPrefix_SPGrid.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid;\r\n\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.CustomerPrefix;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.Parse;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport com.hom.ebmw.view.admin.setting.grid.service.LayoutService;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.hom.ebmw.view.components.interfaces.FileInputLoader;\r\nimport com.hom.ebmw.view.dialogs.FileImportDialog;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.HeaderRow;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.*;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class CustomerPrefix_SPGrid extends SettingParameterGrid<CustomerPrefix> implements LayoutService, FileInputLoader {\r\n\r\n    private final List<LocalCustomer> currentCustomers;\r\n    private final List<Role> currentRoles;\r\n    private Column<SettingParameter<CustomerPrefix>> first;\r\n    private final Setting settingPrefix;\r\n\r\n    /**\r\n     * The CustomerPrefix_SPGrid function is a constructor for the CustomerPrefix_SPGrid class.\r\n     * It sets up the grid by setting its columns, sorting ability, and header row.\r\n     *\r\n     * @param Context ctx Get the current context of the application\r\n     * @param Setting setting Get the setting for this grid\r\n     * @return A customerprefix_spgrid object\r\n     */\r\n    public CustomerPrefix_SPGrid(Context ctx, Setting setting) {\r\n        super(ctx, setting);\r\n\r\n        currentCustomers = ctx.getServices().getLocalCustomerCustomService().findAll();\r\n        currentRoles = ctx.getServices().getRoleService().findAll();\r\n        Role dyn = new Role();\r\n        dyn.setName(\"DYN\");\r\n        currentRoles.add(dyn);\r\n\r\n        settingPrefix = SettingUtils.getSettingByType(getCtx(), SettingType.DEFAULT_CUSTOMER_PREFIX);\r\n\r\n        setColumn();\r\n        setSortAble();\r\n        setHeaderRow();\r\n    }\r\n\r\n    /**\r\n     * The setColumn function is used to set the column of the table.\r\n     */\r\n    private void setColumn() {\r\n\r\n        first = addComponentColumn(item -> buildRow(item)).setHeader(\"\");\r\n    }\r\n\r\n    /**\r\n     * The buildRow function is used to create a row of the table.\r\n     * It takes in an item, which is a SettingParameter&lt;CustomerPrefix&gt; object.\r\n     * The function then creates and returns a HorizontalLayout containing:\r\n     * - A ComboBox with all customers as options (customerBox)\r\n     * - A ComboBox with all roles as options (eCatBox)\r\n     * - A ComboBox with all roles as options (impexBox)\r\n     *\r\n     * @param SettingParameter&lt;CustomerPrefix&gt; item Pass the current item to the function\r\n     * @return A horizontallayout with a combobox, a textfield and an imagebutton\r\n     */\r\n    private HorizontalLayout buildRow(SettingParameter<CustomerPrefix> item) {\r\n        final String customerId = item.getParam();\r\n        Optional<LocalCustomer> customerItem = currentCustomers.stream().filter(filter -> filter.getCustomerId().equals(customerId)).findFirst();\r\n\r\n        LocalCustomer selected = item.getValue().getCustomer();\r\n        if (customerItem.isPresent()) {\r\n            selected = customerItem.get();\r\n        }\r\n        HorizontalLayout result = new HorizontalLayout();\r\n        result.setWidthFull();\r\n        CompUtils.removeMSP(result, \"MP\");\r\n\r\n        CustomerPrefix object = item.getValue();\r\n        ComboBox<Role> eCatBox = new ComboBox<>();\r\n        ComboBox<Role> impexBox = new ComboBox<>();\r\n        ComboBox<LocalCustomer> customerBox = new ComboBox<>();\r\n\r\n        customerBox.setItems(currentCustomers);\r\n        customerBox.setItemLabelGenerator(label -> \"(\" + label.getCustomerId() + \") \" + label.getName());\r\n        customerBox.addValueChangeListener(event -> {\r\n            final String sapCustomerId = customerBox.getValue().getCustomerId();\r\n            UI.getCurrent().access(() -> {\r\n                String prefix = sapCustomerId.substring(0, 3);\r\n                if (Parse.toInt(prefix) != 0) {\r\n                    prefix = settingPrefix.getValue();\r\n                }\r\n                if (!eCatBox.getOptionalValue().isPresent()) {\r\n                    eCatBox.setValue(getRole(prefix));\r\n                }\r\n                if (!impexBox.getOptionalValue().isPresent()) {\r\n                    impexBox.setValue(getRole(prefix));\r\n                }\r\n            });\r\n        });\r\n\r\n        customerBox.setValue(selected);\r\n        customerBox.setWidth(\"50%\");\r\n\r\n        eCatBox.setItems(currentRoles);\r\n        eCatBox.setItemLabelGenerator(Role::getName);\r\n        if (Objects.nonNull(object.getEcat()) && !object.getEcat().isEmpty()) {\r\n            eCatBox.setValue(getRole(object.getEcat()));\r\n        }\r\n        eCatBox.setWidth(\"20%\");\r\n\r\n        impexBox.setItems(currentRoles);\r\n        impexBox.setItemLabelGenerator(Role::getName);\r\n        if (Objects.nonNull(object.getImpex()) && !object.getImpex().isEmpty()) {\r\n            impexBox.setValue(getRole(object.getImpex()));\r\n        }\r\n        impexBox.setWidth(\"20%\");\r\n\r\n        ImageButton imgBtn = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        imgBtn.addClickListener(event -> {\r\n            object.setCustomer(customerBox.getValue());\r\n            if (!eCatBox.isEmpty()) {\r\n                object.setEcat(eCatBox.getValue().getName());\r\n            }\r\n\r\n            if (!impexBox.isEmpty()) {\r\n                object.setImpex(impexBox.getValue().getName());\r\n            }\r\n\r\n            item.setValue(object);\r\n            item.setParam(object.getCustomer().getCustomerId());\r\n            if (item.getDisplayOrder() == -1)\r\n                item.setDisplayOrder(getSettingParams().size());\r\n            save(item);\r\n            reload();\r\n        });\r\n        imgBtn.setWidth(\"2em\");\r\n\r\n        result.add(customerBox, eCatBox, impexBox, imgBtn);\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The setSortAble function sets the first column of the table to be sortable.\r\n     * It also sets a comparator for that column, which compares two items by their param values.\r\n     */\r\n    private void setSortAble() {\r\n        first.setSortable(true);\r\n        first.setComparator((item1, item2) -> item1.getParam().compareTo(item2.getParam()));\r\n    }\r\n\r\n    /**\r\n     * The setHeaderRow function is used to create a header row for the grid.\r\n     * The header row contains three components:\r\n     * 1) A text field that allows users to search for customers by name.\r\n     * 2) A combo box that allows users to filter the grid by eCat role.\r\n     * 3) A combo box that allows users to filter the grid by impex role.\r\n     */\r\n    private void setHeaderRow() {\r\n        HeaderRow head = this.getDefaultHeaderRow();\r\n\r\n        HorizontalLayout box = new HorizontalLayout();\r\n        CompUtils.removeMSP(box, \"MP\");\r\n\r\n        //CustomerSearch\r\n        TextField searchCustomerFld = new TextField();\r\n        searchCustomerFld.setWidth(\"50%\");\r\n        searchCustomerFld.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<CustomerPrefix>> dataProvider = (ListDataProvider<SettingParameter<CustomerPrefix>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                LocalCustomer customer = item.getValue().getCustomer();\r\n                String text = (\"(\" + item.getParam() + \") \" + customer.getName()).toLowerCase(Locale.ENGLISH);\r\n                String search = event.getValue().toLowerCase(Locale.ENGLISH);\r\n                return text.contains(search);\r\n            });\r\n        });\r\n\r\n\r\n        //eCat Filter\r\n        ComboBox<Role> eCatBox = new ComboBox<>();\r\n\r\n        eCatBox.setItems(currentRoles);\r\n        eCatBox.setItemLabelGenerator(Role::getName);\r\n        eCatBox.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<CustomerPrefix>> dataProvider = (ListDataProvider<SettingParameter<CustomerPrefix>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                String eCatRole = item.getValue().getEcat();\r\n                String text = eCatRole.toLowerCase(Locale.ENGLISH);\r\n                String search = event.getValue().getName().toLowerCase(Locale.ENGLISH);\r\n                return text.contains(search);\r\n            });\r\n        });\r\n        eCatBox.setWidth(\"25%\");\r\n\r\n        //eCat Filter\r\n        ComboBox<Role> impexBox = new ComboBox<>();\r\n\r\n        impexBox.setItems(currentRoles);\r\n        impexBox.setItemLabelGenerator(Role::getName);\r\n        impexBox.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<CustomerPrefix>> dataProvider = (ListDataProvider<SettingParameter<CustomerPrefix>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                String eCatRole = item.getValue().getImpex();\r\n                String text = eCatRole.toLowerCase(Locale.ENGLISH);\r\n                String search = event.getValue().getName().toLowerCase(Locale.ENGLISH);\r\n                return text.contains(search);\r\n            });\r\n        });\r\n\r\n        box.add(searchCustomerFld, eCatBox, impexBox);\r\n        head.getCell(first).setComponent(box);\r\n    }\r\n\r\n\r\n    /**\r\n     * The setEmptyRow function is used to add an empty row to the table.\r\n     * This allows for a user to add a new customer prefix without having\r\n     * to delete the last row in the table.  The function checks if there is already an empty row, and if not, it adds one.\r\n     */\r\n    @Override\r\n    public void setEmptyRow() {\r\n        SettingParameter<CustomerPrefix> params = new SettingParameter<CustomerPrefix>();\r\n        CustomerPrefix object = new CustomerPrefix();\r\n        object.setCustomer(null);\r\n        object.setEcat(\"\");\r\n        object.setImpex(\"\");\r\n        params.setValue(object);\r\n        params.setSetting(getSetting());\r\n        params.setDisplayOrder(-1);\r\n        if (Objects.isNull(getSettingParams()) || getSettingParams().isEmpty()) {\r\n            setSettingParams(new ArrayList<SettingParameter<CustomerPrefix>>());\r\n            getSettingParams().add(0, params);\r\n        } else if (getSettingParams().get(0).getDisplayOrder() != -1) {\r\n            getSettingParams().add(0, params);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The onSave function is called when the user clicks on the &quot;Save&quot; button.\r\n     * It saves the selected parameter to a setting, which can be accessed by other classes.\r\n     */\r\n    @Override\r\n    public void onSave() {\r\n        List<SettingParameter<CustomerPrefix>> selected = getSelectedParameters();\r\n        if (Objects.nonNull(selected) && !selected.isEmpty()) {\r\n            getSetting().setValue(selected.get(0).getParam());\r\n            getCtx().getServices().getSettingServices().save(getSetting());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add additional components to the settings page.\r\n     * The function takes a HorizontalLayout as an argument, and adds any number of components\r\n     * to that layout.  This allows for the creation of custom settings pages with more complex\r\n     * functionality than just a simple text field or checkbox.  In this case, we are adding two\r\n     * new elements: A ComboBox containing all available roles in the system, and a button which will save whatever role is selected in that box as the value for this setting's key-value pair.  Note that we also have access to our Setting object through getSetting(),\r\n     *\r\n     * @param HorizontalLayout layout Add the combobox and imagebutton to the layout\r\n     */\r\n    @Override\r\n    public void extendContent(HorizontalLayout layout) {\r\n        ComboBox<Role> eCatBox = new ComboBox<>();\r\n        ImageButton button = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n\r\n        eCatBox.setItems(currentRoles);\r\n        eCatBox.setItemLabelGenerator(Role::getName);\r\n        eCatBox.setWidth(\"50%\");\r\n        eCatBox.setValue(getRole(settingPrefix.getValue()));\r\n\r\n        button.addClickListener(event -> {\r\n            getSetting().setValue(eCatBox.getValue().getName());\r\n            getCtx().getServices().getSettingServices().save(getSetting());\r\n        });\r\n\r\n        layout.add(eCatBox, button);\r\n    }\r\n\r\n    /**\r\n     * The getRole function takes a String name as an argument and returns the Role object with that name.\r\n     * If no such role exists, it returns null.\r\n     *\r\n     * @param String name Find the role in the currentroles list\r\n     * @return A role object, which is an instance of the role class\r\n     */\r\n    private Role getRole(String name) {\r\n        Role result = null;\r\n        Optional<Role> value = currentRoles.stream().filter(role -> role.getName().equals(name)).findFirst();\r\n        if (value.isPresent()) {\r\n            result = value.get();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the layout.\r\n     *\r\n     * @param VerticalLayout layout Add the horizontallayout hlayout to the layout\r\n     */\r\n    @Override\r\n    public void extendContent(VerticalLayout layout) {\r\n        CompUtils.removeMSP(layout, \"MP\");\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        layout.add(hLayout);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the page.\r\n     * The div parameter is a Div object that represents the body of the page.\r\n     * This function can be used to add components, such as buttons and text fields,\r\n     * or other HTML elements, such as headers and horizontal lines (the HR element).\r\n     *\r\n     * @param Div div Add the horizontallayout to the page\r\n     */\r\n    @Override\r\n    public void extendContent(Div div) {\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        div.add(hLayout);\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is used to add the necessary fields for the import dialog.\r\n     * The first parameter of each function call is a string that represents the name of\r\n     * a field in TMS. The second parameter indicates whether or not this field should be\r\n     * visible in the import dialog (true = visible, false = hidden). If you want to add more\r\n     * fields than just these three, you can find all available options by looking at your TMS database.\r\n     *\r\n     * @param FileImportDialog dialog Add the column names to the dialog\r\n     */\r\n    @Override\r\n    public void initLayout(FileImportDialog dialog) {\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_CUSTOMER_NR, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_ECAT, true);\r\n        dialog.addValueCbx(TMS.FILE_IMPORTER_IMPEX, true);\r\n    }\r\n\r\n    /**\r\n     * The directSave function is used to save the articles directly into the database.\r\n     * This function is called when a user selects &quot;Save&quot; from the FileImportDialog.\r\n     * The directSave function should be implemented by each importer, and it should\r\n     * call ArticleBaseDAO's saveArticle() method for each article in its list of articles.\r\n     *\r\n     * @param FileImportDialog        dialog Get the file path and to display a message\r\n     * @param List&lt;ArticleBase&gt; articles Pass the list of articles to be saved\r\n     */\r\n    @Override\r\n    public void directSave(FileImportDialog dialog, List<ArticleBase> articles) {\r\n    }\r\n\r\n    /**\r\n     * The doOnSave function is called when the user clicks on the &quot;Save&quot; button in the FileImportDialog.\r\n     * It takes a single argument, which is an instance of FileImportDialog.\r\n     * The function iterates through each row in the table and calls getSettingParameter to create a SettingParameter object for that row.\r\n     * If this object exists, it saves it using SettingParameterService's save method (which will either update or insert depending on whether or not there was already an existing record).\r\n     *\r\n     * @param FileImportDialog dialog Get the table containing the data to be saved\r\n     */\r\n    @Override\r\n    public void doOnSave(FileImportDialog dialog) {\r\n        Setting current = SettingUtils.getSettingByType(getCtx(), SettingType.DEFAULT_CUSTOMER_PREFIX);\r\n        dialog.getTable().forEach(row -> {\r\n            SettingParameter<CustomerPrefix> object = getSettingParameter(row, dialog, current);\r\n            if (Objects.nonNull(object))\r\n                getCtx().getServices().getSettingParameterService().save(object);\r\n        });\r\n        this.reload();\r\n    }\r\n\r\n    /**\r\n     * The getSettingParameter function is used to create a SettingParameter object from the data in the file being imported.\r\n     * The function takes three parameters: colString, dialog, and setting.\r\n     * The colString parameter is a Map of Integers and Strings that contains all of the data from one row in the file being imported.\r\n     * The dialog parameter is an instance of FileImportDialog that contains information about how to import this particular type of file (e.g., which columns contain which types of data).\r\n     * Finally, setting is an instance of Setting that contains information about what kind(s) or role(s) should be assigned\r\n     *\r\n     * @param Map&lt;Integer   Get the column values from the file\r\n     * @param String&gt;       colString Map the column name to its index\r\n     * @param FileImportDialog dialog Get the column values from the file\r\n     * @param Setting          setting Get the default value for the ecat and impex roles\r\n     * @return A settingparameter object\r\n     */\r\n    private SettingParameter<CustomerPrefix> getSettingParameter(Map<Integer, String> colString,\r\n                                                                 FileImportDialog dialog, Setting setting) throws NullPointerException {\r\n        SettingParameter<CustomerPrefix> param = new SettingParameter<CustomerPrefix>();\r\n        CustomerPrefix object = new CustomerPrefix();\r\n        String customerID = \"\";\r\n        //FILE_IMPORTER_CUSTOMER_NR\r\n        if (dialog.getColumns()[0] > -1) {\r\n            customerID = dialog.getColumnsByIdx(colString, 0);\r\n            String curCustomerID = customerID;\r\n            List<SettingParameter<CustomerPrefix>> values = SettingUtils.getAllSettingParametersByType(getCtx(), SettingType.DEFAULT_CUSTOMER_PREFIX);\r\n            Optional<SettingParameter<CustomerPrefix>> optCustomerPrefix = values.stream().filter(item -> item.getParam().equals(curCustomerID)).findFirst();\r\n            if (optCustomerPrefix.isPresent()) {\r\n                param = optCustomerPrefix.get();\r\n                object = param.getValue();\r\n            } else {\r\n                Optional<LocalCustomer> optCustomer = getCtx().getServices().getLocalCustomerCustomService()\r\n                        .findByCustomerNr(customerID);\r\n                optCustomer.ifPresent(object::setCustomer);\r\n            }\r\n        }\r\n        //FILE_IMPORTER_ECAT\r\n        if (dialog.getColumns()[1] > -1) {\r\n            String ecat = dialog.getColumnsByIdx(colString, 1);\r\n            Role role = getRole(ecat);\r\n            if (Objects.isNull(role)) {\r\n                role = getRole(setting.getValue());\r\n            }\r\n            object.setEcat(role.getName());\r\n\r\n        }\r\n        //FILE_IMPORTER_IMPEX\r\n        if (dialog.getColumns()[2] > -1) {\r\n            String impex = dialog.getColumnsByIdx(colString, 2);\r\n            Role role = getRole(impex);\r\n            if (Objects.isNull(role)) {\r\n                role = getRole(setting.getValue());\r\n            }\r\n            object.setImpex(role.getName());\r\n        }\r\n\r\n        param.setValue(object);\r\n        param.setParam(customerID);\r\n        param.setSetting(setting);\r\n        param.setDisplayOrder(-1);\r\n\r\n        if (Objects.isNull(object.getCustomer())) {\r\n            param = null;\r\n        }\r\n\r\n        return param;\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\CustomerPrefix_SPGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\Delay_SPGrid.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid;\r\n\r\nimport com.hom.ebmw.jpa.model.Role;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.jpa.model.SettingParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.Delay;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.CronJobUtils;\r\nimport com.hom.ebmw.utilities.Parse;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.Interval;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.view.admin.setting.grid.service.LayoutService;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.HeaderRow;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.notification.Notification;\r\nimport com.vaadin.flow.component.notification.Notification.Position;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\n\r\nimport java.util.*;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class Delay_SPGrid extends SettingParameterGrid<Delay> implements LayoutService {\r\n\r\n    private final List<Role> currentRoles;\r\n    private Column<SettingParameter<Delay>> first;\r\n    private final List<ObjectType> fileTypes = new ArrayList<ObjectType>();\r\n\r\n    /*\r\n     * Prefix_Type, days, before(true = before/ false = after)\r\n     */\r\n\r\n    /**\r\n     * The Delay_SPGrid function is a constructor for the Delay_SPGrid class.\r\n     * It sets up the columns, sortable fields, and header row of the grid.\r\n     *\r\n     * @param Context ctx Get the services from the context\r\n     * @param Setting setting Set the columns and sortable\r\n     * @return A grid with the following columns:\r\n     */\r\n    public Delay_SPGrid(Context ctx, Setting setting) {\r\n        super(ctx, setting);\r\n\r\n        currentRoles = ctx.getServices().getRoleService().findAll();\r\n        Role dyn = new Role();\r\n        dyn.setName(\"DYN\");\r\n        currentRoles.add(dyn);\r\n\r\n        fileTypes.add(ObjectType.IMPEX);\r\n        fileTypes.add(ObjectType.ECAT);\r\n\r\n        setColumn();\r\n        setSortAble();\r\n        setHeaderRow();\r\n    }\r\n\r\n    /**\r\n     * The buildRow function is used to create a row in the grid.\r\n     * It takes an item as a parameter and returns a HorizontalLayout containing\r\n     * the components for each column in that row. The HorizontalLayout is added to\r\n     * the grid using addRow(HorizontalLayout). This function also adds listeners to each component, so that when they are changed, it will update their value in the database.\r\n     *\r\n     * @param SettingParameter&lt;Delay&gt; item Get the value of the settingparameter&lt;delay&gt; item\r\n     * @return A horizontallayout\r\n     */\r\n    private HorizontalLayout buildRow(SettingParameter<Delay> item) {\r\n        Delay delay = item.getValue();\r\n\r\n        ComboBox<Role> prefixBox = new ComboBox<>();\r\n        prefixBox.setItemLabelGenerator(Role::getName);\r\n        prefixBox.setItems(currentRoles);\r\n        if (Objects.nonNull(delay.getPrefix()))\r\n            prefixBox.setValue(getRole(delay.getPrefix()));\r\n        prefixBox.addValueChangeListener(event -> {\r\n            delay.setPrefix(event.getValue().getName());\r\n        });\r\n        ComboBox<ObjectType> exportTypeBox = new ComboBox<>();\r\n        exportTypeBox.setItemLabelGenerator(ObjectType::name);\r\n        exportTypeBox.setItems(fileTypes);\r\n        if (Objects.nonNull(delay.getType()))\r\n            exportTypeBox.setValue(delay.getType());\r\n        exportTypeBox.addValueChangeListener(event -> {\r\n            delay.setType(event.getValue());\r\n        });\r\n        // positiv after / negativ before\r\n        TextField daysFld = new TextField();\r\n        daysFld.setValue(String.valueOf(delay.getDays()));\r\n        daysFld.setPlaceholder(\"(+/-) 0 Days\");\r\n        CompUtils.addToolTip(getCtx(), daysFld, TMS.SETTING_GRID_HOLD_ON_DAYS_GONE);\r\n\r\n        HorizontalLayout result = new HorizontalLayout();\r\n        result.setWidthFull();\r\n        CompUtils.removeMSP(result, \"MP\");\r\n\r\n        ImageButton imgBtn = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        imgBtn.addClickListener(event -> {\r\n            delay.setDays(Parse.toInt(daysFld.getValue()));\r\n            item.setParam(delay.getPrefix() + \"_\" + delay.getType());\r\n            item.setValue(delay);\r\n            save(item);\r\n            reload();\r\n        });\r\n\r\n        result.add(prefixBox, exportTypeBox, daysFld, imgBtn);\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The setEmptyRow function is used to add an empty row to the table.\r\n     * This allows for a user to add a new setting parameter without having\r\n     * to delete the existing ones. The function creates a new SettingParameter&lt;Delay&gt; object,\r\n     * and sets its value as an empty Delay object with all of its fields set as null or 0.\r\n     * It then adds this SettingParameter&lt;Delay&gt; object into the list of setting parameters at index 0,\r\n     * which will be displayed on top of all other rows in the table. If there are no other rows in the table, it will simply create a new\r\n     */\r\n    @Override\r\n    public void setEmptyRow() {\r\n        SettingParameter<Delay> params = new SettingParameter<Delay>();\r\n        Delay object = new Delay();\r\n        object.setPrefix(\"\");\r\n        object.setType(null);\r\n        object.setDays(0);\r\n        params.setValue(object);\r\n        params.setSetting(getSetting());\r\n        params.setDisplayOrder(-1);\r\n        if (Objects.isNull(getSettingParams()) || getSettingParams().isEmpty()) {\r\n            setSettingParams(new ArrayList<SettingParameter<Delay>>());\r\n            getSettingParams().add(0, params);\r\n        } else if (getSettingParams().get(0).getDisplayOrder() != -2) {\r\n            getSettingParams().add(0, params);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setColumn function is used to add a column to the grid.\r\n     * The function takes in an item and builds a row for that item.\r\n     */\r\n    private void setColumn() {\r\n        first = addComponentColumn(item -> buildRow(item)).setHeader(\"\");\r\n    }\r\n\r\n    /**\r\n     * The setSortAble function sets the first column of the table to be sortable.\r\n     * It also sets a comparator for that column, which compares two items by their param values.\r\n     */\r\n    private void setSortAble() {\r\n        first.setSortable(true);\r\n        first.setComparator((item1, item2) -> item1.getParam().compareTo(item2.getParam()));\r\n    }\r\n\r\n    /**\r\n     * The setHeaderRow function is used to create a filter for the table.\r\n     * The filter allows the user to search through all of the parameters in\r\n     * order to find one that they are looking for.  This function creates two\r\n     * ComboBoxes, one which filters by role and another which filters by object type.\r\n     */\r\n    private void setHeaderRow() {\r\n        HeaderRow head = this.getDefaultHeaderRow();\r\n\r\n        HorizontalLayout box = new HorizontalLayout();\r\n        CompUtils.removeMSP(box, \"MP\");\r\n\r\n        ComboBox<Role> prefixBox = new ComboBox<>();\r\n        prefixBox.setItemLabelGenerator(Role::getName);\r\n        prefixBox.setItems(currentRoles);\r\n        prefixBox.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<Delay>> dataProvider = (ListDataProvider<SettingParameter<Delay>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                String prefix = item.getValue().getPrefix().toLowerCase(Locale.ENGLISH);\r\n                String search = event.getValue().getName().toLowerCase(Locale.ENGLISH);\r\n                return prefix.contains(search);\r\n            });\r\n        });\r\n\r\n        ComboBox<ObjectType> exportTypeBox = new ComboBox<>();\r\n        exportTypeBox.setItemLabelGenerator(ObjectType::name);\r\n        exportTypeBox.setItems(fileTypes);\r\n        exportTypeBox.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<SettingParameter<Delay>> dataProvider = (ListDataProvider<SettingParameter<Delay>>) this\r\n                    .getDataProvider();\r\n            dataProvider.setFilter(item -> {\r\n                String prefix = item.getValue().getType().getName().toLowerCase(Locale.ENGLISH);\r\n                String search = event.getValue().name().toLowerCase(Locale.ENGLISH);\r\n                return prefix.contains(search);\r\n            });\r\n        });\r\n\r\n        box.add(prefixBox, exportTypeBox);\r\n        head.getCell(first).setComponent(box);\r\n    }\r\n\r\n    /**\r\n     * The getRole function takes a String name as an argument and returns the Role object with that name.\r\n     * If no such role exists, it returns null.\r\n     *\r\n     * @param String name Find the role in the currentroles list\r\n     * @return A role object\r\n     */\r\n    private Role getRole(String name) {\r\n        Role result = null;\r\n        Optional<Role> value = currentRoles.stream().filter(role -> role.getName().equals(name)).findFirst();\r\n        if (value.isPresent()) {\r\n            result = value.get();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add additional components to the content area of the dialog.\r\n     * The layout parameter is a HorizontalLayout that can be added to, and it will automatically be displayed in the dialog.\r\n     *\r\n     * @param HorizontalLayout layout Add the components to\r\n     */\r\n    @Override\r\n    public void extendContent(HorizontalLayout layout) {\r\n        final ComboBox<Interval> intervalBox = new ComboBox<Interval>();\r\n        intervalBox.setItems(Interval.values());\r\n        intervalBox.setItemLabelGenerator(Interval::name);\r\n        final TextField valueFld = new TextField();\r\n        final ImageButton button = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        final Button resetBtn = new Button(getTranslation(TMS.GLB_BUTTON_LIST_RESET, getLocale(), getCtx()));\r\n\r\n        button.addClickListener(event -> {\r\n            if (Objects.nonNull(intervalBox.getValue()) && !valueFld.getValue().isEmpty()) {\r\n                String cron = CronJobUtils.create(intervalBox.getValue(), valueFld.getValue());\r\n                getSetting().setValue(cron);\r\n                getCtx().getServices().getSettingServices().save(getSetting());\r\n            }\r\n            Notification.show(TMS.ADMIN_DIALOG_RESTART, 6000, Position.MIDDLE);\r\n        });\r\n\r\n        resetBtn.addClickListener(event -> {\r\n            getCtx().getServices().getRestartEndpoint().restart();\r\n        });\r\n\r\n        if (getSetting().getValue().contains(\" \")) {\r\n            intervalBox.setValue(Interval.CUSTOM);\r\n            valueFld.setValue(getSetting().getValue());\r\n        }\r\n        layout.add(intervalBox, valueFld, button, resetBtn);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the layout.\r\n     *\r\n     * @param VerticalLayout layout Add the horizontallayout to\r\n     */\r\n    @Override\r\n    public void extendContent(VerticalLayout layout) {\r\n        CompUtils.removeMSP(layout, \"MP\");\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        layout.add(hLayout);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the page.\r\n     * The div parameter is a Div object that represents the body of the page.\r\n     * This function can be used to add components, such as buttons and text fields,\r\n     * or other HTML elements, such as headers and horizontal lines (the HR element).\r\n     *\r\n     * @param Div div Add the horizontallayout to the div\r\n     */\r\n    @Override\r\n    public void extendContent(Div div) {\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        div.add(hLayout);\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\Delay_SPGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\KatalogVersionSPGrid.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid;\r\n\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.jpa.model.SettingParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.KatalogVersion;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.ObjectType;\r\nimport com.hom.ebmw.view.admin.setting.grid.service.LayoutService;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.datepicker.DatePicker;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.select.Select;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.time.LocalDate;\r\nimport java.util.*;\r\n\r\n@Slf4j\r\npublic class KatalogVersionSPGrid extends SettingParameterGrid<KatalogVersion> implements LayoutService {\r\n    private static final long serialVersionUID = -461101487591490216L;\r\n\r\n    private List<String> categories = new ArrayList<>();\r\n    private final Map<ObjectType, String> masterMap = new EnumMap<>(ObjectType.class);\r\n    private final TextField ecatTxt = new TextField();\r\n    private final TextField impexTxt = new TextField();\r\n\r\n\r\n    /**\r\n     * The KatalogVersionSPGrid function is a constructor for the KatalogVersionSPGrid class.\r\n     * It takes in two parameters: a Context object and a Setting object.\r\n     * The function sets the type of grid to be displayed by calling setType() with getSetting().getValue() as its parameter, which returns an ObjectType enum value (IMPEX or ECAT).\r\n     * The function then calls reloadCategory(), which returns an ArrayList&lt;String&gt; containing all of the categories that are available for selection in this grid's category dropdown menu.  This list is stored in categories, which is used later on when populating this grid's category\r\n     *\r\n     * @param Context ctx Get the current locale and to access the database\r\n     * @param Setting setting Set the type of setting\r\n     * @return an Object\r\n     */\r\n    public KatalogVersionSPGrid(Context ctx, Setting setting) {\r\n        super(ctx, setting);\r\n\r\n        setType(getSetting().getValue());\r\n\r\n        categories = reloadCategory();\r\n\r\n        addComponentColumn(item -> {\r\n            HorizontalLayout result = new HorizontalLayout();\r\n            result.setWidthFull();\r\n            CompUtils.removeMSP(result, \"MP\");\r\n\r\n            KatalogVersion object = item.getValue();\r\n\r\n            TextField version = new TextField();\r\n            version.setValue(object.getVersion());\r\n            version.setWidth(\"60px\");\r\n\r\n            DatePicker fromDate = new DatePicker(object.getValidFrom());\r\n            fromDate.setWidth(\"120px\");\r\n\r\n            DatePicker toDate = new DatePicker(object.getValidTo());\r\n            toDate.setWidth(\"120px\");\r\n\r\n            ComboBox<String> categoryBox = new ComboBox<>();\r\n            ComboBox<String> nameBox = new ComboBox<>();\r\n            Select<ObjectType> typeBox = new Select<>();\r\n\r\n            categoryBox.setItems(categories);\r\n            categoryBox.setClearButtonVisible(true);\r\n            categoryBox.addValueChangeListener(event -> {\r\n                object.setPimAssortmentCategory(event.getValue());\r\n                nameBox.setReadOnly(false);\r\n                nameBox.setItems(reloadName(object.getPimAssortmentCategory()));\r\n                nameBox.addValueChangeListener(eventInter ->\r\n                        object.setPimAssortmentName(eventInter.getValue())\r\n                );\r\n            });\r\n            categoryBox.setValue(object.getPimAssortmentCategory());\r\n            categoryBox.setWidth(\"160px\");\r\n\r\n            if (Objects.nonNull(object.getPimAssortmentCategory()) && !object.getPimAssortmentCategory().isEmpty()) {\r\n                nameBox.setReadOnly(false);\r\n                nameBox.setItems(reloadName(object.getPimAssortmentCategory()));\r\n                nameBox.addValueChangeListener(event ->\r\n                        object.setPimAssortmentName(event.getValue())\r\n                );\r\n            }\r\n\r\n            List<ObjectType> objects = new ArrayList<>();\r\n            objects.add(ObjectType.IMPEX);\r\n            objects.add(ObjectType.ECAT);\r\n            objects.add(ObjectType.BOTH);\r\n            typeBox.setId(\"type-box\");\r\n            typeBox.setItems(objects);\r\n            typeBox.setItemEnabledProvider(type -> !type.equals(ObjectType.BOTH));\r\n            typeBox.setWidth(\"90px\");\r\n            typeBox.setValue(Objects.nonNull(object.getType()) ? object.getType() : ObjectType.BOTH);\r\n\r\n            if (item.getParam().isEmpty()) {\r\n                categoryBox.setPlaceholder(getTranslation(TMS.SETTING_PLACEHOLDER_SELECT, getLocale(), getCtx()));\r\n                nameBox.setPlaceholder(getTranslation(TMS.SETTING_PLACEHOLDER_SELECT, getLocale(), getCtx()));\r\n            }\r\n            ImageButton imgBtn = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n            imgBtn.addClickListener(event -> {\r\n                object.setVersion(version.getValue());\r\n                object.setValidFrom(fromDate.getValue());\r\n                object.setValidTo(toDate.getValue());\r\n                object.setPimAssortmentName(nameBox.getValue());\r\n                object.setPimAssortmentCategory(categoryBox.getValue());\r\n                object.setType(typeBox.getValue());\r\n                item.setValue(object);\r\n                item.setParam(object.getVersion());\r\n                if (item.getDisplayOrder() == -1)\r\n                    item.setDisplayOrder(getSettingParams().size());\r\n                save(item);\r\n                reload();\r\n            });\r\n            imgBtn.setWidth(\"2em\");\r\n\r\n            nameBox.setValue(object.getPimAssortmentName());\r\n            nameBox.setClearButtonVisible(true);\r\n            nameBox.setWidth(\"160px\");\r\n\r\n            result.add(version, fromDate, toDate, categoryBox, nameBox, typeBox, imgBtn);\r\n            return result;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setType function takes a string value and splits it into two parts.\r\n     * The first part is the ECAT type, and the second part is the IMPEX type.\r\n     * If there are no # symbols in the string, then both types will be set to\r\n     * whatever was passed in as an argument. Otherwise, if there are # symbols\r\n     * present in the string, then they will be split up accordingly based on their position.\r\n     *\r\n     * @param String value Split the string into two parts\r\n     */\r\n    private void setType(String value) {\r\n        if (value.contains(\"#\")) {\r\n            if (value.split(\"#\").length == 1) {\r\n                value = value.split(\"#\")[0] + \"#\" + value.split(\"#\")[0];\r\n            }\r\n            if (splitIfValid(value, 0).isEmpty()) {\r\n                masterMap.put(ObjectType.ECAT, splitIfValid(value, 1));\r\n                ecatTxt.setValue(ObjectType.ECAT.name() + \" \" + clean(splitIfValid(value, 1)));\r\n            } else {\r\n                masterMap.put(ObjectType.ECAT, splitIfValid(value, 0));\r\n                ecatTxt.setValue(ObjectType.ECAT.name() + \" \" + clean(splitIfValid(value, 0)));\r\n            }\r\n\r\n            masterMap.put(ObjectType.IMPEX, splitIfValid(value, 1));\r\n            impexTxt.setValue(ObjectType.IMPEX.name() + \" \" + clean(splitIfValid(value, 1)));\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The setEmptyRow function is used to add a row to the table that allows the user\r\n     * to create a new KatalogVersion. The function checks if there is already an empty row,\r\n     * and if not it adds one. This way, there will always be an empty row at the top of\r\n     * the table for creating new KatalogVersions. If this function was not implemented,\r\n     * then every time you added a new version and saved it in your database, you would have\r\n     * to refresh your page before being able to add another version (because otherwise you would get an error).\r\n     */\r\n    @Override\r\n    public void setEmptyRow() {\r\n        SettingParameter<KatalogVersion> params = new SettingParameter<>();\r\n        KatalogVersion kVersion = new KatalogVersion();\r\n        kVersion.setVersion(\"KXX\");\r\n        kVersion.setValidFrom(LocalDate.of(LocalDate.now().getYear(), 8, 1));\r\n        kVersion.setValidTo(LocalDate.of(LocalDate.now().getYear() + 1, 7, 31));\r\n        kVersion.setPimAssortmentCategory(\"\");\r\n        kVersion.setPimAssortmentName(\"\");\r\n        params.setValue(kVersion);\r\n        params.setParam(kVersion.getVersion());\r\n        params.setSetting(getSetting());\r\n        params.setDisplayOrder(-1);\r\n        if (Objects.isNull(getSettingParams()) || getSettingParams().isEmpty()) {\r\n            setSettingParams(new ArrayList<>());\r\n            getSettingParams().add(0, params);\r\n        } else if (!getSettingParams().get(0).getValue().getVersion().equals(\"KXX\")) {\r\n            getSettingParams().add(0, params);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The onSave function is called when the user clicks on the &quot;Save&quot; button in the settings page.\r\n     * It takes all of the values from each of our dropdown menus and concatenates them into a single string, separated by &quot;#&quot;.\r\n     * This string is then saved as a value for this setting.  The reason we do it this way is because there are two different types of objects that can be selected: ECATs and Impexes.\r\n     * We need to save both values so that they can be retrieved later, but we only have one field to store them in (the Setting object).  So instead, we store\r\n     */\r\n    @Override\r\n    public void onSave() {\r\n        getSetting().setValue(masterMap.get(ObjectType.ECAT) + \"#\" + masterMap.get(ObjectType.IMPEX));\r\n        getCtx().getServices().getSettingServices().save(getSetting());\r\n\r\n    }\r\n\r\n    /**\r\n     * The reloadCategory function is used to reload the category list.\r\n     *\r\n     * @return The list of all categories\r\n     */\r\n    public List<String> reloadCategory() {\r\n        Map<String, Map<String, Integer>> cache = getCtx().getServices().getIPIMService().getAllArticleAssortments();\r\n        List<String> result = new ArrayList<>();\r\n        result.addAll(cache.keySet());\r\n        result.sort((o1, o2) -> o1.compareTo(o2));\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The reloadName function is used to reload the names of all articles in a given category.\r\n     *\r\n     * @param String category Get the subcache from cache\r\n     * @return A list of all the names of articles that are in a category\r\n     */\r\n    public List<String> reloadName(String category) {\r\n        Map<String, Map<String, Integer>> cache = getCtx().getServices().getIPIMService().getAllArticleAssortments();\r\n        List<String> result = new ArrayList<>();\r\n        Map<String, Integer> subCache = cache.get(category);\r\n        result.addAll(subCache.keySet());\r\n        result.sort((o1, o2) -> o1.compareTo(o2));\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The splitIfValid function takes a string and an integer as parameters.\r\n     * If the string contains a &quot;#&quot; character, it splits the string into two parts at that point.\r\n     * The function then returns one of those two parts, depending on which part is specified by the integer parameter.\r\n     *\r\n     * @param String value Get the value of the key in the hashmap\r\n     * @param int    part Determine which part of the string to return\r\n     * @return The part of the string that is before or after the # symbol\r\n     */\r\n    private String splitIfValid(String value, int part) {\r\n        String dummy = value;\r\n        if (dummy.contains(\"#\"))\r\n            dummy = dummy.split(\"#\")[part];\r\n        return dummy;\r\n    }\r\n\r\n    /**\r\n     * The clean function takes a string and removes all characters after the first instance of [.\r\n     *\r\n     * @param String value Store the value of the key\r\n     * @return The value of the string before any special characters\r\n     */\r\n    private String clean(String value) {\r\n        String dummy = value;\r\n        if (dummy.contains(\"[\"))\r\n            dummy = dummy.replace(\"[\", \"#\");\r\n        dummy = dummy.split(\"#\")[0];\r\n        return dummy;\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add additional components to the grid.\r\n     * In this case, we are adding a button that allows us to set the default value of our setting parameter.\r\n     *\r\n     * @param HorizontalLayout layout Add components to the bottom of the grid\r\n     */\r\n    @Override\r\n    public void extendContent(HorizontalLayout layout) {\r\n        final Button selectMasterBtn = new Button(getTranslation(TMS.SETTING_GRID_SET_DEFAULT, getLocale(), getCtx()));\r\n\r\n        ecatTxt.setReadOnly(true);\r\n        impexTxt.setReadOnly(true);\r\n\r\n        ImageButton saveBtn = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        saveBtn.addClickListener(event -> {\r\n            Optional<SettingParameter<KatalogVersion>> optParameter = this.getSelectedItems().stream().findFirst();\r\n            optParameter.ifPresent(item -> {\r\n                KatalogVersion version = item.getValue();\r\n                try {\r\n                    ObjectType type = version.getType();\r\n                    switch (type) {\r\n                        case IMPEX:\r\n                            impexTxt.setValue(type.name() + \" \" + version.getVersion());\r\n                            masterMap.put(type, version.getVersion() + \"[\" + item.getId() + \"]\");\r\n                            break;\r\n                        case ECAT:\r\n                            ecatTxt.setValue(type.name() + \" \" + version.getVersion());\r\n                            masterMap.put(type, version.getVersion() + \"[\" + item.getId() + \"]\");\r\n                            break;\r\n                        default:\r\n                        case BOTH:\r\n                            masterMap.put(ObjectType.ECAT, version.getVersion() + \"[\" + item.getId() + \"]\");\r\n                            masterMap.put(ObjectType.IMPEX, version.getVersion() + \"[\" + item.getId() + \"]\");\r\n                            ecatTxt.setValue(ObjectType.ECAT + \" \" + version.getVersion());\r\n                            impexTxt.setValue(ObjectType.IMPEX + \" \" + version.getVersion());\r\n                            break;\r\n                    }\r\n                } catch (Exception e) {\r\n                    log.error(\"Could not Find Type\");\r\n                }\r\n            });\r\n            getSetting().setValue(masterMap.get(ObjectType.ECAT) + \"#\" + masterMap.get(ObjectType.IMPEX));\r\n\r\n            getCtx().getServices().getSettingServices().save(getSetting());\r\n        });\r\n\r\n        selectMasterBtn.addClickListener(event -> {\r\n            Optional<SettingParameter<KatalogVersion>> optParameter = this.getSelectedItems().stream().findFirst();\r\n\r\n            optParameter.ifPresent(item -> {\r\n                String version = item.getValue().getVersion();\r\n                if (!version.isEmpty()) {\r\n                    getSetting().setValue(version);\r\n                    getCtx().getServices().getSettingServices().save(getSetting());\r\n                }\r\n            });\r\n        });\r\n        layout.add(saveBtn, ecatTxt, impexTxt);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add components to the layout of a page.\r\n     * The function takes in a VerticalLayout object, which is the layout that will be added to.\r\n     * This function can be called multiple times on different pages, and each time it will add\r\n     * different components depending on what page it was called from. In this case, we are adding\r\n     * an empty HorizontalLayout component with no margins or padding (MSP) so that we can use it later for our own purposes.\r\n     *\r\n     * @param VerticalLayout layout Add the horizontallayout hlayout to it\r\n     */\r\n    @Override\r\n    public void extendContent(VerticalLayout layout) {\r\n        CompUtils.removeMSP(layout, \"MP\");\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        layout.add(hLayout);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the div that is passed in as a parameter.\r\n     * The function can be called multiple times, and each time it will append more content to the end of the div.\r\n     *\r\n     * @param Div div Add the new content to the page\r\n     */\r\n    @Override\r\n    public void extendContent(Div div) {\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        div.add(hLayout);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\KatalogVersionSPGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\PartnerShort_SPGrid.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid;\r\n\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.jpa.model.SettingParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.PartnerShort;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.Objects;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class PartnerShort_SPGrid extends SettingParameterGrid<PartnerShort> {\r\n\r\n\r\n    /**\r\n     * The PartnerShort_SPGrid function is a constructor for the PartnerShort_SPGrid class.\r\n     * It creates a new grid with two columns: one for the partner ID and another for its name.\r\n     * The first column has an input field that allows users to enter in a partner ID, while the second column has an input field that allows users to enter in a partner name.\r\n     * Both of these fields are editable by default, but they can be disabled if necessary (e.g., when displaying data).\r\n     *\r\n     * @param Context ctx Get the current locale, and to get the translations\r\n     * @param Setting setting Determine which type of setting is being used\r\n     * @return The following\r\n     */\r\n    public PartnerShort_SPGrid(Context ctx, Setting setting) {\r\n        super(ctx, setting);\r\n\r\n        addComponentColumn(item -> {\r\n            HorizontalLayout result = new HorizontalLayout();\r\n            result.setWidthFull();\r\n            CompUtils.removeMSP(result, \"MP\");\r\n\r\n            PartnerShort object = item.getValue();\r\n\r\n            TextField id = new TextField();\r\n            id.setValue(item.getValue().getId());\r\n            id.addValueChangeListener(event -> {\r\n            });\r\n            id.setWidth(\"30%\");\r\n\r\n            TextField name = new TextField();\r\n            name.setValue(item.getValue().getName());\r\n            name.addValueChangeListener(event -> {\r\n            });\r\n            name.setWidth(\"60%\");\r\n\r\n            if (item.getParam().isEmpty()) {\r\n                id.setPlaceholder(getTranslation(TMS.SETTING_PLACEHOLDER_TYPE, getLocale(), getCtx()));\r\n                name.setPlaceholder(getTranslation(TMS.SETTING_PLACEHOLDER_TYPE, getLocale(), getCtx()));\r\n            }\r\n            ImageButton imgBtn = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n            imgBtn.addClickListener(event -> {\r\n                object.setId(id.getValue());\r\n                object.setName(name.getValue());\r\n                item.setValue(object);\r\n                item.setParam(object.getId());\r\n                if (item.getDisplayOrder() == -1) item.setDisplayOrder(getSettingParams().size());\r\n                save(item);\r\n                reload();\r\n            });\r\n            imgBtn.setWidth(\"2em\");\r\n\r\n            result.add(id, name, imgBtn);\r\n            return result;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setEmptyRow function is used to add an empty row to the table.\r\n     * This allows the user to select a new partner without having to delete\r\n     * all of their current selections.  The function checks if there are any\r\n     * existing rows in the table, and if not it adds one with an empty value.\r\n     */\r\n    @Override\r\n    public void setEmptyRow() {\r\n        SettingParameter<PartnerShort> params = new SettingParameter<PartnerShort>();\r\n        PartnerShort partner = new PartnerShort();\r\n        partner.setId(\"\");\r\n        partner.setName(\"partner\");\r\n        params.setValue(partner);\r\n        params.setParam(partner.getId());\r\n        params.setSetting(getSetting());\r\n        params.setDisplayOrder(-1);\r\n        if (Objects.isNull(getSettingParams()) || getSettingParams().isEmpty()) {\r\n            setSettingParams(new ArrayList<SettingParameter<PartnerShort>>());\r\n            getSettingParams().add(0, params);\r\n        } else if (!getSettingParams().get(0).getValue().getId().isEmpty()) {\r\n            getSettingParams().add(0, params);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The onSave function saves all the data in the program.\r\n     * It does this by calling saveAll() from the DataManager class.\r\n     */\r\n    @Override\r\n    public void onSave() {\r\n        saveAll();\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\PartnerShort_SPGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\S3Catalog_SPGrid.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid;\r\n\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.jpa.model.SettingParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.S3Catalog;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.view.admin.setting.grid.service.LayoutService;\r\nimport com.hom.ebmw.view.components.ImageButton;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\n\r\nimport java.util.*;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class S3Catalog_SPGrid extends SettingParameterGrid<S3Catalog> implements LayoutService {\r\n\r\n    private Map<String, Map<String, Integer>> cache = new HashMap<String, Map<String, Integer>>();\r\n    private Map<String, Integer> subCache = new HashMap<String, Integer>();\r\n    private List<Territory> territories = null;\r\n    private final Setting setting;\r\n    private final Context ctx;\r\n\r\n    /**\r\n     * The S3Catalog_SPGrid function creates a grid of the S3 catalog.\r\n     *\r\n     * @param Context ctx Get the current context of the application\r\n     * @param Setting setting Set the setting for the s3catalog_spgrid class\r\n     *                public void loadcache(context ctx) {\r\n     *                if (cache == null) {\r\n     *                cache = new hashmap&lt;&gt;();\r\n     *                <p>\r\n     *                try {\r\n     *                <p>\r\n     *                list&lt;s3objectsummary&gt; s3objectsummaries = amazons3util\r\n     * @return A component\r\n     */\r\n    public S3Catalog_SPGrid(Context ctx, Setting setting) {\r\n        super(ctx, setting);\r\n        this.ctx = ctx;\r\n        this.setting = setting;\r\n        loadCache(ctx);\r\n\r\n        addComponentColumn(this::createLine);\r\n    }\r\n\r\n    /**\r\n     * The setEmptyRow function is used to add an empty row to the table.\r\n     * This allows for a user to add a new entry without having to delete\r\n     * an existing one. The function checks if there is already an empty row,\r\n     * and if not it adds one at the top of the list. If there is already\r\n     * an empty row, then nothing happens and no additional rows are added.\r\n     */\r\n    @Override\r\n    public void setEmptyRow() {\r\n        SettingParameter<S3Catalog> params = new SettingParameter<>();\r\n        S3Catalog catalog = new S3Catalog();\r\n        catalog.setPrimary(\"XX\");\r\n        catalog.setAlternate(\"XX\");\r\n        params.setValue(catalog);\r\n        params.setParam(catalog.getPrimary());\r\n        params.setDisplayOrder(-1);\r\n        params.setSetting(setting);\r\n\r\n        if (Objects.isNull(getSettingParams()) || getSettingParams().isEmpty()) {\r\n            setSettingParams(new ArrayList<SettingParameter<S3Catalog>>());\r\n            getSettingParams().add(0, params);\r\n        } else if (!getSettingParams().get(0).getValue().getPrimary().equals(\"XX\")) {\r\n            getSettingParams().add(0, params);\r\n        }\r\n\r\n\r\n    }\r\n\r\n    /**\r\n     * The onSave function is called when the user clicks on the &quot;Save&quot; button.\r\n     * It saves the selected S3Catalog to a SettingParameter object, which is then saved to a database.\r\n     */\r\n    @Override\r\n    public void onSave() {\r\n        List<SettingParameter<S3Catalog>> selected = getSelectedParameters();\r\n        if (Objects.nonNull(selected) && !selected.isEmpty()) {\r\n            getSetting().setValue(selected.get(0).getParam());\r\n            getCtx().getServices().getSettingServices().save(getSetting());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The createLine function creates a horizontal layout that contains three components:\r\n     * 1. A ComboBox containing the list of territories, which is used to select the primary territory for this S3 catalog.\r\n     * 2. A ComboBox containing the list of territories, which is used to select an alternate territory for this S3 catalog (if any).\r\n     * 3. An ImageButton that saves changes made in either combo box and reloads the page with those changes applied (or not).\r\n     *\r\n     * @param SettingParameter&lt;S3Catalog&gt; item Determine which line is being edited\r\n     * @return A horizontallayout with a combobox, another combobox and an imagebutton\r\n     */\r\n    private HorizontalLayout createLine(SettingParameter<S3Catalog> item) {\r\n        HorizontalLayout layout = new HorizontalLayout();\r\n        S3Catalog s3Item = item.getValue();\r\n\r\n        ComboBox<Territory> box1 = getTerritorySelector();\r\n        box1.setValue(getTerritory(s3Item.getPrimary()));\r\n        box1.addValueChangeListener(event -> {\r\n            s3Item.setPrimary(event.getValue().getKey());\r\n        });\r\n        ComboBox<Territory> box2 = getTerritorySelector();\r\n        if (Objects.isNull(s3Item.getAlternate()) || s3Item.getAlternate().isEmpty()) {\r\n            box2.setValue(getTerritory(s3Item.getPrimary()));\r\n        } else {\r\n            box2.setValue(getTerritory(s3Item.getAlternate()));\r\n        }\r\n        box2.addValueChangeListener(event -> {\r\n            s3Item.setAlternate(event.getValue().getKey());\r\n        });\r\n\r\n        ImageButton imgBtn = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n        imgBtn.addClickListener(event -> {\r\n            s3Item.setPrimary(box1.getValue().getKey());\r\n            if (Objects.nonNull(box2.getValue()))\r\n                s3Item.setAlternate(box2.getValue().getKey());\r\n            else\r\n                s3Item.setAlternate(\"XX\");\r\n            item.setValue(s3Item);\r\n            item.setParam(s3Item.getPrimary());\r\n            item.setSetting(setting);\r\n            if (item.getDisplayOrder() == -1) item.setDisplayOrder(getSettingParams().size());\r\n            save(item);\r\n            reload();\r\n        });\r\n        box1.setSizeFull();\r\n        box2.setSizeFull();\r\n        layout.add(box1, box2, imgBtn);\r\n        CompUtils.removeMSP(layout, \"MP\");\r\n        return layout;\r\n    }\r\n\r\n    /**\r\n     * The getTerritorySelector function creates a ComboBox object that contains all of the territories in the game.\r\n     * The function takes no parameters and returns a ComboBox object.\r\n     *\r\n     * @return A combobox&lt;territory&gt;\r\n     */\r\n    private ComboBox<Territory> getTerritorySelector() {\r\n        ComboBox<Territory> box = new ComboBox<>();\r\n        box.setItems(territories);\r\n        box.setItemLabelGenerator(item -> \"(\" + item.getKey() + \") \" + item.getLabel());\r\n        return box;\r\n    }\r\n\r\n    /**\r\n     * The getTerritory function takes a String key as an argument and returns the Territory object with that key.\r\n     *\r\n     * @param String key Find the territory object in the territories list\r\n     * @return The territory with the key that is passed in\r\n     */\r\n    private Territory getTerritory(String key) {\r\n        Territory result = null;\r\n        Optional<Territory> optTerritory = territories.stream().filter(item -> item.getKey().equals(key)).findFirst();\r\n        if (optTerritory.isPresent()) {\r\n            result = optTerritory.get();\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The loadCache function is called by the ArticleAssortmentService.\r\n     * It loads all of the article assortments from the database into a cache,\r\n     * and it also loads all of the territories from an enumeration service.\r\n     *\r\n     * @param Context ctx Get the services and enumerations\r\n     */\r\n    public void loadCache(Context ctx) {\r\n        cache = ctx.getServices().getIPIMService().getAllArticleAssortments();\r\n        territories = ctx.getServices().getEnumerationService().getAllTerritories();\r\n        territories.sort((o1, o2) -> o1.getKey().compareTo(o2.getKey()));\r\n    }\r\n\r\n    /**\r\n     * The reloadCategory function is used to reload the category box with all of the categories that are currently in use.\r\n     *\r\n     * @param ComboBox&lt;String&gt; categoryBox Reload the categorybox with the new items\r\n     */\r\n    public void reloadCategory(ComboBox<String> categoryBox) {\r\n        List<String> result = new ArrayList<String>();\r\n        result.addAll(cache.keySet());\r\n        result.sort((o1, o2) -> o1.compareTo(o2));\r\n        categoryBox.setItems(result);\r\n    }\r\n\r\n    /**\r\n     * The reloadName function is used to reload the nameBox with a new list of names.\r\n     * It takes in a ComboBox&lt;String&gt; and String as parameters, and returns nothing.\r\n     * The function first creates an empty ArrayList called result, then adds all the keys from subCache into it.\r\n     * Then it sorts the result ArrayList alphabetically using lambda expressions (Java 8 feature).\r\n     * Finally, it sets nameBox's items to be equal to result.\r\n     *\r\n     * @param ComboBox&lt;String&gt; nameBox Set the items in the combobox to a list of strings\r\n     * @param String                 category Determine which category of\r\n     */\r\n    public void reloadName(ComboBox<String> nameBox, String category) {\r\n        List<String> result = new ArrayList<String>();\r\n        subCache = cache.get(category);\r\n        result.addAll(subCache.keySet());\r\n        result.sort((o1, o2) -> o1.compareTo(o2));\r\n        nameBox.setItems(result);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add additional components to the content area of a setting.\r\n     * This function is called by the SettingViewer class, and it takes in a HorizontalLayout as an argument.\r\n     * The layout that is passed in can be modified with any Vaadin component, and this will allow for more complex settings than just text fields.\r\n     *\r\n     * @param HorizontalLayout layout Add the components to the layout\r\n     */\r\n    @Override\r\n    public void extendContent(HorizontalLayout layout) {\r\n        final ComboBox<String> categoryBox = new ComboBox<String>();\r\n        final ComboBox<String> nameBox = new ComboBox<String>();\r\n        final TextField placeholder = new TextField();\r\n        final ImageButton button = new ImageButton(CompUtils.getSaveFloppy(getCtx()), CompUtils.getDisableSaveFloppy(getCtx()));\r\n\r\n        placeholder.setValue(setting.getValue());\r\n\r\n        reloadCategory(categoryBox);\r\n        categoryBox.addValueChangeListener(event -> {\r\n            reloadName(nameBox, event.getValue());\r\n        });\r\n        nameBox.addValueChangeListener(event -> {\r\n            placeholder.setValue(event.getValue());\r\n        });\r\n        button.addClickListener(event -> {\r\n            setting.setValue(placeholder.getValue());\r\n            ctx.getServices().getSettingServices().save(setting);\r\n        });\r\n        layout.add(categoryBox, nameBox, placeholder, button);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the layout.\r\n     *\r\n     * @param VerticalLayout layout Add the horizontallayout hlayout to it\r\n     */\r\n    @Override\r\n    public void extendContent(VerticalLayout layout) {\r\n        CompUtils.removeMSP(layout, \"MP\");\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        layout.add(hLayout);\r\n    }\r\n\r\n    /**\r\n     * The extendContent function is used to add content to the page.\r\n     * The div parameter is a Div object that represents the body of the page.\r\n     * This function can be used to add components, such as buttons and text fields,\r\n     * or other HTML elements, such as headers and horizontal lines (the HR element).\r\n     *\r\n     * @param Div div Add the horizontallayout to the page\r\n     */\r\n    @Override\r\n    public void extendContent(Div div) {\r\n        HorizontalLayout hLayout = new HorizontalLayout();\r\n        CompUtils.removeMSP(hLayout, \"MSP\");\r\n        div.add(hLayout);\r\n    }\r\n\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\S3Catalog_SPGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\service\\GridService.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid.service;\r\n\r\n\r\npublic interface GridService<E> {\r\n    void save(E object);\r\n\r\n    void saveAll();\r\n\r\n    void setEmptyRow();\r\n\r\n    void onSave();\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\service\\GridService.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\service\\LayoutService.java =====\n```\npackage com.hom.ebmw.view.admin.setting.grid.service;\r\n\r\nimport com.vaadin.flow.component.html.Div;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\n\r\npublic interface LayoutService {\r\n    void extendContent(HorizontalLayout layout);\r\n\r\n    void extendContent(VerticalLayout layout);\r\n\r\n    void extendContent(Div div);\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\setting\\grid\\service\\LayoutService.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-aHwbtvkexLdKqR5StQkWiJcTokB2F5Ni",
    "created" : 1762171264,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"MultipleFiles\",\n  \"issues\": [\n    {\n      \"severity\": \"High\",\n      \"problem\": \"reloadDetailFilter uses wrong variable 'select' instead of the method argument 'filter'\",\n      \"justification\": \"The method always queries child filters for the currently selected filter, ignoring the filter passed in, leading to incorrect UI data and possible NPE when 'select' is null.\",\n      \"action\": \"Replace 'select' with the 'filter' parameter in the service call; add nullcheck for filter before accessing; write unit test verifying correct child loading for given filter.\",\n      \"source\": \"GlobalExcludeView.reloadDetailFilter(Filter filter), line ~215\",\n      \"component\": \"admin/globalexclude\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"setFilterBaseChild(Map<Integer,String>,FileImportDialog) uses class field 'name' which is never initialized\",\n      \"justification\": \"Resulting child Filterbase objects have null label values, causing NPE downstream when label is accessed or displayed.\",\n      \"action\": \"Use the parent filter's name (e.g., filter.getName()) or pass the name as a parameter; add nullcheck; add test confirming label is set.\",\n      \"source\": \"GlobalExcludeView.setFilterBaseChild(Map<Integer,String> colString, FileImportDialog dialog), line ~400\",\n      \"component\": \"admin/globalexclude\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": \"Duplicate of issue 1\",\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"CustomerPrefix_SPGrid.getSettingParameter may throw NPE when setting.getValue() is null\",\n      \"justification\": \"If the default setting value is missing, role lookup returns null and role.getName() is called, causing runtime failure during import.\",\n      \"action\": \"Add null check after getRole; fallback to a safe default or abort import with user feedback; add test for null setting value scenario.\",\n      \"source\": \"CustomerPrefix_SPGrid.getSettingParameter(...), lines ~340-360\",\n      \"component\": \"admin/setting/grid\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Delay_SPGrid.setHeaderRow filters assume nonnull prefix and type\",\n      \"justification\": \"When a Delay entry has null prefix or type, the filter lambda throws NPE, breaking the UI filter functionality.\",\n      \"action\": \"Guard against null in filter lambdas (e.g., Objects.nonNull(item.getValue().getPrefix()) ? ... : false); add tests for rows with null fields.\",\n      \"source\": \"Delay_SPGrid.setHeaderRow(), lines ~140-165\",\n      \"component\": \"admin/setting/grid\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"S3Catalog_SPGrid.createLine does not validate ComboBox selections before using them\",\n      \"justification\": \"If a user leaves a combo box empty, getKey() is called on a null object, causing NPE on save.\",\n      \"action\": \"Add null checks for box1.getValue() and box2.getValue(); disable save button until required selections are made; unit test NPE scenario.\",\n      \"source\": \"S3Catalog_SPGrid.createLine(...), lines ~120-150\",\n      \"component\": \"admin/setting/grid\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Missing input validation on uploaded files (GlobalExcludeView Importer)\",\n      \"justification\": \"Files are accepted and processed without size/type checks, opening a path for memory exhaustion or malicious content.\",\n      \"action\": \"Validate file size and mime type before opening; reject unsupported formats; add integration tests for oversized/invalid files.\",\n      \"source\": \"GlobalExcludeView.Importer class, constructor, line ~500\",\n      \"component\": \"admin/globalexclude\",\n      \"impact_scope\": \"securitycritical\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"MultiFileMemoryBuffer stores uploaded files entirely in memory\",\n      \"justification\": \"Large uploads can lead to OutOfMemoryError, especially without limits.\",\n      \"action\": \"Replace with DiskBuffer or set explicit max file size; monitor memory usage; add performance test with large files.\",\n      \"source\": \"GlobalExcludeView.Importer constructor, line ~505\",\n      \"component\": \"admin/globalexclude\",\n      \"impact_scope\": \"performancecritical\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Magic numbers (e.g., setGlobal(4), displayOrder checks) reduce code clarity\",\n      \"justification\": \"Hardcoded values are unclear and errorprone, making maintenance harder.\",\n      \"action\": \"Introduce named constants or enum values; replace literal checks with those constants; add documentation comments.\",\n      \"source\": \"GlobalExcludeView.setSaveBtn(), line ~80; various setEmptyRow methods\",\n      \"component\": \"admin/*\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"KatalogVersionSPGrid.onSave may NPE when masterMap entries are missing\",\n      \"justification\": \"If no version has been selected, masterMap.get(ObjectType.ECAT) returns null, causing a NullPointerException during save.\",\n      \"action\": \"Check for null before concatenation; provide user feedback if no master version selected; add unit test for empty masterMap scenario.\",\n      \"source\": \"KatalogVersionSPGrid.onSave(), line ~250\",\n      \"component\": \"admin/setting/grid\",\n      \"impact_scope\": \"prod-relevant\",\n      \"relations\": null,\n      \"evidence\": null\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"ComboBox priorityBox setReadOnly(true) while clear button is visible\",\n      \"justification\": \"UI inconsistency may confuse users; also prevents intended priority changes.\",\n      \"action\": \"Either make the box editable or hide the clear button; update UI tests accordingly.\",\n      \"source\": \"GlobalExcludeView.setPrioritybox(), line ~150\",\n      \"component\": \"admin/globalexclude\",\n      \"impact_scope\": null,\n      \"relations\": null,\n      \"evidence\": null\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"2\",\n    \"top_todos\": [\n      \"Fix reloadDetailFilter to use the passed filter argument and add null checks.\",\n      \"Add proper null handling and validation in import and UI save methods (CustomerPrefix_SPGrid, Delay_SPGrid, S3Catalog_SPGrid).\",\n      \"Introduce input validation and size limits for file uploads to prevent security and memory issues.\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to produce JSON review for each file? The prompt: \"You are a senior code reviewer. You analyze each code chunk.\" Likely need one JSON per file? The schema includes \"file\": path, issues array, summary. Probably produce one JSON covering all files? Might need separate for each file? It says \"max 10 Issues per file/Chunk\". Probably produce one JSON per file. But output must be a single JSON object. Could we embed multiple files? The schema only allows one file field. So likely we need to produce one JSON per file, but we can only output one JSON. The instruction: \"Du bist ein erfahrener Senior Code Reviewer. Du analysierst jeweils einen Code-Chunk.\" So maybe per chunk we output JSON. The user gave many chunks; we need to output for each? Might combine? But rule 1: Answer always a single JSON object. So maybe we need to produce combined JSON with file key array? Not allowed by schema. Maybe we need to produce separate messages? But only one answer. Could we output array of objects? Not allowed.\n\nProbably they expect one JSON per file, but we can only give one. Maybe they only want review for the first file? The prompt includes many files but maybe they want overall? Could set file field to something like \"multiple\" and issues include aggregated. But spec says file: \"string - Pfad der Datei oder Chunk-ID\". Could be a combined identifier like \"MultipleFiles\". Might be okay.\n\nI'll produce a summary with top issues across all files, referencing each file in source field.\n\nLet's identify issues:\n\nGlobalExcludeView.java:\n\n- importer may be null when setRightSection called? In constructor, importer is null initially, setLeftSection creates importer = new Importer(); then setRightVisible(false); importer.setVisible(false); OK.\n\n- In setLeftSection, searchFld listener uses filterGrid.getDataProvider cast to ListDataProvider but filterGrid default DataProvider may not be ListDataProvider leading ClassCastException if not set yet. Could cause runtime error.\n\n- In setLeftSection selection listener, uses filterpart which is not initialized before setLeftSection? filterpart is declared but not instantiated until setMiddleSection, where filterpart = new Div(); So selection may happen before middle section? setLeftSection called before setMiddleSection, but selection listener may be triggered later after UI built, filterpart will be set. OK.\n\n- In setSaveBtn, select = binder.getBean(); select.setDate(user); setTeam etc. Might cause NPE if binder bean null? binder setBean(defaultFilter() earlier. OK.\n\n- In setSaveBtn, select.setGlobal(4); magic number.\n\n- In setAddBtn: defaultFilter sets sortType ECAT, but later they set role to ADMIN. OK.\n\n- In reloadDetailFilter, uses ui.access but filterDetailGrid data provider set to result list but result may be empty if filter null. Also uses select variable rather than passed filter for findAllByFilterAndDelete: passes select (field) not filter param. That's a bug: should use filter parameter. Could cause wrong data.\n\n- In setPrioritybox: priorityBox.setItems(FILTER_ADM); priorityBox.setValue(FILTER_ADM); setReadOnly(true) but setClearButtonVisible true; contradictory.\n\n- In setRadioInAssortment: assortmentBox setValue(ObjectType.ECAT) default, but not bind required maybe null.\n\n- In defaultFilter: filter.setDate(ctx.getSession().getCurrentUser(ctx)); date expects a user? maybe setDate expects a Date, but passes a User object; possible type mismatch.\n\n- In setSaveBtn: User user = ctx.getSession().getCurrentUser(ctx); select.setDate(user); likely expecting a user, maybe date is a User type. Not sure.\n\n- In directSave: uses ui.access inside but also uses dialog.getTable().forEach(row ...) may be heavy.\n\n- In setFilterBaseChild(Map<Integer, String> colString, FileImportDialog dialog): uses name field (class variable) but name is never set; will be null leading label null. Should use filter.getName.\n\n- Multiple duplicate setFilterBaseChild overloads; one for ArticleBase, one for Map. Potential confusion.\n\n- In reloadDetailFilter: filters = ctx.getServices().getFilterBaseService().findAllByFilterAndDelete(select, false); Should use filter param.\n\n- Security: No input validation on uploaded files; potential file injection. Use of UI.getCurrent().access may cause concurrency issues.\n\n- Memory leak: Importer uses MultiFileMemoryBuffer which holds files in memory; no limit.\n\n- UI access may be called from non-UI thread? In setSaveBtn UI access not needed.\n\n- In setPrioritybox: setReadOnly(true) but user cannot change priority; maybe okay.\n\n- In setAddBtn: optRole.get() without checking present, could NPE if role not found.\n\nNow CustomerLanguage_SPGrid:\n\n- In getSettingParameter, throws NullPointerException in signature, but may return null; not needed.\n\n- In getSettingParameter, language detection: if language contains \"-\", uses label equalsIgnoreCase, else splits; may cause NPE if language null.\n\n- In getSettingParameter, optLanguage may be empty, then object language stays null.\n\n- In getSettingParameter, param set to null if object.getCustomer() null; okay.\n\n- In setEmptyRow: creates new SettingParameter but does not set param maybe null; fine.\n\n- In setEmptyRow: params param empty string.\n\n- In setEmptyRow: not adding to settingParams list correctly maybe duplicates.\n\n- No validation on customerID uniqueness.\n\n- Use of currentLanguages list not refreshed after changes.\n\nCustomerPrefix_SPGrid:\n\n- In buildRow: customerBox.addValueChangeListener uses UI.getCurrent().access, but inside UI thread already. May cause deadlock.\n\n- In buildRow: uses eCatBox.getOptionalValue().isPresent() - optional may be empty leading NPE if getOptionalValue returns empty? getOptionalValue returns Optional, okay.\n\n- In getRole: returns null if not found; later code calls .getName() without null check (e.g., in setAddBtn? not there). In save click, they check if (!eCatBox.isEmpty()) then object.setEcat(eCatBox.getValue().getName()); If eCatBox empty, skip. OK.\n\n- In getSettingParameter: uses setting.getValue() may be null; getRole(null) returns null, then object.setEcat(role.getName()) -> NPE. Indeed in ecat and impex handling: Role role = getRole(ecat); if null then role = getRole(setting.getValue()); but if setting.getValue() null, then role null; then object.setEcat(role.getName()); NPE. Should check null.\n\n- In getSettingParameter: throws NullPointerException declared but not needed.\n\n- In setEmptyRow: object.setEcat(\"\"); setImpex(\"\"); fine.\n\nDelay_SPGrid:\n\n- In setHeaderRow: prefixBox filter uses item.getValue().getPrefix().toLowerCase but getPrefix may be null causing NPE.\n\n- In setHeaderRow exportTypeBox filter uses item.getValue().getType().getName() but getType may be null causing NPE.\n\n- In setEmptyRow: displayOrder condition uses -2 but compare to -2 maybe typo; inconsistent.\n\n- In setEmptyRow: object.setPrefix(\"\"); setType(null) fine.\n\n- In extendContent: intervalBox may be null; but used.\n\n- In extendContent: button click uses intervalBox.getValue() and valueFld.getValue() but no validation.\n\n- In extendContent: resetBtn triggers restart endpoint; security risk.\n\nKatalogVersionSPGrid:\n\n- masterMap not initialized for both keys before use; may cause NPE in onSave if not set.\n\n- setType: uses masterMap.put but masterMap may be empty; ok.\n\n- clean: replaces \"[\" with \"#\", then split \"#\", might cause index issues.\n\n- In extendContent saveBtn: uses getSelectedItems().stream().findFirst() but getSelectedItems maybe empty leading no action.\n\n- In extendContent selectMasterBtn: similar.\n\n- In setEmptyRow: uses new SettingParameter<>() raw type? but fine.\n\n- In setEmptyRow: sets kVersion.setValidFrom(LocalDate.of(LocalDate.now().getYear(), 8, 1)); if month/day invalid? August 1 fine.\n\n- In setEmptyRow: version \"KXX\" may conflict.\n\n- In extendContent: uses masterMap.get(ObjectType.ECAT) could be null leading NPE.\n\nPartnerShort_SPGrid:\n\n- In addComponentColumn: id.addValueChangeListener empty; no validation; could allow empty IDs.\n\n- No null checks.\n\n- In setEmptyRow: partner.setId(\"\"); may cause duplicate empty IDs.\n\nS3Catalog_SPGrid:\n\n- loadCache called in constructor, but cache and territories may be null if service returns null.\n\n- In createLine: box2 setValue(getTerritory(s3Item.getPrimary())) if alternate empty then set to same; but if getTerritory returns null may cause NPE.\n\n- In createLine: imgBtn click: s3Item.setPrimary(box1.getValue().getKey()); if box1 value null NPE.\n\n- In setEmptyRow: uses setting param but not setSetting.\n\n- In reloadCategory/reloadName: uses cache without null check.\n\n- In extendContent: placeholder.setValue(setting.getValue()); could be null.\n\n- In extendContent: categoryBox addValueChangeListener reloadName; nameBox may be null.\n\nGeneral:\n\n- Many missing null checks.\n\n- No input validation for uploaded files.\n\n- Magic numbers.\n\n- Concurrency UI access.\n\n- Potential memory leaks with MultiFileMemoryBuffer.\n\nNow produce JSON with summary.\n\nWe need up to 10 issues total across all files.\n\nSelect top 10.\n\nLet's list:\n\n1. GlobalExcludeView.reloadDetailFilter uses field 'select' instead of method parameter causing wrong data retrieval (High).\n\n2. GlobalExcludeView.setPrioritybox makes ComboBox readOnly while also setting clear button visible; UI inconsistency (Low).\n\n3. GlobalExcludeView.setFilterBaseChild uses class field 'name' which is never set, leading to null labels (High).\n\n4. CustomerPrefix_SPGrid.getSettingParameter may cause NPE when setting.getValue() is null (High).\n\n5. Delay_SPGrid.setHeaderRow filters assume non-null prefix/type leading to NPE (High).\n\n6. S3Catalog_SPGrid.createLine does not check for null selections; box1/box2 values may be null causing NPE (High).\n\n7. Multiple classes lack input validation on user-provided data (e.g., uploaded files, text fields) leading to security risk (Med).\n\n8. Use of MultiFileMemoryBuffer in Importer may cause memory overflow for large uploads (Med).\n\n9. In several places magic numbers (e.g., setGlobal(4), displayOrder checks) reduce maintainability (Low).\n\n10. In KatalogVersionSPGrid, masterMap may be null when onSave called before any selection, causing NPE (High).\n\nNow build JSON.\n\nProvide source: file path + method/line.\n\ncomponent: maybe module name.\n\nimpact_scope: production relevant, security, performance.\n\nrelations: null.\n\nProvide action for each.\n\nLet's craft."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 3899,
      "prompt_tokens" : 24901,
      "total_tokens" : 28800
    },
    "timings" : {
      "cache_n" : 527,
      "prompt_n" : 24374,
      "prompt_ms" : 18329.251,
      "prompt_per_token_ms" : 0.7520001230819726,
      "prompt_per_second" : 1329.787016392541,
      "predicted_n" : 3899,
      "predicted_ms" : 47073.754,
      "predicted_per_token_ms" : 12.073289048473969,
      "predicted_per_second" : 82.82747112116871
    }
  }
}