{
  "timestamp" : "2025-11-03T12:59:59.2269993",
  "index" : 11,
  "file" : "review-summary",
  "prompt" : {
    "role" : "user",
    "content" : "===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\SettingUtils.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport com.hom.ebmw.ipim.model.Territory;\r\nimport com.hom.ebmw.jpa.dao.impl.SettingCustomRepository;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.jpa.model.SettingParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.S3Catalog;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\nimport java.util.UUID;\r\n\r\n@Slf4j\r\npublic class SettingUtils {\r\n\r\n    /**\r\n     * The getSettingByType function returns a Setting object from the database based on the type of setting.\r\n     *\r\n     * @param Context     ctx Get the services for the setting\r\n     * @param SettingType type Find the setting by type\r\n     * @return A setting object\r\n     */\r\n    public static Setting getSettingByType(Context ctx, SettingType type) throws NullPointerException {\r\n        Setting setting = null;\r\n        SettingCustomRepository settingServices = ctx.getServices().getSettingCustomServices();\r\n        Optional<Setting> optSetting = settingServices.findBySettingType(ctx, type);\r\n        if (optSetting.isPresent()) {\r\n            setting = optSetting.get();\r\n        }\r\n        return setting;\r\n    }\r\n\r\n    /**\r\n     * The getS3CatalogSetting function is used to retrieve the S3 catalog setting for a given territory.\r\n     *\r\n     * @param Context   ctx Get the services and setting parameters\r\n     * @param Territory territory Determine the s3 catalog to use for the given territory\r\n     * @return A string value\r\n     */\r\n    public static String getS3CatalogSetting(Context ctx, Territory territory) throws NullPointerException {\r\n        Setting setting = null;\r\n        String value = \"\";\r\n        SettingCustomRepository settingServices = ctx.getServices().getSettingCustomServices();\r\n        Optional<Setting> optSetting = settingServices.findBySettingType(ctx, SettingType.S3_CATALOG_DEFINITION);\r\n        if (optSetting.isPresent()) {\r\n            setting = optSetting.get();\r\n            value = setting.getValue();\r\n\r\n            if (value.contains(\"%s\")) {\r\n                String terrValue = \"DE\";\r\n                Optional<SettingParameter<S3Catalog>> optParam = ctx.getServices().getSettingParameterService().findByParamAndSetting(territory.getKey(), setting);\r\n                if (optParam.isPresent()) {\r\n                    S3Catalog item = optParam.get().getValue();\r\n                    if (item.getAlternate().equals(\"XX\")) {\r\n                        terrValue = item.getPrimary();\r\n                    } else {\r\n                        terrValue = item.getAlternate();\r\n                    }\r\n                }\r\n                value = String.format(value, terrValue);\r\n            }\r\n        }\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * The getAllSettingParameterValuesByType function takes in a Context and SettingType, and returns a List of objects.\r\n     * It first creates an empty list of objects called &quot;objects&quot;. Then it tries to get the setting by type using the\r\n     * getSettingByType function. If this is successful, then it gets all setting parameters for that setting ordered by display order.\r\n     * For each item in that list, add its value to the &quot;objects&quot; list created earlier. Finally return this object list at the end of\r\n     * try block or catch block if there was an error creating it (in which case log an error).\r\n     *\r\n     * @param Context     ctx Get the settingparameterservice and to get the setting by type\r\n     * @param SettingType type Determine which setting to get the parameters from\r\n     * @return A list of all settingparameter values for a specific setting type\r\n     */\r\n    public static <E> List<E> getAllSettingParameterValuesByType(Context ctx, SettingType type) {\r\n        List<E> objects = new ArrayList<E>();\r\n        try {\r\n            Setting setting = getSettingByType(ctx, type);\r\n            List<SettingParameter<E>> settingParams = ctx.getServices().getSettingParameterService().findAllBySettingOrderByDisplayOrder(setting);\r\n            settingParams.forEach(item -> objects.add(item.getValue()));\r\n        } catch (Exception e) {\r\n            log.error(\"Could not Create List\");\r\n        }\r\n\r\n        return objects;\r\n    }\r\n\r\n    /**\r\n     * The getAllSettingParametersByType function returns a list of all SettingParameters that are associated with the given SettingType.\r\n     *\r\n     * @param Context     ctx Get the settingparameterservice\r\n     * @param SettingType type Determine what type of setting is being retrieved\r\n     * @return A list of all setting parameters, which are associated with the given setting type\r\n     */\r\n    public static <E> List<SettingParameter<E>> getAllSettingParametersByType(Context ctx, SettingType type) {\r\n        List<SettingParameter<E>> settingParams = new ArrayList<SettingParameter<E>>();\r\n        try {\r\n            Setting setting = getSettingByType(ctx, type);\r\n            settingParams = ctx.getServices().getSettingParameterService().findAllBySettingOrderByDisplayOrder(setting);\r\n        } catch (Exception e) {\r\n            log.error(\"Could not Create List\");\r\n        }\r\n\r\n        return settingParams;\r\n    }\r\n\r\n    /**\r\n     * The getFolder function is used to get the directory of a specific type of file.\r\n     *\r\n     * @param Context     ctx Access the database\r\n     * @param SettingType type Determine the directory to which the file is being uploaded\r\n     * @return The path to the folder where the files will be saved\r\n     */\r\n    public static String getFolder(Context ctx, SettingType type) throws NullPointerException {\r\n        String directory = \"\";\r\n        SettingCustomRepository settingServices = ctx.getServices().getSettingCustomServices();\r\n\r\n        Optional<Setting> optSetting = settingServices.findBySettingType(ctx, type);\r\n        if (optSetting.isPresent()) {\r\n            directory = optSetting.get().getValue();\r\n            FileUtils.mkdir(directory);\r\n            directory += File.separator;\r\n        }\r\n        if (directory.isEmpty()) {\r\n            throw new NullPointerException();\r\n        }\r\n\r\n        log.info(\"To Folder: \" + directory);\r\n        return directory;\r\n    }\r\n\r\n    /**\r\n     * The getSettingsFolder function returns the path to the settings folder.\r\n     *\r\n     * @param Context ctx Access the application's environment\r\n     * @return The path to the upload folder for settings\r\n     */\r\n    public static String getSettingsFolder(Context ctx) throws NullPointerException {\r\n        return getFolder(ctx, SettingType.UPLOAD_FOLDER_SETTINGS);\r\n    }\r\n\r\n    /**\r\n     * The getTempFolder function returns the path to a temporary folder.\r\n     *\r\n     * @param Context ctx Get the path to the folder\r\n     * @return The path to the folder where temporary files are stored\r\n     */\r\n    public static String getTempFolder(Context ctx) throws NullPointerException {\r\n        String directory = getFolder(ctx, SettingType.UPLOAD_FOLDER_TEMP);\r\n        FileUtils.deleteOlderThan(directory, 60 /* 1 Stunde */ * 60 /* 1 Minute */ * 1000L /* 1 Sekunde */);\r\n        return directory;\r\n    }\r\n\r\n    /**\r\n     * The createTempFile function creates a temporary file in the application's cache directory.\r\n     *\r\n     * @param Context ctx Get the context of the application\r\n     * @param String  path Specify the path of the file to be created\r\n     * @return A string that is a path to a file in the app's temporary directory\r\n     */\r\n    public static String createTempFile(Context ctx, String path) throws NullPointerException {\r\n        String xPathFile = \"\";\r\n\r\n        if (path.isEmpty()) {\r\n            xPathFile = getTempFolder(ctx) + UUID.randomUUID();\r\n        } else if (!path.contains(File.separator)) {\r\n            xPathFile = getTempFolder(ctx) + path;\r\n        } else {\r\n            xPathFile = path;\r\n        }\r\n\r\n        return xPathFile;\r\n    }\r\n\r\n    /**\r\n     * The getCustomerFolder function returns the folder where customer files are stored.\r\n     *\r\n     * @param Context ctx Get the application context\r\n     * @return The value of the upload_folder_customer setting\r\n     */\r\n    public static String getCustomerFolder(Context ctx) throws NullPointerException {\r\n        return getFolder(ctx, SettingType.UPLOAD_FOLDER_CUSTOMER);\r\n    }\r\n\r\n    /**\r\n     * The getAssortmentFolder function returns the path to the folder where assortment files are stored.\r\n     *\r\n     * @param Context ctx Get the context of the application\r\n     * @return The value of the upload_folder_assortment setting\r\n     */\r\n    public static String getAssortmentFolder(Context ctx) throws NullPointerException {\r\n        return getFolder(ctx, SettingType.UPLOAD_FOLDER_ASSORTMENT);\r\n    }\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\SettingUtils.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\TranslationProvider.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport com.hom.ebmw.configuration.ApplicationProperty;\r\nimport com.hom.ebmw.jpa.model.User;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.vaadin.flow.i18n.I18NProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.stereotype.Component;\r\n\r\nimport java.io.*;\r\nimport java.nio.charset.StandardCharsets;\r\nimport java.util.*;\r\nimport java.util.function.Supplier;\r\nimport java.util.stream.Collectors;\r\n\r\n/**\r\n * Simple implementation of {@link I18NProvider}.\r\n */\r\n@Slf4j\r\n@Component\r\n@SuppressWarnings(\"serial\")\r\npublic class TranslationProvider\r\n        implements\r\n        I18NProvider {\r\n\r\n    @Autowired\r\n    private ApplicationProperty prop;\r\n\r\n    /**\r\n     * The getProvidedLocales function returns a list of Locale objects that represent the languages\r\n     * supported by this translation service. The function is called by the TranslationServiceFactory\r\n     * to determine which languages are available for translation.\r\n     *\r\n     * @return A list of locales that are supported by the translation service\r\n     */\r\n    @Override\r\n    public List<Locale> getProvidedLocales() {\r\n        final List<Locale> locales = new ArrayList<Locale>();\r\n        Arrays.asList(prop.getTranslationLang().split(\",\")).forEach(langTag -> {\r\n            for (Locale locale : Locale.getAvailableLocales()) {\r\n                if (locale.toLanguageTag().equals(langTag)) {\r\n                    locales.add(locale);\r\n                }\r\n            }\r\n        });\r\n\r\n        return locales;\r\n    }\r\n\r\n    /**\r\n     * The getTranslation function is used to translate a given key into the language of the user.\r\n     * The function takes in a String key, which is used to find the translation for that specific string.\r\n     * It also takes in an optional Locale object, which can be used to specify what language should be translated into.\r\n     * If no locale is specified, then it will use either German or English depending on whether or not there are any users logged in at that time.\r\n     *\r\n     * @param String    key Identify the translation key\r\n     * @param Locale    curlocale Get the current locale of the user\r\n     * @param Object... params Pass in the current context\r\n     * @return The translation of the key in the given locale\r\n     */\r\n    @Override\r\n    public String getTranslation(String key, Locale curlocale, Object... params) {\r\n        Locale locale = curlocale;\r\n\r\n        Context ctx = null;\r\n        String result = \"\";\r\n        if (Objects.nonNull(params) && params.length > 0) {\r\n            int i = 0;\r\n            if (params[i] instanceof Context) {\r\n                ctx = (Context) params[0];\r\n            }\r\n            i++;\r\n\r\n            try {\r\n                User user = ctx.getSession().getCurrentUser(ctx);\r\n                if (Objects.isNull(user)) {\r\n                    locale = Locale.GERMANY;\r\n                } else {\r\n                    locale = Locale.forLanguageTag(user.getLocale());\r\n                }\r\n                result = getTranslator(key, locale);\r\n            } catch (Exception e) {\r\n                locale = curlocale;\r\n            }\r\n        } else {\r\n            if (locale.equals(Locale.GERMANY) || locale.equals(Locale.ENGLISH))\r\n                result = getTranslator(key, locale);\r\n            else\r\n                result = getTranslator(key, Locale.ENGLISH);\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * The getCurrentLocale function returns the current locale of the user.\r\n     *\r\n     * @param Context ctx Get the current user's locale\r\n     * @return The current locale of the user\r\n     */\r\n    @SuppressWarnings(\"unused\")\r\n    private Locale getCurrentLocale(Context ctx) {\r\n        Locale locale = Locale.GERMANY;\r\n        if (Objects.nonNull(ctx.getSession())) {\r\n            locale = Locale.forLanguageTag(ctx.getSession().getCurrentUser(ctx).getLocale());\r\n        }\r\n        return locale;\r\n    }\r\n\r\n    /**\r\n     * The getTranslator function is used to retrieve the translated value of a key from the translation file.\r\n     *\r\n     * @param String key Get the value from the properties file\r\n     * @param Locale locale Determine which language to translate the key into\r\n     * @return The value of the key from the file\r\n     */\r\n    public String getTranslator(String key, Locale locale) {\r\n        File translate = new File(prop.getTranslationPath() + File.separator + locale.toLanguageTag() + \".prop\");\r\n        String value = \"\";\r\n\r\n        if (translate.exists()) {\r\n            Reader reader = null;\r\n            try {\r\n                reader = new InputStreamReader(new FileInputStream(translate), StandardCharsets.UTF_8);\r\n                Properties prop = new Properties();\r\n                prop.load(reader);\r\n                value = prop.getProperty(key);\r\n                if (value == null || value.length() == 0) {\r\n                    setTranslator(key, key, locale);\r\n                    value = key;\r\n                }\r\n\r\n            } catch (FileNotFoundException e) {\r\n                log.error(\"ErrorMessage[FileNotExists]: \" + e.getLocalizedMessage());\r\n            } catch (IOException e) {\r\n                log.error(\"ErrorMessage[FileIO]: \" + e.getLocalizedMessage());\r\n            } finally {\r\n                try {\r\n                    reader.close();\r\n                } catch (Exception e) {\r\n                    log.error(\"ErrorMessage[Reader]: \" + e.getLocalizedMessage());\r\n                }\r\n            }\r\n        } else {\r\n            try {\r\n                translate.createNewFile();\r\n            } catch (IOException e) {\r\n                log.error(e.getLocalizedMessage());\r\n            }\r\n        }\r\n\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * The setTranslator function is used to set the value of a key in a translation file.\r\n     *\r\n     * @param String key Identify the key of the property\r\n     * @param String value Set the value of a key in the properties file\r\n     * @param Locale locale Determine the language of the translation\r\n     */\r\n    private void setTranslator(String key, String value, Locale locale) {\r\n        File translate = new File(prop.getTranslationPath() + File.separator + locale.toLanguageTag() + \".prop\");\r\n\r\n        if (translate.exists()) {\r\n            Reader reader = null;\r\n            Writer writer = null;\r\n            try {\r\n                reader = new InputStreamReader(new FileInputStream(translate), StandardCharsets.UTF_8);\r\n                Properties prop = new Properties() {\r\n\r\n                    private static final long serialVersionUID = 4112578634029874840L;\r\n\r\n                    @SuppressWarnings(\"rawtypes\")\r\n                    @Override\r\n                    public synchronized Enumeration<Object> keys() {\r\n                        Comparator<Object> byCaseInsensitiveString = Comparator.comparing(Object::toString,\r\n                                String.CASE_INSENSITIVE_ORDER);\r\n\r\n                        @SuppressWarnings(\"unchecked\")\r\n                        Supplier<TreeSet<Object>> supplier = () -> new TreeSet(byCaseInsensitiveString);\r\n\r\n                        TreeSet<Object> sortedSet = super.keySet().stream()\r\n                                .collect(Collectors.toCollection(supplier));\r\n\r\n                        return Collections.enumeration(sortedSet);\r\n                    }\r\n                };\r\n                prop.load(reader);\r\n\r\n                if (value == null || value.length() == 0) {\r\n                    prop.setProperty(key, \"\");\r\n                } else {\r\n                    prop.setProperty(key, value);\r\n\r\n                }\r\n                writer = new OutputStreamWriter(new FileOutputStream(translate), StandardCharsets.UTF_8);\r\n                prop.store(writer, \"Translation-\" + locale.toLanguageTag());\r\n\r\n            } catch (FileNotFoundException e) {\r\n                log.error(\"ErrorMessage: \" + e.getLocalizedMessage());\r\n            } catch (IOException e) {\r\n                log.error(\"ErrorMessage: \" + e.getLocalizedMessage());\r\n            } finally {\r\n                try {\r\n                    writer.close();\r\n                } catch (Exception e) {\r\n                    log.error(\"ErrorMessage: \" + e.getLocalizedMessage());\r\n                }\r\n                try {\r\n                    reader.close();\r\n                } catch (Exception e) {\r\n                    log.error(\"ErrorMessage: \" + e.getLocalizedMessage());\r\n                }\r\n            }\r\n        } else {\r\n            try {\r\n                translate.createNewFile();\r\n            } catch (IOException e) {\r\n                log.error(e.getLocalizedMessage());\r\n            }\r\n        }\r\n    }\r\n}\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\TranslationProvider.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\TreeConverter.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.stream.Collectors;\r\n\r\npublic class TreeConverter {\r\n\r\n    private int maxCount = 0;\r\n    private int minCount = 99;\r\n    private List<Filterbase> treeItems;\r\n\r\n    /**\r\n     * The TreeConverter function takes a list of Filterbase objects and converts them into a tree structure.\r\n     * The function returns the root node of the tree.\r\n     *\r\n     * @param List&lt;Filterbase&gt; treeItems Pass the list of tree items to the treeconverter function\r\n     * @return A treeitem&lt;filterbase&gt;\r\n     */\r\n    public TreeConverter(List<Filterbase> treeItems) {\r\n        this.treeItems = treeItems;\r\n    }\r\n\r\n    /**\r\n     * The convertToTree function takes the list of Filterbase objects and converts it into a tree structure.\r\n     * The function first finds the maximum level in the tree, then finds the minimum level in the tree.\r\n     * It then iterates through each level from max to min, compressing each one by calling compressByLevel().\r\n     * Finally, it sorts all of its items by their sort value (which is set during compression).\r\n     *\r\n     * @return A list of filterbase objects\r\n     */\r\n    public List<Filterbase> convertToTree() {\r\n        getMaxLevel();\r\n        getMinLevel();\r\n        for (int i = maxCount; i != minCount; i--) {\r\n            compressByLevel(i);\r\n        }\r\n        treeItems.sort((o1, o2) -> o1.getSort().compareTo(o2.getSort()));\r\n        return treeItems;\r\n    }\r\n\r\n    /**\r\n     * The getMinLevel function is used to find the minimum level of the tree.\r\n     * This is done by splitting each identifier on &quot;:&quot; and counting how many times it occurs.\r\n     * The lowest count will be the minimum level of the tree, which we need to know in order to\r\n     * properly indent each item in our table view.\r\n     *\r\n     * @return The minimum number of levels in the tree\r\n     */\r\n    private void getMinLevel() {\r\n        minCount = 0;\r\n        for (Filterbase item : treeItems) {\r\n            int count = item.getIdentifier().split(\":\").length;\r\n            if (count < minCount) {\r\n                minCount = count;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The getMaxLevel function is used to determine the maximum number of levels in the tree.\r\n     * This is done by splitting each identifier on &quot;:&quot; and counting how many elements are in that array.\r\n     * The largest count will be stored as maxCount, which can then be used to determine how many columns should exist for this table.\r\n     *\r\n     * @return The maximum number of levels in the tree\r\n     */\r\n    private void getMaxLevel() {\r\n        maxCount = 0;\r\n        for (Filterbase item : treeItems) {\r\n            int count = item.getIdentifier().split(\":\").length;\r\n            if (count > maxCount) {\r\n                maxCount = count;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The compressByLevel function takes a level as an argument and then iterates through the treeItems list.\r\n     * If the item's identifier is one less than the level, it adds all items that start with that item's identifier to its childs list.\r\n     * It then sorts those childs by their sort value and adds them to a buffer list.\r\n     * If an item has a lower level than the given one, it is also added to this buffer list.\r\n     * After iterating through all items in treeItems, if there are any elements in this bufferList they will be assigned back into treeItems so that only relevant elements remain\r\n     *\r\n     * @param int level Determine the level of the tree\r\n     */\r\n    private void compressByLevel(int level) {\r\n        List<Filterbase> buffer = new ArrayList<>();\r\n        treeItems.forEach(item -> {\r\n            int itemLevel = item.getIdentifier().split(\":\").length;\r\n            if (itemLevel + 1 == level) {\r\n                List<Filterbase> items = treeItems.stream().filter(filter -> filter.getIdentifier().startsWith(item.getIdentifier() + \":\")).collect(Collectors.toList());\r\n                items.sort((o1, o2) -> o1.getSort().compareTo(o2.getSort()));\r\n                item.setChilds(items);\r\n                buffer.add(item);\r\n            } else if (itemLevel < level) {\r\n                buffer.add(item);\r\n            }\r\n\r\n        });\r\n        if (!buffer.isEmpty()) {\r\n            treeItems = buffer;\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\TreeConverter.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\UnzipUtility.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport java.io.*;\r\nimport java.util.zip.ZipEntry;\r\nimport java.util.zip.ZipInputStream;\r\n\r\npublic class UnzipUtility {\r\n    /**\r\n     * Size of the buffer to read/write data\r\n     */\r\n    private static final int BUFFER_SIZE = 4096;\r\n\r\n    /**\r\n     * Extracts a zip file specified by the zipFilePath to a directory specified by\r\n     * destDirectory (will be created if does not exists)\r\n     *\r\n     * @param zipFilePath\r\n     * @param destDirectory\r\n     * @throws IOException\r\n     */\r\n    public void unzip(String zipFilePath, String destDirectory) throws IOException {\r\n        File destDir = new File(destDirectory);\r\n        if (!destDir.exists()) {\r\n            destDir.mkdir();\r\n        }\r\n        ZipInputStream zipIn = new ZipInputStream(new FileInputStream(zipFilePath));\r\n        ZipEntry entry = zipIn.getNextEntry();\r\n        // iterates over entries in the zip file\r\n        while (entry != null) {\r\n            String filePath = destDirectory + File.separator + entry.getName();\r\n            if (!entry.isDirectory()) {\r\n                // if the entry is a file, extracts it\r\n                extractFile(zipIn, filePath);\r\n            } else {\r\n                // if the entry is a directory, make the directory\r\n                File dir = new File(filePath);\r\n                dir.mkdir();\r\n            }\r\n            zipIn.closeEntry();\r\n            entry = zipIn.getNextEntry();\r\n        }\r\n        zipIn.close();\r\n    }\r\n\r\n    /**\r\n     * Extracts a zip entry (file entry)\r\n     *\r\n     * @param zipIn\r\n     * @param filePath\r\n     * @throws IOException\r\n     */\r\n    private void extractFile(ZipInputStream zipIn, String filePath) throws IOException {\r\n        BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(filePath));\r\n        byte[] bytesIn = new byte[BUFFER_SIZE];\r\n        int read = 0;\r\n        while ((read = zipIn.read(bytesIn)) != -1) {\r\n            bos.write(bytesIn, 0, read);\r\n        }\r\n        bos.close();\r\n    }\r\n}\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\UnzipUtility.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\UserParameterUtils.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport com.hom.ebmw.jpa.model.User;\r\nimport com.hom.ebmw.jpa.model.UserParameter;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.enums.UserParameterType;\r\n\r\nimport java.util.Objects;\r\nimport java.util.Optional;\r\n\r\npublic class UserParameterUtils {\r\n\r\n    /**\r\n     * The getParameter function is used to retrieve a parameter from the database.\r\n     *\r\n     * @param Context           ctx Get the services from the context\r\n     * @param UserParameterType type Specify the type of parameter that you want to retrieve\r\n     * @param User              user Get the user parameter for a specific user\r\n     * @return The value of the parameter\r\n     */\r\n    public static <E> E getParameter(Context ctx, UserParameterType type, User user) {\r\n        Optional<UserParameter> optUserParameter = ctx.getServices().getUserParameterService().findByUserAndParam(user, type.name());\r\n        if (optUserParameter.isPresent()) {\r\n            return optUserParameter.get().getValue();\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The putParameter function is used to store a value in the database.\r\n     * The function takes four parameters:\r\n     * - A Context object, which is used to access the database and other services.\r\n     * - A UserParameterType enum, which specifies what type of parameter we are storing (e.g., &quot;LAST_LOGIN&quot;).\r\n     * - An E value, which represents the actual data that we want to store (e.g., &quot;2017/01/01 12:00:00&quot;). This can be any type of object; it will be converted into a String before being stored\r\n     *\r\n     * @param Context           ctx Access the database\r\n     *                          public static &lt;t&gt; t getparameter(context ctx, userparametertype type, class&lt;t&gt; clazz) {\r\n     *                          optional&lt;userparameter&gt; optuserparam = ctx\r\n     * @param UserParameterType type Identify the parameter that is to be saved\r\n     * @param E                 value Set the value of the userparameter object\r\n     * @param User              user Identify the user for which we want to save a parameter\r\n     */\r\n    public static <E> void putParameter(Context ctx, UserParameterType type, E value, User user) {\r\n        Optional<UserParameter> optUserParameter = ctx.getServices().getUserParameterService().findByUserAndParam(user, type.name());\r\n        UserParameter toSave = new UserParameter();\r\n        toSave.setParam(type.name());\r\n        toSave.setUser(user);\r\n        if (optUserParameter.isPresent()) {\r\n            toSave = optUserParameter.get();\r\n        }\r\n        toSave.setValue(value);\r\n        ctx.getServices().getUserParameterService().save(toSave);\r\n    }\r\n\r\n    /**\r\n     * The cloneParameter function is used to copy a parameter from one user to another.\r\n     *\r\n     * @param Context           ctx Store the parameter in the database\r\n     * @param UserParameterType type Identify the type of parameter to be cloned\r\n     * @param User              from Get the value of a parameter from that user\r\n     * @param User              to Store the value of the user from parameter\r\n     */\r\n    public static void cloneParameter(Context ctx, UserParameterType type, User from, User to) {\r\n        Object value = getParameter(ctx, type, from);\r\n        if (Objects.nonNull(value))\r\n            putParameter(ctx, type, value, to);\r\n    }\r\n\r\n    /**\r\n     * The cloneAllParameter function takes in a Context, User from, and User to.\r\n     * It then iterates through all of the values in the enum class UserParameterType.\r\n     * For each value it calls cloneParameter with that value as well as the other two parameters passed into this function.\r\n     *\r\n     * @param Context ctx Get the current context of the application\r\n     * @param User    from Get the parameter value from\r\n     * @param User    to Set the user parameter to a specific value\r\n     */\r\n    public static void cloneAllParameter(Context ctx, User from, User to) {\r\n        for (UserParameterType type : UserParameterType.values()) {\r\n            cloneParameter(ctx, type, from, to);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The removeParameter function removes a parameter from the database.\r\n     *\r\n     * @param Context           ctx Access the database\r\n     * @param UserParameterType type Specify the type of parameter to be removed\r\n     * @param User              from Find the parameter to remove\r\n     */\r\n    public static void removeParameter(Context ctx, UserParameterType type, User from) {\r\n        Optional<UserParameter> optParam = ctx.getServices().getUserParameterService().findByUserAndParam(from, type.name());\r\n        optParam.ifPresent(param -> {\r\n            ctx.getServices().getUserParameterService().delete(param);\r\n        });\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\UserParameterUtils.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\ZIPFiles.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport java.io.File;\r\nimport java.io.IOException;\r\nimport java.net.URI;\r\nimport java.nio.file.*;\r\nimport java.util.HashMap;\r\nimport java.util.List;\r\nimport java.util.Map;\r\n\r\npublic class ZIPFiles {\r\n    private final FileSystem zipfs;\r\n\r\n    /**\r\n     * The ZIPFiles function creates a new ZIP file system, which is used to read and write files in the ZIP file.\r\n     *\r\n     * @param File runFile Create a new file system\r\n     * @return A filesystem object\r\n     */\r\n    public ZIPFiles(File runFile) throws IOException, FileSystemAlreadyExistsException {\r\n        Map<String, String> env = new HashMap<>();\r\n        env.put(\"create\", \"true\");\r\n        env.put(\"encoding\", \"UTF-8\");\r\n        zipfs = FileSystems.newFileSystem(URI.create(\"jar:\" + runFile.toURI()), env);\r\n    }\r\n\r\n    /**\r\n     * The addAllToZip function takes a list of files and adds them to the zip file.\r\n     *\r\n     * @param List&lt;File&gt; files Pass a list of files to the function\r\n     */\r\n    public void addAllToZip(List<File> files) throws IOException {\r\n        for (File file : files) {\r\n            addToZip(file);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The addToZip function takes a file and adds it to the zip file.\r\n     *\r\n     * @param String filename Create a new file object\r\n     */\r\n    public void addToZip(String filename) throws IOException {\r\n        File file = new File(filename);\r\n        addToZip(file);\r\n    }\r\n\r\n    /**\r\n     * The addToZip function takes a file or directory and adds it to the zip file.\r\n     * If the input is a directory, then all files in that directory are added recursively.\r\n     *\r\n     * @param File fo Specify the file or folder to be added to the zip file\r\n     */\r\n    public void addToZip(File fo) throws IOException {\r\n        Path externalTxtFile = fo.toPath();\r\n        Path pathInZipfile = zipfs.getPath(fo.getName()); //all files to be stored have a common base folder, results/ in my case\r\n        if (fo.exists()) {\r\n            if (Files.isDirectory(externalTxtFile)) {\r\n                Files.createDirectories(pathInZipfile);\r\n                try (DirectoryStream<Path> ds = Files.newDirectoryStream(externalTxtFile)) {\r\n                    for (Path child : ds) {\r\n                        addToZip(child.normalize().toString()); //recursive call\r\n                    }\r\n                }\r\n            } else {\r\n                // copy file to zip file\r\n                Files.copy(externalTxtFile, pathInZipfile, StandardCopyOption.REPLACE_EXISTING);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The close function closes the zip file system.\r\n     */\r\n    public void close() throws IOException {\r\n        zipfs.close();\r\n    }\r\n}\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\ZIPFiles.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\ZipUtility.java =====\n```\npackage com.hom.ebmw.utilities;\r\n\r\nimport java.io.File;\r\nimport java.io.FileNotFoundException;\r\nimport java.io.IOException;\r\nimport java.nio.file.Files;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\n\r\n/**\r\n * This utility compresses a list of files to standard ZIP format file. It is\r\n * able to compress all sub files and sub directories, recursively.\r\n *\r\n * @author www.codejava.net\r\n */\r\npublic class ZipUtility {\r\n    /**\r\n     * Compresses a list of files to a destination zip file\r\n     *\r\n     * @param listFiles   A collection of files and directories\r\n     * @param destZipFile The path of the destination zip file\r\n     * @throws FileNotFoundException\r\n     * @throws IOException\r\n     */\r\n\r\n    public static File compress(List<File> listFiles, String destZipFile) throws FileNotFoundException, IOException {\r\n        File zipFile = new File(destZipFile);\r\n        ZipUtility.compress(listFiles, zipFile);\r\n\r\n        return zipFile;\r\n    }\r\n\r\n    public static File compress(List<File> listFiles, File zip)\r\n            throws\r\n            IOException {\r\n\r\n        Files.deleteIfExists(zip.toPath());\r\n        ZIPFiles packer = new ZIPFiles(zip);\r\n        packer.addAllToZip(listFiles);\r\n        packer.close();\r\n\r\n        return zip;\r\n    }\r\n\r\n    /**\r\n     * Compresses files represented in an array of paths\r\n     *\r\n     * @param files       a String array containing file paths\r\n     * @param destZipFile The path of the destination zip file\r\n     * @throws FileNotFoundException\r\n     * @throws IOException\r\n     */\r\n    public static void zip(String[] files, String destZipFile) throws FileNotFoundException, IOException {\r\n        List<File> listFiles = new ArrayList<File>();\r\n        for (int i = 0; i < files.length; i++) {\r\n            listFiles.add(new File(files[i]));\r\n        }\r\n        compress(listFiles, destZipFile);\r\n    }\r\n}\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\utilities\\ZipUtility.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\AdminHeader.java =====\n```\npackage com.hom.ebmw.view.admin;\r\n\r\npublic class AdminHeader {\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\AdminHeader.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\AdminPresenter.java =====\n```\npackage com.hom.ebmw.view.admin;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.graph.model.GraphUser;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.AstNotification;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.view.admin.components.PermissionGrid;\r\nimport com.vaadin.flow.component.ClickEvent;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.Serializable;\r\nimport java.util.Collection;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\nimport java.util.Optional;\r\n\r\n@Slf4j\r\npublic class AdminPresenter implements Serializable {\r\n\r\n    private static final long serialVersionUID = 1198056873012388263L;\r\n\r\n    private final SessionUtils session;\r\n    private final Services services;\r\n    private final Context ctx;\r\n\r\n    /**\r\n     * The AdminPresenter function is responsible for the following:\r\n     * 1. It creates a new AdminView object and sets it as the view of this presenter.\r\n     * 2. It adds an event listener to the view's &quot;add&quot; button, which calls addUser() when clicked.\r\n     * 3. It adds an event listener to the view's &quot;remove&quot; button, which calls removeUser() when clicked.\r\n     *\r\n     * @param Context ctx Get the services and session objects\r\n     * @return An instance of the adminpresenter class\r\n     */\r\n    public AdminPresenter(Context ctx) {\r\n        this.ctx = ctx;\r\n        this.services = ctx.getServices();\r\n        this.session = ctx.getSession();\r\n    }\r\n\r\n    /**\r\n     * The updatePermissions function is used to update the permissions of a role.\r\n     * It takes in a Role object as an argument and uses it to find all the permissions that are not associated with that role.\r\n     * Then, for each permission found, it creates a new RolePermission object and sets its read, write, delete and edit properties to false.\r\n     * The function then saves this new RolePermission object into the database using the save method from our service layer's RolePermissionService class.\r\n     *\r\n     * @param Role currentRole Find the permissions for that role\r\n     */\r\n    public void updatePermissions(Role currentRole) {\r\n        List<Permission> permClass = services.getPermissionService().findAll();\r\n\r\n        List<RolePermission> permissions = services.getRolePermissionService().findByRole(currentRole);\r\n        permissions.forEach(perms -> {\r\n            permClass.removeIf(permClazz -> permClazz.getName().equals(perms.getPermission().getName()));\r\n        });\r\n\r\n        permClass.forEach(perms -> {\r\n            RolePermission perm = new RolePermission();\r\n            perm.setRead(false);\r\n            perm.setWrite(false);\r\n            perm.setDelete(false);\r\n            perm.setEdit(false);\r\n            perm.setPermission(perms);\r\n            perm.setRole(currentRole);\r\n            services.getRolePermissionService().save(perm);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The searchUser function is used to search for users in the Azure Active Directory.\r\n     *\r\n     * @param GridPro&lt;GraphUser&gt; uGrid Set the data provider for the grid\r\n     * @param String                   searchValue Search for the users\r\n     */\r\n    public void searchUser(GridPro<GraphUser> uGrid, String searchValue) {\r\n        try {\r\n            List<GraphUser> graphUsers = null;\r\n            graphUsers = services.getGraphService().getUsersBySurNameAndGiveName(searchValue, searchValue);\r\n            graphUsers.removeIf(item -> Objects.isNull(item.getMail()));\r\n            graphUsers.removeIf(item -> item.getMail().isEmpty());\r\n            uGrid.setDataProvider(DataProvider.ofCollection(graphUsers));\r\n        } catch (IllegalArgumentException e) {\r\n            log.error(e.getLocalizedMessage(), e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The savePermissions function is used to save the permissions that have been set for a role.\r\n     *\r\n     * @param PermissionGrid pGrid Get the data provider, which is used to get all of the items in the grid\r\n     */\r\n    public void savePermissions(PermissionGrid pGrid) {\r\n        @SuppressWarnings(\"unchecked\")\r\n        ListDataProvider<RolePermission> dataProvider = (ListDataProvider<RolePermission>) pGrid.getDataProvider();\r\n        Collection<RolePermission> items = dataProvider.getItems();\r\n        services.getRolePermissionService().saveAll(items);\r\n    }\r\n\r\n    /**\r\n     * The setPrimaryRole function sets the primary role of a user.\r\n     *\r\n     * @param User user Set the role of a user\r\n     * @param Role role Set the role of the user\r\n     */\r\n    public void setPrimaryRole(User user, Role role) {\r\n        user.setRole(role);\r\n        services.getUserServices().save(user);\r\n    }\r\n\r\n    /**\r\n     * The setRoleSelector function is called when a user clicks on the checkbox next to a role in the roles list.\r\n     * If the checkbox was checked, it will add that role to that user's list of roles.\r\n     * If it was unchecked, it will remove that role from their list of roles.\r\n     *\r\n     * @param User                       user Get the user object from the database\r\n     * @param Role                       role Determine if the user has a certain role\r\n     * @param ClickEvent&lt;Checkbox&gt; event Get the value of the checkbox\r\n     */\r\n    public void setRoleSelector(User user, Role role, ClickEvent<Checkbox> event) {\r\n        Optional<RoleUser> optSearch = services.getRoleUserService().findByRoleAndUser(role, user);\r\n        if (event.getSource().getValue().booleanValue() && !optSearch.isPresent()) {\r\n            RoleUser rUser = new RoleUser();\r\n            rUser.setRole(role);\r\n            rUser.setUser(user);\r\n            services.getRoleUserService().save(rUser);\r\n        } else if (!event.getSource().getValue().booleanValue() && optSearch.isPresent()) {\r\n            if (user.getId() == 1 && role.getId() == 1) {\r\n                event.getSource().setValue(true);\r\n                String message = services.getTranslationService()\r\n                        .getTranslation(TMS.ERROR_MSG_COULD_NOT_DELETE_ADMIN_ROLE, session.getLocale(ctx), ctx);\r\n                AstNotification notify = new AstNotification(ctx);\r\n                notify.errorMessage(message);\r\n            } else {\r\n                services.getRoleUserService().delete(optSearch.get());\r\n            }\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\AdminPresenter.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\AdminView.java =====\n```\npackage com.hom.ebmw.view.admin;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.graph.model.GraphUser;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.AstNotification;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.UserParameterUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.utilities.enums.UserParameterType;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.admin.components.PermissionGrid;\r\nimport com.hom.ebmw.view.admin.components.RoleGrid;\r\nimport com.hom.ebmw.view.admin.components.UserParamaterLayout;\r\nimport com.vaadin.flow.component.Composite;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.confirmdialog.ConfirmDialog;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.grid.Grid.Column;\r\nimport com.vaadin.flow.component.grid.Grid.SelectionMode;\r\nimport com.vaadin.flow.component.grid.HeaderRow;\r\nimport com.vaadin.flow.component.grid.contextmenu.GridContextMenu;\r\nimport com.vaadin.flow.component.grid.contextmenu.GridMenuItem;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.data.provider.ListDataProvider;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\n\r\nimport java.util.*;\r\n\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_ADMIN;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_ADMIN;\r\n\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_ADMIN, layout = MainView.class)\r\n@PageTitle(TITLE_ADMIN)\r\npublic class AdminView extends Composite<VerticalLayout> {\r\n    private final Services services;\r\n    private List<Role> roles;\r\n    private List<User> users;\r\n    private GridPro<GraphUser> uGrid;\r\n    private GridPro<RoleGrid> xGrid;\r\n    private GridContextMenu<RoleGrid> menue;\r\n    private UserParamaterLayout userParameters;\r\n\r\n    private GridPro<Role> rGrid;\r\n    private PermissionGrid pGrid;\r\n\r\n    private final AdminPresenter presenter;\r\n\r\n    private final Context ctx = new Context();\r\n\r\n\r\n    /**\r\n     * The AdminView function is the constructor for the AdminView class.\r\n     * It initializes a new instance of this class, and sets up all of its attributes.\r\n     *\r\n     * @param @NotNull Services services Get the services from the adminview function\r\n     */\r\n    public AdminView(Services services) {\r\n        this.services = services;\r\n        ctx.setUuid(UUID.randomUUID());\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        this.presenter = new AdminPresenter(ctx);\r\n        reload();\r\n\r\n    }\r\n\r\n    /**\r\n     * The reload function is called when the user clicks on the &quot;Reload&quot; button.\r\n     * It clears all of the data from this panel and then re-populates it with new data.\r\n     */\r\n    public void reload() {\r\n        initLayout();\r\n    }\r\n\r\n    /**\r\n     * The initLayout function is responsible for setting up the layout of the UserRoleView.\r\n     * It does this by first removing all components from the content area, then it initializes\r\n     * a list of roles and users, builds grids to display them in, sets context menus for each grid,\r\n     * and finally adds these grids to the content area.  The function also sets up a user parameter layout.\r\n     */\r\n    private void initLayout() {\r\n        getContent().removeAll();\r\n\r\n        roles = ctx.getServices().getRoleService().findAll();\r\n        users = ctx.getServices().getUserServices().findAllByActive(true);\r\n\r\n        buildUserImportGrid();\r\n        buildUserRoleGrid();\r\n        buildRoleGrid();\r\n        buildPermissionGrid();\r\n\r\n        setGridContextMenue();\r\n        setUserParameterlayout();\r\n\r\n        reloadRoleGrid();\r\n        HorizontalLayout userBay = new HorizontalLayout();\r\n        HorizontalLayout roleBay = new HorizontalLayout();\r\n        userBay.add(uGrid, xGrid, menue, userParameters);\r\n        roleBay.add(rGrid, pGrid);\r\n        userBay.setSizeFull();\r\n        roleBay.setSizeFull();\r\n        uGrid.setWidth(\"35%\");\r\n        uGrid.setHeight(\"100%\");\r\n        rGrid.setWidth(\"35%\");\r\n        rGrid.setHeight(\"100%\");\r\n        xGrid.setWidth(\"65%\");\r\n        xGrid.setHeight(\"100%\");\r\n        pGrid.setWidth(\"65%\");\r\n        pGrid.setHeight(\"100%\");\r\n        CompUtils.removeMSP(userBay, \"MP\");\r\n        CompUtils.removeMSP(roleBay, \"MP\");\r\n        getContent().add(userBay, roleBay);\r\n        getContent().setSizeFull();\r\n    }\r\n\r\n    /**\r\n     * The buildUserImportGrid function creates a grid that displays the users that are found by the search function.\r\n     * The user can then select which of these users to add to their team.\r\n     */\r\n    private void buildUserImportGrid() {\r\n        TextField searchTxt = new TextField();\r\n        searchTxt.setPlaceholder(getTranslation(TMS.ADMIN_SEARCH_USER, getLocale(), ctx));\r\n\r\n        Button searchBtn = new Button(VaadinIcon.SEARCH.create());\r\n\r\n        uGrid = new GridPro<>();\r\n        HeaderRow addRow = uGrid.appendHeaderRow();\r\n\r\n        Column<GraphUser> firstColumn = uGrid.addColumn(GraphUser::getSurname)\r\n                .setHeader(getTranslation(TMS.USER_GRID_SUR_NAME, getLocale(), ctx));\r\n        addRow.getCell(firstColumn).setComponent(searchTxt);\r\n        Column<GraphUser> secondColumn = uGrid.addColumn(GraphUser::getGivenname)\r\n                .setHeader(getTranslation(TMS.USER_GRID_GIVEN_NAME, getLocale(), ctx));\r\n        addRow.getCell(secondColumn).setComponent(searchBtn);\r\n        uGrid.addColumn(GraphUser::getMail).setHeader(getTranslation(TMS.USER_GRID_MAIL, getLocale(), ctx));\r\n        uGrid.addComponentColumn(this::addUser);\r\n\r\n        searchBtn.addClickListener(event ->\r\n                presenter.searchUser(uGrid, searchTxt.getValue())\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The setUserParameterlayout function sets the userParameters layout to be invisible and 40% of the screen.\r\n     */\r\n    private void setUserParameterlayout() {\r\n        userParameters = new UserParamaterLayout(ctx);\r\n        userParameters.setVisible(false);\r\n        userParameters.setWidth(\"40%\");\r\n    }\r\n\r\n    /**\r\n     * The addUser function is used to add a user to the database.\r\n     *\r\n     * @param GraphUser user Create a new user in the database\r\n     * @return A horizontallayout\r\n     */\r\n    private HorizontalLayout addUser(GraphUser user) {\r\n        HorizontalLayout cell = new HorizontalLayout();\r\n\r\n        ComboBox<User> cloneUser = new ComboBox<>();\r\n        cloneUser.setPlaceholder(\"toClone\");\r\n        cloneUser.setItems(users);\r\n        cloneUser.setItemLabelGenerator(item -> item.getSurName() + \", \" + item.getGivenName());\r\n\r\n        Button addBtn = new Button(VaadinIcon.PLUS.create());\r\n        addBtn.addClickListener(event -> {\r\n            Optional<User> optUser = ctx.getServices().getUserServices().findByUserId(user.getId());\r\n            if (!optUser.isPresent()) {\r\n                User newUser = new User();\r\n                newUser.setGivenName(user.getGivenname());\r\n                newUser.setSurName(user.getSurname());\r\n                newUser.setUserId(user.getId());\r\n                User tempUser = ctx.getServices().getUserServices().save(newUser);\r\n\r\n                if (Objects.nonNull(cloneUser.getValue())) {\r\n                    User cloneFrom = cloneUser.getValue();\r\n                    List<RoleUser> xCrossList = new ArrayList<>();\r\n                    xCrossList = ctx.getServices().getRoleUserService().findAllByUser(cloneFrom);\r\n                    xCrossList.forEach(item -> item.setId(0));\r\n                    xCrossList.forEach(item -> item.setUser(tempUser));\r\n                    tempUser.setRole(cloneFrom.getRole());\r\n                    ctx.getServices().getRoleUserService().saveAll(xCrossList);\r\n                    ctx.getServices().getUserServices().save(tempUser);\r\n                    UserParameterUtils.cloneAllParameter(ctx, cloneFrom, tempUser);\r\n                }\r\n            } else {\r\n                User oldUser = optUser.get();\r\n                oldUser.setActive(true);\r\n                ctx.getServices().getUserServices().save(oldUser);\r\n            }\r\n            reloadUserRoleGrid();\r\n        });\r\n        cell.add(cloneUser, addBtn);\r\n        cell.setSizeFull();\r\n        cloneUser.setWidth(\"75%\");\r\n        addBtn.setWidth(\"25%\");\r\n        CompUtils.removeMSP(cell, \"MP\");\r\n        return cell;\r\n    }\r\n\r\n    /**\r\n     * The buildUserRoleGrid function creates the grid that displays all of the users and their roles.\r\n     * It also adds a filter to search for specific users by name.\r\n     */\r\n    private void buildUserRoleGrid() {\r\n        xGrid = new GridPro<>();\r\n\r\n        String header = getTranslation(TMS.USER_GRID_SUR_NAME, getLocale(), ctx) + \", \"\r\n                + getTranslation(TMS.USER_GRID_GIVEN_NAME, getLocale(), ctx);\r\n        Grid.Column<RoleGrid> firstColumn = xGrid\r\n                .addColumn(item -> item.getUser().getGivenName() + \" \" + item.getUser().getSurName()).setHeader(header)\r\n                .setSortable(true).setWidth(\"8em\").setFrozen(true);\r\n\r\n        xGrid.addComponentColumn(item -> setDeleteBtn(item.getUser()))\r\n                .setHeader(getTranslation(TMS.GLB_BUTTON_DELETE, getLocale(), ctx)).setWidth(\"5em\").setFrozen(true);\r\n        for (int i = 0; i < roles.size(); i++) {\r\n            final int colum = i;\r\n\r\n            xGrid.addComponentColumn(item -> addRoleSelector(item.getUser(), item.getRoles().get(colum)))\r\n                    .setHeader(roles.get(colum).getName()).setWidth(\"4em\");\r\n        }\r\n\r\n        HeaderRow filterRow = xGrid.appendHeaderRow();\r\n\r\n        TextField userFld = new TextField();\r\n        userFld.addValueChangeListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<RoleGrid> dataProvider = (ListDataProvider<RoleGrid>) xGrid.getDataProvider();\r\n            dataProvider.setFilter(RoleGrid::getUser, user -> {\r\n                String name = user.getGivenName() + \" \" + user.getSurName();\r\n                String nameLower = (name == null ? \"\" : name.toLowerCase(Locale.ENGLISH));\r\n                String filterLower = event.getValue().toLowerCase(Locale.ENGLISH);\r\n                return nameLower.contains(filterLower);\r\n            });\r\n            xGrid.setDataProvider(dataProvider);\r\n        });\r\n        Button clearUserFltr = new Button(VaadinIcon.CLOSE_SMALL.create());\r\n        clearUserFltr.addClickListener(event -> {\r\n            @SuppressWarnings(\"unchecked\")\r\n            ListDataProvider<RoleGrid> provider = (ListDataProvider<RoleGrid>) xGrid.getDataProvider();\r\n            provider.clearFilters();\r\n            userFld.setValue(\"\");\r\n        });\r\n        HorizontalLayout cell1 = new HorizontalLayout();\r\n        cell1.add(userFld, clearUserFltr);\r\n        cell1.setSizeFull();\r\n        CompUtils.removeMSP(cell1, \"MSP\");\r\n        userFld.setWidth(\"80%\");\r\n        clearUserFltr.setWidth(\"20%\");\r\n        filterRow.getCell(firstColumn).setComponent(cell1);\r\n    }\r\n\r\n    /**\r\n     * The saveRoleName function saves the name of a role to the database.\r\n     *\r\n     * @param Role   item Set the name of the role\r\n     * @param String name Set the name of the role\r\n     * @return A role object\r\n     */\r\n    private Role saveRoleName(Role item, String name) {\r\n        item.setName(name);\r\n        return ctx.getServices().getRoleService().save(item);\r\n    }\r\n\r\n    /**\r\n     * The buildRoleGrid function creates a grid that displays the roles in the database.\r\n     * It also allows for new roles to be added and existing ones to be deleted.\r\n     */\r\n    private void buildRoleGrid() {\r\n        rGrid = new GridPro<>();\r\n\r\n        HeaderRow addRow = rGrid.appendHeaderRow();\r\n\r\n        TextField nameTxt = new TextField();\r\n        Button addBtn = new Button(VaadinIcon.PLUS.create());\r\n\r\n        Column<Role> firstColumn = rGrid.addEditColumn(Role::getName).text(this::saveRoleName).setHeader(\"Name\");\r\n        addRow.getCell(firstColumn).setComponent(nameTxt);\r\n        Column<Role> secondColumn = rGrid.addComponentColumn(this::deleteRole);\r\n        addRow.getCell(secondColumn).setComponent(addBtn);\r\n        addBtn.addClickListener(event -> {\r\n            if (!nameTxt.getValue().isEmpty()) {\r\n                Role role = new Role();\r\n                role = saveRoleName(role, nameTxt.getValue());\r\n                presenter.updatePermissions(role);\r\n            }\r\n        });\r\n        rGrid.setSelectionMode(SelectionMode.SINGLE);\r\n        rGrid.addSelectionListener(event -> {\r\n            if (event.getFirstSelectedItem().isPresent()) {\r\n                reloadPermissionGrid(event.getFirstSelectedItem().get());\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The reloadRoleGrid function is called when the user clicks on the &quot;Refresh&quot; button in the Role tab.\r\n     * It calls a function from our service layer to get all of the roles from our database, and then it\r\n     * sets that data as a DataProvider for our role grid. Then, it calls reloadUserRoleGrid() to update\r\n     * any changes made by this refresh operation. This function is also called at initialization time so\r\n     * that we can populate our role grid with data right away when we first load up this page.\r\n     */\r\n    private void reloadRoleGrid() {\r\n        roles = ctx.getServices().getRoleService().findAll();\r\n        rGrid.setDataProvider(DataProvider.ofCollection(roles));\r\n        reloadUserRoleGrid();\r\n    }\r\n\r\n    /**\r\n     * The deleteRole function is used to delete a role from the database.\r\n     *\r\n     * @param Role item Get the name of the role to be deleted\r\n     *             private button editrole(role item) {\r\n     *             button edit = new button(vaadinicon\r\n     * @return A button that is used to delete a role\r\n     */\r\n    private Button deleteRole(Role item) {\r\n        Button delete = new Button(VaadinIcon.CLOSE.create());\r\n        delete.addClickListener(event -> {\r\n            ConfirmDialog dialog = new ConfirmDialog(\"Delete Role \" + item.getName(), \"Are you sure!!!\", \"Accept\",\r\n                    onAccept -> {\r\n                        List<Filter> filters = ctx.getServices().getFilterService().findAllByTeam(item);\r\n                        List<RoleUser> roleUsers = ctx.getServices().getRoleUserService().findAllByRole(item);\r\n                        List<ProjectRole> projectRoles = ctx.getServices().getProjectRoleServices().findAllByRole(item);\r\n\r\n                        if (roleUsers.isEmpty() && projectRoles.isEmpty() && filters.isEmpty() && item.getId() != 1) {\r\n                            ctx.getServices().getRoleService().delete(item);\r\n                        } else {\r\n                            AstNotification notify = new AstNotification(ctx);\r\n                            notify.errorMessage(\"Please contact your adminstrator for more Details!!!\");\r\n                        }\r\n                    }, \"Cancel\", onCancel -> {\r\n                /* Do Nothing */\r\n            });\r\n            dialog.open();\r\n        });\r\n        return delete;\r\n    }\r\n\r\n    /**\r\n     * The buildPermissionGrid function creates a new PermissionGrid object, which is used to display the permissions\r\n     * that are currently granted to the application. The function also adds an onClickListener to each of the buttons in\r\n     * this grid, so that when they are clicked, their corresponding permission will be revoked from the application.\r\n     */\r\n    private void buildPermissionGrid() {\r\n        pGrid = new PermissionGrid(ctx);\r\n    }\r\n\r\n    /**\r\n     * The reloadPermissionGrid function is used to reload the permission grid with the permissions of a given role.\r\n     *\r\n     * @param Role item Get all the rolepermissions for that role\r\n     */\r\n    private void reloadPermissionGrid(Role item) {\r\n        List<RolePermission> items = ctx.getServices().getRolePermissionService().findByRole(item);\r\n        pGrid.setDataProvider(DataProvider.ofCollection(items));\r\n    }\r\n\r\n    /**\r\n     * The setDeleteBtn function creates a delete button for each user in the grid.\r\n     * The function is called by the reloadUserRoleGrid function, which is called when\r\n     * a new user is added or an existing one deleted.\r\n     *\r\n     * @param User user Get the user id and to set the active status of a user\r\n     * @return A button\r\n     */\r\n    private Button setDeleteBtn(User user) {\r\n        Button deleteBtn = new Button(VaadinIcon.CLOSE.create());\r\n        deleteBtn.addClickListener(event -> {\r\n            if (user.getId() != 1) {\r\n                user.setActive(false);\r\n                ctx.getServices().getUserServices().save(user);\r\n                reloadUserRoleGrid();\r\n            } else {\r\n                String message = getTranslation(TMS.ERROR_MSG_COULD_NOT_DELETE_INITIAL_ADMIN, getLocale(), ctx);\r\n                AstNotification notify = new AstNotification(ctx);\r\n                notify.errorMessage(message);\r\n            }\r\n        });\r\n\r\n        return deleteBtn;\r\n    }\r\n\r\n    /**\r\n     * The setUserDetailRolePrimary function is used to set the user's role.\r\n     *\r\n     * @param User user Get the user's role and set it to the combo box\r\n     */\r\n    private void setUserDetailRolePrimary(User user) {\r\n        userParameters.setVisible(true);\r\n        ComboBox<Role> combo = new ComboBox<>();\r\n        combo.setItems(roles);\r\n        combo.setItemLabelGenerator(Role::getName);\r\n        if (Objects.nonNull(user.getRole())) {\r\n            combo.setValue(user.getRole());\r\n        }\r\n        userParameters.getBody().removeAll();\r\n        userParameters.getBody().add(combo);\r\n        userParameters.getSaveBtn().setVisible(true);\r\n        userParameters.getSaveBtn().addClickListener(event -> {\r\n            if (Objects.nonNull(combo.getValue())) {\r\n                user.setRole(combo.getValue());\r\n            }\r\n            ctx.getServices().getUserServices().save(user);\r\n            userParameters.setVisible(false);\r\n        });\r\n        userParameters.getDeleteBtn().setVisible(false);\r\n\r\n        userParameters.getCancelBtn().setVisible(true);\r\n        userParameters.getCancelBtn().addClickListener(event ->\r\n                userParameters.setVisible(false)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The setUserDetailCustomerPrefix function is used to set the user detail customer prefix.\r\n     *\r\n     * @param User user Get the user's id and to set the value of the parameter\r\n     */\r\n    private void setUserDetailCustomerPrefix(User user) {\r\n        userParameters.setVisible(true);\r\n        ComboBox<Role> combo = new ComboBox<>();\r\n        combo.setItems(roles);\r\n        combo.setItemLabelGenerator(Role::getName);\r\n        Role customerPrefix = UserParameterUtils.getParameter(ctx, UserParameterType.CUSTOMER_PREFIX, user);\r\n        if (Objects.nonNull(customerPrefix)) {\r\n            combo.setValue(customerPrefix);\r\n        }\r\n        userParameters.getBody().removeAll();\r\n        userParameters.getBody().add(combo);\r\n        userParameters.getSaveBtn().setVisible(true);\r\n        userParameters.getSaveBtn().addClickListener(event -> {\r\n            if (Objects.nonNull(combo.getValue())) {\r\n                UserParameterUtils.putParameter(ctx, UserParameterType.CUSTOMER_PREFIX, combo.getValue(), user);\r\n            }\r\n            userParameters.setVisible(false);\r\n        });\r\n        userParameters.getDeleteBtn().setVisible(true);\r\n        userParameters.getDeleteBtn().addClickListener(event -> {\r\n            if (Objects.nonNull(combo.getValue())) {\r\n                UserParameterUtils.removeParameter(ctx, UserParameterType.CUSTOMER_PREFIX, user);\r\n            }\r\n            userParameters.setVisible(false);\r\n        });\r\n        userParameters.getCancelBtn().setVisible(true);\r\n        userParameters.getCancelBtn().addClickListener(event ->\r\n                userParameters.setVisible(false)\r\n        );\r\n    }\r\n\r\n\r\n    /**\r\n     * The setUserDetailCustomerByType function is used to set the user detail customer by type.\r\n     *\r\n     * @param User              user Set the user parameters for a specific user\r\n     * @param UserParameterType type Determine which parameter to set\r\n     */\r\n    private void setUserDetailCustomerByType(User user, UserParameterType type) {\r\n        userParameters.setVisible(true);\r\n        ComboBox<String> combo = new ComboBox<>();\r\n        List<String> values = new ArrayList<>();\r\n        values.add(getTranslation(TMS.GLB_TRUE, getLocale(), ctx));\r\n        values.add(getTranslation(TMS.GLB_FALSE, getLocale(), ctx));\r\n        combo.setItems(values);\r\n        Boolean value = UserParameterUtils.getParameter(ctx, type, user);\r\n\r\n        if (Objects.nonNull(value) && value.booleanValue()) {\r\n            combo.setValue(values.get(0));\r\n        } else {\r\n            combo.setValue(values.get(1));\r\n        }\r\n        userParameters.getBody().removeAll();\r\n        userParameters.getBody().add(combo);\r\n\r\n        userParameters.getSaveBtn().setVisible(true);\r\n        userParameters.getSaveBtn().addClickListener(event -> {\r\n            if (Objects.nonNull(combo.getValue())) {\r\n                UserParameterUtils.putParameter(ctx, type,\r\n                        values.get(0).equals(combo.getValue()), user);\r\n            }\r\n            userParameters.setVisible(false);\r\n        });\r\n        userParameters.getDeleteBtn().setVisible(false);\r\n        userParameters.getCancelBtn().setVisible(false);\r\n    }\r\n\r\n    /**\r\n     * The setUserDetailCustomerNewAble function is a helper function that sets the user's ability to create new customers.\r\n     *\r\n     * @param User user Set the userdetailcustomernewable field\r\n     */\r\n    private void setUserDetailCustomerNewAble(User user) {\r\n        setUserDetailCustomerByType(user, UserParameterType.CUSTOMER_WRITE);\r\n    }\r\n\r\n    /**\r\n     * The setUserDetailCustomerEditAble function sets the user detail customer editable field to true.\r\n     *\r\n     * @param User user Set the userdetailcustomereditable\r\n     */\r\n    private void setUserDetailCustomerEditAble(User user) {\r\n        setUserDetailCustomerByType(user, UserParameterType.CUSTOMER_EDITABLE);\r\n    }\r\n\r\n    /**\r\n     * The setUserDetailCustomerDelete function sets the user's customer delete parameter to true.\r\n     *\r\n     * @param User user Set the userdetailcustomerdelete variable\r\n     */\r\n    private void setUserDetailCustomerDelete(User user) {\r\n        setUserDetailCustomerByType(user, UserParameterType.CUSTOMER_DELETE);\r\n    }\r\n\r\n    /**\r\n     * The setGridContextMenue function adds a context menu to the grid.\r\n     * The context menu has several options:\r\n     * - Change role definition (setUserDetailRolePrimary)\r\n     * - Set customer prefix (setUserDetailCustomerPrefix)\r\n     * - Set customer editable (setUserDetailCustomerEditAble)\r\n     */\r\n    private void setGridContextMenue() {\r\n        menue = xGrid.addContextMenu();\r\n        // Change role definiton\r\n        GridMenuItem<RoleGrid> roleDefine = menue.addItem(getTranslation(TMS.ROLE_GRID_CONTEXT_MENUE_SET_ROLE));\r\n        roleDefine.addMenuItemClickListener(event ->\r\n                setUserDetailRolePrimary(event.getItem().get().getUser())\r\n        );\r\n        GridMenuItem<RoleGrid> customerPrefix = menue\r\n                .addItem(getTranslation(TMS.ROLE_GRID_CONTEXT_MENUE_SET_CUSTOMER_PREFIX));\r\n        customerPrefix.addMenuItemClickListener(event ->\r\n                setUserDetailCustomerPrefix(event.getItem().get().getUser())\r\n        );\r\n        // set Customer editable\r\n        GridMenuItem<RoleGrid> customerEditAble = menue\r\n                .addItem(getTranslation(TMS.ROLE_GRID_CONTEXT_MENUE_SET_CUSTOMER_EDITABLE));\r\n        customerEditAble.addMenuItemClickListener(event ->\r\n                setUserDetailCustomerEditAble(event.getItem().get().getUser())\r\n        );\r\n        GridMenuItem<RoleGrid> customerNewAble = menue\r\n                .addItem(getTranslation(TMS.ROLE_GRID_CONTEXT_MENUE_SET_CUSTOMER_WRITE));\r\n        customerNewAble.addMenuItemClickListener(event ->\r\n                setUserDetailCustomerNewAble(event.getItem().get().getUser())\r\n        );\r\n        // set Customer editable\r\n        GridMenuItem<RoleGrid> customerDelete = menue\r\n                .addItem(getTranslation(TMS.ROLE_GRID_CONTEXT_MENUE_SET_CUSTOMER_DELETE));\r\n        customerDelete.addMenuItemClickListener(event ->\r\n                setUserDetailCustomerDelete(event.getItem().get().getUser())\r\n        );\r\n    }\r\n\r\n    /**\r\n     * The addRoleSelector function creates a checkbox for each role in the system.\r\n     * The function checks to see if the user has that role, and sets the value of\r\n     * the checkbox accordingly. When clicked, it calls setRoleSelector on presenter.\r\n     *\r\n     * @param User user Get the user's id\r\n     *             private textfield addusername(user user) {\r\n     *             textfield field = new textfield();\r\n     *             <p>\r\n     *             field\r\n     * @param Role role Determine if the user has that role\r\n     * @return A checkbox\r\n     */\r\n    private Checkbox addRoleSelector(User user, Role role) {\r\n        Checkbox box = new Checkbox();\r\n        Optional<RoleUser> optResult = ctx.getServices().getRoleUserService().findByRoleAndUser(role, user);\r\n        box.setValue(optResult.isPresent());\r\n\r\n        box.addClickListener(event ->\r\n                presenter.setRoleSelector(user, role, event)\r\n        );\r\n\r\n        return box;\r\n    }\r\n\r\n    /**\r\n     * The reloadUserRoleGrid function is used to reload the user role grid.\r\n     * It does this by creating a new list of RoleGrids, and then adding each user in the users list to that new list.\r\n     * The function then sets the data provider for xGrid as DataProvider.ofCollection(rGrids).\r\n     */\r\n    private void reloadUserRoleGrid() {\r\n        List<RoleGrid> rGrids = new ArrayList<>();\r\n        users = ctx.getServices().getUserServices().findAllByActive(true);\r\n        users.forEach(user -> {\r\n            RoleGrid roleGrid = new RoleGrid();\r\n            roleGrid.setUser(user);\r\n            roleGrid.setRoles(roles);\r\n            rGrids.add(roleGrid);\r\n        });\r\n        xGrid.setDataProvider(DataProvider.ofCollection(rGrids));\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\AdminView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\components\\PermissionGrid.java =====\n```\npackage com.hom.ebmw.view.admin.components;\r\n\r\nimport com.hom.ebmw.jpa.model.RolePermission;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.view.admin.AdminView;\r\nimport com.vaadin.flow.component.checkbox.Checkbox;\r\nimport com.vaadin.flow.component.gridpro.GridPro;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class PermissionGrid extends GridPro<RolePermission> {\r\n    private final Context ctx;\r\n\r\n    /**\r\n     * The PermissionGrid function creates a grid that displays the permissions of a user.\r\n     * The grid has 5 columns: Name, Read, Write, Edit and Delete.\r\n     * Each column is filled with data from the database using getTranslation() and addColumn().\r\n     *\r\n     * @param Context ctx Get the translation for the grid\r\n     * @return A new grid with the given context\r\n     */\r\n    public PermissionGrid(Context ctx) {\r\n        this.ctx = ctx;\r\n        addColumn(perm -> getTranslation(TMS.PERMISSION + perm.getPermission().getName(), getLocale(), ctx))\r\n                .setHeader(getTranslation(TMS.PERMISSION_GRID_NAME, getLocale(), ctx)).setSortable(true).setFlexGrow(4);\r\n        addComponentColumn(this::createHasReadRights)\r\n                .setHeader(getTranslation(TMS.PERMISSION_GRID_READ, getLocale(), ctx)).setFlexGrow(1);\r\n        addComponentColumn(this::createHasWriteRights)\r\n                .setHeader(getTranslation(TMS.PERMISSION_GRID_WRITE, getLocale(), ctx)).setFlexGrow(1);\r\n        addComponentColumn(this::createHasEditRights)\r\n                .setHeader(getTranslation(TMS.PERMISSION_GRID_EDIT, getLocale(), ctx)).setFlexGrow(1);\r\n        addComponentColumn(this::createHasDeleteRights)\r\n                .setHeader(getTranslation(TMS.PERMISSION_GRID_DELETE, getLocale(), ctx)).setFlexGrow(1);\r\n    }\r\n\r\n    /**\r\n     * The createHasWriteRights function creates a checkbox that allows the user to set whether or not a role has write access to a permission.\r\n     *\r\n     * @param RolePermission permission Get the role and permission of the user\r\n     * @return A checkbox with a listener\r\n     */\r\n    private Checkbox createHasWriteRights(RolePermission permission) {\r\n        Checkbox valid = new Checkbox();\r\n        valid.setReadOnly(permission.getRole().getName().equals(\"admin\")\r\n                && permission.getPermission().getName().equals(AdminView.class.getName()));\r\n        valid.setValue(permission.isWrite());\r\n        valid.addValueChangeListener(event -> {\r\n            permission.setWrite(valid.getValue());\r\n            save(permission);\r\n        });\r\n        return valid;\r\n    }\r\n\r\n    /**\r\n     * The createHasReadRights function creates a checkbox that allows the user to set whether or not a role has read rights for a given permission.\r\n     *\r\n     * @param RolePermission permission Get the role and permission of the user\r\n     * @return A checkbox\r\n     */\r\n    private Checkbox createHasReadRights(RolePermission permission) {\r\n        Checkbox valid = new Checkbox();\r\n        valid.setReadOnly(permission.getRole().getName().equals(\"admin\")\r\n                && permission.getPermission().getName().equals(AdminView.class.getName()));\r\n        valid.setValue(permission.isRead());\r\n        valid.addValueChangeListener(event -> {\r\n            permission.setRead(valid.getValue());\r\n            save(permission);\r\n        });\r\n        return valid;\r\n    }\r\n\r\n    /**\r\n     * The createHasDeleteRights function creates a checkbox that allows the user to set whether or not a role has delete rights.\r\n     *\r\n     * @param RolePermission permission Determine if the checkbox is readonly or not\r\n     * @return A checkbox\r\n     */\r\n    private Checkbox createHasDeleteRights(RolePermission permission) {\r\n        Checkbox valid = new Checkbox();\r\n        valid.setReadOnly(permission.getRole().getName().equals(\"admin\")\r\n                && permission.getPermission().getName().equals(AdminView.class.getName()));\r\n        valid.setValue(permission.isDelete());\r\n        valid.addValueChangeListener(event -> {\r\n            permission.setDelete(valid.getValue());\r\n            save(permission);\r\n        });\r\n        return valid;\r\n    }\r\n\r\n    /**\r\n     * The createHasEditRights function creates a checkbox that allows the user to set whether or not a role has edit rights for a given permission.\r\n     *\r\n     * @param RolePermission permission Determine if the checkbox is readonly\r\n     *                       private checkbox createhasviewrights(rolepermission permission) {\r\n     *                       checkbox valid = new checkbox();\r\n     *                       if (permission\r\n     * @return A checkbox\r\n     */\r\n    private Checkbox createHasEditRights(RolePermission permission) {\r\n        Checkbox valid = new Checkbox();\r\n        valid.setReadOnly(permission.getRole().getName().equals(\"admin\")\r\n                && permission.getPermission().getName().equals(AdminView.class.getName()));\r\n        valid.setValue(permission.isEdit());\r\n        valid.addValueChangeListener(event -> {\r\n            permission.setEdit(valid.getValue());\r\n            save(permission);\r\n        });\r\n        return valid;\r\n    }\r\n\r\n    /**\r\n     * The save function saves the RolePermission object to the database.\r\n     *\r\n     * @param RolePermission item Save the rolepermission item to the database\r\n     */\r\n    private void save(RolePermission item) {\r\n        ctx.getServices().getRolePermissionService().save(item);\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\components\\PermissionGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\components\\RoleGrid.java =====\n```\npackage com.hom.ebmw.view.admin.components;\r\n\r\nimport com.hom.ebmw.jpa.model.Role;\r\nimport com.hom.ebmw.jpa.model.User;\r\nimport lombok.Data;\r\n\r\nimport java.util.List;\r\n\r\npublic @Data class RoleGrid {\r\n    private User user;\r\n    private List<Role> roles;\r\n}\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\components\\RoleGrid.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\components\\UserParamaterLayout.java =====\n```\npackage com.hom.ebmw.view.admin.components;\r\n\r\n\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport lombok.Getter;\r\n\r\n@SuppressWarnings(\"serial\")\r\npublic class UserParamaterLayout extends VerticalLayout {\r\n\r\n    private final @Getter HorizontalLayout body;\r\n    private final HorizontalLayout buttons;\r\n    private final @Getter Button saveBtn;\r\n    private final @Getter Button deleteBtn;\r\n    private final @Getter Button cancelBtn;\r\n\r\n    /**\r\n     * The UserParamaterLayout function is a constructor for the UserParamaterLayout class.\r\n     * It creates a new HorizontalLayout called body, and another called buttons.\r\n     * It also creates three Buttons: saveBtn, deleteBtn, and cancelBtn.  The text of each button is set to the translation of its name in TMS (TMS = Translation Management System).\r\n     * The click listener for saveBtn sets this layout's visibility to false when clicked on.\r\n     *\r\n     * @param Context ctx Get the current locale\r\n     * @return A horizontallayout\r\n     */\r\n    public UserParamaterLayout(Context ctx) {\r\n        body = new HorizontalLayout();\r\n        buttons = new HorizontalLayout();\r\n        saveBtn = new Button(getTranslation(TMS.GLB_BUTTON_SAVE_CLOSE, getLocale(), ctx));\r\n        deleteBtn = new Button(getTranslation(TMS.GLB_BUTTON_DELETE_CLOSE, getLocale(), ctx));\r\n        cancelBtn = new Button(getTranslation(TMS.GLB_BUTTON_CANCEL, getLocale(), ctx));\r\n\r\n        saveBtn.addClickListener(event -> setVisible(false));\r\n\r\n        buttons.add(saveBtn, deleteBtn, cancelBtn);\r\n        add(body, buttons);\r\n\r\n        CompUtils.removeMSP(this, \"MSP\");\r\n        CompUtils.removeMSP(buttons, \"MP\");\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\components\\UserParamaterLayout.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\export\\AstFileExportView.java =====\n```\npackage com.hom.ebmw.view.admin.export;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.jpa.model.*;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.Blob;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.vaadin.flow.component.Composite;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.grid.Grid;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.component.textfield.TextField;\r\nimport com.vaadin.flow.data.provider.DataProvider;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\n\r\nimport java.io.File;\r\nimport java.util.*;\r\n\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_EXPORT;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_EXPORT;\r\n\r\n@SuppressWarnings(\"serial\")\r\n@Route(value = PAGE_EXPORT, layout = MainView.class)\r\n@PageTitle(TITLE_EXPORT)\r\npublic class AstFileExportView extends Composite<VerticalLayout> {\r\n\r\n    private final Context ctx = new Context();\r\n    private final Grid<AstFile> grid = new Grid<>();\r\n    private DownloadButton downloadBtn;\r\n    private final ComboBox<LocalCustomer> customerCbx = new ComboBox<LocalCustomer>();\r\n    private final ComboBox<Role> roleCbx = new ComboBox<Role>();\r\n\r\n    /**\r\n     * The AstFileExportView function is a constructor for the AstFileExportView class.\r\n     * It initializes the context and calls the initial function to initialize all of its variables.\r\n     *\r\n     * @param Services services Get the user services and the http session\r\n     * @return A string\r\n     */\r\n    public AstFileExportView(Services services) {\r\n        ctx.setUuid(UUID.randomUUID());\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        initial();\r\n    }\r\n\r\n    /**\r\n     * The initial function is used to initialize the page.\r\n     * It adds a download button, customer combo box, role combo box, search button and grid.\r\n     * The download button is initialized with the TMS.DOWNLOAD_PREPARE_EXPORT translation key and context ctx.\r\n     * The customer combo box has its items set to all local customers found by calling findAll on LocalCustomerCustomService in ctx's services object (ctx.getServices()).\r\n     * Its item label generator is set to a lambda expression that returns &quot;(&quot; + customerId + &quot;) &quot; + name for each local customer (customer).\r\n     */\r\n    public void initial() {\r\n        downloadBtn = new DownloadButton(ctx, TMS.DOWNLOAD_PREPARE_EXPORT);\r\n\r\n        customerCbx.setItems(ctx.getServices().getLocalCustomerCustomService().findAll());\r\n        customerCbx.setItemLabelGenerator(customer -> \"(\" + customer.getCustomerId() + \") \" + customer.getName());\r\n\r\n        roleCbx.setItems(ctx.getServices().getRoleService().findAll());\r\n        roleCbx.setItemLabelGenerator(Role::getName);\r\n\r\n        Button searchBtn = new Button(getTranslation(TMS.GLB_BUTTON_SEARCH, getLocale(), ctx));\r\n\r\n        searchBtn.addClickListener(event -> {\r\n            LocalCustomer customer = customerCbx.getValue();\r\n            Role role = roleCbx.getValue();\r\n            if (Objects.nonNull(customer) && Objects.nonNull(role)) {\r\n                reload(customer, role);\r\n            }\r\n        });\r\n\r\n        TextField searchFld = CompUtils.getSearchField(ctx, grid, AstFile::getName);\r\n\r\n        grid.addColumn(AstFile::getName);\r\n        grid.addColumn(AstFile::getUpdateOn);\r\n        grid.addColumn(astFile -> astFile.getClass().getSimpleName());\r\n\r\n        grid.addSelectionListener(event -> {\r\n            event.getFirstSelectedItem().ifPresent(select -> {\r\n                downloadBtn.reloadAsFile(() -> select.getName(), () -> {\r\n                    File file = new File(SettingUtils.getTempFolder(ctx) + File.separator + select.getName());\r\n                    Storage sFile = CompUtils.getStorage(ctx, select);\r\n                    Blob.loadFromCompressedFile(sFile.getFileblob(), file);\r\n                    return file;\r\n                });\r\n            });\r\n        });\r\n\r\n        HorizontalLayout buttons = new HorizontalLayout();\r\n        buttons.add(searchBtn, searchFld, downloadBtn);\r\n        CompUtils.removeMSP(buttons, \"MP\");\r\n        getContent().add(customerCbx, roleCbx, buttons, grid);\r\n    }\r\n\r\n    /**\r\n     * The reload function is used to update the grid with new data.\r\n     * It takes a LocalCustomer and a Role as parameters, and uses them to find all AstFiles that are associated with the given customer and role.\r\n     * The function then removes any files that have no name or storage location, sorts them by their last updated date,\r\n     * and sets the grid's DataProvider to be ofCollection(files). This causes the grid to display only those files which match these criteria.\r\n     *\r\n     * @param LocalCustomer customer Find the project that is associated with this customer\r\n     * @param Role          role Filter the files by role\r\n     */\r\n    public void reload(LocalCustomer customer, Role role) {\r\n        Optional<Project> optProject = ctx.getServices().getProjectServices()\r\n                .findByCustomerNr(customer.getCustomerId());\r\n        optProject.ifPresent(project -> {\r\n            final List<AstFile> files = new ArrayList<>();\r\n            List<ProjectRole> pRoles = ctx.getServices().getProjectRoleServices().findAllByProjectAndRole(project,\r\n                    role);\r\n            pRoles.forEach(pRole -> {\r\n                files.addAll(ctx.getServices().getAstFileService().findAllByProjectRole(pRole));\r\n            });\r\n            files.removeIf(item -> item.getName().isEmpty());\r\n            files.removeIf(item -> !ctx.getServices().getStorageService().findByAstFile(item).isPresent());\r\n            files.sort((o1, o2) -> o2.getUpdateOn().compareTo(o1.getUpdateOn()));\r\n            grid.setDataProvider(DataProvider.ofCollection(files));\r\n\r\n        });\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\export\\AstFileExportView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\generation\\GeneratePresenter.java =====\n```\npackage com.hom.ebmw.view.admin.generation;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.jpa.model.Filterbase;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.spring.annotation.SpringComponent;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.util.*;\r\n\r\n@Slf4j\r\n@SpringComponent\r\npublic class GeneratePresenter {\r\n\r\n    private Map<String, Map<String, Integer>> cache = new HashMap<String, Map<String, Integer>>();\r\n    private Map<String, Integer> subCache = new HashMap<String, Integer>();\r\n    private List<Language> languages = new ArrayList<Language>();\r\n    private List<Filterbase> structures = new ArrayList<Filterbase>();\r\n\r\n    /**\r\n     * The GeneratePresenter function is the constructor for the GeneratePresenter class.\r\n     * It takes in a Services object and uses it to load all of the data from PIM into a cache.\r\n     *\r\n     * @param Services sessions Load the cache\r\n     * @return A new instance of the generatepresenter class\r\n     */\r\n    public GeneratePresenter(Services sessions) {\r\n        try {\r\n            loadCache(sessions);\r\n        } catch (Exception e) {\r\n            log.error(\"PIM Not Readey View must be Reload later\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The loadCache function is called by the IPIMService.getAllArticleAssortments() function, which in turn is called by the\r\n     * ArticleAssortmentController.loadCache() function, which in turn is called by the ArticleAssortmentController constructor.\r\n     * The loadCache function loads all of the article assortments from a database into an ArrayList&lt;ArticleAssortment&gt; object named cache,\r\n     * and it also loads all of the languages from a database into an ArrayList&lt;Language&gt; object named languages and all of\r\n     * structures from a database into an ArrayList&lt;Structure&gt; object named structures.\r\n     *\r\n     * @param Services services Load the cache\r\n     */\r\n    public void loadCache(Services services) throws Exception {\r\n        cache = services.getIPIMService().getAllArticleAssortments();\r\n        languages = services.getEnumerationService().getAllLanguages();\r\n        structures = services.getIPIMService().getAllRootStructure();\r\n    }\r\n\r\n    /**\r\n     * The reloadCategory function is used to reload the category box with all of the categories that are currently in use.\r\n     *\r\n     * @param ComboBox&lt;String&gt; categoryBox Set the items in the combobox\r\n     */\r\n    public void reloadCategory(ComboBox<String> categoryBox) {\r\n        List<String> result = new ArrayList<String>();\r\n        result.addAll(cache.keySet());\r\n        result.sort((o1, o2) -> o1.compareTo(o2));\r\n        categoryBox.setItems(result);\r\n    }\r\n\r\n    /**\r\n     * The reloadName function is used to update the nameBox ComboBox with a list of names\r\n     * that are associated with the category selected in the categoryBox ComboBox.\r\n     *\r\n     * @param ComboBox&lt;String&gt; nameBox Set the items in the combobox\r\n     * @param String                 category Determine which category of items to display in the namebox combobox\r\n     */\r\n    public void reloadName(ComboBox<String> nameBox, String category) {\r\n        List<String> result = new ArrayList<String>();\r\n        subCache = cache.get(category);\r\n        result.addAll(subCache.keySet());\r\n        result.sort((o1, o2) -> o1.compareTo(o2));\r\n        nameBox.setItems(result);\r\n    }\r\n\r\n    /**\r\n     * The reloadStructures function is used to reload the structures in the ComboBox.\r\n     * It removes any null items from the list, sorts it alphabetically, and then sets\r\n     * that sorted list as the new items for filterBox.\r\n     *\r\n     * @param ComboBox&lt;Filterbase&gt; filterBox Set the items in the combobox\r\n     */\r\n    public void reloadStructures(ComboBox<Filterbase> filterBox) {\r\n        structures.removeIf(item -> Objects.isNull(item) || Objects.isNull(item.getLabel()));\r\n        structures.sort((o1, o2) -> compareTo(o1.getLabel(), o2.getLabel()));\r\n        filterBox.setItems(structures);\r\n    }\r\n\r\n    /**\r\n     * The compareTo function compares two strings and returns a negative integer, zero, or a positive integer as the first string is less than, equal to, or greater than the second.\r\n     *\r\n     * @param String o1 Compare the first string to the second string\r\n     * @param String o2 Compare the string o2 to the string o2\r\n     * @return An int\r\n     */\r\n    private int compareTo(String o1, String o2) {\r\n        o1 = (Objects.nonNull(o1) ? o1 : \"\");\r\n        o2 = (Objects.nonNull(o2) ? o2 : \"\");\r\n        return o1.compareTo(o2);\r\n    }\r\n\r\n    /**\r\n     * The getSubCacheValue function returns the value of a key in the subCache.\r\n     *\r\n     * @param String key Get the value of a key in the subcache\r\n     * @return The value associated with the key\r\n     */\r\n    public int getSubCacheValue(String key) {\r\n        return subCache.get(key);\r\n    }\r\n\r\n    /**\r\n     * The getLanguages function returns a list of languages that the user has selected.\r\n     *\r\n     * @return A list of languages\r\n     */\r\n    public List<Language> getLanguages() {\r\n        return languages;\r\n    }\r\n\r\n\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\generation\\GeneratePresenter.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\generation\\GenerateView.java =====\n```\npackage com.hom.ebmw.view.admin.generation;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.ipim.model.Language;\r\nimport com.hom.ebmw.jpa.model.Setting;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.CompUtils;\r\nimport com.hom.ebmw.utilities.SettingUtils;\r\nimport com.hom.ebmw.utilities.constans.TMS;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.utilities.enums.Params;\r\nimport com.hom.ebmw.utilities.enums.SettingType;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.hom.ebmw.view.components.DownloadButton;\r\nimport com.hom.ebmw.view.dialogs.GenerateDialog;\r\nimport com.vaadin.flow.component.Composite;\r\nimport com.vaadin.flow.component.UI;\r\nimport com.vaadin.flow.component.button.Button;\r\nimport com.vaadin.flow.component.combobox.ComboBox;\r\nimport com.vaadin.flow.component.icon.VaadinIcon;\r\nimport com.vaadin.flow.component.orderedlayout.HorizontalLayout;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\nimport lombok.extern.slf4j.Slf4j;\r\n\r\nimport java.io.File;\r\nimport java.util.*;\r\n\r\nimport static com.hom.ebmw.utilities.enums.CTXAttribute.*;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_GENERIC;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_GENERIC;\r\n\r\n@Slf4j\r\n@SuppressWarnings(\"serial\")\r\n@PageTitle(TITLE_GENERIC)\r\n@Route(value = PAGE_GENERIC, layout = MainView.class)\r\npublic class GenerateView\r\n        extends\r\n        Composite<VerticalLayout> {\r\n\r\n    private ComboBox<Language> langBox = null;\r\n    private ComboBox<String> categoryBox = null;\r\n    private ComboBox<String> nameBox = null;\r\n    private ComboBox<Setting> filterBox = null;\r\n\r\n    private Button initialBoxes = null;\r\n    private Button generateBtn = null;\r\n    private DownloadButton downloadBtn = null;\r\n\r\n    private GeneratePresenter presenter = null;\r\n    private final Context ctx = new Context();\r\n\r\n    /**\r\n     * The GenerateView function is the constructor for the GenerateView class.\r\n     * It sets up all of the buttons and boxes that are used in this view, as well as\r\n     * setting up a context object to be passed around between different classes.\r\n     *\r\n     * @param Services          services Get the userservices and the httpsession\r\n     *                          private void setinitialboxesbtn() {\r\n     *                          initialboxes = new horizontallayout();\r\n     *                          <p>\r\n     *                          }\r\n     *                          <p>\r\n     *                          private void setlanguage() {\r\n     *                          }\r\n     * @param GeneratePresenter presenter Call the loadcache method\r\n     * @return A new generateview object\r\n     */\r\n    public GenerateView(\r\n            Services services,\r\n            GeneratePresenter presenter) {\r\n        this.presenter = presenter;\r\n        ctx.setUuid(UUID.randomUUID());\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n\r\n        try {\r\n            presenter.loadCache(ctx.getServices());\r\n        } catch (Exception e) {\r\n            log.error(\"PIM Not Ready View must be Reload later\");\r\n        }\r\n\r\n        setInitialBoxesBtn();\r\n        setLanguage();\r\n        setFilterBox();\r\n        setAssortmentBox();\r\n        presenter.reloadCategory(categoryBox);\r\n        setGenerateBtn();\r\n        setDownloadBtn();\r\n\r\n        HorizontalLayout bay = new HorizontalLayout();\r\n        bay.add(categoryBox, nameBox);\r\n        CompUtils.removeMSP(bay, \"MSP\");\r\n\r\n        getContent().add(initialBoxes, langBox, filterBox, bay, generateBtn, downloadBtn);\r\n        ctx.put(CURRENT_VIEW, this);\r\n        ctx.getUserSession().put(Params.ACTIVE_UI, UI.getCurrent());\r\n    }\r\n\r\n    /**\r\n     * The setInitialBoxesBtn function creates a button that allows the user to refresh the cache.\r\n     * This is useful if there are new boxes in the database, or if some of them have been deleted.\r\n     */\r\n    private void setInitialBoxesBtn() {\r\n        initialBoxes = new Button(VaadinIcon.REFRESH.create());\r\n        initialBoxes.addClickListener(event -> {\r\n            try {\r\n                presenter.loadCache(ctx.getServices());\r\n            } catch (Exception e) {\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setGenerateBtn function creates a button that allows the user to generate an Excel file.\r\n     * The function is called in the constructor of this class, and it sets up a click listener for\r\n     * when the button is clicked. When it's clicked, it opens up a GenerateDialog window with context\r\n     * information from ctx (the Context object). It then runs this dialog window. The generateBtn variable\r\n     * is set to false by default until all required fields are filled out correctly (see setRequiredFields()).\r\n     */\r\n    private void setGenerateBtn() {\r\n        generateBtn = new Button(getTranslation(TMS.GENERATE_BUTTON_GENERATE_LIST, getLocale(), ctx));\r\n        generateBtn.addClickListener(event -> {\r\n            Language lang = ctx.get(LANGUAGE);\r\n            ctx.put(FILE_NAME, ctx.get(ARTICLEASSORTMENT) + \"_\" + lang.getLabel() + \".xlsx\");\r\n            GenerateDialog dialog = new GenerateDialog(ctx);\r\n            dialog.open();\r\n            dialog.run();\r\n        });\r\n        generateBtn.setEnabled(false);\r\n    }\r\n\r\n    /**\r\n     * The setAssortmentBox function creates a ComboBox for the category and name of an article.\r\n     * The category box is populated with all categories from the database, while the name box is\r\n     * populated with names that correspond to a selected category. The user can select either one or both boxes,\r\n     * but if only one is selected then it will be ignored when generating an article number. If both are selected,\r\n     * then they will be used in conjunction to generate an article number. This function also sets up listeners for each box so that when their values change (i.e., when another value in their dropdown menu is chosen),\r\n     */\r\n    private void setAssortmentBox() {\r\n        categoryBox = new ComboBox<String>();\r\n        nameBox = new ComboBox<String>();\r\n\r\n        categoryBox.setPlaceholder(getTranslation(TMS.GENERATE_CATEGORY, getLocale(), ctx));\r\n        categoryBox.setClearButtonVisible(true);\r\n        nameBox.setPlaceholder(getTranslation(TMS.GENERATE_NAME, getLocale(), ctx));\r\n        nameBox.setClearButtonVisible(true);\r\n        nameBox.setReadOnly(true);\r\n        nameBox.setWidth(\"400px\");\r\n\r\n        categoryBox.addValueChangeListener(event -> {\r\n            nameBox.setReadOnly(true);\r\n\r\n            if (Objects.nonNull(event.getValue())) {\r\n                nameBox.setReadOnly(false);\r\n                presenter.reloadName(nameBox, event.getValue());\r\n            }\r\n        });\r\n\r\n        nameBox.addValueChangeListener(event -> {\r\n            generateBtn.setEnabled(false);\r\n            if (Objects.nonNull(event.getValue())) {\r\n                ctx.put(ARTICLEASSORTMENT, event.getValue());\r\n                setEnableGenerateBtn();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setLanguage function sets the language dropdown menu.\r\n     * It is a ComboBox that allows users to select from a list of languages.\r\n     * The function also adds an event listener to the ComboBox, which enables or disables\r\n     * the generate button depending on whether or not there is a selected value in the box.\r\n     */\r\n    private void setLanguage() {\r\n        langBox = new ComboBox<Language>();\r\n        langBox.setClearButtonVisible(true);\r\n        langBox.setPlaceholder(getTranslation(TMS.GENERATE_LANGUAGE, getLocale(), ctx));\r\n        langBox.setItems(presenter.getLanguages());\r\n        langBox.setItemLabelGenerator(item -> {\r\n            String label = \"\";\r\n            if (item.getLabel().contains(\"-\"))\r\n                label = Locale.forLanguageTag(item.getLabel()).getDisplayCountry();\r\n            else\r\n                label = item.getLabel();\r\n            return label;\r\n        });\r\n        langBox.addValueChangeListener(event -> {\r\n            generateBtn.setEnabled(false);\r\n            if (Objects.nonNull(event.getValue())) {\r\n                ctx.put(LANGUAGE, event.getValue());\r\n                setEnableGenerateBtn();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setFilterBox function is used to create a dropdown menu that allows the user to select which type of structure they would like to generate.\r\n     * The function creates a new ComboBox object, and then adds two settings objects (one for each type of structure) into an ArrayList.\r\n     * The function then sets the placeholder text for the dropdown menu, as well as its item label generator and items.\r\n     * Finally, it adds a value change listener that enables or disables the Generate button depending on whether or not there is an item selected in the dropdown menu.\r\n     */\r\n    private void setFilterBox() {\r\n        filterBox = new ComboBox<Setting>();\r\n        List<Setting> settings = new ArrayList<>();\r\n        settings.add(SettingUtils.getSettingByType(ctx, SettingType.DEFAULT_ECAT_STRUCUTURE_NAME));\r\n        settings.add(SettingUtils.getSettingByType(ctx, SettingType.DEFAULT_IMPEX_STRUCUTURE_NAME));\r\n\r\n        filterBox.setClearButtonVisible(true);\r\n        filterBox.setPlaceholder(getTranslation(TMS.GENERATE_STRUCTURE, getLocale(), ctx));\r\n        filterBox.setItemLabelGenerator(Setting::getIdentifier);\r\n        filterBox.setItems(settings);\r\n        filterBox.addValueChangeListener(event -> {\r\n            generateBtn.setEnabled(true);\r\n            if (Objects.nonNull(event.getValue())) {\r\n                ctx.put(STRUCTURECATEGORY, event.getValue());\r\n                setEnableGenerateBtn();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setDownloadBtn function sets the download button to be disabled.\r\n     */\r\n    private void setDownloadBtn() {\r\n        downloadBtn = new DownloadButton(ctx, TMS.GENERATE_EXCEL_DOWNLOAD_TOOLTIP);\r\n        downloadBtn.setEnabled(false);\r\n    }\r\n\r\n    /**\r\n     * The downloader function is used to download the file that was created by the\r\n     * user. It takes in a File object as an argument and uses it to create a new\r\n     * DownloadButton object, which is then added to the UI. The function also sets\r\n     * this button's enabled property to true so that it can be clicked on by users.\r\n     *\r\n     * @param File fi Get the name of the file to be downloaded\r\n     */\r\n    public void downloader(File fi) {\r\n        UI ui = ctx.getUserSession().get(Params.ACTIVE_UI);\r\n        ui.access(() -> {\r\n            if (Objects.nonNull(fi)) {\r\n                downloadBtn.setEnabled(true);\r\n                downloadBtn.reloadAsFile(() -> fi.getName(), () -> fi);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * The setEnableGenerateBtn function enables the generate button if all of the following conditions are met:\r\n     * 1. The article assortment is not null\r\n     * 2. The language is not null\r\n     * 3. The structure category is not null\r\n     * 3. The structure category is not null\r\n     */\r\n    private void setEnableGenerateBtn() {\r\n\r\n        if (Objects.nonNull(ctx.get(ARTICLEASSORTMENT)) && Objects.nonNull(ctx.get(LANGUAGE))\r\n                && Objects.nonNull(ctx.get(STRUCTURECATEGORY))) {\r\n            generateBtn.setEnabled(true);\r\n        }\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\generation\\GenerateView.java =====\n\n===== BEGIN FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\generation\\TestView.java =====\n```\npackage com.hom.ebmw.view.admin.generation;\r\n\r\nimport com.hom.ebmw.configuration.security.Services;\r\nimport com.hom.ebmw.configuration.security.SessionUtils;\r\nimport com.hom.ebmw.pojo.Context;\r\nimport com.hom.ebmw.pojo.UserSession;\r\nimport com.hom.ebmw.utilities.enums.CTXAttribute;\r\nimport com.hom.ebmw.view.MainView;\r\nimport com.vaadin.flow.component.Composite;\r\nimport com.vaadin.flow.component.orderedlayout.VerticalLayout;\r\nimport com.vaadin.flow.router.PageTitle;\r\nimport com.vaadin.flow.router.Route;\r\n\r\nimport java.util.UUID;\r\n\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.PAGE_TEST;\r\nimport static com.hom.ebmw.utilities.interfaces.PageConst.TITLE_TEST;\r\n\r\n\r\n@SuppressWarnings(\"serial\")\r\n@PageTitle(TITLE_TEST)\r\n@Route(value = PAGE_TEST, layout = MainView.class)\r\npublic class TestView extends Composite<VerticalLayout> {\r\n\r\n    private final Context ctx = new Context();\r\n\r\n    /**\r\n     * The TestView function is a constructor for the TestView class.\r\n     * It creates a new context and sets its UUID to a random UUID.\r\n     * It then puts the SessionUtils, UserSession, Services, and HttpSession into the context as attributes.\r\n     *\r\n     * @param Services services Set the services in the context\r\n     * @return A new context object\r\n     */\r\n    public TestView(Services services) {\r\n        ctx.setUuid(UUID.randomUUID());\r\n        ctx.put(CTXAttribute.SESSION, new SessionUtils(services.getUserServices()));\r\n        ctx.put(CTXAttribute.USER_SESSION, new UserSession());\r\n        ctx.put(CTXAttribute.SERVICES, services);\r\n        ctx.put(CTXAttribute.HTTP_SESSION, ctx.getSession().getHttpSession());\r\n        /* for Testing */\r\n    }\r\n}\r\n\n```\n===== END FILE: C:\\Users\\mtheele\\IdeaProjects\\TIP - Assortmenttool_2\\src\\main\\java\\com\\hom\\ebmw\\view\\admin\\generation\\TestView.java =====\n\n"
  },
  "response" : {
    "id" : "chatcmpl-V0iLS6wmXUngN6lsGDEKLYEKrq4gXAri",
    "created" : 1762171199,
    "model" : "gpt-oss:120b",
    "object" : "chat.completion",
    "system_fingerprint" : "b1-b0d5299",
    "choices" : [ {
      "finish_reason" : "stop",
      "index" : 0,
      "message" : {
        "content" : "{\n  \"file\": \"multiple\",\n  \"issues\": [\n    {\n      \"severity\": \"High\",\n      \"problem\": \"Potential NullPointerException in SettingUtils.getSettingByType and getFolder\",\n      \"justification\": \"Method declares throws NullPointerException but returns null; callers may dereference without nullcheck, leading to runtime crashes.\",\n      \"action\": \"Return Optional<Setting> instead of null; never throw NullPointerException for control flow. Add nullchecks in callers and update method signature.\",\n      \"source\": \"SettingUtils.getSettingByType, SettingUtils.getFolder\",\n      \"component\": \"configuration\",\n      \"impact_scope\": \"prodrelevant, stability\",\n      \"relations\": null,\n      \"evidence\": \"Calling getSettingByType and then using the returned Setting without null check can cause NPE.\"\n    },\n    {\n      \"severity\": \"High\",\n      \"problem\": \"UnzipUtility is vulnerable to Zip Slip path traversal\",\n      \"justification\": \"extractFile writes files using entry names directly, allowing malicious zip entries like '../../etc/passwd' to overwrite arbitrary files.\",\n      \"action\": \"Sanitize ZipEntry names by normalizing the destination path and ensuring it stays within destDirectory; reject entries that escape the target folder.\",\n      \"source\": \"UnzipUtility.unzip / extractFile\",\n      \"component\": \"filehandling\",\n      \"impact_scope\": \"securitycritical\",\n      \"relations\": null,\n      \"evidence\": \"No validation of entry.getName() before writing.\"\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Resource leaks in UnzipUtility and ZIPFiles (streams not closed on exception)\",\n      \"justification\": \"ZipInputStream and FileOutputStream are closed only in normal flow; exceptions leave them open, causing file descriptor leaks.\",\n      \"action\": \"Use trywithresources for ZipInputStream, BufferedOutputStream and any other I/O streams.\",\n      \"source\": \"UnzipUtility.unzip, UnzipUtility.extractFile, ZIPFiles.addToZip\",\n      \"component\": \"fileio\",\n      \"impact_scope\": \"performance, stability\",\n      \"relations\": null,\n      \"evidence\": \"zipIn.close() called after loop; if exception occurs before, stream remains open.\"\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"TranslationProvider.getTranslator may cause NullPointerException in finally block\",\n      \"justification\": \"Reader is initialized to null; if translate file does not exist, reader remains null and reader.close() throws NPE, masking original error.\",\n      \"action\": \"Initialize reader inside trywithresources or check for null before closing. Apply same fix to writer in setTranslator.\",\n      \"source\": \"TranslationProvider.getTranslator, TranslationProvider.setTranslator\",\n      \"component\": \"i18n\",\n      \"impact_scope\": \"stability\",\n      \"relations\": null,\n      \"evidence\": \"finally { reader.close(); } without null check.\"\n    },\n    {\n      \"severity\": \"Med\",\n      \"problem\": \"Generic catch blocks swallowing exceptions in SettingUtils\",\n      \"justification\": \"Methods getAllSettingParameterValuesByType and getAllSettingParametersByType catch Exception, log generic message and return empty list, hiding root causes.\",\n      \"action\": \"Catch specific exceptions, propagate or wrap them, and provide detailed log messages. Avoid returning silently empty collections on failure.\",\n      \"source\": \"SettingUtils.getAllSettingParameterValuesByType, SettingUtils.getAllSettingParametersByType\",\n      \"component\": \"servicelayer\",\n      \"impact_scope\": \"testability, debugging\",\n      \"relations\": null,\n      \"evidence\": \"log.error(\\\"Could not Create List\\\");\"\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"TreeConverter.getMinLevel logic bug\",\n      \"justification\": \"minCount is initialized to 0, then only decreased; because identifiers have at least one part, minCount stays 0, breaking compress loop logic.\",\n      \"action\": \"Initialize minCount to Integer.MAX_VALUE and update correctly; add unit tests for min/max level calculation.\",\n      \"source\": \"TreeConverter.getMinLevel\",\n      \"component\": \"uiutils\",\n      \"impact_scope\": \"logic correctness\",\n      \"relations\": null,\n      \"evidence\": \"minCount = 0; if (count < minCount) never true.\"\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"PermissionGrid readOnly logic ties admin protection to class name\",\n      \"justification\": \"Checks permission name against AdminView class name, which may change; security relies on fragile string comparison.\",\n      \"action\": \"Introduce a dedicated flag/role check (e.g., isImmutable) in Permission entity; compare role names or permission identifiers rather than class names.\",\n      \"source\": \"PermissionGrid.createHasReadRights (and similar methods)\",\n      \"component\": \"security\",\n      \"impact_scope\": \"securitymaintenance\",\n      \"relations\": null,\n      \"evidence\": \"permission.getPermission().getName().equals(AdminView.class.getName())\"\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"Potential race condition when multiple threads call TranslationProvider.getTranslator\",\n      \"justification\": \"Creates/updates property files without synchronization; concurrent writes can corrupt files.\",\n      \"action\": \"Synchronize file creation and property store operations or use a threadsafe cache; add integration tests for concurrent access.\",\n      \"source\": \"TranslationProvider.getTranslator / setTranslator\",\n      \"component\": \"i18n\",\n      \"impact_scope\": \"concurrency\",\n      \"relations\": null,\n      \"evidence\": \"translate.createNewFile() and prop.store() not synchronized.\"\n    },\n    {\n      \"severity\": \"Low\",\n      \"problem\": \"ZIPFiles.addToZip uses recursive call with child.normalize().toString which may lose path hierarchy\",\n      \"justification\": \"Normalization may strip necessary relative paths, causing files to be added at wrong locations in the zip.\",\n      \"action\": \"Pass the relative path inside the zip explicitly; preserve directory structure when recursing.\",\n      \"source\": \"ZIPFiles.addToZip\",\n      \"component\": \"ziputility\",\n      \"impact_scope\": \"functionality\",\n      \"relations\": null,\n      \"evidence\": \"addToZip(child.normalize().toString);\"\n    }\n  ],\n  \"summary\": {\n    \"overall_rating\": \"2\",\n    \"top_todos\": [\n      \"Fix NPE handling in SettingUtils and use Optional instead of null returns.\",\n      \"Mitigate Zip Slip in UnzipUtility and ensure all streams are closed with trywithresources.\",\n      \"Correct resource handling and null checks in TranslationProvider to avoid hidden NPEs.\"\n    ]\n  }\n}",
        "role" : "assistant",
        "reasoning_content" : "We need to produce a single JSON object for each file? The instruction: \"Du analysierst jeweils einen Code-Chunk.\" Likely need one JSON per file. Probably combine all? It says \"file\": path. So maybe produce one JSON per file? But output must be a single JSON object. Could include issues across all files? Probably we need one JSON object per file, but they said respond with exactly this JSON object. Might need to output for each file separately? The prompt includes many files. Could produce a JSON array? Schema expects object with file, issues, summary. Might need separate per file. But can we output multiple objects? The rule: answer always as a single JSON object. So maybe we need to combine all files into one object with file as something like \"multiple\" and aggregate issues across all? Might be acceptable. Let's create one JSON with file \"multiple\" and include issues across all files (max 10). We must prioritize top issues across the whole code base. We'll identify major issues:\n\n1. SettingUtils.getSettingByType returns null if not found but method signature declares throws NullPointerException but not thrown. Might cause NPE downstream. Also getFolder throws NullPointerException if directory empty; using NPE for flow is bad.\n\n2. getS3CatalogSetting: uses setting.getValue() and checks contains(\"%s\") but then uses terrValue logic; potential NPE if setting.getValue() null. Also uses equals on item.getAlternate() without null check.\n\n3. getAllSettingParameterValuesByType catches generic Exception, logs generic message; swallowing errors hides problems. Also returns empty list silently.\n\n4. In TranslationProvider.getTranslation: logic uses ctx possibly null, may cause NPE. Also catches generic Exception and silently reverts locale. Also uses getTranslation(key, locale) which may call getTranslator that may create new property files on missing translation; potential race condition, file handling not synchronized.\n\n5. getTranslator: Reader may be null if file not exists, finally block attempts reader.close() causing NPE. Also creates file if missing but does not write initial properties; concurrency issues.\n\n6. setTranslator: similar issue, writer may be null if exception; finally block closes writer without null check.\n\n7. UnzipUtility.unzip: does not close ZipInputStream in finally if exception; also does not validate zip entry paths (zip slip vulnerability). Also extracts files without checking for directory traversal.\n\n8. ZIPFiles.addToZip: recursive call using child.normalize().toString may cause infinite recursion? Not likely but path handling may be wrong. Also uses Files.copy without checking if target exists leads to overwrite (OK). Not closing resources? Using try-with-resources for DirectoryStream but not for file copy.\n\n9. TreeConverter: getMinLevel sets minCount =0 then iterates but initial minCount 0 leads to never updated because count >=1, so minCount remains 0 always, causing compressByLevel range wrong. Also potential off-by-one loops.\n\n10. PermissionGrid: readOnly condition compares permission.getPermission().getName().equals(AdminView.class.getName()) which may not reflect permission name; also security: admin role cannot be altered but logic might be reversed.\n\nWe need max 10 issues. Provide severity and actions.\n\nNow construct JSON.\n\nWe'll include summary rating maybe 2 stars.\n\nProvide top todos list.\n\nLet's craft."
      },
      "provider_specific_fields" : { }
    } ],
    "usage" : {
      "completion_tokens" : 2120,
      "prompt_tokens" : 23185,
      "total_tokens" : 25305
    },
    "timings" : {
      "cache_n" : 527,
      "prompt_n" : 22658,
      "prompt_ms" : 16967.295,
      "prompt_per_token_ms" : 0.7488434548503838,
      "prompt_per_second" : 1335.3925890956693,
      "predicted_n" : 2120,
      "predicted_ms" : 25361.427,
      "predicted_per_token_ms" : 11.962937264150943,
      "predicted_per_second" : 83.59151084045862
    }
  }
}